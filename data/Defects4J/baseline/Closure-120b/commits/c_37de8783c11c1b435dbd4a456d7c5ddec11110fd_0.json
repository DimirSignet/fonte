{"sha": "37de8783c11c1b435dbd4a456d7c5ddec11110fd", "log": "reverse type inference order for inner functions  Tested: yes  R=johnlenz DELTA=285  (196 added, 61 deleted, 28 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=4643   ", "commit": "\n--- a/src/com/google/javascript/jscomp/TypeInferencePass.java\n+++ b/src/com/google/javascript/jscomp/TypeInferencePass.java\n import com.google.common.base.Preconditions;\n import com.google.common.collect.Maps;\n import com.google.javascript.jscomp.CodingConvention.AssertionFunctionSpec;\n-import com.google.javascript.jscomp.NodeTraversal.ScopedCallback;\n+import com.google.javascript.jscomp.NodeTraversal.AbstractScopedCallback;\n import com.google.javascript.jscomp.type.ReverseAbstractInterpreter;\n import com.google.javascript.rhino.Node;\n \n     }\n   }\n \n-  private class TypeInferringCallback implements ScopedCallback {\n+  private class TypeInferringCallback extends AbstractScopedCallback {\n     @Override\n     public void enterScope(NodeTraversal t) {\n-      Scope scope = t.getScope();\n-      Node node = t.getCurrentNode();\n-      if (scope.isGlobal()) {\n-        inferTypes(t, node, scope);\n-      }\n-    }\n-\n-    @Override\n-    public void exitScope(NodeTraversal t) {\n-      Scope scope = t.getScope();\n-      Node node = t.getCurrentNode();\n-      if (scope.isLocal()) {\n-        inferTypes(t, node, scope);\n-      }\n-    }\n-\n-    @Override\n-    public boolean shouldTraverse(NodeTraversal t, Node n, Node parent) {\n-      return true;\n+      inferTypes(t, t.getCurrentNode(), t.getScope());\n     }\n \n     @Override\n--- a/test/com/google/javascript/jscomp/LooseTypeCheckTest.java\n+++ b/test/com/google/javascript/jscomp/LooseTypeCheckTest.java\n         \" var x = 0 || function() {};\\n\" +\n         \" function g() { if (goog.isFunction(x)) { x(1); } }\" +\n         \" g();\" +\n-        \"}\", null);\n+        \"}\",\n+        \"Function x: called with 1 argument(s). \" +\n+        \"Function requires at least 0 argument(s) \" +\n+        \"and no more than 0 argument(s).\");\n   }\n \n   public void testInnerFunction7() throws Exception {\n--- a/test/com/google/javascript/jscomp/TypeCheckTest.java\n+++ b/test/com/google/javascript/jscomp/TypeCheckTest.java\n         \" var x = 0 || function() {};\\n\" +\n         \" function g() { if (goog.isFunction(x)) { x(1); } }\" +\n         \" g();\" +\n-        \"}\", null);\n+        \"}\",\n+        \"Function x: called with 1 argument(s). \" +\n+        \"Function requires at least 0 argument(s) \" +\n+        \"and no more than 0 argument(s).\");\n   }\n \n   public void testInnerFunction7() throws Exception {\n         + \"baz(function() { this; }, {});\");\n   }\n \n+  public void testFunctionLiteralDefinedThisArgument2() throws Exception {\n+    testTypes(\"\"\n+        + \"/** @param {string} x */ function f(x) {}\"\n+        + \"/**\\n\"\n+        + \" * @param {?function(this:T, ...)} fn\\n\"\n+        + \" * @param {T=} opt_obj\\n\"\n+        + \" * @template T\\n\"\n+        + \" */\\n\"\n+        + \"function baz(fn, opt_obj) {}\\n\"\n+        + \"function g() { baz(function() { f(this.length); }, []); }\",\n+        \"actual parameter 1 of f does not match formal parameter\\n\"\n+        + \"found   : number\\n\"\n+        + \"required: string\");\n+  }\n+\n   public void testFunctionLiteralUnreadNullThisArgument() throws Exception {\n     testTypes(\"\"\n         + \"/**\\n\"", "timestamp": 1335876376, "metainfo": ""}