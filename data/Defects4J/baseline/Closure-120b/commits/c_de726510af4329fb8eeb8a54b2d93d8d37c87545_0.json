{"sha": "de726510af4329fb8eeb8a54b2d93d8d37c87545", "log": "When -language_in=ECMASCRIPT5_STRICT, only print 'use strict' in the first input file.  Fixes Issue 489.  R=acleung DELTA=22  (18 added, 0 deleted, 4 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=2325   ", "commit": "\n--- a/src/com/google/javascript/jscomp/Compiler.java\n+++ b/src/com/google/javascript/jscomp/Compiler.java\n               cb.getLineIndex(), cb.getColumnIndex());\n         }\n \n-        String code = toSource(root, sourceMap);\n+        // if LanguageMode is ECMASCRIPT5_STRICT, only print 'use strict'\n+        // for the first input file\n+        String code = toSource(root, sourceMap, inputSeqNum == 0);\n         if (!code.isEmpty()) {\n           cb.append(code);\n \n   @Override\n   String toSource(Node n) {\n     initCompilerOptionsIfTesting();\n-    return toSource(n, null);\n+    return toSource(n, null, true);\n   }\n \n   /**\n    * Generates JavaScript source code for an AST.\n    */\n-  private String toSource(Node n, SourceMap sourceMap) {\n+  private String toSource(Node n, SourceMap sourceMap, boolean firstOutput) {\n     CodePrinter.Builder builder = new CodePrinter.Builder(n);\n     builder.setPrettyPrint(options.prettyPrint);\n     builder.setLineBreak(options.lineBreak);\n     builder.setSourceMap(sourceMap);\n     builder.setSourceMapDetailLevel(options.sourceMapDetailLevel);\n-    builder.setTagAsStrict(\n+    builder.setTagAsStrict(firstOutput &&\n         options.getLanguageOut() == LanguageMode.ECMASCRIPT5_STRICT);\n     builder.setLineLengthThreshold(options.lineLengthThreshold);\n \n--- a/test/com/google/javascript/jscomp/CommandLineRunnerTest.java\n+++ b/test/com/google/javascript/jscomp/CommandLineRunnerTest.java\n     test(\"var let\", RhinoErrorReporter.PARSE_ERROR);\n   }\n \n+  public void testES5StrictUseStrict() {\n+    args.add(\"--language_in=ECMASCRIPT5_STRICT\");\n+    Compiler compiler = compile(new String[] {\"var x = f.function\"});\n+    String outputSource = compiler.toSource();\n+    assertEquals(\"'use strict'\", outputSource.substring(0, 12));\n+  }\n+\n+  public void testES5StrictUseStrictMultipleInputs() {\n+    args.add(\"--language_in=ECMASCRIPT5_STRICT\");\n+    Compiler compiler = compile(new String[] {\"var x = f.function\",\n+        \"var y = f.function\", \"var z = f.function\"});\n+    String outputSource = compiler.toSource();\n+    assertEquals(\"'use strict'\", outputSource.substring(0, 12));\n+    assertEquals(outputSource.substring(13).indexOf(\"'use strict'\"), -1);\n+  }\n+\n   /* Helper functions */\n \n   private void testSame(String original) {", "timestamp": 1308346564, "metainfo": ""}