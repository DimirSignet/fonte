{"sha": "ea140fb5c327e2b58f6c5bf1057c7dede909a50c", "log": "LANG-567 - ArrayUtils.addAll(T[] array1, T... array2) does not handle mixed types very well Also remove unnecessary main() and suite() from test class  ", "commit": "\n--- a/src/java/org/apache/commons/lang3/ArrayUtils.java\n+++ b/src/java/org/apache/commons/lang3/ArrayUtils.java\n         } else if (array2 == null) {\n             return clone(array1);\n         }\n-        T[] joinedArray = (T[]) Array.newInstance(array1.getClass().getComponentType(),\n-                                                            array1.length + array2.length);\n+        final Class<?> type1 = array1.getClass().getComponentType();\n+        T[] joinedArray = (T[]) Array.newInstance(type1, array1.length + array2.length);\n         System.arraycopy(array1, 0, joinedArray, 0, array1.length);\n-        System.arraycopy(array2, 0, joinedArray, array1.length, array2.length);\n+        try {\n+            System.arraycopy(array2, 0, joinedArray, array1.length, array2.length);\n+        } catch (ArrayStoreException ase) {\n+            // Check if problem is incompatible types\n+            final Class<?> type2 = array2.getClass().getComponentType();\n+            if (!type1.isAssignableFrom(type2)){\n+                throw new IllegalArgumentException(\"Cannot store \"+type2.getName()+\" in an array of \"+type1.getName());\n+            }\n+            throw ase; // No, so rethrow original\n+        }\n         return joinedArray;\n     }\n \n--- a/src/test/org/apache/commons/lang3/ArrayUtilsAddTest.java\n+++ b/src/test/org/apache/commons/lang3/ArrayUtilsAddTest.java\n \n import java.util.Arrays;\n \n-import junit.framework.Test;\n import junit.framework.TestCase;\n-import junit.framework.TestSuite;\n-import junit.textui.TestRunner;\n \n /**\n  * Tests ArrayUtils add methods.\n  * @version $Id$\n  */\n public class ArrayUtilsAddTest extends TestCase {\n-    public static void main(String[] args) {\n-        TestRunner.run(suite());\n-    }\n-\n-    public static Test suite() {\n-        TestSuite suite = new TestSuite(ArrayUtilsAddTest.class);\n-        suite.setName(\"ArrayUtils add Tests\");\n-        return suite;\n+\n+    public void testJira567(){\n+        Number[] n;\n+        // Valid array construction\n+        n = ArrayUtils.addAll(new Number[]{Integer.valueOf(1)}, new Long[]{Long.valueOf(2)});\n+        assertEquals(2,n.length);\n+        assertEquals(Number.class,n.getClass().getComponentType());\n+        try {\n+            // Invalid - can't store Long in Integer array\n+               n = ArrayUtils.addAll(new Integer[]{Integer.valueOf(1)}, new Long[]{Long.valueOf(2)});\n+               fail(\"Should have generated IllegalArgumentException\");\n+        } catch (IllegalArgumentException expected) {\n+        }\n     }\n \n     public void testAddObjectArrayBoolean() {", "timestamp": 1261104621, "metainfo": ""}