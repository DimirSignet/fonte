{"sha": "006fca88e86bd6f650d4d021d2ff3573a572827d", "log": "[LANG-586] Clear ThreadLocal for HashCodeBuilder as well  ", "commit": "\n--- a/src/main/java/org/apache/commons/lang3/builder/HashCodeBuilder.java\n+++ b/src/main/java/org/apache/commons/lang3/builder/HashCodeBuilder.java\n      * \n      * @since 2.3\n      */\n-    private static final ThreadLocal<Set<IDKey>> registry = new ThreadLocal<Set<IDKey>>() {\n-        @Override\n-        protected Set<IDKey> initialValue() {\n-            // The HashSet implementation is not synchronized,\n-            // which is just what we need here.\n-            return new HashSet<IDKey>();\n-        }\n-    };\n+    private static final ThreadLocal<Set<IDKey>> REGISTRY = new ThreadLocal<Set<IDKey>>();\n \n     /*\n      * N.B. we cannot store the actual objects in a HashSet, as that would use the very hashCode()\n      * @since 2.3\n      */\n     static Set<IDKey> getRegistry() {\n-        return registry.get();\n+        return REGISTRY.get();\n     }\n \n     /**\n      * @since 2.3\n      */\n     static boolean isRegistered(Object value) {\n-        return getRegistry().contains(new IDKey(value));\n+        Set<IDKey> registry = getRegistry();\n+        return registry != null && registry.contains(new IDKey(value));\n     }\n \n     /**\n      *            The object to register.\n      */\n     static void register(Object value) {\n+        synchronized (HashCodeBuilder.class) {\n+            if (getRegistry() == null) {\n+                REGISTRY.set(new HashSet<IDKey>());\n+            }\n+        }\n         getRegistry().add(new IDKey(value));\n     }\n \n      * @since 2.3\n      */\n     static void unregister(Object value) {\n-        getRegistry().remove(new IDKey(value));\n+        Set<IDKey> s = getRegistry();\n+        if (s != null) {\n+            s.remove(new IDKey(value));\n+            synchronized (HashCodeBuilder.class) {\n+                if (s.isEmpty()) {\n+                    REGISTRY.remove();\n+                }\n+            }\n+        }\n     }\n \n     /**\n--- a/src/test/java/org/apache/commons/lang3/builder/HashCodeBuilderTest.java\n+++ b/src/test/java/org/apache/commons/lang3/builder/HashCodeBuilderTest.java\n         // at org.apache.commons.lang.builder.HashCodeBuilder.append(HashCodeBuilder.java:422)\n \n         a.hashCode();\n+        assertNull(HashCodeBuilder.getRegistry());\n         b.hashCode();\n+        assertNull(HashCodeBuilder.getRegistry());\n     }\n \n     /**", "timestamp": 1265512449, "metainfo": ""}