{"sha": "861e89475b2cd98814dbfa3921d6e4052898b637", "log": "fix a minor bug in prototype resetting  R=johnlenz DELTA=28  (23 added, 1 deleted, 4 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=3249   ", "commit": "\n--- a/src/com/google/javascript/rhino/jstype/JSTypeRegistry.java\n+++ b/src/com/google/javascript/rhino/jstype/JSTypeRegistry.java\n       JSType type, ObjectType newImplicitProto) {\n     if (type instanceof PrototypeObjectType) {\n       PrototypeObjectType poType = (PrototypeObjectType) type;\n-      if (!poType.hasCachedValues()) {\n-        poType.setImplicitPrototype(newImplicitProto);\n-        return true;\n-      }\n+      poType.clearCachedValues();\n+      poType.setImplicitPrototype(newImplicitProto);\n+      return true;\n     }\n     return false;\n   }\n--- a/src/com/google/javascript/rhino/jstype/ObjectType.java\n+++ b/src/com/google/javascript/rhino/jstype/ObjectType.java\n   }\n \n   /**\n-   * Returns true if any cached valeus have been set for this type.  If true,\n+   * Returns true if any cached values have been set for this type.  If true,\n    * then the prototype chain should not be changed, as it might invalidate the\n    * cached values.\n    */\n--- a/test/com/google/javascript/jscomp/TypeCheckTest.java\n+++ b/test/com/google/javascript/jscomp/TypeCheckTest.java\n         \"};\" +\n         \"Bar.prototype.__proto__ = Foo.prototype;\",\n         \"Property baz2 never defined on Bar\");\n+  }\n+\n+  public void testIssue537d() throws Exception {\n+    testTypes(\n+        \"/** @constructor */ function Foo() {}\" +\n+        \"Foo.prototype = {\" +\n+        \"  /** @return {Bar} */ x: function() { new Bar(); },\" +\n+        \"  /** @return {Foo} */ y: function() { new Bar(); }\" +\n+        \"};\" +\n+        \"/**\\n\" +\n+        \" * @constructor\\n\" +\n+        \" * @extends {Foo}\\n\" +\n+        \" */\\n\" +\n+        \"function Bar() {\" +\n+        \"  this.xy = 3;\" +\n+        \"}\" +\n+        \"/** @return {Bar} */ function f() { return new Bar(); }\" +\n+        \"/** @return {Foo} */ function g() { return new Bar(); }\" +\n+        \"Bar.prototype = {\" +\n+        \"  /** @return {Bar} */ x: function() { new Bar(); },\" +\n+        \"  /** @return {Foo} */ y: function() { new Bar(); }\" +\n+        \"};\" +\n+        \"Bar.prototype.__proto__ = Foo.prototype;\");\n   }\n \n   /**", "timestamp": 1315938588, "metainfo": ""}