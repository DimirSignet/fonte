{"sha": "d07260c6993303adf0d1d0c8d4d01ab8d10308c8", "log": "Handle disappearing definition sites in OptimizeReturns.  R=acleung DELTA=17  (15 added, 0 deleted, 2 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=28   ", "commit": "\n--- a/src/com/google/javascript/jscomp/OptimizeReturns.java\n+++ b/src/com/google/javascript/jscomp/OptimizeReturns.java\n   @Override\n   public void process(\n       Node externs, Node root, SimpleDefinitionFinder definitions) {\n-    for (DefinitionSite defSite : definitions.getDefinitionSites()) {\n-      optimizeResultsIfEligible(defSite, definitions);\n+    // Create a snapshot of the definition sites to iterate over\n+    // as they can be removed during processing.\n+    for (DefinitionSite defSite :\n+        definitions.getDefinitionSites().toArray(new DefinitionSite[0])) {\n+      if (definitions.getDefinitionSites().contains(defSite)) {\n+        optimizeResultsIfEligible(defSite, definitions);\n+      }\n     }\n   }\n \n--- a/test/com/google/javascript/jscomp/OptimizeReturnsTest.java\n+++ b/test/com/google/javascript/jscomp/OptimizeReturnsTest.java\n         \"c();\");\n     test(source, expected);\n   }\n-  \n+\n   public void testRewriteUnusedResult7b() throws Exception {\n     String source = newlineJoin(\n         \"c();\",\n         \"function b() { a(); return }\",\n         \"function a() { return }\");\n     test(source, expected);\n-  }  \n+  }\n \n   public void testRewriteUnusedResult8() throws Exception {\n     String source = newlineJoin(\n \n     testSame(\"function a() {return 1}; a.apply(new foo);\");\n   }\n+\n+  public void testRewriteUseSiteRemoval() throws Exception {\n+    String source = newlineJoin(\n+        \"function a() { return {\\\"_id\\\" : 1} }\",\n+        \"a();\");\n+    String expected = newlineJoin(\n+        \"function a() { return }\",\n+        \"a();\");\n+    test(source, expected);\n+  }\n }", "timestamp": 1291159274, "metainfo": ""}