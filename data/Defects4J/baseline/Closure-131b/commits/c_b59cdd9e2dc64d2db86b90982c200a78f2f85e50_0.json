{"sha": "b59cdd9e2dc64d2db86b90982c200a78f2f85e50", "log": "Don't fold arrays if they have side effects. Contributed by Robert Gust-Bardon Fixes issue 747  R=acleung DELTA=16  (13 added, 0 deleted, 3 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=4968   ", "commit": "\n--- a/src/com/google/javascript/jscomp/PeepholeFoldConstants.java\n+++ b/src/com/google/javascript/jscomp/PeepholeFoldConstants.java\n       return n;\n     }\n \n-    Node elem = left.getFirstChild();\n-    for (int i = 0; elem != null && i < intIndex; i++) {\n-      elem = elem.getNext();\n+    Node current = left.getFirstChild();\n+    Node elem = null;\n+    for (int i = 0; current != null; i++) {\n+      if (i != intIndex) {\n+        if (mayHaveSideEffects(current)) {\n+          return n;\n+        }\n+      } else {\n+        elem = current;\n+      }\n+\n+      current = current.getNext();\n     }\n \n     if (elem == null) {\n--- a/test/com/google/javascript/jscomp/PeepholeFoldConstantsTest.java\n+++ b/test/com/google/javascript/jscomp/PeepholeFoldConstantsTest.java\n         PeepholeFoldConstants.INDEX_OUT_OF_BOUNDS_ERROR);\n     fold(\"x = [10, 20][2]\",     \"\",\n         PeepholeFoldConstants.INDEX_OUT_OF_BOUNDS_ERROR);\n+\n+    foldSame(\"x = [foo(), 0][1]\");\n+    fold(\"x = [0, foo()][1]\", \"x = foo()\");\n+    foldSame(\"x = [0, foo()][0]\");\n   }\n \n   public void testFoldComplex() {", "timestamp": 1339109338, "metainfo": ""}