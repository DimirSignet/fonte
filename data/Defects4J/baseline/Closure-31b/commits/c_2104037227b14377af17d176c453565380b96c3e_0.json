{"sha": "2104037227b14377af17d176c453565380b96c3e", "log": "fix SimpleDefinitionFinder crash on objectliterals in externs  R=avd,johnlenz DELTA=34  (23 added, 0 deleted, 11 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=181031   ", "commit": "\n--- a/src/com/google/javascript/jscomp/SimpleDefinitionFinder.java\n+++ b/src/com/google/javascript/jscomp/SimpleDefinitionFinder.java\n \n             List<Definition> stubsToRemove = Lists.newArrayList();\n             String qualifiedName = node.getQualifiedName();\n-            for (Definition prevDef : nameDefinitionMultimap.get(name)) {\n-              if (prevDef instanceof ExternalNameOnlyDefinition\n-                  && node.getJSDocInfo() == null) {\n-                String prevName = prevDef.getLValue().getQualifiedName();\n-                if (qualifiedName.equals(prevName)) {\n-                  // Drop this stub, there is a real definition.\n-                  stubsToRemove.add(prevDef);\n+\n+            // If there is no qualified name for this, then there will be\n+            // no stubs to remove. This will happen if node is an object\n+            // literal key.\n+            if (qualifiedName != null) {\n+              for (Definition prevDef : nameDefinitionMultimap.get(name)) {\n+                if (prevDef instanceof ExternalNameOnlyDefinition\n+                    && node.getJSDocInfo() == null) {\n+                  String prevName = prevDef.getLValue().getQualifiedName();\n+                  if (qualifiedName.equals(prevName)) {\n+                    // Drop this stub, there is a real definition.\n+                    stubsToRemove.add(prevDef);\n+                  }\n                 }\n               }\n-            }\n-\n-            for (Definition prevDef : stubsToRemove) {\n-              nameDefinitionMultimap.remove(name, prevDef);\n+\n+              for (Definition prevDef : stubsToRemove) {\n+                nameDefinitionMultimap.remove(name, prevDef);\n+              }\n             }\n           }\n \n--- a/test/com/google/javascript/jscomp/SimpleDefinitionFinderTest.java\n+++ b/test/com/google/javascript/jscomp/SimpleDefinitionFinderTest.java\n     checkDefinitionsInExterns(\n         externs,\n         ImmutableSet.of(\"DEF NAME a -> EXTERN NUMBER\"));\n+  }\n+\n+  public void testObjectLitInExterns() {\n+    checkDefinitions(\n+        \"var goog = {};\" +\n+        \"/** @type {number} */ goog.HYBRID;\" +\n+        \"/** @enum */ goog.Enum = {HYBRID: 0, ROADMAP: 1};\",\n+        \"goog.HYBRID; goog.Enum.ROADMAP;\",\n+        ImmutableSet.<String>of(\n+            \"DEF GETPROP goog.Enum -> EXTERN <null>\",\n+            \"DEF GETPROP goog.HYBRID -> EXTERN <null>\",\n+            \"DEF NAME goog -> EXTERN <null>\",\n+            \"DEF STRING null -> EXTERN NUMBER\",\n+            \"USE GETPROP goog.Enum -> [EXTERN <null>]\",\n+            \"USE GETPROP goog.Enum.ROADMAP -> [EXTERN NUMBER]\",\n+            \"USE GETPROP goog.HYBRID -> [EXTERN <null>, EXTERN NUMBER]\",\n+            \"USE NAME goog -> [EXTERN <null>]\"));\n   }\n \n   void checkDefinitionsInExterns(String externs, Set<String> expected) {", "timestamp": 1282580648, "metainfo": ""}