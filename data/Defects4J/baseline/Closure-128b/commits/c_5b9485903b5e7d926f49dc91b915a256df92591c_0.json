{"sha": "5b9485903b5e7d926f49dc91b915a256df92591c", "log": "Don't reorder if condition expressions if they contain side-effects. Fixes issue 925. ------------- Created by MOE: http://code.google.com/p/moe-java MOE_MIGRATED_REVID=43060270", "commit": "\n--- a/src/com/google/javascript/jscomp/PeepholeSubstituteAlternateSyntax.java\n+++ b/src/com/google/javascript/jscomp/PeepholeSubstituteAlternateSyntax.java\n               // evaluates LHS before cond]\n               // NOTE - there are some circumstances where we can\n               // proceed even if there are side effects...\n-              !mayEffectMutableState(lhs)) {\n+              !mayEffectMutableState(lhs) &&\n+              (!mayHaveSideEffects(cond) ||\n+                  (thenOp.isAssign() && thenOp.getFirstChild().isName()))) {\n \n             n.removeChild(cond);\n             Node assignName = thenOp.removeFirstChild();\n--- a/test/com/google/javascript/jscomp/PeepholeSubstituteAlternateSyntaxTest.java\n+++ b/test/com/google/javascript/jscomp/PeepholeSubstituteAlternateSyntaxTest.java\n     testSame(\"function f() { if (x) { if (y) { return 1; } } else f() }\");\n   }\n \n+  public void testIssue925() {\n+    test(\n+        \"if (x[--y] === 1) {\\n\" +\n+        \"    x[y] = 0;\\n\" +\n+        \"} else {\\n\" +\n+        \"    x[y] = 1;\\n\" +\n+        \"}\",\n+        \"(x[--y] === 1) ? x[y] = 0 : x[y] = 1;\");\n+\n+    test(\n+        \"if (x[--y]) {\\n\" +\n+        \"    a = 0;\\n\" +\n+        \"} else {\\n\" +\n+        \"    a = 1;\\n\" +\n+        \"}\",\n+        \"a = (x[--y]) ? 0 : 1;\");\n+\n+    test(\"if (x++) { x += 2 } else { x += 3 }\",\n+         \"x++ ? x += 2 : x += 3\");\n+\n+    test(\"if (x++) { x = x + 2 } else { x = x + 3 }\",\n+        \"x = x++ ? x + 2 : x + 3\");\n+  }\n+\n   public void testBindToCall1() {\n     test(\"(goog.bind(f))()\", \"f()\");\n     test(\"(goog.bind(f,a))()\", \"f.call(a)\");\n       // Don't rewrite if the bind isn't the immediate call target\n       testSame(\"goog.bind(f.m).call(g)\");\n     }\n-\n-\n   }\n }", "timestamp": 1361815504, "metainfo": ""}