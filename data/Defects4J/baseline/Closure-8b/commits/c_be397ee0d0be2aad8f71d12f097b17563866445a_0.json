{"sha": "be397ee0d0be2aad8f71d12f097b17563866445a", "log": "Remove addSingletonGetter stragglers. Fixes issue 668  R=nicksantos DELTA=34  (31 added, 2 deleted, 1 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=4297   ", "commit": "\n--- a/src/com/google/javascript/jscomp/InlineVariables.java\n+++ b/src/com/google/javascript/jscomp/InlineVariables.java\n         return false;\n       }\n \n-      // Bug 2388531: Don't inline subclass definitions into class defining\n-      // calls as this confused class removing logic.\n       if (value.isFunction()) {\n         Node callNode = reference.getParent();\n         if (reference.getParent().isCall()) {\n+          CodingConvention convention = compiler.getCodingConvention();\n+          // Bug 2388531: Don't inline subclass definitions into class defining\n+          // calls as this confused class removing logic.\n           SubclassRelationship relationship =\n-              compiler.getCodingConvention().getClassesDefinedByCall(callNode);\n+              convention.getClassesDefinedByCall(callNode);\n           if (relationship != null) {\n+            return false;\n+          }\n+\n+          // issue 668: Don't inline singleton getter methods\n+          // calls as this confused class removing logic.\n+          if (convention.getSingletonGetterClassName(callNode) != null) {\n             return false;\n           }\n         }\n--- a/test/com/google/javascript/jscomp/IntegrationTest.java\n+++ b/test/com/google/javascript/jscomp/IntegrationTest.java\n         \"print(3/0);print(3/-0);\");\n   }\n \n+  public void testSingletonGetter1() {\n+    CompilerOptions options = createCompilerOptions();\n+    CompilationLevel.ADVANCED_OPTIMIZATIONS\n+        .setOptionsForCompilationLevel(options);\n+    options.setCodingConvention(new ClosureCodingConvention());\n+    test(options,\n+        \"/** @const */\\n\" +\n+        \"var goog = goog || {};\\n\" +\n+        \"goog.addSingletonGetter = function(ctor) {\\n\" +\n+        \"  ctor.getInstance = function() {\\n\" +\n+        \"    return ctor.instance_ || (ctor.instance_ = new ctor());\\n\" +\n+        \"  };\\n\" +\n+        \"};\" +\n+        \"function Foo() {}\\n\" +\n+        \"goog.addSingletonGetter(Foo);\" +\n+        \"Foo.prototype.bar = 1;\" +\n+        \"function Bar() {}\\n\" +\n+        \"goog.addSingletonGetter(Bar);\" +\n+        \"Bar.prototype.bar = 1;\",\n+        \"\");\n+  }\n+\n   public void testIncompleteFunction() {\n     CompilerOptions options = createCompilerOptions();\n     options.ideMode = true;", "timestamp": 1330494980, "metainfo": ""}