{"sha": "7760221a3cc58f1e3b6c44fd682ead55aa91fff7", "log": "Tightens type checking of @struct's by disallowing \"if(a.bar)\" when the type of \"a\" is a struct and \"bar\" is not defined on it. ------------- Created by MOE: http://code.google.com/p/moe-java MOE_MIGRATED_REVID=44743873", "commit": "\n--- a/src/com/google/javascript/jscomp/TypeCheck.java\n+++ b/src/com/google/javascript/jscomp/TypeCheck.java\n   private void checkPropertyAccessHelper(JSType objectType, String propName,\n       NodeTraversal t, Node n) {\n     if (!objectType.isEmptyType() &&\n-        reportMissingProperties && !isPropertyTest(n)) {\n+        reportMissingProperties && (!isPropertyTest(n) || objectType.isStruct())) {\n       if (!typeRegistry.canPropertyBeDefined(objectType, propName)) {\n         report(t, n, INEXISTENT_PROPERTY, propName,\n             validator.getReadableJSTypeName(n.getFirstChild(), true));\n--- a/test/com/google/javascript/jscomp/TypeCheckTest.java\n+++ b/test/com/google/javascript/jscomp/TypeCheckTest.java\n \n   }\n \n+  public void testNonexistentPropertyAccessOnStruct() throws Exception {\n+    testTypes(\n+        \"/**\\n\" +\n+        \" * @constructor\\n\" +\n+        \" * @struct\\n\" +\n+        \" */\\n\" +\n+        \"var A = function() {};\\n\" +\n+        \"/** @param {A} a */\\n\" +\n+        \"function foo(a) {\\n\" +\n+        \"  if (a.bar) { a.bar(); }\\n\" +\n+        \"}\",\n+        \"Property bar never defined on A\");\n+  }\n+\n+  public void testNonexistentPropertyAccessOnStructOrObject() throws Exception {\n+    testTypes(\n+        \"/**\\n\" +\n+        \" * @constructor\\n\" +\n+        \" * @struct\\n\" +\n+        \" */\\n\" +\n+        \"var A = function() {};\\n\" +\n+        \"/** @param {A|Object} a */\\n\" +\n+        \"function foo(a) {\\n\" +\n+        \"  if (a.bar) { a.bar(); }\\n\" +\n+        \"}\");\n+  }\n+\n+  public void testNonexistentPropertyAccessOnExternStruct() throws Exception {\n+    testTypes(\n+        \"/**\\n\" +\n+        \" * @constructor\\n\" +\n+        \" * @struct\\n\" +\n+        \" */\\n\" +\n+        \"var A = function() {};\",\n+        \"/** @param {A} a */\\n\" +\n+        \"function foo(a) {\\n\" +\n+        \"  if (a.bar) { a.bar(); }\\n\" +\n+        \"}\",\n+        \"Property bar never defined on A\", false);\n+  }\n+\n   private void testTypes(String js) throws Exception {\n     testTypes(js, (String) null);\n   }", "timestamp": 1364947229, "metainfo": ""}