{"sha": "375e35882d3533f5af9a900d78682089900822ba", "log": "Preserve template keys when building derivative function types for .call, .apply, and .bind Also adds a TypeCheckTest for the issue this was fixing.  R=johnlenz DELTA=39  (37 added, 0 deleted, 2 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=5958   ", "commit": "\n--- a/src/com/google/javascript/rhino/jstype/FunctionType.java\n+++ b/src/com/google/javascript/rhino/jstype/FunctionType.java\n             new FunctionBuilder(registry)\n             .withParams(builder)\n             .withReturnType(getReturnType())\n+            .withTemplateKeys(getTemplateKeys())\n             .build(),\n             source);\n       }\n    */\n   public FunctionType getBindReturnType(int argsToBind) {\n     FunctionBuilder builder = new FunctionBuilder(registry)\n-        .withReturnType(getReturnType());\n+        .withReturnType(getReturnType())\n+        .withTemplateKeys(getTemplateKeys());\n     if (argsToBind >= 0) {\n       Node origParams = getParametersNode();\n       if (origParams != null) {\n   private FunctionType getCallOrBindSignature(boolean isCall) {\n     boolean isBind = !isCall;\n     FunctionBuilder builder = new FunctionBuilder(registry)\n-        .withReturnType(isCall ? getReturnType() : getBindReturnType(-1));\n+        .withReturnType(isCall ? getReturnType() : getBindReturnType(-1))\n+        .withTemplateKeys(getTemplateKeys());\n \n     Node origParams = getParametersNode();\n     if (origParams != null) {\n--- a/src/com/google/javascript/rhino/jstype/ModificationVisitor.java\n+++ b/src/com/google/javascript/rhino/jstype/ModificationVisitor.java\n     }\n \n     if (changed) {\n+      // TODO(johnlenz): should we support preserving template keys?\n       FunctionBuilder builder = new FunctionBuilder(registry);\n       builder.withParams(paramBuilder);\n       builder.withReturnType(afterReturn);\n--- a/test/com/google/javascript/jscomp/TypeCheckTest.java\n+++ b/test/com/google/javascript/jscomp/TypeCheckTest.java\n         \"required: Object\");\n   }\n \n+  public void testTemplateType5() throws Exception {\n+    testTypes(\n+        \"/**\" +\n+        \" * @param {Array.<T>} arr \\n\" +\n+        \" * @param {?function(T)} f \\n\" +\n+        \" * @return {T} \\n\" +\n+        \" * @template T\\n\" +\n+        \" */\\n\" +\n+        \"function fn(arr, f) { return arr[0]; }\\n\" +\n+        \"/** @param {Array.<number>} arr */ function g(arr) {\" +\n+        \"  /** @type {!Object} */ var x = fn.call(null, arr, null);\" +\n+        \"}\",\n+        \"initializing variable\\n\" +\n+        \"found   : number\\n\" +\n+        \"required: Object\");\n+  }\n+\n   public void disable_testBadTemplateType4() throws Exception {\n     // TODO(johnlenz): Add a check for useless of template types.\n     // Unless there are at least two references to a Template type in\n--- a/test/com/google/javascript/rhino/jstype/FunctionTypeTest.java\n+++ b/test/com/google/javascript/rhino/jstype/FunctionTypeTest.java\n     assertEquals(\n         \"function ((Date|null)=): boolean\",\n         fn.getPropertyType(\"call\").toString());\n+  }\n+\n+  public void testTemplatedFunctionDerivedFunctions() {\n+    FunctionType fn = new FunctionBuilder(registry)\n+      .withTypeOfThis(new TemplateType(registry, \"T\"))\n+      .withTemplateKeys(ImmutableList.of(\"T\"))\n+      .withReturnType(BOOLEAN_TYPE).build();\n+\n+    assertEquals(\"[T]\",\n+        fn.getPropertyType(\"call\").getTemplateKeys().toString());\n+    assertEquals(\"[T]\",\n+        fn.getPropertyType(\"apply\").getTemplateKeys().toString());\n+    assertEquals(\"[T]\",\n+        fn.getPropertyType(\"bind\").getTemplateKeys().toString());\n+    assertEquals(\"[T]\",\n+        fn.getBindReturnType(0).getTemplateKeys().toString());\n   }\n \n   public void testPrint() {", "timestamp": 1355240231, "metainfo": ""}