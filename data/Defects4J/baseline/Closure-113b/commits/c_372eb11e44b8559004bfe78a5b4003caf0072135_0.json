{"sha": "372eb11e44b8559004bfe78a5b4003caf0072135", "log": "don't bother with module exports if there's nothing to export Fixes issue 732  R=malteubl DELTA=35  (8 added, 18 deleted, 9 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=4830   ", "commit": "\n--- a/src/com/google/javascript/jscomp/ProcessCommonJSModules.java\n+++ b/src/com/google/javascript/jscomp/ProcessCommonJSModules.java\n package com.google.javascript.jscomp;\n \n import com.google.common.base.Preconditions;\n+import com.google.common.collect.Sets;\n import com.google.javascript.jscomp.NodeTraversal.AbstractPostOrderCallback;\n import com.google.javascript.rhino.IR;\n import com.google.javascript.rhino.Node;\n import java.io.File;\n import java.net.URI;\n import java.net.URISyntaxException;\n+import java.util.Set;\n import java.util.regex.Pattern;\n \n /**\n       AbstractPostOrderCallback {\n \n     private int scriptNodeCount = 0;\n+    private Set<String> modulesWithExports = Sets.newHashSet();\n \n     @Override\n     public void visit(NodeTraversal t, Node n, Node parent) {\n      */\n     private void emitOptionalModuleExportsOverride(Node script,\n         String moduleName) {\n+      if (!modulesWithExports.contains(moduleName)) {\n+        return;\n+      }\n+\n       Node moduleExportsProp = IR.getprop(IR.name(moduleName),\n           IR.string(\"module$exports\"));\n       script.addChildToBack(IR.ifNode(\n       Node exports = prop.getChildAtIndex(1);\n       exports.putProp(Node.ORIGINALNAME_PROP, \"exports\");\n       exports.setString(\"module$exports\");\n+      modulesWithExports.add(moduleName);\n     }\n \n     /**\n--- a/test/com/google/javascript/jscomp/CommandLineRunnerTest.java\n+++ b/test/com/google/javascript/jscomp/CommandLineRunnerTest.java\n     args.add(\"--common_js_entry_module=foo/bar\");\n     setFilename(0, \"foo/bar.js\");\n     test(\"exports.test = 1\",\n-        \"var module$foo$bar={test:1}; \" +\n-        \"module$foo$bar.module$exports && \" +\n-        \"(module$foo$bar=module$foo$bar.module$exports)\");\n+        \"var module$foo$bar={test:1};\");\n   }\n \n   public void testTransformAMDAndProcessCJS() {\n     args.add(\"--common_js_entry_module=foo/bar\");\n     setFilename(0, \"foo/bar.js\");\n     test(\"define({foo: 1})\",\n-        \"var module$foo$bar={}, module$foo$bar={foo:1}; \" +\n-        \"module$foo$bar.module$exports && \" +\n-        \"(module$foo$bar=module$foo$bar.module$exports)\");\n+        \"var module$foo$bar={}, module$foo$bar={foo:1};\");\n   }\n \n   /* Helper functions */\n--- a/test/com/google/javascript/jscomp/ProcessCommonJSModulesTest.java\n+++ b/test/com/google/javascript/jscomp/ProcessCommonJSModulesTest.java\n         \"var module$test = {};\" +\n         \"goog.require('module$name');\" +\n         \"var name$$module$test = module$name;\" +\n-        \"name$$module$test();\" +\n-        \"if(module$test.module$exports)\" +\n-        \"module$test=module$test.module$exports\");\n+        \"name$$module$test();\");\n     setFilename(\"test/sub\");\n     test(\n         \"var name = require('mod/name');\" +\n         \"var module$test$sub = {};\" +\n         \"goog.require('module$mod$name');\" +\n         \"var name$$module$test$sub = module$mod$name;\" +\n-        \"(function() { name$$module$test$sub(); })();\" +\n-        \"if(module$test$sub.module$exports)\" +\n-        \"module$test$sub=module$test$sub.module$exports\");\n+        \"(function() { name$$module$test$sub(); })();\");\n   }\n \n   public void testExports() {\n         \"var module$test = {};\" +\n         \"goog.require('module$name');\" +\n         \"var name$$module$test = module$name;\" +\n-        \"module$test.foo = 1;\" +\n-        \"if(module$test.module$exports)\" +\n-        \"module$test=module$test.module$exports\");\n+        \"module$test.foo = 1;\");\n     test(\n         \"var name = require('name');\" +\n         \"module.exports = function() {};\",\n         \"goog.provide('module$test');\" +\n         \"var module$test = {};\" +\n         \"var a$$module$test = 1, b$$module$test = 2;\" +\n-        \"(function() { var a; b$$module$test = 4})();\" +\n-        \"if(module$test.module$exports)\" +\n-        \"module$test=module$test.module$exports\");\n+        \"(function() { var a; b$$module$test = 4})();\");\n   }\n \n   public void testDash() {\n         \"var module$test_test = {};\" +\n         \"goog.require('module$name');\" +\n         \"var name$$module$test_test = module$name;\" +\n-        \"module$test_test.foo = 1;\" +\n-        \"if(module$test_test.module$exports)\" +\n-        \"module$test_test=module$test_test.module$exports\");\n+        \"module$test_test.foo = 1;\");\n   }\n \n   public void testModuleName() {\n         \"var name = require('name');\",\n         \"goog.provide('module$foo$bar'); var module$foo$bar = {};\" +\n         \"goog.require('module$name');\" +\n-        \"var name$$module$foo$bar = module$name;\" +\n-        \"if(module$foo$bar.module$exports)\" +\n-        \"module$foo$bar=module$foo$bar.module$exports\");\n+        \"var name$$module$foo$bar = module$name;\");\n     test(\n         \"var name = require('./name');\",\n         \"goog.provide('module$foo$bar');\" +\n         \"var module$foo$bar = {};\" +\n         \"goog.require('module$foo$name');\" +\n-        \"var name$$module$foo$bar = module$foo$name;\" +\n-        \"if(module$foo$bar.module$exports)\" +\n-        \"module$foo$bar=module$foo$bar.module$exports\");\n+        \"var name$$module$foo$bar = module$foo$name;\");\n \n   }\n ", "timestamp": 1337385472, "metainfo": ""}