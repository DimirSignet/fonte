{"sha": "9bdacbfb9631d3a3710a64f35482c643b78a2e79", "log": "COMPRESS-191 ArchiveStreamFactory false positive for tar format.  Submitted by Jukka Zitting  ", "commit": "\n--- a/src/main/java/org/apache/commons/compress/archivers/ArchiveStreamFactory.java\n+++ b/src/main/java/org/apache/commons/compress/archivers/ArchiveStreamFactory.java\n             if (signatureLength >= 512) {\n                 try {\n                     TarArchiveInputStream tais = new TarArchiveInputStream(new ByteArrayInputStream(tarheader));\n-                    tais.getNextEntry();\n-                    return new TarArchiveInputStream(in);\n+                    // COMPRESS-191 - verify the header checksum\n+                    if (tais.getNextTarEntry().isCheckSumOK()) {\n+                        return new TarArchiveInputStream(in);\n+                    }\n                 } catch (Exception e) { // NOPMD\n                     // can generate IllegalArgumentException as well\n                     // as IOException\n--- a/src/test/java/org/apache/commons/compress/archivers/ArchiveStreamFactoryTest.java\n+++ b/src/test/java/org/apache/commons/compress/archivers/ArchiveStreamFactoryTest.java\n import static org.junit.Assert.assertTrue;\n import static org.junit.Assert.fail;\n \n+import java.io.BufferedInputStream;\n import java.io.ByteArrayInputStream;\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n \n import org.junit.Test;\n \n         }\n     }\n \n-}\n+    /**\n+     * see https://issues.apache.org/jira/browse/COMPRESS-191\n+     */\n+    @Test\n+    public void aiffFilesAreNoTARs() throws Exception {\n+        InputStream is = null;\n+        try {\n+            is = new BufferedInputStream(new FileInputStream(\"src/test/resources/testAIFF.aif\"));\n+            new ArchiveStreamFactory().createArchiveInputStream(is);\n+            fail(\"created an input stream for a non-archive\");\n+        } catch (ArchiveException ae) {\n+            assertTrue(ae.getMessage().startsWith(\"No Archiver found\"));\n+        } finally {\n+            if (is != null) {\n+                is.close();\n+            }\n+        }\n+    }\n+\n+}", "timestamp": 1341639040, "metainfo": ""}