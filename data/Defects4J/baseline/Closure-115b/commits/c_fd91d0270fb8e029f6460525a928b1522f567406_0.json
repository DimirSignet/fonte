{"sha": "fd91d0270fb8e029f6460525a928b1522f567406", "log": "Correct the reference for \"this\" in jQuery.extend expansions  R=nicksantos", "commit": "\n--- a/src/com/google/javascript/jscomp/ExpandJqueryAliases.java\n+++ b/src/com/google/javascript/jscomp/ExpandJqueryAliases.java\n \n     Node fn = n.getLastChild();\n     if (fn != null) {\n-      n.replaceChild(fn, IR.string(\"prototype\"));\n+      n.replaceChild(fn, IR.string(\"prototype\").srcref(fn));\n       compiler.reportCodeChange();\n     }\n   }\n \n       Node fnc = IR.function(IR.name(\"\").srcref(n),\n           IR.paramList().srcref(n),\n-          fncBlock);\n-      n.replaceChild(callTarget, fnc);\n-      n.putBooleanProp(Node.FREE_CALL, true);\n+          fncBlock).srcref(n);\n+\n+      // add an explicit \"call\" statement so that we can maintain\n+      // the same reference for \"this\"\n+      Node newCallTarget = IR.getprop(\n+          fnc, IR.string(\"call\").srcref(n)).srcref(n);\n+      n.replaceChild(callTarget, newCallTarget);\n+      n.putBooleanProp(Node.FREE_CALL, false);\n \n       // remove any other pre-existing call arguments\n-      while(fnc.getNext() != null) {\n-        n.removeChildAfter(fnc);\n-      }\n+      while(newCallTarget.getNext() != null) {\n+        n.removeChildAfter(newCallTarget);\n+      }\n+      n.addChildToBack(IR.thisNode().srcref(n));\n     }\n     compiler.reportCodeChange();\n   }\n--- a/test/com/google/javascript/jscomp/ExpandJqueryAliasesTest.java\n+++ b/test/com/google/javascript/jscomp/ExpandJqueryAliasesTest.java\n     // Test extend call where first argument includes a method call\n     testSame(setupCode+\"obj2.meth=function() { return { a:{} }; };\" +\n         \"jQuery.extend(obj2.meth().a, {a: 'test'});\");\n+\n+    // Test extend call where returned object is used\n+    test(setupCode + \"obj2 = jQuery.extend(obj2, {a:'test', \" +\n+        \"b:'test2'});\",\n+        setupCode + \"obj2 = function() {obj2 = obj2 || {}; \" + \n+        \"obj2.a = 'test';obj2.b = 'test2';return obj2;}.call(this);\");\n   }\n \n   public void testJqueryExpandedEachExpansion() {", "timestamp": 1362999049, "metainfo": ""}