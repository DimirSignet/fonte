{"sha": "251c596a9aa846d8b1e657dfa51417a74c706f7e", "log": "The was being too aggressive about trying to preserve \"this\" for method calls and should a this point never try to do so.  R=acleung DELTA=99  (82 added, 2 deleted, 15 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=2453   ", "commit": "\n--- a/src/com/google/javascript/jscomp/ExpressionDecomposer.java\n+++ b/src/com/google/javascript/jscomp/ExpressionDecomposer.java\n     state.extractBeforeStatement = exprInjectionPoint;\n \n     // Extract expressions in the reverse order of their evaluation.\n-    for (Node child = nonconditionalExpr, parent = child.getParent();\n+    for (Node grandchild = null,\n+            child = nonconditionalExpr,\n+            parent = child.getParent();\n          parent != expressionRoot;\n-         child = parent, parent = child.getParent()) {\n+         grandchild = child,\n+             child = parent,\n+             parent = child.getParent()) {\n       int parentType = parent.getType();\n       Preconditions.checkState(\n           !isConditionalOp(parent) || child == parent.getFirstChild());\n           }\n       } else if (parentType == Token.CALL\n           && NodeUtil.isGet(parent.getFirstChild())) {\n-        // TODO(johnlenz): In Internet Explorer, non-javascript objects such\n-        // as DOM objects can not be decomposed.\n-        if (!maybeExternMethod(parent.getFirstChild())) {\n-          throw new IllegalStateException(\n-              \"External object method calls can not be decomposed.\");\n-        } else {\n-          Node functionExpression = parent.getFirstChild();\n-          decomposeSubExpressions(\n-              functionExpression.getNext(), child, state);\n-          // Now handle the call expression\n-          if (isExpressionTreeUnsafe(functionExpression, state.sideEffects)) {\n+        Node functionExpression = parent.getFirstChild();\n+        decomposeSubExpressions(functionExpression.getNext(), child, state);\n+        // Now handle the call expression\n+        if (isExpressionTreeUnsafe(functionExpression, state.sideEffects)\n+            && functionExpression.getFirstChild() != grandchild) {\n+          // TODO(johnlenz): In Internet Explorer, non-javascript objects such\n+          // as DOM objects can not be decomposed.\n+          if (true) {\n+            throw new IllegalStateException(\n+                \"Object method calls can not be decomposed.\");\n+          } else {\n             // Either there were preexisting side-effects, or this node has\n             // side-effects.\n             state.sideEffects = true;\n           }\n         }\n       } else if (parentType == Token.OBJECTLIT) {\n-        decomposeObjectLiteralKeys(\n-            parent.getFirstChild(), child, state);\n+        decomposeObjectLiteralKeys(parent.getFirstChild(), child, state);\n       } else {\n-        decomposeSubExpressions(\n-            parent.getFirstChild(), child, state);\n+        decomposeSubExpressions(parent.getFirstChild(), child, state);\n       }\n     }\n \n--- a/test/com/google/javascript/jscomp/ExpressionDecomposerTest.java\n+++ b/test/com/google/javascript/jscomp/ExpressionDecomposerTest.java\n                 \"return ret\\n\" +\n             \"}()\\n\" +\n         \");\", 2);\n+  }\n+\n+  public void testCanExposeExpression8() {\n+    // Can it be decompose?\n+    helperCanExposeExpression(\n+        DecompositionType.DECOMPOSABLE,\n+        \"HangoutStarter.prototype.launchHangout = function() {\\n\" +\n+        \"  var self = a.b;\\n\" +\n+        \"  var myUrl = new goog.Uri(getDomServices_(self).getDomHelper().\" +\n+        \"getWindow().location.href);\\n\" +\n+        \"};\",\n+        \"getDomServices_\");\n+\n+    // Verify it is properly expose the target expression.\n+    helperExposeExpression(\n+        \"HangoutStarter.prototype.launchHangout = function() {\\n\" +\n+        \"  var self = a.b;\\n\" +\n+        \"  var myUrl = new goog.Uri(getDomServices_(self).getDomHelper().\" +\n+        \"getWindow().location.href);\\n\" +\n+        \"};\",\n+        \"getDomServices_\",\n+        \"HangoutStarter.prototype.launchHangout = function() {\" +\n+        \"  var self = a.b;\" +\n+        \"  var temp_const$$0 = goog.Uri;\" +\n+        \"  var myUrl = new temp_const$$0(getDomServices_(self).\" +\n+        \"      getDomHelper().getWindow().location.href)}\");\n+\n+    // Verify the results can be properly moved.\n+    helperMoveExpression(\n+        \"HangoutStarter.prototype.launchHangout = function() {\" +\n+        \"  var self = a.b;\" +\n+        \"  var temp_const$$0 = goog.Uri;\" +\n+        \"  var myUrl = new temp_const$$0(getDomServices_(self).\" +\n+        \"      getDomHelper().getWindow().location.href)}\",\n+        \"getDomServices_\",\n+        \"HangoutStarter.prototype.launchHangout = function() {\" +\n+        \"  var self=a.b;\" +\n+        \"  var temp_const$$0=goog.Uri;\" +\n+        \"  var temp$$0=getDomServices_(self);\" +\n+        \"  var myUrl=new temp_const$$0(temp$$0.getDomHelper().\" +\n+        \"      getWindow().location.href)}\");\n   }\n \n   public void testMoveExpression1() {\n--- a/test/com/google/javascript/jscomp/InlineFunctionsTest.java\n+++ b/test/com/google/javascript/jscomp/InlineFunctionsTest.java\n     }\n   }\n \n+  public void testBug4944818() {\n+    test(\n+        \"var getDomServices_ = function(self) {\\n\" +\n+        \"  if (!self.domServices_) {\\n\" +\n+        \"    self.domServices_ = goog$component$DomServices.get(\" +\n+        \"        self.appContext_);\\n\" +\n+        \"  }\\n\" +\n+        \"\\n\" +\n+        \"  return self.domServices_;\\n\" +\n+        \"};\\n\" +\n+        \"\\n\" +\n+        \"var getOwnerWin_ = function(self) {\\n\" +\n+        \"  return getDomServices_(self).getDomHelper().getWindow();\\n\" +\n+        \"};\\n\" +\n+        \"\\n\" +\n+        \"HangoutStarter.prototype.launchHangout = function() {\\n\" +\n+        \"  var self = a.b;\\n\" +\n+        \"  var myUrl = new goog.Uri(getOwnerWin_(self).location.href);\\n\" +\n+        \"};\",\n+        \"HangoutStarter.prototype.launchHangout = function() { \" +\n+        \"  var self$$2 = a.b;\" +\n+        \"  var JSCompiler_temp_const$$0 = goog.Uri;\" +\n+        \"  {\" +\n+        \"  var JSCompiler_inline_result$$1;\" +\n+        \"  var self$$inline_3 = self$$2;\" +\n+        \"  if (!self$$inline_3.domServices_) {\" +\n+        \"    self$$inline_3.domServices_ = goog$component$DomServices.get(\" +\n+        \"        self$$inline_3.appContext_);\" +\n+        \"  }\" +\n+        \"  JSCompiler_inline_result$$1=self$$inline_3.domServices_;\" +\n+        \"  }\" +\n+        \"  var myUrl = new JSCompiler_temp_const$$0(\" +\n+        \"      JSCompiler_inline_result$$1.getDomHelper().\" +\n+        \"          getWindow().location.href)\" +\n+        \"}\");\n+  }\n+\n   public void testIssue423() {\n     test(\n         \"(function($) {\\n\" +", "timestamp": 1309371617, "metainfo": ""}