{"sha": "3475dc846d78e56422b3e6fdf36dfd4416f359f5", "log": "Maintain stack for namespaces  Fixes #977", "commit": "\n--- a/src/main/java/org/jsoup/helper/W3CDom.java\n+++ b/src/main/java/org/jsoup/helper/W3CDom.java\n import javax.xml.transform.stream.StreamResult;\n import java.io.StringWriter;\n import java.util.HashMap;\n+import java.util.Stack;\n \n /**\n  * Helper class to transform a {@link org.jsoup.nodes.Document} to a {@link org.w3c.dom.Document org.w3c.dom.Document},\n         private static final String xmlnsPrefix = \"xmlns:\";\n \n         private final Document doc;\n-        private final HashMap<String, String> namespaces = new HashMap<>(); // prefix => urn\n+        private final Stack<HashMap<String, String>> namespacesStack = new Stack<>(); // stack of namespaces, prefix => urn\n         private Element dest;\n \n         public W3CBuilder(Document doc) {\n             this.doc = doc;\n+            this.namespacesStack.push(new HashMap<String, String>());\n         }\n \n         public void head(org.jsoup.nodes.Node source, int depth) {\n+            namespacesStack.push(new HashMap<>(namespacesStack.peek())); // inherit from above on the stack\n             if (source instanceof org.jsoup.nodes.Element) {\n                 org.jsoup.nodes.Element sourceEl = (org.jsoup.nodes.Element) source;\n \n                 String prefix = updateNamespaces(sourceEl);\n-                String namespace = namespaces.get(prefix);\n+                String namespace = namespacesStack.peek().get(prefix);\n \n                 Element el = doc.createElementNS(namespace, sourceEl.tagName());\n                 copyAttributes(sourceEl, el);\n             if (source instanceof org.jsoup.nodes.Element && dest.getParentNode() instanceof Element) {\n                 dest = (Element) dest.getParentNode(); // undescend. cromulent.\n             }\n+            namespacesStack.pop();\n         }\n \n         private void copyAttributes(org.jsoup.nodes.Node source, Element el) {\n                 } else {\n                     continue;\n                 }\n-                namespaces.put(prefix, attr.getValue());\n+                namespacesStack.peek().put(prefix, attr.getValue());\n             }\n \n             // get the element prefix if any\n--- a/src/test/java/org/jsoup/helper/W3CDomTest.java\n+++ b/src/test/java/org/jsoup/helper/W3CDomTest.java\n         assertEquals(\"html\", htmlEl.getLocalName());\n         assertEquals(\"html\", htmlEl.getNodeName());\n \n+        // inherits default namespace\n+        Node head = htmlEl.getFirstChild();\n+        assertEquals(\"http://www.w3.org/1999/xhtml\", head.getNamespaceURI());\n+        assertEquals(\"head\", head.getLocalName());\n+        assertEquals(\"head\", head.getNodeName());\n+\n         Node epubTitle = htmlEl.getChildNodes().item(2).getChildNodes().item(3);\n+        assertEquals(\"Check\", epubTitle.getTextContent());\n         assertEquals(\"http://www.idpf.org/2007/ops\", epubTitle.getNamespaceURI());\n         assertEquals(\"title\", epubTitle.getLocalName());\n         assertEquals(\"epub:title\", epubTitle.getNodeName());\n         assertEquals(\"urn:test\", xSection.getNamespaceURI());\n         assertEquals(\"section\", xSection.getLocalName());\n         assertEquals(\"x:section\", xSection.getNodeName());\n+\n+        // https://github.com/jhy/jsoup/issues/977\n+        // does not keep last set namespace\n+        Node svg = xSection.getNextSibling().getNextSibling();\n+        assertEquals(\"http://www.w3.org/2000/svg\", svg.getNamespaceURI());\n+        assertEquals(\"svg\", svg.getLocalName());\n+        assertEquals(\"svg\", svg.getNodeName());\n+\n+        Node path = svg.getChildNodes().item(1);\n+        assertEquals(\"http://www.w3.org/2000/svg\", path.getNamespaceURI());\n+        assertEquals(\"path\", path.getLocalName());\n+        assertEquals(\"path\", path.getNodeName());\n+\n+        Node clip = path.getChildNodes().item(1);\n+        assertEquals(\"http://example.com/clip\", clip.getNamespaceURI());\n+        assertEquals(\"clip\", clip.getLocalName());\n+        assertEquals(\"clip\", clip.getNodeName());\n+        assertEquals(\"456\", clip.getTextContent());\n+\n+        Node picture = svg.getNextSibling().getNextSibling();\n+        assertEquals(\"http://www.w3.org/1999/xhtml\", picture.getNamespaceURI());\n+        assertEquals(\"picture\", picture.getLocalName());\n+        assertEquals(\"picture\", picture.getNodeName());\n+\n+        Node img = picture.getFirstChild();\n+        assertEquals(\"http://www.w3.org/1999/xhtml\", img.getNamespaceURI());\n+        assertEquals(\"img\", img.getLocalName());\n+        assertEquals(\"img\", img.getNodeName());\n+\n     }\n \n     @Test", "timestamp": 1511038372, "metainfo": ""}