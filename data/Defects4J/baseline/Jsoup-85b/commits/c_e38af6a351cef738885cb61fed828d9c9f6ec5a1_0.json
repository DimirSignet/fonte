{"sha": "e38af6a351cef738885cb61fed828d9c9f6ec5a1", "log": "Threadlocal encoder  Fixes #970", "commit": "\n--- a/src/main/java/org/jsoup/nodes/Document.java\n+++ b/src/main/java/org/jsoup/nodes/Document.java\n \n         private Entities.EscapeMode escapeMode = Entities.EscapeMode.base;\n         private Charset charset;\n-        CharsetEncoder encoder; // initialized by start of OuterHtmlVisitor and cleared at end\n+        private ThreadLocal<CharsetEncoder> encoderThreadLocal = new ThreadLocal<>();\n+        //CharsetEncoder encoder; // initialized by start of OuterHtmlVisitor and cleared at end\n         Entities.CoreCharset coreCharset; // fast encoders for ascii and utf8\n \n         private boolean prettyPrint = true;\n         }\n \n         CharsetEncoder prepareEncoder() {\n-            encoder = charset.newEncoder(); // created at start of OuterHtmlVisitor so each pass has own encoder, so OutputSettings can be shared among threads\n+            //encoder = charset.newEncoder(); // created at start of OuterHtmlVisitor so each pass has own encoder, so OutputSettings can be shared among threads\n+            CharsetEncoder encoder = charset.newEncoder();\n+            encoderThreadLocal.set(encoder);\n             coreCharset = Entities.CoreCharset.byName(encoder.charset().name());\n             return encoder;\n+        }\n+\n+        CharsetEncoder encoder() {\n+            CharsetEncoder encoder = encoderThreadLocal.get();\n+            return encoder != null ? encoder : prepareEncoder();\n         }\n \n         /**\n--- a/src/main/java/org/jsoup/nodes/Entities.java\n+++ b/src/main/java/org/jsoup/nodes/Entities.java\n         boolean lastWasWhite = false;\n         boolean reachedNonWhite = false;\n         final EscapeMode escapeMode = out.escapeMode();\n-        final CharsetEncoder encoder = out.encoder != null ? out.encoder : out.prepareEncoder();\n+        final CharsetEncoder encoder = out.encoder();\n         final CoreCharset coreCharset = out.coreCharset; // init in out.prepareEncoder()\n         final int length = string.length();\n ", "timestamp": 1510724318, "metainfo": ""}