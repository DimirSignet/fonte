{"sha": "4b5575897834707871a359b3b7183c856dd301a8", "log": "Combine nested IF-ELSE.  R=zhuyi DELTA=35  (34 added, 0 deleted, 1 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=431   ", "commit": "\n--- a/src/com/google/javascript/jscomp/PeepholeSubstituteAlternateSyntax.java\n+++ b/src/com/google/javascript/jscomp/PeepholeSubstituteAlternateSyntax.java\n         reportCodeChange();\n \n         return newExpr;\n+      } else {\n+\n+        // Try to combine two IF-ELSE\n+        if (NodeUtil.isStatementBlock(thenBranch) &&\n+            thenBranch.hasOneChild()) {\n+          Node innerIf = thenBranch.getFirstChild();\n+\n+          if (innerIf.getType() == Token.IF) {\n+            Node innerCond = innerIf.getFirstChild();\n+            Node innerThenBranch = innerCond.getNext();\n+            Node innerElseBranch = innerThenBranch.getNext();\n+\n+            if (innerElseBranch == null &&\n+                 !(isLowerPrecedenceInExpression(cond, AND_PRECEDENCE) &&\n+                   isLowerPrecedenceInExpression(innerCond, AND_PRECEDENCE))) {\n+              n.detachChildren();\n+              n.addChildToBack(new Node(Token.AND, cond,\n+                  innerCond.detachFromParent()).copyInformationFrom(cond));\n+              n.addChildrenToBack(innerThenBranch.detachFromParent());\n+              reportCodeChange();\n+              // Not worth trying to fold the current IF-ELSE into && because\n+              // the inner IF-ELSE wasn't able to be folded into && anyways.\n+              return n;\n+            }\n+          }\n+        }\n       }\n \n       return n;\n--- a/test/com/google/javascript/jscomp/PeepholeSubstituteAlternateSyntaxTest.java\n+++ b/test/com/google/javascript/jscomp/PeepholeSubstituteAlternateSyntaxTest.java\n     fold(\"if(e1){with(e2){if(e3){foo()}}}else{bar()}\",\n          \"if(e1)with(e2)e3&&foo();else bar()\");\n \n-    fold(\"if(x){if(y){var x;}}\", \"if(x)if(y)var x\");\n+    fold(\"if(a||b){if(c||d){var x;}}\", \"if(a||b)if(c||d)var x\");\n     fold(\"if(x){ if(y){var x;}else{var z;} }\",\n          \"if(x)if(y)var x;else var z\");\n \n          \"function f() { switch(a){ case 1: break; case 2: } throw a; }\");\n   }\n \n+  public void testNestedIfCombine() {\n+    fold(\"if(x)if(y){while(1){}}\", \"if(x&&y){while(1){}}\");\n+    fold(\"if(x||z)if(y){while(1){}}\", \"if((x||z)&&y){while(1){}}\");\n+    fold(\"if(x)if(y||z){while(1){}}\", \"if((x)&&(y||z)){while(1){}}\");\n+    foldSame(\"if(x||z)if(y||z){while(1){}}\");\n+    fold(\"if(x)if(y){if(z){while(1){}}}\", \"if(x&&y&&z){while(1){}}\");\n+  }\n+\n   public void testIssue291() {\n     fold(\"if (true) { f.onchange(); }\", \"if (1) f.onchange();\");\n     foldSame(\"if (f) { f.onchange(); }\");", "timestamp": 1296857868, "metainfo": ""}