{"sha": "12f896a8129892d1921c630bfa049b843e53d02e", "log": "get rid of Deflater#getBytesWritten by self-counting  ", "commit": "\n--- a/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveOutputStream.java\n+++ b/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveOutputStream.java\n             throw new IOException(\"No current entry to close\");\n         }\n \n-        long realCrc = crc.getValue();\n-        crc.reset();\n-\n         if (entry.entry.getMethod() == DEFLATED) {\n             def.finish();\n             while (!def.finished()) {\n                 deflate();\n             }\n-\n+        }\n+\n+        long bytesWritten = written - entry.dataStart;\n+        long realCrc = crc.getValue();\n+        crc.reset();\n+\n+        if (entry.entry.getMethod() == DEFLATED) {\n             /* It turns out def.getBytesRead() returns wrong values if\n-             * the size exceeds 4 GB - no idea whether one can trust\n-             * def.getBytesWritten()\n+             * the size exceeds 4 GB on Java < Java7\n             entry.entry.setSize(def.getBytesRead());\n             */\n             entry.entry.setSize(entry.bytesRead);\n-            entry.entry.setCompressedSize(def.getBytesWritten());\n+            entry.entry.setCompressedSize(bytesWritten);\n             entry.entry.setCrc(realCrc);\n \n             def.reset();\n-\n-            written += entry.entry.getCompressedSize();\n         } else if (raf == null) {\n             if (entry.entry.getCrc() != realCrc) {\n                 throw new ZipException(\"bad CRC checksum for entry \"\n                                        + Long.toHexString(realCrc));\n             }\n \n-            if (entry.entry.getSize() != written - entry.dataStart) {\n+            if (entry.entry.getSize() != bytesWritten) {\n                 throw new ZipException(\"bad size for entry \"\n                                        + entry.entry.getName() + \": \"\n                                        + entry.entry.getSize()\n                                        + \" instead of \"\n-                                       + (written - entry.dataStart));\n+                                       + bytesWritten);\n             }\n         } else { /* method is STORED and we used RandomAccessFile */\n-            long size = written - entry.dataStart;\n-\n-            entry.entry.setSize(size);\n-            entry.entry.setCompressedSize(size);\n+            entry.entry.setSize(bytesWritten);\n+            entry.entry.setCompressedSize(bytesWritten);\n             entry.entry.setCrc(realCrc);\n         }\n \n         int len = def.deflate(buf, 0, buf.length);\n         if (len > 0) {\n             writeOut(buf, 0, len);\n+            written += len;\n         }\n     }\n ", "timestamp": 1312373163, "metainfo": ""}