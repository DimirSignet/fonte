{"sha": "e124cb4ae76a634b66a5df0afc03ede5a63ec17c", "log": "Allow easy changing of archive type Change most tests to cpio, because ZipArchiveInputStream fails to set the entry size  ", "commit": "\n--- a/src/test/java/org/apache/commons/compress/changes/ChangeSetTestCase.java\n+++ b/src/test/java/org/apache/commons/compress/changes/ChangeSetTestCase.java\n import org.apache.commons.compress.archivers.ArchiveEntry;\n import org.apache.commons.compress.archivers.ArchiveInputStream;\n import org.apache.commons.compress.archivers.ArchiveOutputStream;\n-import org.apache.commons.compress.archivers.ArchiveStreamFactory;\n import org.apache.commons.compress.archivers.ar.ArArchiveEntry;\n import org.apache.commons.compress.archivers.jar.JarArchiveEntry;\n import org.apache.commons.compress.archivers.tar.TarArchiveEntry;\n  */\n public final class ChangeSetTestCase extends AbstractTestCase {\n     \n-    private ArchiveStreamFactory factory = new ArchiveStreamFactory();\n-\n     private void archiveListDelete(String prefix){\n         Iterator it = archiveList.iterator();\n         while(it.hasNext()){\n     }\n \n     /**\n-     * Tries to delete the folder \"bla\" from a zip file. This should result in\n+     * Tries to delete the folder \"bla\" from an archive file. This should result in\n      * the deletion of bla/*, which actually means bla/test4.xml should be\n-     * removed from this zipfile. The file something/bla (without ending, named\n+     * removed from the archive. The file something/bla (without ending, named\n      * like the folder) should not be deleted.\n      * \n      * @throws Exception\n      */\n     public void testDeleteDir() throws Exception {\n-        File input = this.createArchive(\"zip\");\n-\n-        ArchiveOutputStream out = null;\n-        ArchiveInputStream ais = null;\n-        File result = File.createTempFile(\"test\", \".zip\");\n-        result.deleteOnExit();\n-        try {\n-\n-            final InputStream is = new FileInputStream(input);\n-            ais = factory.createArchiveInputStream(\"zip\", is);\n-\n-            out = factory.createArchiveOutputStream(\"zip\",\n+        final String archivename = \"cpio\";\n+        File input = this.createArchive(archivename);\n+\n+        ArchiveOutputStream out = null;\n+        ArchiveInputStream ais = null;\n+        File result = File.createTempFile(\"test\", \".\"+archivename);\n+        result.deleteOnExit();\n+        try {\n+\n+            final InputStream is = new FileInputStream(input);\n+            ais = factory.createArchiveInputStream(archivename, is);\n+\n+            out = factory.createArchiveOutputStream(archivename,\n                     new FileOutputStream(result));\n \n             ChangeSet changes = new ChangeSet();\n     }\n \n     /**\n-     * Tries to delete the file \"bla/test5.xml\" from a zip file. This should\n+     * Tries to delete the file \"bla/test5.xml\" from an archive. This should\n      * result in the deletion of \"bla/test5.xml\".\n      * \n      * @throws Exception\n      */\n     public void testDeleteFile() throws Exception {\n-        File input = this.createArchive(\"zip\");\n-\n-        ArchiveOutputStream out = null;\n-        ArchiveInputStream ais = null;\n-        File result = File.createTempFile(\"test\", \".zip\");\n-        result.deleteOnExit();\n-        try {\n-\n-            final InputStream is = new FileInputStream(input);\n-            ais = factory.createArchiveInputStream(\"zip\", is);\n-\n-            out = factory.createArchiveOutputStream(\"zip\",\n+        final String archivename = \"cpio\";\n+        File input = this.createArchive(archivename);\n+\n+        ArchiveOutputStream out = null;\n+        ArchiveInputStream ais = null;\n+        File result = File.createTempFile(\"test\", \".\"+archivename);\n+        result.deleteOnExit();\n+        try {\n+\n+            final InputStream is = new FileInputStream(input);\n+            ais = factory.createArchiveInputStream(archivename, is);\n+\n+            out = factory.createArchiveOutputStream(archivename,\n                     new FileOutputStream(result));\n \n             ChangeSet changes = new ChangeSet();\n      * @throws Exception\n      */\n     public void testDeletePlusAdd() throws Exception {\n-        File input = this.createArchive(\"zip\");\n-\n-        ArchiveOutputStream out = null;\n-        ArchiveInputStream ais = null;\n-        File result = File.createTempFile(\"test\", \".zip\");\n-        result.deleteOnExit();\n-        try {\n-\n-            final InputStream is = new FileInputStream(input);\n-            ais = factory.createArchiveInputStream(\"zip\", is);\n-            out = factory.createArchiveOutputStream(\"zip\",\n+        final String archivename = \"cpio\";\n+        File input = this.createArchive(archivename);\n+\n+        ArchiveOutputStream out = null;\n+        ArchiveInputStream ais = null;\n+        File result = File.createTempFile(\"test\", \".\"+archivename);\n+        result.deleteOnExit();\n+        try {\n+\n+            final InputStream is = new FileInputStream(input);\n+            ais = factory.createArchiveInputStream(archivename, is);\n+            out = factory.createArchiveOutputStream(archivename,\n                     new FileOutputStream(result));\n \n             ChangeSet changes = new ChangeSet();\n \n             // Add a file\n             final File file1 = getFile(\"test.txt\");\n-            ArchiveEntry entry = new ZipArchiveEntry(\"bla/test.txt\");\n+            ArchiveEntry entry = out.createArchiveEntry(file1, \"bla/test.txt\");\n             changes.add(entry, new FileInputStream(file1));\n             archiveList.add(\"bla/test.txt\");\n \n      * @throws Exception\n      */\n     public void testDeleteFromAndAddToZip() throws Exception {\n-        File input = this.createArchive(\"zip\");\n-\n-        ArchiveOutputStream out = null;\n-        ArchiveInputStream ais = null;\n-        File result = File.createTempFile(\"test\", \".zip\");\n-        result.deleteOnExit();\n-        try {\n-\n-            final InputStream is = new FileInputStream(input);\n-            ais = factory.createArchiveInputStream(\"zip\", is);\n-            out = factory.createArchiveOutputStream(\"zip\",\n+        final String archivename = \"zip\";\n+        File input = this.createArchive(archivename);\n+\n+        ArchiveOutputStream out = null;\n+        ArchiveInputStream ais = null;\n+        File result = File.createTempFile(\"test\", \".\"+archivename);\n+        result.deleteOnExit();\n+        try {\n+\n+            final InputStream is = new FileInputStream(input);\n+            ais = factory.createArchiveInputStream(archivename, is);\n+            out = factory.createArchiveOutputStream(archivename,\n                     new FileOutputStream(result));\n \n             ChangeSet changes = new ChangeSet();\n \n     /**\n      * add blub/test.txt + delete blub Should add blub/test.txt and delete it\n-     * afterwards. In this example, the zip archive should stay untouched.\n+     * afterwards. In this example, the archive should stay untouched.\n      * \n      * @throws Exception\n      */\n     public void testAddDeleteAdd() throws Exception {\n-        File input = this.createArchive(\"zip\");\n-\n-        ArchiveOutputStream out = null;\n-        ArchiveInputStream ais = null;\n-        File result = File.createTempFile(\"test\", \".zip\");\n-        result.deleteOnExit();\n-        try {\n-\n-            final InputStream is = new FileInputStream(input);\n-            ais = factory.createArchiveInputStream(\"zip\", is);\n-            out = factory.createArchiveOutputStream(\"zip\",\n+        final String archivename = \"cpio\";\n+        File input = this.createArchive(archivename);\n+\n+        ArchiveOutputStream out = null;\n+        ArchiveInputStream ais = null;\n+        File result = File.createTempFile(\"test\", \".\"+archivename);\n+        result.deleteOnExit();\n+        try {\n+\n+            final InputStream is = new FileInputStream(input);\n+            ais = factory.createArchiveInputStream(archivename, is);\n+            out = factory.createArchiveOutputStream(archivename,\n                     new FileOutputStream(result));\n \n             ChangeSet changes = new ChangeSet();\n \n     /**\n      * delete bla + add bla/test.txt + delete bla Deletes dir1/* first, then\n-     * surpresses the add of bla.txt cause there is a delete operation later.\n+     * suppresses the add of bla.txt because there is a delete operation later.\n      * \n      * @throws Exception\n      */\n     public void testDeleteAddDelete() throws Exception {\n-        File input = this.createArchive(\"zip\");\n-\n-        ArchiveOutputStream out = null;\n-        ArchiveInputStream ais = null;\n-        File result = File.createTempFile(\"test\", \".zip\");\n-        result.deleteOnExit();\n-        try {\n-\n-            final InputStream is = new FileInputStream(input);\n-            ais = factory.createArchiveInputStream(\"zip\", is);\n-            out = factory.createArchiveOutputStream(\"zip\",\n+        final String archivename = \"cpio\";\n+        File input = this.createArchive(archivename);\n+\n+        ArchiveOutputStream out = null;\n+        ArchiveInputStream ais = null;\n+        File result = File.createTempFile(\"test\", \".\"+archivename);\n+        result.deleteOnExit();\n+        try {\n+\n+            final InputStream is = new FileInputStream(input);\n+            ais = factory.createArchiveInputStream(archivename, is);\n+            out = factory.createArchiveOutputStream(archivename,\n                     new FileOutputStream(result));\n \n             ChangeSet changes = new ChangeSet();\n      * @throws Exception\n      */\n     public void testAddToEmptyArchive() throws Exception {\n-        File input = this.createEmptyArchive(\"zip\");\n+        final String archivename = \"zip\";\n+        File input = this.createEmptyArchive(archivename);\n \n         ArchiveOutputStream out = null;\n         ArchiveInputStream ais = null;\n         InputStream is = null;\n-        File result = File.createTempFile(\"test\", \".zip\");\n+        File result = File.createTempFile(\"test\", \".\"+archivename);\n         result.deleteOnExit();\n         ChangeSet changes = new ChangeSet();\n         try {\n \n             is = new FileInputStream(input);\n-            ais = factory.createArchiveInputStream(\"zip\", is);\n-\n-            out = factory.createArchiveOutputStream(\"zip\",\n+            ais = factory.createArchiveInputStream(archivename, is);\n+\n+            out = factory.createArchiveOutputStream(archivename,\n                     new FileOutputStream(result));\n \n             final File file1 = getFile(\"test.txt\");\n      * @throws Exception\n      */\n     public void testDeleteAddToOneFileArchive() throws Exception {\n-        File input = this.createSingleEntryArchive(\"zip\");\n+        final String archivename = \"cpio\";\n+        File input = this.createSingleEntryArchive(archivename);\n \n         ArchiveOutputStream out = null;\n         ArchiveInputStream ais = null;\n         InputStream is = null;\n-        File result = File.createTempFile(\"test\", \".zip\");\n+        File result = File.createTempFile(\"test\", \".\"+archivename);\n         result.deleteOnExit();\n         ChangeSet changes = new ChangeSet();\n         try {\n \n             is = new FileInputStream(input);\n-            ais = factory.createArchiveInputStream(\"zip\", is);\n-\n-            out = factory.createArchiveOutputStream(\"zip\",\n+            ais = factory.createArchiveInputStream(archivename, is);\n+\n+            out = factory.createArchiveOutputStream(archivename,\n                     new FileOutputStream(result));\n             changes.delete(\"testdata\");\n             archiveListDelete(\"testdata\");\n             \n-            ArchiveEntry entry = new ZipArchiveEntry(\"bla/test.txt\");\n-            changes.add(entry, new FileInputStream(getFile(\"test.txt\")));\n+            final File file = getFile(\"test.txt\");\n+            ArchiveEntry entry = out.createArchiveEntry(file,\"bla/test.txt\");\n+            changes.add(entry, new FileInputStream(file));\n             archiveList.add(\"bla/test.txt\");\n             \n             changes.perform(ais, out);\n      * @throws Exception\n      */\n     public void testAddDeleteToOneFileArchive() throws Exception {\n-        File input = this.createSingleEntryArchive(\"zip\");\n+        final String archivename = \"cpio\";\n+        File input = this.createSingleEntryArchive(archivename);\n \n         ArchiveOutputStream out = null;\n         ArchiveInputStream ais = null;\n         InputStream is = null;\n-        File result = File.createTempFile(\"test\", \".zip\");\n+        File result = File.createTempFile(\"test\", \".\"+archivename);\n         result.deleteOnExit();\n         ChangeSet changes = new ChangeSet();\n         try {\n \n             is = new FileInputStream(input);\n-            ais = factory.createArchiveInputStream(\"zip\", is);\n-\n-            out = factory.createArchiveOutputStream(\"zip\",\n-                    new FileOutputStream(result));\n-            ArchiveEntry entry = new ZipArchiveEntry(\"bla/test.txt\");\n-            changes.add(entry, new FileInputStream(getFile(\"test.txt\")));\n+            ais = factory.createArchiveInputStream(archivename, is);\n+\n+            out = factory.createArchiveOutputStream(archivename,\n+                    new FileOutputStream(result));\n+            final File file = getFile(\"test.txt\");\n+            ArchiveEntry entry = out.createArchiveEntry(file,\"bla/test.txt\"); \n+            changes.add(entry, new FileInputStream(file));\n             archiveList.add(\"bla/test.txt\");\n \n             changes.delete(\"testdata\");", "timestamp": 1238461521, "metainfo": ""}