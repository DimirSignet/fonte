{"sha": "a77c3de6211694ef2bffd7c3b94edc939284e560", "log": "bit more tweaking with location handling code", "commit": "\n--- a/src/main/java/com/fasterxml/jackson/core/json/ReaderBasedJsonParser.java\n+++ b/src/main/java/com/fasterxml/jackson/core/json/ReaderBasedJsonParser.java\n     protected boolean _tokenIncomplete = false;\n \n     /**\n-     * NOTE: value stored is 1 greater than value reported, as update\n-     * is called _after_ reading first character of name token (usually quote)\n+     * Value of {@link #_inputPtr} at the time when the first character of\n+     * name token was read. Used for calculating token location when requested;\n+     * combined with {@link #_currInputProcessed}, may be updated appropriately\n+     * as needed.\n      *\n      * @since 2.7\n      */\n-    protected long _nameInputTotal; \n+    protected long _nameStartOffset;\n \n     /**\n      * @since 2.7\n      */\n-    protected int _nameInputRow;\n+    protected int _nameStartRow;\n \n     /**\n      * @since 2.7\n      */\n-    protected int _nameInputCol;\n+    protected int _nameStartCol;\n \n     /*\n     /**********************************************************\n     @Override\n     protected boolean loadMore() throws IOException\n     {\n-        _currInputProcessed += _inputEnd;\n-        _currInputRowStart -= _inputEnd;\n+        final int bufSize = _inputEnd;\n+\n+        _currInputProcessed += bufSize;\n+        _currInputRowStart -= bufSize;\n+\n+        // 26-Nov-2015, tatu: Since name-offset requires it too, must offset\n+        //   this increase to avoid \"moving\" name-offset, resulting most likely\n+        //   in negative value, which is fine as combine value remains unchanged.\n+        _nameStartOffset -= bufSize;\n \n         if (_reader != null) {\n             int count = _reader.read(_inputBuffer, 0, _inputBuffer.length);\n     {\n         final Object src = _ioContext.getSourceReference();\n         if (_currToken == JsonToken.FIELD_NAME) {\n+            long total = _currInputProcessed + (_nameStartOffset-1);\n             return new JsonLocation(src,\n-                    -1L, _nameInputTotal-1, _nameInputRow, _nameInputCol);\n+                    -1L, total, _nameStartRow, _nameStartCol);\n         }\n         return new JsonLocation(src,\n                 -1L, _tokenInputTotal-1, _tokenInputRow, _tokenInputCol);\n     private final void _updateNameLocation()\n     {\n         int ptr = _inputPtr;\n-        _nameInputTotal = _currInputProcessed + ptr;\n-        _nameInputRow = _currInputRow;\n-        _nameInputCol = ptr - _currInputRowStart;\n+        _nameStartOffset = ptr;\n+        _nameStartRow = _currInputRow;\n+        _nameStartCol = ptr - _currInputRowStart;\n     }\n \n     /*\n--- a/src/main/java/com/fasterxml/jackson/core/json/UTF8StreamJsonParser.java\n+++ b/src/main/java/com/fasterxml/jackson/core/json/UTF8StreamJsonParser.java\n     private int _quad1;\n \n     /**\n-     * NOTE: value stored is 1 greater than value reported, as update\n-     * is called _after_ reading first character of name token (usually quote)\n-     * \n+     * Value of {@link #_inputPtr} at the time when the first character of\n+     * name token was read. Used for calculating token location when requested;\n+     * combined with {@link #_currInputProcessed}, may be updated appropriately\n+     * as needed.\n+     *\n      * @since 2.7\n      */\n-    protected long _nameInputTotal; \n+    protected int _nameStartOffset; \n \n     /**\n      * @since 2.7\n      */\n-    protected int _nameInputRow;\n+    protected int _nameStartRow;\n \n     /**\n      * @since 2.7\n      */\n-    protected int _nameInputCol;\n+    protected int _nameStartCol;\n \n     /*\n     /**********************************************************\n     @Override\n     protected final boolean loadMore() throws IOException\n     {\n+        final int bufSize = _inputEnd;\n+\n         _currInputProcessed += _inputEnd;\n         _currInputRowStart -= _inputEnd;\n-        \n+\n+        // 26-Nov-2015, tatu: Since name-offset requires it too, must offset\n+        //   this increase to avoid \"moving\" name-offset, resulting most likely\n+        //   in negative value, which is fine as combine value remains unchanged.\n+        _nameStartOffset -= bufSize;\n+\n         if (_inputStream != null) {\n             int space = _inputBuffer.length;\n             if (space == 0) { // only occurs when we've been closed\n         // Need to move remaining data in front?\n         int amount = _inputEnd - _inputPtr;\n         if (amount > 0 && _inputPtr > 0) {\n-            _currInputProcessed += _inputPtr;\n-            _currInputRowStart -= _inputPtr;\n-            System.arraycopy(_inputBuffer, _inputPtr, _inputBuffer, 0, amount);\n+            final int ptr = _inputPtr;\n+\n+            _currInputProcessed += ptr;\n+            _currInputRowStart -= ptr;\n+            // 26-Nov-2015, tatu: Since name-offset requires it too, must offset\n+            //  (note: probably has little effect here but just in case)\n+            _nameStartOffset -= ptr;\n+\n+            System.arraycopy(_inputBuffer, ptr, _inputBuffer, 0, amount);\n             _inputEnd = amount;\n         } else {\n             _inputEnd = 0;\n     {\n         final Object src = _ioContext.getSourceReference();\n         if (_currToken == JsonToken.FIELD_NAME) {\n+            long total = _currInputProcessed + (_nameStartOffset-1);\n             return new JsonLocation(src,\n-                    _nameInputTotal-1, -1L, _nameInputRow, _nameInputCol);\n+                    total, -1L, _nameStartRow, _nameStartCol);\n         }\n         return new JsonLocation(src,\n                 _tokenInputTotal-1, -1L, _tokenInputRow, _tokenInputCol);\n     // @since 2.7\n     private final void _updateLocation()\n     {\n-        int ptr = _inputPtr;\n+        _tokenInputRow = _currInputRow;\n+        final int ptr = _inputPtr;\n         _tokenInputTotal = _currInputProcessed + ptr;\n-        _tokenInputRow = _currInputRow;\n         _tokenInputCol = ptr - _currInputRowStart;\n     }\n \n     // @since 2.7\n     private final void _updateNameLocation()\n     {\n-        int ptr = _inputPtr;\n-        _nameInputTotal = _currInputProcessed + ptr;\n-        _nameInputRow = _currInputRow;\n-        _nameInputCol = ptr - _currInputRowStart;\n+        _nameStartRow = _currInputRow;\n+        final int ptr = _inputPtr;\n+        _nameStartOffset = ptr;\n+        _nameStartCol = ptr - _currInputRowStart;\n     }\n \n     /*", "timestamp": 1448562208, "metainfo": ""}