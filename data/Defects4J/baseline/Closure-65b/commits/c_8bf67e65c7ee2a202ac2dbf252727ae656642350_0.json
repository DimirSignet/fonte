{"sha": "8bf67e65c7ee2a202ac2dbf252727ae656642350", "log": "Change on 2011-03-18 10:06:19-07:00 by nicksantos  \tAllow suppression of duplicate property declarations when \tthe property is in an object literal  \tR=johnlenz \tDELTA=48  (47 added, 0 deleted, 1 changed)  Change on 2011-03-18 12:02:54-07:00 by nicksantos  \tAllow the \"global this\" warning to be suppressed on a per-file basis  \tR=johnlenz \tDELTA=82  (50 added, 22 deleted, 10 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=945   ", "commit": "\n--- a/src/com/google/javascript/jscomp/CheckGlobalThis.java\n+++ b/src/com/google/javascript/jscomp/CheckGlobalThis.java\n \n package com.google.javascript.jscomp;\n \n-import com.google.javascript.jscomp.CheckLevel;\n import com.google.javascript.jscomp.NodeTraversal.Callback;\n import com.google.javascript.rhino.JSDocInfo;\n import com.google.javascript.rhino.Node;\n       \"dangerous use of the global 'this' object\");\n \n   private final AbstractCompiler compiler;\n-  private final CheckLevel level;\n \n   /**\n    * If {@code assignLhsChild != null}, then the node being traversed is\n    */\n   private Node assignLhsChild = null;\n \n-  CheckGlobalThis(AbstractCompiler compiler, CheckLevel level) {\n+  CheckGlobalThis(AbstractCompiler compiler) {\n     this.compiler = compiler;\n-    this.level = level;\n   }\n \n   /**\n \n   public void visit(NodeTraversal t, Node n, Node parent) {\n     if (n.getType() == Token.THIS && shouldReportThis(n, parent)) {\n-      compiler.report(t.makeError(n, level, GLOBAL_THIS));\n+      compiler.report(t.makeError(n, GLOBAL_THIS));\n     }\n     if (n == assignLhsChild) {\n       assignLhsChild = null;\n--- a/src/com/google/javascript/jscomp/Compiler.java\n+++ b/src/com/google/javascript/jscomp/Compiler.java\n       }\n     }\n \n+    // DiagnosticGroups override the plain checkTypes option.\n+    if (options.enables(DiagnosticGroups.CHECK_TYPES)) {\n+      options.checkTypes = true;\n+    } else if (options.disables(DiagnosticGroups.CHECK_TYPES)) {\n+      options.checkTypes = false;\n+    } else if (!options.checkTypes) {\n+      // If DiagnosticGroups did not override the plain checkTypes\n+      // option, and checkTypes is enabled, then turn off the\n+      // parser type warnings.\n+      options.setWarningLevel(\n+          DiagnosticGroup.forType(\n+              RhinoErrorReporter.TYPE_PARSE_ERROR),\n+          CheckLevel.OFF);\n+    }\n+\n+    if (options.checkGlobalThisLevel.isOn()) {\n+      options.setWarningLevel(\n+          DiagnosticGroups.GLOBAL_THIS,\n+          options.checkGlobalThisLevel);\n+    }\n+\n     // Initialize the warnings guard.\n     List<WarningsGuard> guards = Lists.newArrayList();\n     guards.add(\n           DiagnosticGroups.CHECK_VARIABLES, CheckLevel.OFF));\n     }\n \n-    // DiagnosticGroups override the plain checkTypes option.\n-    if (options.enables(DiagnosticGroups.CHECK_TYPES)) {\n-      options.checkTypes = true;\n-    } else if (options.disables(DiagnosticGroups.CHECK_TYPES)) {\n-      options.checkTypes = false;\n-    } else if (!options.checkTypes) {\n-      // If DiagnosticGroups did not override the plain checkTypes\n-      // option, and checkTypes is enabled, then turn off the\n-      // parser type warnings.\n-      guards.add(\n-          new DiagnosticGroupWarningsGuard(\n-              DiagnosticGroup.forType(\n-                  RhinoErrorReporter.TYPE_PARSE_ERROR),\n-              CheckLevel.OFF));\n-    }\n     this.warningsGuard = new ComposeWarningsGuard(guards);\n   }\n \n--- a/src/com/google/javascript/jscomp/DefaultPassConfig.java\n+++ b/src/com/google/javascript/jscomp/DefaultPassConfig.java\n     }\n \n     if (options.checkSuspiciousCode ||\n-        options.checkGlobalThisLevel.isOn()) {\n+        options.enables(DiagnosticGroups.GLOBAL_THIS)) {\n       checks.add(suspiciousCode);\n     }\n \n         sharedCallbacks.add(new CheckSideEffects(CheckLevel.WARNING));\n       }\n \n-      CheckLevel checkGlobalThisLevel = options.checkGlobalThisLevel;\n-      if (checkGlobalThisLevel.isOn()) {\n-        sharedCallbacks.add(\n-            new CheckGlobalThis(compiler, checkGlobalThisLevel));\n+      if (options.enables(DiagnosticGroups.GLOBAL_THIS)) {\n+        sharedCallbacks.add(new CheckGlobalThis(compiler));\n       }\n       return combineChecks(compiler, sharedCallbacks);\n     }\n--- a/src/com/google/javascript/jscomp/DiagnosticGroups.java\n+++ b/src/com/google/javascript/jscomp/DiagnosticGroups.java\n   // A bit of a hack to display the available groups on the command-line.\n   // New groups should be added to this list if they are public and should\n   // be listed on the command-line as an available option.\n+  //\n+  // If a group is suppressable on a per-file basis, it should be added\n+  // to parser/ParserConfig.properties\n   static final String DIAGNOSTIC_GROUP_NAMES =\n       \"accessControls, ambiguousFunctionDecl, checkRegExp,\" +\n       \"checkTypes, checkVars, constantProperty, deprecated, \" +\n-      \"externsValidation, fileoverviewTags, internetExplorerChecks, \" +\n-      \"invalidCasts, missingProperties, nonStandardJsDocs, \" +\n-      \"strictModuleDepCheck, typeInvalidation, \" +\n+      \"externsValidation, fileoverviewTags, globalThis, \" +\n+      \"internetExplorerChecks, nvalidCasts, missingProperties, \" +\n+      \"nonStandardJsDocs, strictModuleDepCheck, typeInvalidation, \" +\n       \"undefinedVars, unknownDefines, uselessCode, \" +\n       \"visibility\";\n+\n+  public static DiagnosticGroup GLOBAL_THIS = DiagnosticGroups\n+      .registerGroup(\"globalThis\",\n+          new DiagnosticGroup(\n+              CheckGlobalThis.GLOBAL_THIS));\n \n   public static DiagnosticGroup DEPRECATED = DiagnosticGroups\n       .registerGroup(\"deprecated\",\n--- a/src/com/google/javascript/jscomp/TypeValidator.java\n+++ b/src/com/google/javascript/jscomp/TypeValidator.java\n   void expectUndeclaredVariable(String sourceName, Node n, Node parent, Var var,\n       String variableName, JSType newType) {\n     boolean allowDupe = false;\n-    if (n.getType() == Token.GETPROP) {\n+    if (n.getType() == Token.GETPROP ||\n+        NodeUtil.isObjectLitKey(n, parent)) {\n       JSDocInfo info = n.getJSDocInfo();\n       if (info == null) {\n         info = parent.getJSDocInfo();\n--- a/test/com/google/javascript/jscomp/CheckGlobalThisTest.java\n+++ b/test/com/google/javascript/jscomp/CheckGlobalThisTest.java\n \n package com.google.javascript.jscomp;\n \n-import com.google.javascript.jscomp.CheckLevel;\n-\n /**\n  * Tests {@link CheckGlobalThis}.\n  */\n   @Override\n   protected CompilerPass getProcessor(Compiler compiler) {\n     return new CombinedCompilerPass(\n-        compiler, new CheckGlobalThis(compiler, CheckLevel.ERROR));\n+        compiler, new CheckGlobalThis(compiler));\n   }\n \n   private void testFailure(String js) {\n-    test(js, null, CheckGlobalThis.GLOBAL_THIS);\n+    testSame(js, CheckGlobalThis.GLOBAL_THIS);\n   }\n \n   public void testGlobalThis1() throws Exception {\n         \"dojo.declare(F, /** @lends {F.prototype} */ (\" +\n         \"    {foo: function() { return this.foo; }}));\");\n   }\n+\n+  public void testSuppressWarning() {\n+    testFailure(\"var x = function() { this.complex = 5; };\");\n+    testSame(\"/** @suppress {globalThis} */\" +\n+        \"var x = function() { this.complex = 5; };\");\n+  }\n }\n--- a/test/com/google/javascript/jscomp/CommandLineRunnerTest.java\n+++ b/test/com/google/javascript/jscomp/CommandLineRunnerTest.java\n     super.tearDown();\n   }\n \n+  public void testCheckGlobalThisOffByDefault() {\n+    testSame(\"function f() { this.a = 3; }\");\n+  }\n+\n+  public void testCheckGlobalThisOnWithAdvancedMode() {\n+    args.add(\"--compilation_level=ADVANCED_OPTIMIZATIONS\");\n+    test(\"function f() { this.a = 3; }\", CheckGlobalThis.GLOBAL_THIS);\n+  }\n+\n+  public void testCheckGlobalThisOnWithErrorFlag() {\n+    args.add(\"--jscomp_error=globalThis\");\n+    test(\"function f() { this.a = 3; }\", CheckGlobalThis.GLOBAL_THIS);\n+  }\n+\n   public void testTypeCheckingOffByDefault() {\n     test(\"function f(x) { return x; } f();\",\n          \"function f(a) { return a; } f();\");\n--- a/test/com/google/javascript/jscomp/TypeCheckTest.java\n+++ b/test/com/google/javascript/jscomp/TypeCheckTest.java\n     testTypes(\n         \"/** @param {{foo: !Function}} x */ function f(x) {}\" +\n         \"f({foo: function() {}});\");\n+  }\n+\n+  public void testObjectLiteralDeclaration4() throws Exception {\n+    testClosureTypesMultipleWarnings(\n+        \"var x = {\" +\n+        \"  /** @param {boolean} x */ abc: function(x) {}\" +\n+        \"};\" +\n+        \"/**\\n\" +\n+        \" * @param {string} x\\n\" +\n+        \" * @suppress {duplicate}\\n\" +\n+        \" */ x.abc = function(x) {};\",\n+        Lists.newArrayList(\n+            \"variable x.abc redefined with type \" +\n+            \"function (string): undefined, \" +\n+            \"original definition at  [testcode] :1 with type \" +\n+            \"function (boolean): undefined\",\n+            \"assignment to property abc of x\\n\" +\n+            \"found   : function (string): undefined\\n\" +\n+            \"required: function (boolean): undefined\"));\n+  }\n+\n+  public void testObjectLiteralDeclaration5() throws Exception {\n+    testTypes(\n+        \"var x = {\" +\n+        \"  /** @param {boolean} x */ abc: function(x) {}\" +\n+        \"};\" +\n+        \"/**\\n\" +\n+        \" * @param {boolean} x\\n\" +\n+        \" * @suppress {duplicate}\\n\" +\n+        \" */ x.abc = function(x) {};\");\n+  }\n+\n+  public void testObjectLiteralDeclaration6() throws Exception {\n+    testTypes(\n+        \"var x = {};\" +\n+        \"/**\\n\" +\n+        \" * @param {boolean} x\\n\" +\n+        \" * @suppress {duplicate}\\n\" +\n+        \" */ x.abc = function(x) {};\" +\n+        \"x = {\" +\n+        \"  /**\\n\" +\n+        \"   * @param {boolean} x\\n\" +\n+        \"   * @suppress {duplicate}\\n\" +\n+        \"   */\" +\n+        \"  abc: function(x) {}\" +\n+        \"};\");\n   }\n \n   public void testCallDateConstructorAsFunction() throws Exception {", "timestamp": 1300494334, "metainfo": ""}