{"sha": "b99b715061f2e333d6d2586e77d257807b9f6cd0", "log": "Fix Duration conversion from String for negative millisecond durations.", "commit": "\n--- a/src/main/java/org/joda/time/convert/StringConverter.java\n+++ b/src/main/java/org/joda/time/convert/StringConverter.java\n         }\n         str = str.substring(2, len - 1);\n         int dot = -1;\n+        boolean negative = false;\n         for (int i = 0; i < str.length(); i++) {\n-            if ((str.charAt(i) >= '0' && str.charAt(i) <= '9') ||\n-                (i == 0 && str.charAt(0) == '-')) {\n+            if (str.charAt(i) >= '0' && str.charAt(i) <= '9') {\n                 // ok\n-            } else if (i > 0 && str.charAt(i) == '.' && dot == -1) {\n+            } else if (i == 0 && str.charAt(0) == '-') {\n+            \t// ok\n+            \tnegative = true;\n+            } else if (i > (negative ? 1 : 0) && str.charAt(i) == '.' && dot == -1) {\n                 // ok\n                 dot = i;\n             } else {\n             }\n         }\n         long millis = 0, seconds = 0;\n+        int firstDigit = negative ? 1 : 0;\n         if (dot > 0) {\n-            seconds = Long.parseLong(str.substring(0, dot));\n+            seconds = Long.parseLong(str.substring(firstDigit, dot));\n             str = str.substring(dot + 1);\n             if (str.length() != 3) {\n                 str = (str + \"000\").substring(0, 3);\n             }\n             millis = Integer.parseInt(str);\n-        } else {\n+        } else if (negative) {\n+        \tseconds = Long.parseLong(str.substring(firstDigit, str.length()));\n+        }\n+        else {\n             seconds = Long.parseLong(str);\n         }\n-        if (seconds < 0) {\n-            return FieldUtils.safeAdd(FieldUtils.safeMultiply(seconds, 1000), -millis);\n+        assert(seconds >= 0L);\n+        if (negative) {\n+            return FieldUtils.safeAdd(FieldUtils.safeMultiply(-seconds, 1000), -millis);\n         } else {\n             return FieldUtils.safeAdd(FieldUtils.safeMultiply(seconds, 1000), millis);\n         }\n--- a/src/test/java/org/joda/time/convert/TestStringConverter.java\n+++ b/src/test/java/org/joda/time/convert/TestStringConverter.java\n         millis = StringConverter.INSTANCE.getDurationMillis(\"pt-12.32s\");\n         assertEquals(-12320, millis);\n         \n+        millis = StringConverter.INSTANCE.getDurationMillis(\"pt-0.32s\");\n+        assertEquals(-320, millis);\n+\n+        millis = StringConverter.INSTANCE.getDurationMillis(\"pt-0.0s\");\n+        assertEquals(0, millis);\n+\n+        millis = StringConverter.INSTANCE.getDurationMillis(\"pt0.0s\");\n+        assertEquals(0, millis);\n+\n         millis = StringConverter.INSTANCE.getDurationMillis(\"pt12.3456s\");\n         assertEquals(12345, millis);\n     }\n         } catch (IllegalArgumentException ex) {}\n         try {\n             StringConverter.INSTANCE.getDurationMillis(\"PT0-00S\");\n+            fail();\n+        } catch (IllegalArgumentException ex) {}\n+        try {\n+            StringConverter.INSTANCE.getDurationMillis(\"PT-.001S\");\n             fail();\n         } catch (IllegalArgumentException ex) {}\n     }", "timestamp": 1362064399, "metainfo": ""}