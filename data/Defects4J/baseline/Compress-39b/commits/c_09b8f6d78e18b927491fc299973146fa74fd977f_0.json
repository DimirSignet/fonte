{"sha": "09b8f6d78e18b927491fc299973146fa74fd977f", "log": "COMPRESS-203 the \"file name\" of a PAX header must not end with a slash or it is mistaken as a directory  ", "commit": "\n--- a/src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStream.java\n+++ b/src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStream.java\n     void writePaxHeaders(String entryName,\n                          Map<String, String> headers) throws IOException {\n         String name = \"./PaxHeaders.X/\" + stripTo7Bits(entryName);\n+        while (name.endsWith(\"/\")) {\n+            // TarEntry's constructor would think this is a directory\n+            // and not allow any data to be written\n+            name = name.substring(0, name.length() - 1);\n+        }\n         if (name.length() >= TarConstants.NAMELEN) {\n             name = name.substring(0, TarConstants.NAMELEN - 1);\n         }\n--- a/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStreamTest.java\n+++ b/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStreamTest.java\n         tin.close();\n     }\n \n+    /**\n+     * @see https://issues.apache.org/jira/browse/COMPRESS-203\n+     */\n+    public void testWriteLongDirectoryNameGnuMode() throws Exception {\n+        testWriteLongDirectoryName(TarArchiveOutputStream.LONGFILE_GNU);\n+    }\n+\n+    /**\n+     * @see https://issues.apache.org/jira/browse/COMPRESS-203\n+     */\n+    public void testWriteLongDirectoryNamePosixMode() throws Exception {\n+        testWriteLongDirectoryName(TarArchiveOutputStream.LONGFILE_POSIX);\n+    }\n+\n+    private void testWriteLongDirectoryName(int mode) throws Exception {\n+        String n = \"01234567890123456789012345678901234567890123456789\"\n+            + \"01234567890123456789012345678901234567890123456789\"\n+            + \"01234567890123456789012345678901234567890123456789/\";\n+        TarArchiveEntry t = new TarArchiveEntry(n);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+        TarArchiveOutputStream tos = new TarArchiveOutputStream(bos, \"ASCII\");\n+        tos.setLongFileMode(mode);\n+        tos.putArchiveEntry(t);\n+        tos.closeArchiveEntry();\n+        tos.close();\n+        byte[] data = bos.toByteArray();\n+        TarArchiveInputStream tin =\n+            new TarArchiveInputStream(new ByteArrayInputStream(data));\n+        TarArchiveEntry e = tin.getNextTarEntry();\n+        assertEquals(n, e.getName());\n+        assertTrue(e.isDirectory());\n+        tin.close();\n+    }\n+\n+    /**\n+     * @see https://issues.apache.org/jira/browse/COMPRESS-203\n+     */\n+    public void testWriteNonAsciiDirectoryNamePosixMode() throws Exception {\n+        String n = \"f\\u00f6\\u00f6/\";\n+        TarArchiveEntry t = new TarArchiveEntry(n);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+        TarArchiveOutputStream tos = new TarArchiveOutputStream(bos);\n+        tos.setAddPaxHeadersForNonAsciiNames(true);\n+        tos.putArchiveEntry(t);\n+        tos.closeArchiveEntry();\n+        tos.close();\n+        byte[] data = bos.toByteArray();\n+        TarArchiveInputStream tin =\n+            new TarArchiveInputStream(new ByteArrayInputStream(data));\n+        TarArchiveEntry e = tin.getNextTarEntry();\n+        assertEquals(n, e.getName());\n+        assertTrue(e.isDirectory());\n+        tin.close();\n+    }\n+\n }", "timestamp": 1356644075, "metainfo": ""}