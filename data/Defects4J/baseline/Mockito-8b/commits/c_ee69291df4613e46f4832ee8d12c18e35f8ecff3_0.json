{"sha": "ee69291df4613e46f4832ee8d12c18e35f8ecff3", "log": "Fix timeout sleep handling to track time more accurately", "commit": "\n--- a/src/org/mockito/internal/verification/VerificationWithTimeoutImpl.java\n+++ b/src/org/mockito/internal/verification/VerificationWithTimeoutImpl.java\n public class VerificationWithTimeoutImpl {\n     \n     VerificationMode delegate;\n-    int timeout;\n-    int treshhold;\n+    int timeoutMillis;\n+    int pollingPeriod;\n \n-    public VerificationWithTimeoutImpl(int treshhold, int millis, VerificationMode delegate) {\n-        this.treshhold = treshhold;\n-        this.timeout = millis;\n+    public VerificationWithTimeoutImpl(int pollingPeriod, int timeoutMillis, VerificationMode delegate) {\n+        this.pollingPeriod = pollingPeriod;\n+        this.timeoutMillis = timeoutMillis;\n         this.delegate = delegate;\n     }\n \n     public void verify(VerificationData data) {\n-        int soFar = 0;\n-        MockitoAssertionError error = null;\n-        while (soFar <= timeout) {\n+        MockitoAssertionError error = null;\n+        \n+        long startTime = System.currentTimeMillis();\n+        while (System.currentTimeMillis() - startTime <= timeoutMillis) {\n             try {\n                 delegate.verify(data);\n                 return;\n             } catch (MockitoAssertionError e) {\n                 error = e;\n-                soFar += treshhold;\n-                sleep(treshhold);\n+                sleep(pollingPeriod);\n             }\n         }\n         if (error != null) {\n     }\n \n     public int getTimeout() {\n-        return timeout;\n+        return timeoutMillis;\n     }\n \n     public int getTreshhold() {\n-        return treshhold;\n+        return pollingPeriod;\n     }    \n }\n--- a/test/org/mockitousage/bugs/ConcurrentModificationExceptionOnMultiThreadedVerificationTest.java\n+++ b/test/org/mockitousage/bugs/ConcurrentModificationExceptionOnMultiThreadedVerificationTest.java\n public class ConcurrentModificationExceptionOnMultiThreadedVerificationTest {\n \n \tint nThreads = 1;\n-\tstatic final int TEST_MILLIS = 1000;\n+\t\n+\tstatic final int TIMES = 100;\n \tstatic final int INTERVAL_MILLIS = 10;\n-\tstatic final int TIMES = TEST_MILLIS / INTERVAL_MILLIS;\n+\tstatic final int TEST_TIMEOUT_MILLIS = TIMES * INTERVAL_MILLIS + 500;\n \n \tITarget target = Mockito.mock(ITarget.class);\n \tExecutorService fixedThreadPool;\n \tpublic void testInvocationConcurrently() throws Exception {\n \t\treset(target);\n \t\tstartInvocations();\n-\t\tverify(target, timeout(TEST_MILLIS).times(TIMES*nThreads)).targetMethod(\"arg\");\n+\t\t\n+\t\tverify(target, timeout(TEST_TIMEOUT_MILLIS * 2).times(TIMES * nThreads)).targetMethod(\"arg\");\n \t\tverifyNoMoreInteractions(target);\n \t}\n \n \t\t}\n \n \t}\n-\n \t\n \tpublic class TargetInvoker implements Callable<Object> {\n ", "timestamp": 1381073266, "metainfo": ""}