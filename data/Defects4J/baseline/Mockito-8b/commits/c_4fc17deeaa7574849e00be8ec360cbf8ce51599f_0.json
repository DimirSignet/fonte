{"sha": "4fc17deeaa7574849e00be8ec360cbf8ce51599f", "log": "housekeeping - rename job  --HG-- rename : test/org/mockitousage/verification/NoMoreInteractionsExcludingStubsTest.java => test/org/mockitousage/verification/VerificationExcludingStubsTest.java", "commit": "\n--- /dev/null\n+++ b/test/org/mockitousage/verification/VerificationExcludingStubsTest.java\n+/*\n+ * Copyright (c) 2007 Mockito contributors\n+ * This program is made available under the terms of the MIT License.\n+ */\n+package org.mockitousage.verification;\n+\n+import org.junit.Test;\n+import org.mockito.InOrder;\n+import org.mockito.Mock;\n+import org.mockito.exceptions.misusing.NotAMockException;\n+import org.mockito.exceptions.verification.NoInteractionsWanted;\n+import org.mockito.internal.invocation.Invocation;\n+import org.mockito.internal.stubbing.InvocationContainer;\n+import org.mockito.internal.util.MockUtil;\n+import org.mockitousage.IMethods;\n+import org.mockitoutil.TestBase;\n+\n+import java.util.List;\n+\n+import static org.mockito.Mockito.*;\n+\n+@SuppressWarnings(\"unchecked\")\n+public class VerificationExcludingStubsTest extends TestBase {\n+\n+    @Mock IMethods mock;\n+\n+    @Test\n+    public void shouldAllowToExcludeStubsForVerification() throws Exception {\n+        //given\n+        when(mock.simpleMethod()).thenReturn(\"foo\");\n+\n+        //when\n+        String stubbed = mock.simpleMethod(); //irrelevant call because it is stubbing\n+        mock.objectArgMethod(stubbed);\n+\n+        //then\n+        verify(mock).objectArgMethod(\"foo\");\n+\n+        //verifyNoMoreInteractions fails:\n+        try { verifyNoMoreInteractions(mock); fail(); } catch (NoInteractionsWanted e) {};\n+        \n+        //but it works when stubs are ignored:\n+        ignoreStubs(mock);\n+        verifyNoMoreInteractions(mock);\n+    }\n+\n+    @Test\n+    public void shouldExcludeFromVerificationInOrder() throws Exception {\n+        //given\n+        when(mock.simpleMethod()).thenReturn(\"foo\");\n+\n+        //when\n+        mock.objectArgMethod(\"1\");\n+        mock.objectArgMethod(\"2\");\n+        mock.simpleMethod(); //calling the stub\n+\n+        //then\n+        InOrder inOrder = inOrder(ignoreStubs(mock));\n+        inOrder.verify(mock).objectArgMethod(\"1\");\n+        inOrder.verify(mock).objectArgMethod(\"2\");\n+        inOrder.verifyNoMoreInteractions();\n+        verifyNoMoreInteractions(mock);\n+    }\n+\n+    @Test(expected = NotAMockException.class)\n+    public void shouldIgnoringStubsDetectNulls() throws Exception {\n+        ignoreStubs(mock, null);\n+    }\n+\n+    @Test(expected = NotAMockException.class)\n+    public void shouldIgnoringStubsDetectNonMocks() throws Exception {\n+        ignoreStubs(mock, new Object());\n+    }\n+\n+    /**\n+     * Ignores stubbed methods of given mocks for the sake of verification.\n+     * <p>\n+     * Other words: all *stubbed* methods of given mocks are marked *verfied* so that they don't get in a way during verifyNoMoreInteractions().\n+     * <p>\n+     * This method <b>changes the input mocks</b>! This method returns input mocks just for convenience.\n+     * <p>\n+     * Example:\n+     * <pre>\n+     *  //mocking lists for the sake of the example (if you mock List in real you will burn in hell)\n+     *  List mock1 = mock(List.class), mock2 = mock(List.class);\n+     *\n+     *  //stubbing mocks:\n+     *  when(mock1.get(0)).thenReturn(10);\n+     *  when(mock2.get(0)).thenReturn(20);\n+     *\n+     *  //using mocks by calling stubbed get(0) methods:\n+     *  System.out.println(mock1.get(0)); //prints 10\n+     *  System.out.println(mock2.get(0)); //prints 20\n+     *\n+     *  //using mocks by calling clear() methods:\n+     *  mock1.clear();\n+     *  mock2.clear();\n+     *\n+     *  //verification:\n+     *  verify(mock1).clear();\n+     *  verify(mock2).clear();\n+     *\n+     *  //verifyNoMoreInteractions() fails because get() methods were not accounted for.\n+     *  try { verifyNoMoreInteractions(mock1, mock2); } catch (NoInteractionsWanted e);\n+     *\n+     *  //However, if we ignore stubbed methods then we can verifyNoMoreInteractions()\n+     *  verifyNoMoreInteractions(ignoreStubs(mock1, mock2));\n+     *\n+     *  //Remember that ignoreStubs() *changes* the input mocks and returns them for convenience.\n+     * <pre>\n+     *\n+     * @param mocks input mocks that will be changed\n+     * @return the same mocks that were passed in as parameters\n+     */\n+    public static Object[] ignoreStubs(Object... mocks) {\n+        for (Object m : mocks) {\n+            InvocationContainer invocationContainer = new MockUtil().getMockHandler(m).getInvocationContainer();\n+            List<Invocation> ins = invocationContainer.getInvocations();\n+            for (Invocation in : ins) {\n+                if (in.stubInfo() != null) {\n+                    in.ignoreForVerification();\n+                }\n+            }\n+        }\n+        return mocks;\n+    }\n+}", "timestamp": 1301823911, "metainfo": ""}