{"sha": "c671cab26ad25b0fbe120565e67e20b5ade89c71", "log": "Invalid use of matchers is now a part of state validation  --HG-- extra : convert_revision : svn%3Aaa2aecf3-ea3e-0410-9d70-716747e7c967/trunk%401092", "commit": "\n--- a/src/org/mockito/exceptions/Reporter.java\n+++ b/src/org/mockito/exceptions/Reporter.java\n     public void wantedAtMostX(int maxNumberOfInvocations, int foundSize) {\n         throw new MockitoAssertionError(join(\"Wanted at most \" + pluralize(maxNumberOfInvocations) + \" but was \" + foundSize));\n     }\n+\n+    public void misplacedArgumentMatcher() {\n+        throw new InvalidUseOfMatchersException(join(\n+                \"Misplaced argument matcher detected!\",\n+                \"Somewhere before this line you probably misused Mockito argument matchers.\",\n+                \"For example you might have used anyObject() argument matcher outside of verification or stubbing.\",\n+                \"Here are examples of correct usage of argument matchers:\",\n+                \"    when(mock.get(anyInt())).thenReturn(null);\",\n+                \"    doThrow(new RuntimeException()).when(mock).someVoidMethod(anyObject());\",\n+                \"    verify(mock).someMethod(contains(\\\"foo\\\"));\"\n+                ));\n+    }\n }\n--- a/src/org/mockito/internal/MockHandler.java\n+++ b/src/org/mockito/internal/MockHandler.java\n             mockitoStubber.setMethodForStubbing(invocationMatcher);\n             return null;\n         }\n-        \n         VerificationMode verificationMode = mockingProgress.pullVerificationMode();\n-        mockingProgress.validateState();\n-        \n+\n         Invocation invocation = new Invocation(proxy, method, args, SequenceNumber.next());\n         InvocationMatcher invocationMatcher = matchersBinder.bindMatchers(invocation);\n+        \n+        mockingProgress.validateState();\n \n         if (verificationMode != null) {\n             VerificationDataImpl data = new VerificationDataImpl(registeredInvocations.getAll(), invocationMatcher);\n--- a/src/org/mockito/internal/progress/LastArguments.java\n+++ b/src/org/mockito/internal/progress/LastArguments.java\n import java.util.Stack;\n \n import org.hamcrest.Matcher;\n+import org.mockito.exceptions.Reporter;\n import org.mockito.exceptions.base.MockitoException;\n import org.mockito.exceptions.misusing.InvalidUseOfMatchersException;\n import org.mockito.internal.matchers.And;\n         //TODO test cleanup?\n         //TODO duplicated\n         if (!matcherStack.isEmpty()) {\n-            MockitoException lastMatcherLocation = ((LocalizedMatcher) matcherStack.pop()).getLocation();\n+//          MockitoException lastMatcherLocation = ((LocalizedMatcher) matcherStack.pop()).getLocation();\n             matcherStack.clear();\n-            throw new InvalidUseOfMatchersException(\"Misplaced argument matcher.\", lastMatcherLocation);\n+            new Reporter().misplacedArgumentMatcher();\n         }\n     }\n \n--- a/src/org/mockito/internal/progress/MockingProgressImpl.java\n+++ b/src/org/mockito/internal/progress/MockingProgressImpl.java\n         }\n       \n         //TODO LastArguments should be somewhere here...\n-        //LastArguments.instance().validateState();\n+        LastArguments.instance().validateState();\n     }\n \n     public void stubbingCompleted() {\n--- a/test/org/mockito/internal/returnvalues/SmartNullReturnValuesTest.java\n+++ b/test/org/mockito/internal/returnvalues/SmartNullReturnValuesTest.java\n         return new Invocation(new Object(), type.getMethod(methodName, new Class[0]), new Object[0], 1);\n     }\n     \n-    //TODO review other default return values\n     @Test\n     public void shouldReturnTheUsualDefaultValuesForPrimitives() throws Exception {\n         SmartNullReturnValues returnValues = new SmartNullReturnValues();\n--- a/test/org/mockitousage/misuse/DetectingMisusedMatchersTest.java\n+++ b/test/org/mockitousage/misuse/DetectingMisusedMatchersTest.java\n import org.mockito.Mock;\n import org.mockito.StateMaster;\n import org.mockito.exceptions.misusing.InvalidUseOfMatchersException;\n+import org.mockito.exceptions.misusing.UnfinishedVerificationException;\n import org.mockitousage.IMethods;\n import org.mockitoutil.ExtraMatchers;\n import org.mockitoutil.TestBase;\n         anyObject();\n     }\n \n+    @Test\n+    public void shouldFailFastWhenArgumentMatchersAbused() {\n+        misplacedArgumentMatcher();\n+        try {\n+            mock(IMethods.class);\n+            fail();\n+        } catch (InvalidUseOfMatchersException e) {\n+            assertThat(e, messageContains(\"Misplaced argument matcher\"));\n+        }\n+    }\n+    \n+    @Test\n+    public void shouldSayUnfinishedVerificationButNotInvalidUseOfMatchers() {\n+        verify(withFinal).finalMethod(anyObject());\n+        try {\n+            verify(withFinal).finalMethod(anyObject());\n+            fail();\n+        } catch (UnfinishedVerificationException e) {}\n+    }\n+    \n     @Ignore\n     @Test\n-    public void shouldFailFastWhenArgumentMatchersAbused() {\n+    public void shouldFailAndShowWhereMatchersAreMisused() {\n         misplacedArgumentMatcher();\n         try {\n             mock(IMethods.class);", "timestamp": 1227997199, "metainfo": ""}