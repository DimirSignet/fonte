{"sha": "1821637121790ee722fdaf80bb03dc8479ef2f5a", "log": "invalid state is corrected on detection  --HG-- extra : convert_revision : svn%3Aaa2aecf3-ea3e-0410-9d70-716747e7c967/trunk%40123", "commit": "\n--- a/src/org/mockito/exceptions/Exceptions.java\n+++ b/src/org/mockito/exceptions/Exceptions.java\n         throw new UnfinishedStubbingException(join(\n                 \"Unifinished stubbing detected, e.g. toReturn() is missing\",\n                 \"Examples of proper stubbing:\",\n-                \"stub(mock.isOk()).toReturn(true);\",\n-                \"stub(mock.isOk()).toThrow(exception);\",\n+                \"stub(mock.isOk()).andReturn(true);\",\n+                \"stub(mock.isOk()).andThrows(exception);\",\n                 \"stubVoid(mock).toThrow(exception).on().someMethod();\"\n         ));\n     }\n--- a/src/org/mockito/internal/MockitoState.java\n+++ b/src/org/mockito/internal/MockitoState.java\n \n     public synchronized void validateState() {\n         if (verifyingModeLocal.get() != null) {\n+            verifyingModeLocal.set(null);\n             Exceptions.unfinishedVerificationException();\n         }\n         \n         if (stubbingModeLocal.get() != null) {\n+            stubbingModeLocal.set(null);\n             Exceptions.unfinishedStubbing();\n         }\n     }\n--- a/src/org/mockito/internal/matchers/ArrayEquals.java\n+++ b/src/org/mockito/internal/matchers/ArrayEquals.java\n                 && (actual == null || actual instanceof Object[])) {\n             return Arrays.equals((Object[]) wanted, (Object[]) actual);\n         } else {\n+            //TODO not tested\n             return super.matches(actual);\n         }\n     }\n \n     public void appendTo(StringBuffer buffer) {\n-        //TODO not tested\n         if (getWanted() != null && getWanted().getClass().isArray()) {\n             appendArray(createObjectArray(getWanted()), buffer);\n         } else {\n+            //TODO not tested\n             super.appendTo(buffer);\n         }\n     }\n \n     private void appendArray(Object[] array, StringBuffer buffer) {\n-        //TODO not tested\n         buffer.append(\"[\");\n         for (int i = 0; i < array.length; i++) {\n             new Equals(array[i]).appendTo(buffer);\n--- a/test/org/mockitousage/InvalidStateDetectionTest.java\n+++ b/test/org/mockitousage/InvalidStateDetectionTest.java\n     @Test\n     public void shouldDetectUnfinishedStubbing() {\n         stub(mock.simpleMethod());\n-        \n-        detects(new OnMethodCallOnMock(), mock, UnfinishedStubbingException.class);\n-        detects(new OnStub(), mock, UnfinishedStubbingException.class);\n-        detects(new OnStubVoid(), mock, UnfinishedStubbingException.class);\n-        detects(new OnVerify(), mock, UnfinishedStubbingException.class);\n-        detects(new OnStrictVerify(), mock, UnfinishedStubbingException.class);\n-        detects(new OnVerifyZeroInteractions(), mock, UnfinishedStubbingException.class);\n-        detects(new OnVerifyNoMoreInteractions(), mock, UnfinishedStubbingException.class);\n+        detects(new OnMethodCallOnMock(), UnfinishedStubbingException.class);\n+\n+        stub(mock.simpleMethod());\n+        detects(new OnStub(), UnfinishedStubbingException.class);\n+        \n+        stub(mock.simpleMethod());\n+        detects(new OnStubVoid(), UnfinishedStubbingException.class);\n+        \n+        stub(mock.simpleMethod());\n+        detects(new OnVerify(), UnfinishedStubbingException.class);\n+        \n+        stub(mock.simpleMethod());\n+        detects(new OnStrictVerify(), UnfinishedStubbingException.class);\n+        \n+        stub(mock.simpleMethod());\n+        detects(new OnVerifyZeroInteractions(), UnfinishedStubbingException.class);\n+        \n+        stub(mock.simpleMethod());\n+        detects(new OnVerifyNoMoreInteractions(), UnfinishedStubbingException.class);\n     }\n     \n     @Test\n     public void shouldDetectUnfinishedStubbingVoid() {\n         stubVoid(mock);\n-        detects(new OnMethodCallOnMock(), mock, UnfinishedStubbingException.class);\n-        detects(new OnStub(), mock, UnfinishedStubbingException.class);\n-        detects(new OnStubVoid(), mock, UnfinishedStubbingException.class);\n-        detects(new OnVerify(), mock, UnfinishedStubbingException.class);\n-        detects(new OnStrictVerify(), mock, UnfinishedStubbingException.class);\n-        detects(new OnVerifyZeroInteractions(), mock, UnfinishedStubbingException.class);\n-        detects(new OnVerifyNoMoreInteractions(), mock, UnfinishedStubbingException.class);\n+        detects(new OnMethodCallOnMock(), UnfinishedStubbingException.class);\n+        \n+        stubVoid(mock);\n+        detects(new OnStub(), UnfinishedStubbingException.class);\n+        \n+        stubVoid(mock);\n+        detects(new OnStubVoid(), UnfinishedStubbingException.class);\n+        \n+        stubVoid(mock);\n+        detects(new OnVerify(), UnfinishedStubbingException.class);\n+        \n+        stubVoid(mock);\n+        detects(new OnStrictVerify(), UnfinishedStubbingException.class);\n+        \n+        stubVoid(mock);\n+        detects(new OnVerifyZeroInteractions(), UnfinishedStubbingException.class);\n+        \n+        stubVoid(mock);\n+        detects(new OnVerifyNoMoreInteractions(), UnfinishedStubbingException.class);\n     }\n     \n     @Test\n     public void shouldDetectUnfinishedVerification() {\n         verify(mock);\n-        detects(new OnStub(), mock, UnfinishedVerificationException.class);\n-        detects(new OnStubVoid(), mock, UnfinishedVerificationException.class);\n-        detects(new OnVerify(), mock, UnfinishedVerificationException.class);\n-        detects(new OnStrictVerify(), mock, UnfinishedVerificationException.class);\n-        detects(new OnVerifyZeroInteractions(), mock, UnfinishedVerificationException.class);\n-        detects(new OnVerifyNoMoreInteractions(), mock, UnfinishedVerificationException.class);\n+        detects(new OnStub(), UnfinishedVerificationException.class);\n+        \n+        verify(mock);\n+        detects(new OnStubVoid(), UnfinishedVerificationException.class);\n+        \n+        verify(mock);\n+        detects(new OnVerify(), UnfinishedVerificationException.class);\n+        \n+        verify(mock);\n+        detects(new OnStrictVerify(), UnfinishedVerificationException.class);\n+        \n+        verify(mock);\n+        detects(new OnVerifyZeroInteractions(), UnfinishedVerificationException.class);\n+        \n+        verify(mock);\n+        detects(new OnVerifyNoMoreInteractions(), UnfinishedVerificationException.class);\n+    }\n+    \n+    @Test\n+    public void shouldCorrectStateAfterDetectingUnfinishedStubbing() {\n+        stubVoid(mock).toThrow(new RuntimeException());\n+        \n+        try {\n+            stubVoid(mock).toThrow(new RuntimeException()).on().oneArg(true);\n+            fail();\n+        } catch (UnfinishedStubbingException e) {}\n+        \n+        stubVoid(mock).toThrow(new RuntimeException()).on().oneArg(true);\n+        try {\n+            mock.oneArg(true);\n+            fail();\n+        } catch (RuntimeException e) {}\n+    }\n+    \n+    @Test\n+    public void shouldCorrectStateAfterDetectingUnfinishedVerification() {\n+        mock.simpleMethod();\n+        verify(mock);\n+        \n+        try {\n+            verify(mock).simpleMethod();\n+            fail();\n+        } catch (UnfinishedVerificationException e) {}\n+        \n+        verify(mock).simpleMethod();\n     }\n     \n     @Test\n     @Ignore\n-    public void shouldCorrectStateAfterDetectingInvalidity() {\n+    public void shouldDetectProblemsWithMatchers() {\n         \n     }\n     \n         }\n     }\n     \n-    private void detects(DetectsInvalidState detector, IMethods mock, Class expected) {\n+    private void detects(DetectsInvalidState detector, Class expected) {\n         try {\n             detector.detect(mock);\n             fail(\"Should throw an exception\");", "timestamp": 1196636501, "metainfo": ""}