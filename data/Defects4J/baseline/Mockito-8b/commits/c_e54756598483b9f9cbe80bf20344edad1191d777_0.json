{"sha": "e54756598483b9f9cbe80bf20344edad1191d777", "log": "Fixes issue #99 deep stubs where automatically marked as serializable  With this commit children mocks will use the serialization mode their parent", "commit": "\n--- a/src/org/mockito/internal/stubbing/defaultanswers/ReturnsDeepStubs.java\n+++ b/src/org/mockito/internal/stubbing/defaultanswers/ReturnsDeepStubs.java\n         }\n \n         // record deep stub answer\n-        return recordDeepStubAnswer(newDeepStubMock(returnTypeGenericMetadata), container);\n+        return recordDeepStubAnswer(\n+                newDeepStubMock(returnTypeGenericMetadata, invocation.getMock()),\n+                container\n+        );\n     }\n \n     /**\n      * {@link ReturnsDeepStubs} answer in which we will store the returned type generic metadata.\n      *\n      * @param returnTypeGenericMetadata The metadata to use to create the new mock.\n+     * @param parentMock The parent of the current deep stub mock.\n      * @return The mock\n      */\n-    private Object newDeepStubMock(GenericMetadataSupport returnTypeGenericMetadata) {\n+    private Object newDeepStubMock(GenericMetadataSupport returnTypeGenericMetadata, Object parentMock) {\n+        MockCreationSettings parentMockSettings = new MockUtil().getMockSettings(parentMock);\n         return mockitoCore().mock(\n                 returnTypeGenericMetadata.rawType(),\n-                withSettingsUsing(returnTypeGenericMetadata)\n+                withSettingsUsing(returnTypeGenericMetadata, parentMockSettings)\n         );\n     }\n \n-    private MockSettings withSettingsUsing(GenericMetadataSupport returnTypeGenericMetadata) {\n+    private MockSettings withSettingsUsing(GenericMetadataSupport returnTypeGenericMetadata, MockCreationSettings parentMockSettings) {\n         MockSettings mockSettings = returnTypeGenericMetadata.hasRawExtraInterfaces() ?\n                 withSettings().extraInterfaces(returnTypeGenericMetadata.rawExtraInterfaces())\n                 : withSettings();\n \n-        return mockSettings\n-\t\t        .serializable()\n+        return propagateSerializationSettings(mockSettings, parentMockSettings)\n                 .defaultAnswer(returnsDeepStubsAnswerUsing(returnTypeGenericMetadata));\n+    }\n+\n+    private MockSettings propagateSerializationSettings(MockSettings mockSettings, MockCreationSettings parentMockSettings) {\n+        return mockSettings.serializable(parentMockSettings.getSerializableMode());\n     }\n \n     private ReturnsDeepStubs returnsDeepStubsAnswerUsing(final GenericMetadataSupport returnTypeGenericMetadata) {\n--- /dev/null\n+++ b/test/org/mockitousage/bugs/DeepStubsWronglyReportsSerializationProblemsTest.java\n+package org.mockitousage.bugs;\n+\n+import org.junit.Test;\n+\n+import static org.fest.assertions.Assertions.assertThat;\n+import static org.mockito.Mockito.RETURNS_DEEP_STUBS;\n+import static org.mockito.Mockito.mock;\n+\n+/**\n+ * In GH issue 99 : https://github.com/mockito/mockito/issues/99\n+ */\n+public class DeepStubsWronglyReportsSerializationProblemsTest {\n+\n+    @Test\n+    public void should_not_raise_a_mockito_exception_about_serialization_when_accessing_deep_stub() {\n+        NotSerializableShouldBeMocked the_deep_stub = mock(ToBeDeepStubbed.class, RETURNS_DEEP_STUBS).getSomething();\n+        assertThat(the_deep_stub).isNotNull();\n+    }\n+\n+    public static class ToBeDeepStubbed {\n+        public ToBeDeepStubbed() { }\n+\n+        public NotSerializableShouldBeMocked getSomething() {\n+            return null;\n+        }\n+    }\n+\n+    public static class NotSerializableShouldBeMocked {\n+        NotSerializableShouldBeMocked(String mandatory_param) { }\n+    }\n+\n+}", "timestamp": 1412864552, "metainfo": ""}