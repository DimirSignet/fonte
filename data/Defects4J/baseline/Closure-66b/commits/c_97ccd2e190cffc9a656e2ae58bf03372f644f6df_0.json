{"sha": "97ccd2e190cffc9a656e2ae58bf03372f644f6df", "log": "do not create objects for goog.provide'd typedefs, try #2 now with an integration test for what broke people.  R=johnlenz DELTA=64  (63 added, 0 deleted, 1 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=1708   ", "commit": "\n--- a/src/com/google/javascript/jscomp/ProcessClosurePrimitives.java\n+++ b/src/com/google/javascript/jscomp/ProcessClosurePrimitives.java\n import com.google.common.collect.Maps;\n import com.google.common.collect.Sets;\n import com.google.javascript.jscomp.NodeTraversal.AbstractPostOrderCallback;\n+import com.google.javascript.rhino.JSDocInfo;\n import com.google.javascript.rhino.Node;\n import com.google.javascript.rhino.Token;\n \n           }\n         }\n         break;\n+\n       case Token.ASSIGN:\n       case Token.NAME:\n         // If this is an assignment to a provided name, remove the provided\n         // object.\n         handleCandidateProvideDefinition(t, n, parent);\n         break;\n+\n+      case Token.EXPR_RESULT:\n+        handleTypedefDefinition(t, n, parent);\n+        break;\n+\n       case Token.FUNCTION:\n         // If this is a declaration of a provided named function, this is an\n         // error. Hosited functions will explode if the're provided.\n         registerAnyProvidedPrefixes(ns, parent, t.getModule());\n         providedNames.put(\n             ns, new ProvidedName(ns, parent, t.getModule(), true));\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Handles a typedef definition for a goog.provided name.\n+   * @param An EXPR_RESULT node.\n+   */\n+  private void handleTypedefDefinition(\n+      NodeTraversal t, Node n, Node parent) {\n+    JSDocInfo info = n.getFirstChild().getJSDocInfo();\n+    if (t.inGlobalScope() && info != null && info.hasTypedefType()) {\n+      String name = n.getFirstChild().getQualifiedName();\n+      if (name != null) {\n+        ProvidedName pn = providedNames.get(name);\n+        if (pn != null) {\n+          pn.addDefinition(n, t.getModule());\n+        }\n       }\n     }\n   }\n \n         // Does this need a VAR keyword?\n         replacementNode = candidateDefinition;\n-        if (NodeUtil.isExpressionNode(candidateDefinition)) {\n+        if (NodeUtil.isExpressionNode(candidateDefinition) &&\n+            !candidateDefinition.getFirstChild().isQualifiedName()) {\n           candidateDefinition.putBooleanProp(Node.IS_NAMESPACE, true);\n           Node assignNode = candidateDefinition.getFirstChild();\n           Node nameNode = assignNode.getFirstChild();\n--- a/test/com/google/javascript/jscomp/ProcessClosurePrimitivesTest.java\n+++ b/test/com/google/javascript/jscomp/ProcessClosurePrimitivesTest.java\n     assertEquals(1, fooBarBazDecl.getLineno());\n     assertEquals(22, fooBarBazDecl.getCharno());\n   }\n+\n+  public void testNoStubForProvidedTypedef() {\n+    test(\"goog.provide('x'); /** @typedef {number} */ var x;\", \"var x;\");\n+  }\n+\n+  public void testNoStubForProvidedTypedef2() {\n+    test(\"goog.provide('x.y'); /** @typedef {number} */ x.y;\",\n+         \"var x = {}; x.y;\");\n+  }\n+\n+  public void testNoStubForProvidedTypedef4() {\n+    test(\"goog.provide('x.y.z'); /** @typedef {number} */ x.y.z;\",\n+         \"var x = {}; x.y = {}; x.y.z;\");\n+  }\n }", "timestamp": 1304445647, "metainfo": ""}