{"sha": "da6f5c4c4b1a5a7b397c77cf5ea0ee93134d7a63", "log": "merge in rhino from head  R=johnlenz,slb   Revision created by MOE tool push_codebase. MOE_MIGRATION=5733   ", "commit": "\n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/ClassDefinitionException.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/ClassDefinitionException.java\n \n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n // API class\n \n package org.mozilla.javascript;\n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/NotAFunctionException.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/NotAFunctionException.java\n \n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n // API class\n \n package org.mozilla.javascript;\n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/PropertyException.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/PropertyException.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/LogicalEquality.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/LogicalEquality.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Ethan Hugg\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/Namespace.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/Namespace.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/NamespaceHelper.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/NamespaceHelper.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/QName.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/QName.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XML.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XML.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLCtor.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLCtor.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLLibImpl.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLLibImpl.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLList.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLList.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLName.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLName.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLObjectImpl.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLObjectImpl.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLWithScope.java\n+++ b/lib/rhino/deprecatedsrc/org/mozilla/javascript/xml/impl/xmlbeans/XMLWithScope.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml.impl.xmlbeans;\n \n--- a/lib/rhino/examples/Control.java\n+++ b/lib/rhino/examples/Control.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n \n--- a/lib/rhino/examples/Counter.java\n+++ b/lib/rhino/examples/Counter.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n import org.mozilla.javascript.annotations.JSFunction;\n--- a/lib/rhino/examples/CounterTest.java\n+++ b/lib/rhino/examples/CounterTest.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n \n--- a/lib/rhino/examples/DynamicScopes.java\n+++ b/lib/rhino/examples/DynamicScopes.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n \n--- a/lib/rhino/examples/File.java\n+++ b/lib/rhino/examples/File.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n import org.mozilla.javascript.annotations.JSConstructor;\n--- a/lib/rhino/examples/Foo.java\n+++ b/lib/rhino/examples/Foo.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n import org.mozilla.javascript.annotations.JSFunction;\n--- a/lib/rhino/examples/Matrix.java\n+++ b/lib/rhino/examples/Matrix.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n import java.util.List;\n--- a/lib/rhino/examples/PrimitiveWrapFactory.java\n+++ b/lib/rhino/examples/PrimitiveWrapFactory.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n \n--- a/lib/rhino/examples/RunScript.java\n+++ b/lib/rhino/examples/RunScript.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n \n--- a/lib/rhino/examples/RunScript2.java\n+++ b/lib/rhino/examples/RunScript2.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n \n--- a/lib/rhino/examples/RunScript3.java\n+++ b/lib/rhino/examples/RunScript3.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n \n--- a/lib/rhino/examples/RunScript4.java\n+++ b/lib/rhino/examples/RunScript4.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n \n--- a/lib/rhino/examples/Shell.java\n+++ b/lib/rhino/examples/Shell.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n import org.mozilla.javascript.*;\n import java.io.*;\n--- a/lib/rhino/src/org/mozilla/classfile/ByteCode.java\n+++ b/lib/rhino/src/org/mozilla/classfile/ByteCode.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.classfile;\n \n--- a/lib/rhino/src/org/mozilla/classfile/ClassFileWriter.java\n+++ b/lib/rhino/src/org/mozilla/classfile/ClassFileWriter.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.classfile;\n \n         InputStream is = null;\n         int major = 48, minor = 0;\n         try {\n-            is = ClassFileWriter.class.getResourceAsStream(\n-                \"org/mozilla/classfile/ClassFileWriter.class\");\n+            is = ClassFileWriter.class.getResourceAsStream(\"ClassFileWriter.class\");\n             if (is == null) {\n                 is = ClassLoader.getSystemResourceAsStream(\n                     \"org/mozilla/classfile/ClassFileWriter.class\");\n--- a/lib/rhino/src/org/mozilla/javascript/Arguments.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Arguments.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/BaseFunction.java\n+++ b/lib/rhino/src/org/mozilla/javascript/BaseFunction.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Roger Lawrence\n- *   Mike McCabe\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n             }\n             result = (Scriptable)val;\n             if (result.getPrototype() == null) {\n-                result.setPrototype(getClassPrototype());\n+                Scriptable proto = getClassPrototype();\n+                if (result != proto) {\n+                    result.setPrototype(proto);\n+                }\n             }\n             if (result.getParentScope() == null) {\n                 Scriptable parent = getParentScope();\n--- a/lib/rhino/src/org/mozilla/javascript/BoundFunction.java\n+++ b/lib/rhino/src/org/mozilla/javascript/BoundFunction.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Raphael Speyer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/Callable.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Callable.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov, igor@fastmail.fm\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ClassCache.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ClassCache.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov, igor@fastmail.fm\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ClassShutter.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ClassShutter.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/CodeGenerator.java\n+++ b/lib/rhino/src/org/mozilla/javascript/CodeGenerator.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Patrick Beard\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Ethan Hugg\n- *   Bob Jervis\n- *   Terry Lucas\n- *   Roger Lawrence\n- *   Milen Nankov\n- *   Hannes Wallnoefer\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n                 }\n                 int callType = node.getIntProp(Node.SPECIALCALL_PROP,\n                                                Node.NON_SPECIALCALL);\n-                if (callType != Node.NON_SPECIALCALL) {\n+                if (type != Token.REF_CALL && callType != Node.NON_SPECIALCALL) {\n                     // embed line number and source filename\n                     addIndexOp(Icode_CALLSPECIAL, argCount);\n                     addUint8(callType);\n--- a/lib/rhino/src/org/mozilla/javascript/CompilerEnvirons.java\n+++ b/lib/rhino/src/org/mozilla/javascript/CompilerEnvirons.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov, igor@fastmail.fm\n- *   Bob Jervis\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ConsString.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ConsString.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ConstProperties.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ConstProperties.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Bob Jervis\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/Context.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Context.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *    Bob Jervis\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n             throw new IllegalArgumentException(\"factory == null\");\n         }\n         this.factory = factory;\n-        setLanguageVersion(VERSION_DEFAULT);\n+        version = VERSION_DEFAULT;\n         optimizationLevel = codegenClass != null ? 0 : -1;\n         maximumInterpreterStackDepth = Integer.MAX_VALUE;\n     }\n--- a/lib/rhino/src/org/mozilla/javascript/ContextAction.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ContextAction.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov, igor@fastmail.fm\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/ContextFactory.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ContextFactory.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov, igor@fastmail.fm\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/ContextListener.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ContextListener.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/ContinuationPending.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ContinuationPending.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/DToA.java\n+++ b/lib/rhino/src/org/mozilla/javascript/DToA.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Waldemar Horwat\n- *   Roger Lawrence\n- *   Attila Szegedi\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n /****************************************************************\n   *\n--- a/lib/rhino/src/org/mozilla/javascript/Decompiler.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Decompiler.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Mike Ang\n- *   Igor Bukanov\n- *   Bob Jervis\n- *   Mike McCabe\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n                 // This needs to be distinct from COLON in the general case\n                 // to distinguish from the colon in a ternary... which needs\n                 // different spacing.\n-                result.append(':');\n+                result.append(\": \");\n                 break;\n \n             case Token.COLON:\n--- a/lib/rhino/src/org/mozilla/javascript/DefaultErrorReporter.java\n+++ b/lib/rhino/src/org/mozilla/javascript/DefaultErrorReporter.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/DefiningClassLoader.java\n+++ b/lib/rhino/src/org/mozilla/javascript/DefiningClassLoader.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Roger Lawrence\n- *   Patrick Beard\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/Delegator.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Delegator.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Delegator.java, released\n- * Sep 27, 2000.\n- *\n- * The Initial Developer of the Original Code is\n- * Matthias Radestock. <matthias@sorted.org>.\n- * Portions created by the Initial Developer are Copyright (C) 2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/EcmaError.java\n+++ b/lib/rhino/src/org/mozilla/javascript/EcmaError.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/ErrorReporter.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ErrorReporter.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/Evaluator.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Evaluator.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/EvaluatorException.java\n+++ b/lib/rhino/src/org/mozilla/javascript/EvaluatorException.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n \n package org.mozilla.javascript;\n--- a/lib/rhino/src/org/mozilla/javascript/Function.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Function.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/FunctionObject.java\n+++ b/lib/rhino/src/org/mozilla/javascript/FunctionObject.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   David C. Navas\n- *   Ted Neward\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/GeneratedClassLoader.java\n+++ b/lib/rhino/src/org/mozilla/javascript/GeneratedClassLoader.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/IRFactory.java\n+++ b/lib/rhino/src/org/mozilla/javascript/IRFactory.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Travis Ennis\n- *   Ethan Hugg\n- *   Bob Jervis\n- *   Terry Lucas\n- *   Milen Nankov\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n     }\n \n     private Node transformLabeledStatement(LabeledStatement ls) {\n-        for (Label lb : ls.getLabels()) {\n-            decompiler.addName(lb.getName());\n+        Label label = ls.getFirstLabel();\n+        List<Label> labels = ls.getLabels();\n+        decompiler.addName(label.getName());\n+        if (labels.size() > 1) {\n+            // more than one label\n+            for (Label lb : labels.subList(1, labels.size())) {\n+                decompiler.addEOL(Token.COLON);\n+                decompiler.addName(lb.getName());\n+            }\n+        }\n+        if (ls.getStatement().getType() == Token.BLOCK) {\n+            // reuse OBJECTLIT for ':' workaround, cf. transformObjectLiteral()\n+            decompiler.addToken(Token.OBJECTLIT);\n+            decompiler.addEOL(Token.LC);\n+        } else {\n             decompiler.addEOL(Token.COLON);\n         }\n-        Label label = ls.getFirstLabel();\n         Node statement = transform(ls.getStatement());\n+        if (ls.getStatement().getType() == Token.BLOCK) {\n+            decompiler.addEOL(Token.RC);\n+        }\n \n         // Make a target and put it _after_ the statement node.  Add in the\n         // LABEL node, so breaks get the right target.\n--- a/lib/rhino/src/org/mozilla/javascript/Icode.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Icode.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Mike Ang\n- *   Igor Bukanov\n- *   Yuh-Ruey Chen\n- *   Ethan Hugg\n- *   Bob Jervis\n- *   Terry Lucas\n- *   Mike McCabe\n- *   Milen Nankov\n- *   Norris Boyd\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/IdFunctionCall.java\n+++ b/lib/rhino/src/org/mozilla/javascript/IdFunctionCall.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/IdFunctionObject.java\n+++ b/lib/rhino/src/org/mozilla/javascript/IdFunctionObject.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/IdScriptableObject.java\n+++ b/lib/rhino/src/org/mozilla/javascript/IdScriptableObject.java\n /* -*- Mode: java; tab-width: 4; indent-tabs-mode: 1; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ImporterTopLevel.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ImporterTopLevel.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Matthias Radestock\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/InterfaceAdapter.java\n+++ b/lib/rhino/src/org/mozilla/javascript/InterfaceAdapter.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/InterpretedFunction.java\n+++ b/lib/rhino/src/org/mozilla/javascript/InterpretedFunction.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Bob Jervis\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n     InterpreterData idata;\n     SecurityController securityController;\n     Object securityDomain;\n-    Scriptable[] functionRegExps;\n \n     private InterpretedFunction(InterpreterData idata,\n                                 Object staticSecurityDomain)\n     {\n         InterpretedFunction f;\n         f = new InterpretedFunction(idata, staticSecurityDomain);\n-        f.initInterpretedFunction(cx, scope);\n+        f.initScriptFunction(cx, scope);\n         return f;\n     }\n \n                                               int index)\n     {\n         InterpretedFunction f = new InterpretedFunction(parent, index);\n-        f.initInterpretedFunction(cx, scope);\n+        f.initScriptFunction(cx, scope);\n         return f;\n     }\n \n-    Scriptable[] createRegExpWraps(Context cx, Scriptable scope)\n-    {\n-        if (idata.itsRegExpLiterals == null) Kit.codeBug();\n-\n-        RegExpProxy rep = ScriptRuntime.checkRegExpProxy(cx);\n-        int N = idata.itsRegExpLiterals.length;\n-        Scriptable[] array = new Scriptable[N];\n-        for (int i = 0; i != N; ++i) {\n-            array[i] = rep.wrapRegExp(cx, scope, idata.itsRegExpLiterals[i]);\n-        }\n-        return array;\n-    }\n-\n-    private void initInterpretedFunction(Context cx, Scriptable scope)\n-    {\n-        initScriptFunction(cx, scope);\n-        if (idata.itsRegExpLiterals != null) {\n-            functionRegExps = createRegExpWraps(cx, scope);\n-        }\n-    }\n \n     @Override\n     public String getFunctionName()\n--- a/lib/rhino/src/org/mozilla/javascript/Interpreter.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Interpreter.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Patrick Beard\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Ethan Hugg\n- *   Bob Jervis\n- *   Terry Lucas\n- *   Roger Lawrence\n- *   Milen Nankov\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n import org.mozilla.javascript.ast.ScriptNode;\n import org.mozilla.javascript.ScriptRuntime.NoSuchMethodShim;\n import org.mozilla.javascript.debug.DebugFrame;\n+\n+import static org.mozilla.javascript.UniqueTag.DOUBLE_MARK;\n \n public final class Interpreter extends Icode implements Evaluator\n {\n         boolean isContinuationsTopFrame;\n \n         Scriptable thisObj;\n-        Scriptable[] scriptRegExps;\n \n // The values that change during interpretation\n \n         // It is also used for continuation restart in which case\n         // it holds ContinuationJump\n \n-        final Object DBL_MRK = UniqueTag.DOUBLE_MARK;\n+        final Object DBL_MRK = DOUBLE_MARK;\n         final Object undefined = Undefined.instance;\n \n         final boolean instructionCounting = (cx.instructionThreshold != 0);\n     case Token.LE :\n     case Token.GT :\n     case Token.LT : {\n-        --stackTop;\n-        Object rhs = stack[stackTop + 1];\n-        Object lhs = stack[stackTop];\n-        boolean valBln;\n-      object_compare:\n-        {\n-          number_compare:\n-            {\n-                double rDbl, lDbl;\n-                if (rhs == DBL_MRK) {\n-                    rDbl = sDbl[stackTop + 1];\n-                    lDbl = stack_double(frame, stackTop);\n-                } else if (lhs == DBL_MRK) {\n-                    rDbl = ScriptRuntime.toNumber(rhs);\n-                    lDbl = sDbl[stackTop];\n-                } else {\n-                    break number_compare;\n-                }\n-                switch (op) {\n-                  case Token.GE:\n-                    valBln = (lDbl >= rDbl);\n-                    break object_compare;\n-                  case Token.LE:\n-                    valBln = (lDbl <= rDbl);\n-                    break object_compare;\n-                  case Token.GT:\n-                    valBln = (lDbl > rDbl);\n-                    break object_compare;\n-                  case Token.LT:\n-                    valBln = (lDbl < rDbl);\n-                    break object_compare;\n-                  default:\n-                    throw Kit.codeBug();\n-                }\n-            }\n-            switch (op) {\n-              case Token.GE:\n-                valBln = ScriptRuntime.cmp_LE(rhs, lhs);\n-                break;\n-              case Token.LE:\n-                valBln = ScriptRuntime.cmp_LE(lhs, rhs);\n-                break;\n-              case Token.GT:\n-                valBln = ScriptRuntime.cmp_LT(rhs, lhs);\n-                break;\n-              case Token.LT:\n-                valBln = ScriptRuntime.cmp_LT(lhs, rhs);\n-                break;\n-              default:\n-                throw Kit.codeBug();\n-            }\n-        }\n-        stack[stackTop] = ScriptRuntime.wrapBoolean(valBln);\n+        stackTop = doCompare(frame, op, stack, sDbl, stackTop);\n         continue Loop;\n     }\n     case Token.IN :\n     case Token.INSTANCEOF : {\n-        Object rhs = stack[stackTop];\n-        if (rhs == DBL_MRK) rhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        --stackTop;\n-        Object lhs = stack[stackTop];\n-        if (lhs == DBL_MRK) lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        boolean valBln;\n-        if (op == Token.IN) {\n-            valBln = ScriptRuntime.in(lhs, rhs, cx);\n-        } else {\n-            valBln = ScriptRuntime.instanceOf(lhs, rhs, cx);\n-        }\n-        stack[stackTop] = ScriptRuntime.wrapBoolean(valBln);\n+        stackTop = doInOrInstanceof(cx, op, stack, sDbl, stackTop);\n         continue Loop;\n     }\n     case Token.EQ :\n     case Token.NE : {\n         --stackTop;\n-        boolean valBln;\n-        Object rhs = stack[stackTop + 1];\n-        Object lhs = stack[stackTop];\n-        if (rhs == DBL_MRK) {\n-            if (lhs == DBL_MRK) {\n-                valBln = (sDbl[stackTop] == sDbl[stackTop + 1]);\n-            } else {\n-                valBln = ScriptRuntime.eqNumber(sDbl[stackTop + 1], lhs);\n-            }\n-        } else {\n-            if (lhs == DBL_MRK) {\n-                valBln = ScriptRuntime.eqNumber(sDbl[stackTop], rhs);\n-            } else {\n-                valBln = ScriptRuntime.eq(lhs, rhs);\n-            }\n-        }\n+        boolean valBln = doEquals(stack, sDbl, stackTop);\n         valBln ^= (op == Token.NE);\n         stack[stackTop] = ScriptRuntime.wrapBoolean(valBln);\n         continue Loop;\n     case Token.SHEQ :\n     case Token.SHNE : {\n         --stackTop;\n-        boolean valBln = shallowEquals(stack, sDbl, stackTop);\n+        boolean valBln = doShallowEquals(stack, sDbl, stackTop);\n         valBln ^= (op == Token.SHNE);\n         stack[stackTop] = ScriptRuntime.wrapBoolean(valBln);\n         continue Loop;\n     case Token.BITXOR :\n     case Token.LSH :\n     case Token.RSH : {\n-        int lIntValue = stack_int32(frame, stackTop-1);\n-        int rIntValue = stack_int32(frame, stackTop);\n-        stack[--stackTop] = DBL_MRK;\n-        switch (op) {\n-          case Token.BITAND:\n-            lIntValue &= rIntValue;\n-            break;\n-          case Token.BITOR:\n-            lIntValue |= rIntValue;\n-            break;\n-          case Token.BITXOR:\n-            lIntValue ^= rIntValue;\n-            break;\n-          case Token.LSH:\n-            lIntValue <<= rIntValue;\n-            break;\n-          case Token.RSH:\n-            lIntValue >>= rIntValue;\n-            break;\n-        }\n-        sDbl[stackTop] = lIntValue;\n+        stackTop = doBitOp(frame, op, stack, sDbl, stackTop);\n         continue Loop;\n     }\n     case Token.URSH : {\n-        double lDbl = stack_double(frame, stackTop-1);\n+        double lDbl = stack_double(frame, stackTop - 1);\n         int rIntValue = stack_int32(frame, stackTop) & 0x1F;\n         stack[--stackTop] = DBL_MRK;\n         sDbl[stackTop] = ScriptRuntime.toUint32(lDbl) >>> rIntValue;\n     }\n     case Token.ADD :\n         --stackTop;\n-        do_add(stack, sDbl, stackTop, cx);\n+        doAdd(stack, sDbl, stackTop, cx);\n         continue Loop;\n     case Token.SUB :\n     case Token.MUL :\n     case Token.DIV :\n     case Token.MOD : {\n-        double rDbl = stack_double(frame, stackTop);\n-        --stackTop;\n-        double lDbl = stack_double(frame, stackTop);\n-        stack[stackTop] = DBL_MRK;\n-        switch (op) {\n-          case Token.SUB:\n-            lDbl -= rDbl;\n-            break;\n-          case Token.MUL:\n-            lDbl *= rDbl;\n-            break;\n-          case Token.DIV:\n-            lDbl /= rDbl;\n-            break;\n-          case Token.MOD:\n-            lDbl %= rDbl;\n-            break;\n-        }\n-        sDbl[stackTop] = lDbl;\n+        stackTop = doArithmetic(frame, op, stack, sDbl, stackTop);\n         continue Loop;\n     }\n     case Token.NOT :\n     }\n     case Token.DELPROP :\n     case Icode_DELNAME : {\n-        Object rhs = stack[stackTop];\n-        if (rhs == DBL_MRK) rhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        --stackTop;\n-        Object lhs = stack[stackTop];\n-        if (lhs == DBL_MRK) lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        stack[stackTop] = ScriptRuntime.delete(lhs, rhs, cx, op == Icode_DELNAME);\n+        stackTop = doDelName(cx, op, stack, sDbl, stackTop);\n         continue Loop;\n     }\n     case Token.GETPROPNOWARN : {\n         --stackTop;\n         Object lhs = stack[stackTop];\n         if (lhs == DBL_MRK) lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        stack[stackTop] = ScriptRuntime.setObjectProp(lhs, stringReg, rhs,\n-                                                      cx);\n+        stack[stackTop] = ScriptRuntime.setObjectProp(lhs, stringReg, rhs, cx);\n         continue Loop;\n     }\n     case Icode_PROP_INC_DEC : {\n         continue Loop;\n     }\n     case Token.GETELEM : {\n-        --stackTop;\n-        Object lhs = stack[stackTop];\n-        if (lhs == DBL_MRK) {\n-            lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        }\n-        Object value;\n-        Object id = stack[stackTop + 1];\n-        if (id != DBL_MRK) {\n-            value = ScriptRuntime.getObjectElem(lhs, id, cx, frame.scope);\n-        } else {\n-            double d = sDbl[stackTop + 1];\n-            value = ScriptRuntime.getObjectIndex(lhs, d, cx);\n-        }\n-        stack[stackTop] = value;\n+        stackTop = doGetElem(cx, frame, stack, sDbl, stackTop);\n         continue Loop;\n     }\n     case Token.SETELEM : {\n-        stackTop -= 2;\n-        Object rhs = stack[stackTop + 2];\n-        if (rhs == DBL_MRK) {\n-            rhs = ScriptRuntime.wrapNumber(sDbl[stackTop + 2]);\n-        }\n-        Object lhs = stack[stackTop];\n-        if (lhs == DBL_MRK) {\n-            lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        }\n-        Object value;\n-        Object id = stack[stackTop + 1];\n-        if (id != DBL_MRK) {\n-            value = ScriptRuntime.setObjectElem(lhs, id, rhs, cx);\n-        } else {\n-            double d = sDbl[stackTop + 1];\n-            value = ScriptRuntime.setObjectIndex(lhs, d, rhs, cx);\n-        }\n-        stack[stackTop] = value;\n+        stackTop = doSetElem(cx, stack, sDbl, stackTop);\n         continue Loop;\n     }\n     case Icode_ELEM_INC_DEC: {\n-        Object rhs = stack[stackTop];\n-        if (rhs == DBL_MRK) rhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        --stackTop;\n-        Object lhs = stack[stackTop];\n-        if (lhs == DBL_MRK) lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        stack[stackTop] = ScriptRuntime.elemIncrDecr(lhs, rhs, cx,\n-                                                     iCode[frame.pc]);\n-        ++frame.pc;\n+        stackTop = doElemIncDec(cx, frame, iCode, stack, sDbl, stackTop);\n         continue Loop;\n     }\n     case Token.GET_REF : {\n         if (instructionCounting) {\n             cx.instructionCount += INVOCATION_COST;\n         }\n-        int callType = iCode[frame.pc] & 0xFF;\n-        boolean isNew =  (iCode[frame.pc + 1] != 0);\n-        int sourceLine = getIndex(iCode, frame.pc + 2);\n-\n-        // indexReg: number of arguments\n-        if (isNew) {\n-            // stack change: function arg0 .. argN -> newResult\n-            stackTop -= indexReg;\n-\n-            Object function = stack[stackTop];\n-            if (function == DBL_MRK)\n-                function = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-            Object[] outArgs = getArgsArray(\n-                                   stack, sDbl, stackTop + 1, indexReg);\n-            stack[stackTop] = ScriptRuntime.newSpecial(\n-                                  cx, function, outArgs, frame.scope, callType);\n-        } else {\n-            // stack change: function thisObj arg0 .. argN -> result\n-            stackTop -= 1 + indexReg;\n-\n-            // Call code generation ensure that stack here\n-            // is ... Callable Scriptable\n-            Scriptable functionThis = (Scriptable)stack[stackTop + 1];\n-            Callable function = (Callable)stack[stackTop];\n-            Object[] outArgs = getArgsArray(\n-                                   stack, sDbl, stackTop + 2, indexReg);\n-            stack[stackTop] = ScriptRuntime.callSpecial(\n-                                  cx, function, functionThis, outArgs,\n-                                  frame.scope, frame.thisObj, callType,\n-                                  frame.idata.itsSourceFile, sourceLine);\n-        }\n-        frame.pc += 4;\n+        stackTop = doCallSpecial(cx, frame, stack, sDbl, stackTop, iCode, indexReg);\n         continue Loop;\n     }\n     case Token.CALL :\n         indexReg = iCode[frame.pc++];\n         // fallthrough\n     case Token.SETCONSTVAR :\n-        if (!frame.useActivation) {\n-            if ((varAttributes[indexReg] & ScriptableObject.READONLY) == 0) {\n-                throw Context.reportRuntimeError1(\"msg.var.redecl\",\n-                                                  frame.idata.argNames[indexReg]);\n-            }\n-            if ((varAttributes[indexReg] & ScriptableObject.UNINITIALIZED_CONST)\n-                != 0)\n-            {\n-                vars[indexReg] = stack[stackTop];\n-                varAttributes[indexReg] &= ~ScriptableObject.UNINITIALIZED_CONST;\n-                varDbls[indexReg] = sDbl[stackTop];\n-            }\n-        } else {\n-            Object val = stack[stackTop];\n-            if (val == DBL_MRK) val = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-            stringReg = frame.idata.argNames[indexReg];\n-            if (frame.scope instanceof ConstProperties) {\n-                ConstProperties cp = (ConstProperties)frame.scope;\n-                cp.putConst(stringReg, frame.scope, val);\n-            } else\n-                throw Kit.codeBug();\n-        }\n+        stackTop = doSetConstVar(frame, stack, sDbl, stackTop, vars, varDbls,\n+                                 varAttributes, indexReg);\n         continue Loop;\n     case Icode_SETVAR1:\n         indexReg = iCode[frame.pc++];\n         // fallthrough\n     case Token.SETVAR :\n-        if (!frame.useActivation) {\n-            if ((varAttributes[indexReg] & ScriptableObject.READONLY) == 0) {\n-                vars[indexReg] = stack[stackTop];\n-                varDbls[indexReg] = sDbl[stackTop];\n-            }\n-        } else {\n-            Object val = stack[stackTop];\n-            if (val == DBL_MRK) val = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-            stringReg = frame.idata.argNames[indexReg];\n-            frame.scope.put(stringReg, frame.scope, val);\n-        }\n+        stackTop = doSetVar(frame, stack, sDbl, stackTop, vars, varDbls,\n+                            varAttributes, indexReg);\n         continue Loop;\n     case Icode_GETVAR1:\n         indexReg = iCode[frame.pc++];\n         // fallthrough\n     case Token.GETVAR :\n-        ++stackTop;\n-        if (!frame.useActivation) {\n-            stack[stackTop] = vars[indexReg];\n-            sDbl[stackTop] = varDbls[indexReg];\n-        } else {\n-            stringReg = frame.idata.argNames[indexReg];\n-            stack[stackTop] = frame.scope.get(stringReg, frame.scope);\n-        }\n+        stackTop = doGetVar(frame, stack, sDbl, stackTop, vars, varDbls, indexReg);\n         continue Loop;\n     case Icode_VAR_INC_DEC : {\n-        // indexReg : varindex\n-        ++stackTop;\n-        int incrDecrMask = iCode[frame.pc];\n-        if (!frame.useActivation) {\n-            stack[stackTop] = DBL_MRK;\n-            Object varValue = vars[indexReg];\n-            double d;\n-            if (varValue == DBL_MRK) {\n-                d = varDbls[indexReg];\n-            } else {\n-                d = ScriptRuntime.toNumber(varValue);\n-                vars[indexReg] = DBL_MRK;\n-            }\n-            double d2 = ((incrDecrMask & Node.DECR_FLAG) == 0)\n-                        ? d + 1.0 : d - 1.0;\n-            varDbls[indexReg] = d2;\n-            sDbl[stackTop] = ((incrDecrMask & Node.POST_FLAG) == 0) ? d2 : d;\n-        } else {\n-            String varName = frame.idata.argNames[indexReg];\n-            stack[stackTop] = ScriptRuntime.nameIncrDecr(frame.scope, varName,\n-                                                         cx, incrDecrMask);\n-        }\n-        ++frame.pc;\n+        stackTop = doVarIncDec(cx, frame, stack, sDbl, stackTop,\n+                               vars, varDbls, indexReg);\n         continue Loop;\n     }\n     case Icode_ZERO :\n     }\n     case Token.REF_MEMBER: {\n         //indexReg: flags\n-        Object elem = stack[stackTop];\n-        if (elem == DBL_MRK) elem = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        --stackTop;\n-        Object obj = stack[stackTop];\n-        if (obj == DBL_MRK) obj = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        stack[stackTop] = ScriptRuntime.memberRef(obj, elem, cx, indexReg);\n+        stackTop = doRefMember(cx, stack, sDbl, stackTop, indexReg);\n         continue Loop;\n     }\n     case Token.REF_NS_MEMBER: {\n         //indexReg: flags\n-        Object elem = stack[stackTop];\n-        if (elem == DBL_MRK) elem = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        --stackTop;\n-        Object ns = stack[stackTop];\n-        if (ns == DBL_MRK) ns = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        --stackTop;\n-        Object obj = stack[stackTop];\n-        if (obj == DBL_MRK) obj = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        stack[stackTop] = ScriptRuntime.memberRef(obj, ns, elem, cx, indexReg);\n+        stackTop = doRefNsMember(cx, stack, sDbl, stackTop, indexReg);\n         continue Loop;\n     }\n     case Token.REF_NAME: {\n     }\n     case Token.REF_NS_NAME: {\n         //indexReg: flags\n-        Object name = stack[stackTop];\n-        if (name == DBL_MRK) name = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        --stackTop;\n-        Object ns = stack[stackTop];\n-        if (ns == DBL_MRK) ns = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n-        stack[stackTop] = ScriptRuntime.nameRef(ns, name, cx, frame.scope,\n-                                                indexReg);\n+        stackTop = doRefNsName(cx, frame, stack, sDbl, stackTop, indexReg);\n         continue Loop;\n     }\n     case Icode_SCOPE_LOAD :\n         initFunction(cx, frame.scope, frame.fnOrScript, indexReg);\n         continue Loop;\n     case Token.REGEXP :\n-        stack[++stackTop] = frame.scriptRegExps[indexReg];\n+        Object re = frame.idata.itsRegExpLiterals[indexReg];\n+        stack[++stackTop] = ScriptRuntime.wrapRegExp(cx, frame.scope, re);\n         continue Loop;\n     case Icode_LITERAL_NEW :\n         // indexReg: number of values in the literal\n         continue Loop;\n     default :\n         dumpICode(frame.idata);\n-        throw new RuntimeException(\n-            \"Unknown icode : \"+op+\" @ pc : \"+(frame.pc-1));\n+        throw new RuntimeException(\"Unknown icode : \" + op\n+                                 + \" @ pc : \" + (frame.pc-1));\n }  // end of interpreter switch\n \n                     } // end of jumplessRun label block\n                 exState = EX_CATCH_STATE;\n             } else if (throwable instanceof EvaluatorException) {\n                 exState = EX_CATCH_STATE;\n+            } else if (throwable instanceof ContinuationPending) {\n+                exState = EX_NO_JS_STATE;\n             } else if (throwable instanceof RuntimeException) {\n                 exState = cx.hasFeature(Context.FEATURE_ENHANCED_JAVA_ACCESS)\n                           ? EX_CATCH_STATE\n                : ScriptRuntime.wrapNumber(interpreterResultDbl);\n     }\n \n+    private static int doInOrInstanceof(Context cx, int op, Object[] stack,\n+                                        double[] sDbl, int stackTop) {\n+        Object rhs = stack[stackTop];\n+        if (rhs == DOUBLE_MARK) rhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        --stackTop;\n+        Object lhs = stack[stackTop];\n+        if (lhs == DOUBLE_MARK) lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        boolean valBln;\n+        if (op == Token.IN) {\n+            valBln = ScriptRuntime.in(lhs, rhs, cx);\n+        } else {\n+            valBln = ScriptRuntime.instanceOf(lhs, rhs, cx);\n+        }\n+        stack[stackTop] = ScriptRuntime.wrapBoolean(valBln);\n+        return stackTop;\n+    }\n+\n+    private static int doCompare(CallFrame frame, int op, Object[] stack,\n+                                 double[] sDbl, int stackTop) {\n+        --stackTop;\n+        Object rhs = stack[stackTop + 1];\n+        Object lhs = stack[stackTop];\n+        boolean valBln;\n+        object_compare:\n+        {\n+            number_compare:\n+            {\n+                double rDbl, lDbl;\n+                if (rhs == DOUBLE_MARK) {\n+                    rDbl = sDbl[stackTop + 1];\n+                    lDbl = stack_double(frame, stackTop);\n+                } else if (lhs == DOUBLE_MARK) {\n+                    rDbl = ScriptRuntime.toNumber(rhs);\n+                    lDbl = sDbl[stackTop];\n+                } else {\n+                    break number_compare;\n+                }\n+                switch (op) {\n+                    case Token.GE:\n+                        valBln = (lDbl >= rDbl);\n+                        break object_compare;\n+                    case Token.LE:\n+                        valBln = (lDbl <= rDbl);\n+                        break object_compare;\n+                    case Token.GT:\n+                        valBln = (lDbl > rDbl);\n+                        break object_compare;\n+                    case Token.LT:\n+                        valBln = (lDbl < rDbl);\n+                        break object_compare;\n+                    default:\n+                        throw Kit.codeBug();\n+                }\n+            }\n+            switch (op) {\n+                case Token.GE:\n+                    valBln = ScriptRuntime.cmp_LE(rhs, lhs);\n+                    break;\n+                case Token.LE:\n+                    valBln = ScriptRuntime.cmp_LE(lhs, rhs);\n+                    break;\n+                case Token.GT:\n+                    valBln = ScriptRuntime.cmp_LT(rhs, lhs);\n+                    break;\n+                case Token.LT:\n+                    valBln = ScriptRuntime.cmp_LT(lhs, rhs);\n+                    break;\n+                default:\n+                    throw Kit.codeBug();\n+            }\n+        }\n+        stack[stackTop] = ScriptRuntime.wrapBoolean(valBln);\n+        return stackTop;\n+    }\n+\n+    private static int doBitOp(CallFrame frame, int op, Object[] stack,\n+                               double[] sDbl, int stackTop) {\n+        int lIntValue = stack_int32(frame, stackTop - 1);\n+        int rIntValue = stack_int32(frame, stackTop);\n+        stack[--stackTop] = DOUBLE_MARK;\n+        switch (op) {\n+          case Token.BITAND:\n+            lIntValue &= rIntValue;\n+            break;\n+          case Token.BITOR:\n+            lIntValue |= rIntValue;\n+            break;\n+          case Token.BITXOR:\n+            lIntValue ^= rIntValue;\n+            break;\n+          case Token.LSH:\n+            lIntValue <<= rIntValue;\n+            break;\n+          case Token.RSH:\n+            lIntValue >>= rIntValue;\n+            break;\n+        }\n+        sDbl[stackTop] = lIntValue;\n+        return stackTop;\n+    }\n+\n+    private static int doDelName(Context cx, int op, Object[] stack,\n+                                 double[] sDbl, int stackTop) {\n+        Object rhs = stack[stackTop];\n+        if (rhs == DOUBLE_MARK) rhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        --stackTop;\n+        Object lhs = stack[stackTop];\n+        if (lhs == DOUBLE_MARK) lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        stack[stackTop] = ScriptRuntime.delete(lhs, rhs, cx, op == Icode_DELNAME);\n+        return stackTop;\n+    }\n+\n+    private static int doGetElem(Context cx, CallFrame frame, Object[] stack,\n+                                 double[] sDbl, int stackTop) {\n+        --stackTop;\n+        Object lhs = stack[stackTop];\n+        if (lhs == DOUBLE_MARK) {\n+            lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        }\n+        Object value;\n+        Object id = stack[stackTop + 1];\n+        if (id != DOUBLE_MARK) {\n+            value = ScriptRuntime.getObjectElem(lhs, id, cx, frame.scope);\n+        } else {\n+            double d = sDbl[stackTop + 1];\n+            value = ScriptRuntime.getObjectIndex(lhs, d, cx);\n+        }\n+        stack[stackTop] = value;\n+        return stackTop;\n+    }\n+\n+    private static int doSetElem(Context cx, Object[] stack, double[] sDbl,\n+                                 int stackTop) {\n+        stackTop -= 2;\n+        Object rhs = stack[stackTop + 2];\n+        if (rhs == DOUBLE_MARK) {\n+            rhs = ScriptRuntime.wrapNumber(sDbl[stackTop + 2]);\n+        }\n+        Object lhs = stack[stackTop];\n+        if (lhs == DOUBLE_MARK) {\n+            lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        }\n+        Object value;\n+        Object id = stack[stackTop + 1];\n+        if (id != DOUBLE_MARK) {\n+            value = ScriptRuntime.setObjectElem(lhs, id, rhs, cx);\n+        } else {\n+            double d = sDbl[stackTop + 1];\n+            value = ScriptRuntime.setObjectIndex(lhs, d, rhs, cx);\n+        }\n+        stack[stackTop] = value;\n+        return stackTop;\n+    }\n+\n+    private static int doElemIncDec(Context cx, CallFrame frame, byte[] iCode,\n+                                    Object[] stack, double[] sDbl, int stackTop) {\n+        Object rhs = stack[stackTop];\n+        if (rhs == DOUBLE_MARK) rhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        --stackTop;\n+        Object lhs = stack[stackTop];\n+        if (lhs == DOUBLE_MARK) lhs = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        stack[stackTop] = ScriptRuntime.elemIncrDecr(lhs, rhs, cx,\n+                                                     iCode[frame.pc]);\n+        ++frame.pc;\n+        return stackTop;\n+    }\n+\n+    private static int doCallSpecial(Context cx, CallFrame frame,\n+                                     Object[] stack, double[] sDbl,\n+                                     int stackTop, byte[] iCode,\n+                                     int indexReg) {\n+        int callType = iCode[frame.pc] & 0xFF;\n+        boolean isNew =  (iCode[frame.pc + 1] != 0);\n+        int sourceLine = getIndex(iCode, frame.pc + 2);\n+\n+        // indexReg: number of arguments\n+        if (isNew) {\n+            // stack change: function arg0 .. argN -> newResult\n+            stackTop -= indexReg;\n+\n+            Object function = stack[stackTop];\n+            if (function == DOUBLE_MARK)\n+                function = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+            Object[] outArgs = getArgsArray(\n+                                   stack, sDbl, stackTop + 1, indexReg);\n+            stack[stackTop] = ScriptRuntime.newSpecial(\n+                                  cx, function, outArgs, frame.scope, callType);\n+        } else {\n+            // stack change: function thisObj arg0 .. argN -> result\n+            stackTop -= 1 + indexReg;\n+\n+            // Call code generation ensure that stack here\n+            // is ... Callable Scriptable\n+            Scriptable functionThis = (Scriptable)stack[stackTop + 1];\n+            Callable function = (Callable)stack[stackTop];\n+            Object[] outArgs = getArgsArray(\n+                                   stack, sDbl, stackTop + 2, indexReg);\n+            stack[stackTop] = ScriptRuntime.callSpecial(\n+                                  cx, function, functionThis, outArgs,\n+                                  frame.scope, frame.thisObj, callType,\n+                                  frame.idata.itsSourceFile, sourceLine);\n+        }\n+        frame.pc += 4;\n+        return stackTop;\n+    }\n+\n+    private static int doSetConstVar(CallFrame frame, Object[] stack,\n+                                     double[] sDbl, int stackTop,\n+                                     Object[] vars, double[] varDbls,\n+                                     int[] varAttributes, int indexReg) {\n+        if (!frame.useActivation) {\n+            if ((varAttributes[indexReg] & ScriptableObject.READONLY) == 0) {\n+                throw Context.reportRuntimeError1(\"msg.var.redecl\",\n+                                                  frame.idata.argNames[indexReg]);\n+            }\n+            if ((varAttributes[indexReg] & ScriptableObject.UNINITIALIZED_CONST)\n+                != 0)\n+            {\n+                vars[indexReg] = stack[stackTop];\n+                varAttributes[indexReg] &= ~ScriptableObject.UNINITIALIZED_CONST;\n+                varDbls[indexReg] = sDbl[stackTop];\n+            }\n+        } else {\n+            Object val = stack[stackTop];\n+            if (val == DOUBLE_MARK) val = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+            String stringReg = frame.idata.argNames[indexReg];\n+            if (frame.scope instanceof ConstProperties) {\n+                ConstProperties cp = (ConstProperties)frame.scope;\n+                cp.putConst(stringReg, frame.scope, val);\n+            } else\n+                throw Kit.codeBug();\n+        }\n+        return stackTop;\n+    }\n+\n+    private static int doSetVar(CallFrame frame, Object[] stack,\n+                                double[] sDbl, int stackTop,\n+                                Object[] vars, double[] varDbls,\n+                                int[] varAttributes, int indexReg) {\n+        if (!frame.useActivation) {\n+            if ((varAttributes[indexReg] & ScriptableObject.READONLY) == 0) {\n+                vars[indexReg] = stack[stackTop];\n+                varDbls[indexReg] = sDbl[stackTop];\n+            }\n+        } else {\n+            Object val = stack[stackTop];\n+            if (val == DOUBLE_MARK) val = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+            String stringReg = frame.idata.argNames[indexReg];\n+            frame.scope.put(stringReg, frame.scope, val);\n+        }\n+        return stackTop;\n+    }\n+\n+    private static int doGetVar(CallFrame frame, Object[] stack,\n+                                double[] sDbl, int stackTop,\n+                                Object[] vars, double[] varDbls,\n+                                int indexReg) {\n+        ++stackTop;\n+        if (!frame.useActivation) {\n+            stack[stackTop] = vars[indexReg];\n+            sDbl[stackTop] = varDbls[indexReg];\n+        } else {\n+            String stringReg = frame.idata.argNames[indexReg];\n+            stack[stackTop] = frame.scope.get(stringReg, frame.scope);\n+        }\n+        return stackTop;\n+    }\n+\n+    private static int doVarIncDec(Context cx, CallFrame frame,\n+                                   Object[] stack, double[] sDbl,\n+                                   int stackTop, Object[] vars,\n+                                   double[] varDbls, int indexReg) {\n+        // indexReg : varindex\n+        ++stackTop;\n+        int incrDecrMask = frame.idata.itsICode[frame.pc];\n+        if (!frame.useActivation) {\n+            stack[stackTop] = DOUBLE_MARK;\n+            Object varValue = vars[indexReg];\n+            double d;\n+            if (varValue == DOUBLE_MARK) {\n+                d = varDbls[indexReg];\n+            } else {\n+                d = ScriptRuntime.toNumber(varValue);\n+                vars[indexReg] = DOUBLE_MARK;\n+            }\n+            double d2 = ((incrDecrMask & Node.DECR_FLAG) == 0)\n+                        ? d + 1.0 : d - 1.0;\n+            varDbls[indexReg] = d2;\n+            sDbl[stackTop] = ((incrDecrMask & Node.POST_FLAG) == 0) ? d2 : d;\n+        } else {\n+            String varName = frame.idata.argNames[indexReg];\n+            stack[stackTop] = ScriptRuntime.nameIncrDecr(frame.scope, varName,\n+                                                         cx, incrDecrMask);\n+        }\n+        ++frame.pc;\n+        return stackTop;\n+    }\n+\n+    private static int doRefMember(Context cx, Object[] stack, double[] sDbl,\n+                                   int stackTop, int flags) {\n+        Object elem = stack[stackTop];\n+        if (elem == DOUBLE_MARK) elem = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        --stackTop;\n+        Object obj = stack[stackTop];\n+        if (obj == DOUBLE_MARK) obj = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        stack[stackTop] = ScriptRuntime.memberRef(obj, elem, cx, flags);\n+        return stackTop;\n+    }\n+\n+    private static int doRefNsMember(Context cx, Object[] stack, double[] sDbl,\n+                                     int stackTop, int flags) {\n+        Object elem = stack[stackTop];\n+        if (elem == DOUBLE_MARK) elem = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        --stackTop;\n+        Object ns = stack[stackTop];\n+        if (ns == DOUBLE_MARK) ns = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        --stackTop;\n+        Object obj = stack[stackTop];\n+        if (obj == DOUBLE_MARK) obj = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        stack[stackTop] = ScriptRuntime.memberRef(obj, ns, elem, cx, flags);\n+        return stackTop;\n+    }\n+\n+    private static int doRefNsName(Context cx, CallFrame frame,\n+                                   Object[] stack, double[] sDbl,\n+                                   int stackTop, int flags) {\n+        Object name = stack[stackTop];\n+        if (name == DOUBLE_MARK) name = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        --stackTop;\n+        Object ns = stack[stackTop];\n+        if (ns == DOUBLE_MARK) ns = ScriptRuntime.wrapNumber(sDbl[stackTop]);\n+        stack[stackTop] = ScriptRuntime.nameRef(ns, name, cx, frame.scope, flags);\n+        return stackTop;\n+    }\n+\n     /**\n      * Call __noSuchMethod__.\n      */\n         Object[] elements = new Object[indexReg];\n         for (int i=0; i < indexReg; ++i, ++shift) {\n             Object val = stack[shift];\n-            if (val == UniqueTag.DOUBLE_MARK) {\n+            if (val == DOUBLE_MARK) {\n                 val = ScriptRuntime.wrapNumber(sDbl[shift]);\n             }\n             elements[i] = val;\n         return calleeFrame;\n     }\n \n-    private static boolean shallowEquals(Object[] stack, double[] sDbl,\n-            int stackTop)\n-    {\n+    private static boolean doEquals(Object[] stack, double[] sDbl,\n+                                    int stackTop) {\n         Object rhs = stack[stackTop + 1];\n         Object lhs = stack[stackTop];\n-        final Object DBL_MRK = UniqueTag.DOUBLE_MARK;\n+        if (rhs == DOUBLE_MARK) {\n+            if (lhs == DOUBLE_MARK) {\n+                return (sDbl[stackTop] == sDbl[stackTop + 1]);\n+            } else {\n+                return ScriptRuntime.eqNumber(sDbl[stackTop + 1], lhs);\n+            }\n+        } else {\n+            if (lhs == DOUBLE_MARK) {\n+                return ScriptRuntime.eqNumber(sDbl[stackTop], rhs);\n+            } else {\n+                return ScriptRuntime.eq(lhs, rhs);\n+            }\n+        }\n+    }\n+\n+    private static boolean doShallowEquals(Object[] stack, double[] sDbl,\n+                                           int stackTop)\n+    {\n+        Object rhs = stack[stackTop + 1];\n+        Object lhs = stack[stackTop];\n+        final Object DBL_MRK = DOUBLE_MARK;\n         double rdbl, ldbl;\n         if (rhs == DBL_MRK) {\n             rdbl = sDbl[stackTop + 1];\n             }\n         } else if (lhs == DBL_MRK) {\n             ldbl = sDbl[stackTop];\n-            if (rhs == DBL_MRK) {\n-                rdbl = sDbl[stackTop + 1];\n-            } else if (rhs instanceof Number) {\n+            if (rhs instanceof Number) {\n                 rdbl = ((Number)rhs).doubleValue();\n             } else {\n                 return false;\n           frame.savedStackTop = stackTop;\n           frame.pc--; // we want to come back here when we resume\n           ScriptRuntime.exitActivationFunction(cx);\n-          return (frame.result != UniqueTag.DOUBLE_MARK)\n+          return (frame.result != DOUBLE_MARK)\n               ? frame.result\n               : ScriptRuntime.wrapNumber(frame.resultDbl);\n     }\n         Scriptable applyThis;\n         if (indexReg != 0) {\n             Object obj = stack[stackTop + 2];\n-            if (obj == UniqueTag.DOUBLE_MARK)\n+            if (obj == DOUBLE_MARK)\n                 obj = ScriptRuntime.wrapNumber(sDbl[stackTop + 2]);\n             applyThis = ScriptRuntime.toObjectOrNull(cx, obj);\n         }\n                 if (fdata.itsFunctionType == FunctionNode.FUNCTION_STATEMENT) {\n                     initFunction(cx, scope, fnOrScript, i);\n                 }\n-            }\n-        }\n-\n-        Scriptable[] scriptRegExps = null;\n-        if (idata.itsRegExpLiterals != null) {\n-            // Wrapped regexps for functions are stored in\n-            // InterpretedFunction\n-            // but for script which should not contain references to scope\n-            // the regexps re-wrapped during each script execution\n-            if (idata.itsFunctionType != 0) {\n-                scriptRegExps = fnOrScript.functionRegExps;\n-            } else {\n-                scriptRegExps = fnOrScript.createRegExpWraps(cx, scope);\n             }\n         }\n \n         frame.useActivation = useActivation;\n \n         frame.thisObj = thisObj;\n-        frame.scriptRegExps = scriptRegExps;\n \n         // Initialize initial values of variables that change during\n         // interpretation.\n                             // the call chain before reaching parent frame's\n                             // scope. This should not be possible.\n                             Kit.codeBug();\n-                            break; // Never reached, but keeps the static analyzer happy about \"scope\" not being null 5 lines above.\n+                            break; // Never reached, but keeps the static analyzer\n+                            // happy about \"scope\" not being null 5 lines above.\n                         }\n                     }\n                     else {\n                     } else {\n                         result = cjump.result;\n                     }\n-                    if (result == UniqueTag.DOUBLE_MARK) {\n+                    if (result == DOUBLE_MARK) {\n                         double resultDbl;\n                         if (cjump == null) {\n                             resultDbl = frame.resultDbl;\n     private static int stack_int32(CallFrame frame, int i)\n     {\n         Object x = frame.stack[i];\n-        double value;\n         if (x == UniqueTag.DOUBLE_MARK) {\n-            value = frame.sDbl[i];\n+            return ScriptRuntime.toInt32(frame.sDbl[i]);\n         } else {\n-            value = ScriptRuntime.toNumber(x);\n-        }\n-        return ScriptRuntime.toInt32(value);\n+            return ScriptRuntime.toInt32(x);\n+        }\n     }\n \n     private static double stack_double(CallFrame frame, int i)\n         }\n     }\n \n-    private static void do_add(Object[] stack, double[] sDbl, int stackTop,\n+    private static void doAdd(Object[] stack, double[] sDbl, int stackTop,\n                               Context cx)\n     {\n         Object rhs = stack[stackTop + 1];\n         Object lhs = stack[stackTop];\n         double d;\n         boolean leftRightOrder;\n-        if (rhs == UniqueTag.DOUBLE_MARK) {\n+        if (rhs == DOUBLE_MARK) {\n             d = sDbl[stackTop + 1];\n-            if (lhs == UniqueTag.DOUBLE_MARK) {\n+            if (lhs == DOUBLE_MARK) {\n                 sDbl[stackTop] += d;\n                 return;\n             }\n             leftRightOrder = true;\n             // fallthrough to object + number code\n-        } else if (lhs == UniqueTag.DOUBLE_MARK) {\n+        } else if (lhs == DOUBLE_MARK) {\n             d = sDbl[stackTop];\n             lhs = rhs;\n             leftRightOrder = false;\n                     ? ((Number)lhs).doubleValue() : ScriptRuntime.toNumber(lhs);\n                 double rDbl = (rhs instanceof Number)\n                     ? ((Number)rhs).doubleValue() : ScriptRuntime.toNumber(rhs);\n-                stack[stackTop] = UniqueTag.DOUBLE_MARK;\n+                stack[stackTop] = DOUBLE_MARK;\n                 sDbl[stackTop] = lDbl + rDbl;\n             }\n             return;\n         } else {\n             double lDbl = (lhs instanceof Number)\n                 ? ((Number)lhs).doubleValue() : ScriptRuntime.toNumber(lhs);\n-            stack[stackTop] = UniqueTag.DOUBLE_MARK;\n+            stack[stackTop] = DOUBLE_MARK;\n             sDbl[stackTop] = lDbl + d;\n         }\n+    }\n+\n+    private static int doArithmetic(CallFrame frame, int op, Object[] stack,\n+                                    double[] sDbl, int stackTop) {\n+        double rDbl = stack_double(frame, stackTop);\n+        --stackTop;\n+        double lDbl = stack_double(frame, stackTop);\n+        stack[stackTop] = DOUBLE_MARK;\n+        switch (op) {\n+          case Token.SUB:\n+            lDbl -= rDbl;\n+            break;\n+          case Token.MUL:\n+            lDbl *= rDbl;\n+            break;\n+          case Token.DIV:\n+            lDbl /= rDbl;\n+            break;\n+          case Token.MOD:\n+            lDbl %= rDbl;\n+            break;\n+        }\n+        sDbl[stackTop] = lDbl;\n+        return stackTop;\n     }\n \n     private static Object[] getArgsArray(Object[] stack, double[] sDbl,\n--- a/lib/rhino/src/org/mozilla/javascript/InterpreterData.java\n+++ b/lib/rhino/src/org/mozilla/javascript/InterpreterData.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Bob Jervis\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/JavaAdapter.java\n+++ b/lib/rhino/src/org/mozilla/javascript/JavaAdapter.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Patrick Beard\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Mike McCabe\n- *   Matthias Radestock\n- *   Andi Vajda\n- *   Andrew Wason\n- *   Kemal Bayram\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n                 ctorArgs[1] = cx.getFactory();\n                 System.arraycopy(args, classCount + 1, ctorArgs, 2, argsCount);\n                 // TODO: cache class wrapper?\n-                NativeJavaClass classWrapper = new NativeJavaClass(scope, adapterClass);\n+                NativeJavaClass classWrapper = new NativeJavaClass(scope,\n+                        adapterClass, true);\n                 NativeJavaMethod ctors = classWrapper.members.ctors;\n                 int index = ctors.findCachedFunction(cx, ctorArgs);\n                 if (index < 0) {\n         }\n \n         String superName = superClass.getName().replace('.', '/');\n-        Constructor<?>[] ctors = superClass.getConstructors();\n+        Constructor<?>[] ctors = superClass.getDeclaredConstructors();\n         for (Constructor<?> ctor : ctors) {\n-            generateCtor(cfw, adapterName, superName, ctor);\n+            int mod = ctor.getModifiers();\n+            if (Modifier.isPublic(mod) || Modifier.isProtected(mod)) {\n+                generateCtor(cfw, adapterName, superName, ctor);\n+            }\n         }\n         generateSerialCtor(cfw, adapterName, superName);\n         if (scriptClassName != null) {\n                 String methodSignature = getMethodSignature(method, argTypes);\n                 String methodKey = methodName + methodSignature;\n                 if (! generatedOverrides.has(methodKey)) {\n-                    generateMethod(cfw, adapterName, methodName,\n-                                   argTypes, method.getReturnType());\n+                    generateMethod(cfw, adapterName, methodName, argTypes,\n+                                   method.getReturnType(), true);\n                     generatedOverrides.put(methodKey, 0);\n                     generatedMethods.put(methodName, 0);\n                 }\n                 String methodSignature = getMethodSignature(method, argTypes);\n                 String methodKey = methodName + methodSignature;\n                 if (! generatedOverrides.has(methodKey)) {\n-                    generateMethod(cfw, adapterName, methodName,\n-                                   argTypes, method.getReturnType());\n+                    generateMethod(cfw, adapterName, methodName, argTypes,\n+                                   method.getReturnType(), true);\n                     generatedOverrides.put(methodKey, 0);\n                     generatedMethods.put(methodName, 0);\n \n             for (int k=0; k < length; k++)\n                 parms[k] = ScriptRuntime.ObjectClass;\n             generateMethod(cfw, adapterName, functionName, parms,\n-                           ScriptRuntime.ObjectClass);\n+                           ScriptRuntime.ObjectClass, false);\n         }\n         return cfw.toByteArray();\n     }\n     {\n         if (f == null) {\n             // See comments in getFunction\n-            return Undefined.instance;\n+            return null;\n         }\n         if (factory == null) {\n             factory = ContextFactory.getGlobal();\n \n     private static void generateMethod(ClassFileWriter cfw, String genName,\n                                        String methodName, Class<?>[] parms,\n-                                       Class<?> returnType)\n+                                       Class<?> returnType, boolean convertResult)\n     {\n         StringBuilder sb = new StringBuilder();\n         int paramsEnd = appendMethodSignature(parms, returnType, sb);\n                       +\"J\"\n                       +\")Ljava/lang/Object;\");\n \n-        generateReturnResult(cfw, returnType, true);\n+        generateReturnResult(cfw, returnType, convertResult);\n \n         cfw.stopMethod((short)paramsEnd);\n     }\n--- a/lib/rhino/src/org/mozilla/javascript/JavaMembers.java\n+++ b/lib/rhino/src/org/mozilla/javascript/JavaMembers.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Cameron McCormack\n- *   Frank Mitchell\n- *   Mike Shaver\n- *   Kurt Westerfeld\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n import java.lang.reflect.*;\n import java.util.*;\n+\n+import static java.lang.reflect.Modifier.isProtected;\n+import static java.lang.reflect.Modifier.isPublic;\n \n /**\n  *\n                 throw Context.reportRuntimeError1(\"msg.access.prohibited\",\n                                                   cl.getName());\n             }\n-            this.includePrivate = cx.hasFeature(\n-                Context.FEATURE_ENHANCED_JAVA_ACCESS);\n             this.members = new HashMap<String,Object>();\n             this.staticMembers = new HashMap<String,Object>();\n             this.cl = cl;\n-            reflect(scope, includeProtected);\n+            boolean includePrivate = cx.hasFeature(\n+                    Context.FEATURE_ENHANCED_JAVA_ACCESS);\n+            reflect(scope, includeProtected, includePrivate);\n         } finally {\n             Context.exit();\n         }\n                 return name.concat(suffix);\n             } else {\n                 int length = name.length() + arrayDimension * suffix.length();\n-                StringBuffer sb = new StringBuffer(length);\n+                StringBuilder sb = new StringBuilder(length);\n                 sb.append(name);\n                 while (arrayDimension != 0) {\n                     --arrayDimension;\n     {\n         int N = argTypes.length;\n         if (N == 0) { return \"()\"; }\n-        StringBuffer sb = new StringBuffer();\n+        StringBuilder sb = new StringBuilder();\n         sb.append('(');\n         for (int i = 0; i != N; ++i) {\n             if (i != 0) {\n         }\n \n         if (methodsOrCtors != null) {\n-            for (int i = 0; i < methodsOrCtors.length; i++) {\n-                Class<?>[] type = methodsOrCtors[i].argTypes;\n+            for (MemberBox methodsOrCtor : methodsOrCtors) {\n+                Class<?>[] type = methodsOrCtor.argTypes;\n                 String sig = liveConnectSignature(type);\n                 if (sigStart + sig.length() == name.length()\n-                    && name.regionMatches(sigStart, sig, 0, sig.length()))\n+                        && name.regionMatches(sigStart, sig, 0, sig.length()))\n                 {\n-                    return methodsOrCtors[i];\n+                    return methodsOrCtor;\n                 }\n             }\n         }\n             Map<MethodSignature,Method> map, boolean includeProtected,\n             boolean includePrivate)\n     {\n-        if (Modifier.isPublic(clazz.getModifiers()) || includePrivate) {\n+        if (isPublic(clazz.getModifiers()) || includePrivate) {\n             try {\n                 if (includeProtected || includePrivate) {\n                     while (clazz != null) {\n                         try {\n                             Method[] methods = clazz.getDeclaredMethods();\n-                            for (int i = 0; i < methods.length; i++) {\n-                                Method method = methods[i];\n+                            for (Method method : methods) {\n                                 int mods = method.getModifiers();\n \n-                                if (Modifier.isPublic(mods) ||\n-                                    Modifier.isProtected(mods) ||\n-                                    includePrivate)\n-                                {\n+                                if (isPublic(mods)\n+                                        || isProtected(mods)\n+                                        || includePrivate) {\n                                     MethodSignature sig = new MethodSignature(method);\n                                     if (!map.containsKey(sig)) {\n                                         if (includePrivate && !method.isAccessible())\n                             // access to Class.getDeclaredMethods. Fall back to\n                             // Class.getMethods.\n                             Method[] methods = clazz.getMethods();\n-                            for (int i = 0; i < methods.length; i++) {\n-                                Method method = methods[i];\n-                                MethodSignature sig\n-                                    = new MethodSignature(method);\n+                            for (Method method : methods) {\n+                                MethodSignature sig = new MethodSignature(method);\n                                 if (!map.containsKey(sig))\n                                     map.put(sig, method);\n                             }\n                     }\n                 } else {\n                     Method[] methods = clazz.getMethods();\n-                    for (int i = 0; i < methods.length; i++) {\n-                        Method method = methods[i];\n+                    for (Method method : methods) {\n                         MethodSignature sig = new MethodSignature(method);\n                         // Array may contain methods with same signature but different return value!\n                         if (!map.containsKey(sig))\n         }\n \n         Class<?>[] interfaces = clazz.getInterfaces();\n-        for (int i = 0; i < interfaces.length; i++) {\n-            discoverAccessibleMethods(interfaces[i], map, includeProtected,\n+        for (Class<?> intface : interfaces) {\n+            discoverAccessibleMethods(intface, map, includeProtected,\n                     includePrivate);\n         }\n         Class<?> superclass = clazz.getSuperclass();\n         }\n     }\n \n-    private void reflect(Scriptable scope, boolean includeProtected)\n+    private void reflect(Scriptable scope,\n+                         boolean includeProtected,\n+                         boolean includePrivate)\n     {\n         // We reflect methods first, because we want overloaded field/method\n         // names to be allocated to the NativeJavaMethod before the field\n \n         Method[] methods = discoverAccessibleMethods(cl, includeProtected,\n                                                      includePrivate);\n-        for (int i = 0; i < methods.length; i++) {\n-            Method method = methods[i];\n+        for (Method method : methods) {\n             int mods = method.getModifiers();\n             boolean isStatic = Modifier.isStatic(mods);\n             Map<String,Object> ht = isStatic ? staticMembers : members;\n         }\n \n         // Reflect fields.\n-        Field[] fields = getAccessibleFields();\n-        for (int i = 0; i < fields.length; i++) {\n-            Field field = fields[i];\n+        Field[] fields = getAccessibleFields(includeProtected, includePrivate);\n+        for (Field field : fields) {\n             String name = field.getName();\n             int mods = field.getModifiers();\n-            if (!includePrivate && !Modifier.isPublic(mods)) {\n-                continue;\n-            }\n             try {\n                 boolean isStatic = Modifier.isStatic(mods);\n                 Map<String,Object> ht = isStatic ? staticMembers : members;\n         }\n \n         // Reflect constructors\n-        Constructor<?>[] constructors = getAccessibleConstructors();\n+        Constructor<?>[] constructors = getAccessibleConstructors(includePrivate);\n         MemberBox[] ctorMembers = new MemberBox[constructors.length];\n         for (int i = 0; i != constructors.length; ++i) {\n             ctorMembers[i] = new MemberBox(constructors[i]);\n         ctors = new NativeJavaMethod(ctorMembers, cl.getSimpleName());\n     }\n \n-    private Constructor<?>[] getAccessibleConstructors()\n+    private Constructor<?>[] getAccessibleConstructors(boolean includePrivate)\n     {\n       // The JVM currently doesn't allow changing access on java.lang.Class\n       // constructors, so don't try\n       return cl.getConstructors();\n     }\n \n-    private Field[] getAccessibleFields() {\n-        if (includePrivate) {\n+    private Field[] getAccessibleFields(boolean includeProtected,\n+                                        boolean includePrivate) {\n+        if (includePrivate || includeProtected) {\n             try {\n                 List<Field> fieldsList = new ArrayList<Field>();\n                 Class<?> currentClass = cl;\n                     // get all declared fields in this class, make them\n                     // accessible, and save\n                     Field[] declared = currentClass.getDeclaredFields();\n-                    for (int i = 0; i < declared.length; i++) {\n-                        declared[i].setAccessible(true);\n-                        fieldsList.add(declared[i]);\n+                    for (Field field : declared) {\n+                        int mod = field.getModifiers();\n+                        if (includePrivate || isPublic(mod) || isProtected(mod)) {\n+                            if (!field.isAccessible())\n+                                field.setAccessible(true);\n+                            fieldsList.add(field);\n+                        }\n                     }\n                     // walk up superclass chain.  no need to deal specially with\n                     // interfaces, since they can't have fields\n     {\n         // Inspect the list of all MemberBox for the only one having no\n         // parameters\n-        for (int methodIdx = 0; methodIdx < methods.length; methodIdx++) {\n-            MemberBox method = methods[methodIdx];\n+        for (MemberBox method : methods) {\n             // Does getter method have an empty parameter list with a return\n             // value (eg. a getSomething() or isSomething())?\n-            if (method.argTypes.length == 0\n-                && (!isStatic || method.isStatic()))\n-            {\n+            if (method.argTypes.length == 0 && (!isStatic || method.isStatic())) {\n                 Class<?> type = method.method().getReturnType();\n                 if (type != Void.TYPE) {\n                     return method;\n         // Make two passes: one to find a method with direct type assignment,\n         // and one to find a widening conversion.\n         for (int pass = 1; pass <= 2; ++pass) {\n-            for (int i = 0; i < methods.length; ++i) {\n-                MemberBox method = methods[i];\n+            for (MemberBox method : methods) {\n                 if (!isStatic || method.isStatic()) {\n                     Class<?>[] params = method.argTypes;\n                     if (params.length == 1) {\n                                               boolean isStatic)\n     {\n \n-        for (int i = 0; i < methods.length; ++i) {\n-            MemberBox method = methods[i];\n+        for (MemberBox method : methods) {\n             if (!isStatic || method.isStatic()) {\n                 if (method.method().getReturnType() == Void.TYPE) {\n                     if (method.argTypes.length == 1) {\n     private Map<String,Object> staticMembers;\n     private Map<String,FieldAndMethods> staticFieldAndMethods;\n     NativeJavaMethod ctors; // we use NativeJavaMethod for ctor overload resolution\n-    private boolean includePrivate;\n }\n \n class BeanProperty\n--- a/lib/rhino/src/org/mozilla/javascript/JavaScriptException.java\n+++ b/lib/rhino/src/org/mozilla/javascript/JavaScriptException.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Bojan Cekrlic\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/Kit.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Kit.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov, igor@fastmail.fm\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/LazilyLoadedCtor.java\n+++ b/lib/rhino/src/org/mozilla/javascript/LazilyLoadedCtor.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/MemberBox.java\n+++ b/lib/rhino/src/org/mozilla/javascript/MemberBox.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Felix Meschberger\n- *   Norris Boyd\n- *   Ulrike Mueller <umueller@demandware.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeArray.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeArray.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Mike McCabe\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n             comparator = new Comparator<Object>() {\n                 public int compare(final Object x, final Object y) {\n                     // sort undefined to end\n-                    if (x == y) {\n-                        return 0;\n-                    } else if (y == Undefined.instance\n-                            || y == Scriptable.NOT_FOUND) {\n+                    if (x == NOT_FOUND) {\n+                        return y == NOT_FOUND ? 0 : 1;\n+                    } else if (y == NOT_FOUND) {\n                         return -1;\n-                    } else if (x == Undefined.instance\n-                            || x == Scriptable.NOT_FOUND) {\n-                        return 1;\n+                    } else if (x == Undefined.instance) {\n+                        return y == Undefined.instance ? 0 : 1;\n+                    } else if (y == Undefined.instance) {\n+                        return -1;\n                     }\n \n                     cmpBuf[0] = x;\n             comparator = new Comparator<Object>() {\n                 public int compare(final Object x, final Object y) {\n                     // sort undefined to end\n-                    if (x == y)\n-                        return 0;\n-                    else if (y == Undefined.instance\n-                            || y == Scriptable.NOT_FOUND) {\n+                    if (x == NOT_FOUND) {\n+                        return y == NOT_FOUND ? 0 : 1;\n+                    } else if (y == NOT_FOUND) {\n                         return -1;\n-                    } else if (x == Undefined.instance\n-                            || x == Scriptable.NOT_FOUND) {\n-                        return 1;\n+                    } else if (x == Undefined.instance) {\n+                        return y == Undefined.instance ? 0 : 1;\n+                    } else if (y == Undefined.instance) {\n+                        return -1;\n                     }\n \n                     final String a = ScriptRuntime.toString(x);\n             };\n         }\n \n-        final int length = (int) getLengthProperty(cx, thisObj);\n+        long llength = getLengthProperty(cx, thisObj);\n+        final int length = (int) llength;\n+        if (llength != length) {\n+            throw Context.reportRuntimeError1(\n+                \"msg.arraylength.too.big\", String.valueOf(llength));\n+        }\n         // copy the JS array into a working array, so it can be\n         // sorted cheaply.\n         final Object[] working = new Object[length];\n         for (int i = 0; i != length; ++i) {\n-            working[i] = getElem(cx, thisObj, i);\n+            working[i] = getRawElem(thisObj, i);\n         }\n \n         Arrays.sort(working, comparator);\n \n         // copy the working array back into thisObj\n         for (int i = 0; i < length; ++i) {\n-            setElem(cx, thisObj, i, working[i]);\n+            setRawElem(cx, thisObj, i, working[i]);\n         }\n \n         return thisObj;\n--- a/lib/rhino/src/org/mozilla/javascript/NativeBoolean.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeBoolean.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Mike McCabe\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeCall.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeCall.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Bob Jervis\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeContinuation.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeContinuation.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeDate.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeDate.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Peter Annema\n- *   Norris Boyd\n- *   Mike McCabe\n- *   Ilya Frank\n- *\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n         return System.currentTimeMillis();\n     }\n \n-    /* Should be possible to determine the need for this dynamically\n-     * if we go with the workaround... I'm not using it now, because I\n-     * can't think of any clean way to make toLocaleString() and the\n-     * time zone (comment) in toString match the generated string\n-     * values.  Currently it's wrong-but-consistent in all but the\n-     * most recent betas of the JRE - seems to work in 1.1.7.\n-     */\n-    private final static boolean TZO_WORKAROUND = false;\n     private static double DaylightSavingTA(double t)\n     {\n         // Another workaround!  The JRE doesn't seem to know about DST\n         // before year 1 AD, so we map to equivalent dates for the\n-        // purposes of finding dst.  To be safe, we do this for years\n-        // outside 1970-2038.\n-        if (t < 0.0 || t > 2145916800000.0) {\n+        // purposes of finding DST. To be safe, we do this for years\n+        // before 1970.\n+        if (t < 0.0) {\n             int year = EquivalentYear(YearFromTime(t));\n             double day = MakeDay(year, MonthFromTime(t), DateFromTime(t));\n             t = MakeDate(day, TimeWithinDay(t));\n         }\n-        if (!TZO_WORKAROUND) {\n-            Date date = new Date((long) t);\n-            if (thisTimeZone.inDaylightTime(date))\n-                return msPerHour;\n-            else\n-                return 0;\n-        } else {\n-            /* Use getOffset if inDaylightTime() is broken, because it\n-             * seems to work acceptably.  We don't switch over to it\n-             * entirely, because it requires (expensive) exploded date arguments,\n-             * and the api makes it impossible to handle dst\n-             * changeovers cleanly.\n-             */\n-\n-            // Hardcode the assumption that the changeover always\n-            // happens at 2:00 AM:\n-            t += LocalTZA + (HourFromTime(t) <= 2 ? msPerHour : 0);\n-\n-            int year = YearFromTime(t);\n-            double offset = thisTimeZone.getOffset(year > 0 ? 1 : 0,\n-                                                   year,\n-                                                   MonthFromTime(t),\n-                                                   DateFromTime(t),\n-                                                   WeekDay(t),\n-                                                   (int)TimeWithinDay(t));\n-\n-            if ((offset - LocalTZA) != 0)\n-                return msPerHour;\n-            else\n-                return 0;\n-            //         return offset - LocalTZA;\n-        }\n+        Date date = new Date((long) t);\n+        if (thisTimeZone.inDaylightTime(date))\n+            return msPerHour;\n+        else\n+            return 0;\n     }\n \n     /*\n             switch (day) {\n                 case 0: return 1978;\n                 case 1: return 1973;\n-                case 2: return 1974;\n-                case 3: return 1975;\n+                case 2: return 1985;\n+                case 3: return 1986;\n                 case 4: return 1981;\n                 case 5: return 1971;\n                 case 6: return 1977;\n \n             // Find an equivalent year before getting the timezone\n             // comment.  See DaylightSavingTA.\n-            if (t < 0.0 || t > 2145916800000.0) {\n+            if (t < 0.0) {\n                 int equiv = EquivalentYear(YearFromTime(local));\n                 double day = MakeDay(equiv, MonthFromTime(t), DateFromTime(t));\n                 t = MakeDate(day, TimeWithinDay(t));\n-             }\n+            }\n             result.append(\" (\");\n             Date date = new Date((long) t);\n             synchronized (timeZoneFormatter) {\n--- a/lib/rhino/src/org/mozilla/javascript/NativeError.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeError.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n \n package org.mozilla.javascript;\n--- a/lib/rhino/src/org/mozilla/javascript/NativeFunction.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeFunction.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Bob Jervis\n- *   Roger Lawrence\n- *   Mike McCabe\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeGenerator.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeGenerator.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeGlobal.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeGlobal.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Mike McCabe\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeIterator.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeIterator.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeJSON.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeJSON.java\n /* -*- Mode: java; tab-width: 4; indent-tabs-mode: 1; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Matthew Crumley\n- *   Raphael Speyer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n  * This class implements the JSON native object.\n  * See ECMA 15.12.\n  */\n-final class NativeJSON extends IdScriptableObject\n+public final class NativeJSON extends IdScriptableObject\n {\n     static final long serialVersionUID = -4567599697595654984L;\n \n         if (property instanceof Scriptable) {\n             Scriptable val = ((Scriptable) property);\n             if (val instanceof NativeArray) {\n-                int len = (int) ((NativeArray) val).getLength();\n-                for (int i = 0; i < len; i++) {\n-                    Object newElement = walk(cx, scope, reviver, val, i);\n-                    if (newElement == Undefined.instance) {\n-                      val.delete(i);\n+                long len = ((NativeArray) val).getLength();\n+                for (long i = 0; i < len; i++) {\n+                    // indices greater than MAX_INT are represented as strings\n+                    if (i > Integer.MAX_VALUE) {\n+                        String id = Long.toString(i);\n+                        Object newElement = walk(cx, scope, reviver, val, id);\n+                        if (newElement == Undefined.instance) {\n+                            val.delete(id);\n+                        } else {\n+                            val.put(id, val, newElement);\n+                        }\n                     } else {\n-                      val.put(i, val, newElement);\n+                        int idx = (int) i;\n+                        Object newElement = walk(cx, scope, reviver, val, idx);\n+                        if (newElement == Undefined.instance) {\n+                            val.delete(idx);\n+                        } else {\n+                            val.put(idx, val, newElement);\n+                        }\n                     }\n                 }\n             } else {\n         state.indent = state.indent + state.gap;\n         List<Object> partial = new LinkedList<Object>();\n \n-        int len = (int) value.getLength();\n-        for (int index = 0; index < len; index++) {\n-            Object strP = str(index, value, state);\n+        long len = value.getLength();\n+        for (long index = 0; index < len; index++) {\n+            Object strP;\n+            if (index > Integer.MAX_VALUE) {\n+                strP = str(Long.toString(index), value, state);\n+            } else {\n+                strP = str((int) index, value, state);\n+            }\n             if (strP == Undefined.instance) {\n                 partial.add(\"null\");\n             } else {\n--- a/lib/rhino/src/org/mozilla/javascript/NativeJavaArray.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeJavaArray.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Frank Mitchell\n- *   Mike Shaver\n- *   Kemal Bayram\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeJavaClass.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeJavaClass.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Frank Mitchell\n- *   Mike Shaver\n- *   Kurt Westerfeld\n- *   Kemal Bayram\n- *   Ulrike Mueller <umueller@demandware.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n     }\n \n     public NativeJavaClass(Scriptable scope, Class<?> cl) {\n-        this.parent = scope;\n-        this.javaObject = cl;\n-        initMembers();\n+        this(scope, cl, false);\n+    }\n+\n+    public NativeJavaClass(Scriptable scope, Class<?> cl, boolean isAdapter) {\n+        super(scope, cl, null, isAdapter);\n     }\n \n     @Override\n     protected void initMembers() {\n         Class<?> cl = (Class<?>)javaObject;\n-        members = JavaMembers.lookupClass(parent, cl, cl, false);\n+        members = JavaMembers.lookupClass(parent, cl, cl, isAdapter);\n         staticFieldAndMethods = members.getFieldAndMethodsObjects(this, cl, true);\n     }\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeJavaConstructor.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeJavaConstructor.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Frank Mitchell\n- *   Mike Shaver\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeJavaMethod.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeJavaMethod.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Frank Mitchell\n- *   Mike Shaver\n- *   Ulrike Mueller <umueller@demandware.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeJavaObject.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeJavaObject.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Frank Mitchell\n- *   Mike Shaver\n- *   Kemal Bayram\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n     protected transient Class<?> staticType;\n     protected transient JavaMembers members;\n     private transient Map<String,FieldAndMethods> fieldAndMethods;\n-    private transient boolean isAdapter;\n+    protected transient boolean isAdapter;\n \n     private static final Object COERCED_INTERFACE_KEY = \"Coerced Interface\";\n     private static Method adapter_writeAdapterObject;\n--- a/lib/rhino/src/org/mozilla/javascript/NativeJavaPackage.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeJavaPackage.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Frank Mitchell\n- *   Mike Shaver\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeJavaTopPackage.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeJavaTopPackage.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Frank Mitchell\n- *   Mike Shaver\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeMath.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeMath.java\n /* -*- Mode: java; tab-width: 4; indent-tabs-mode: 1; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeNumber.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeNumber.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Mike McCabe\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeObject.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeObject.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Bob Jervis\n- *   Mike McCabe\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeScript.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeScript.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Roger Lawrence\n- *   Mike McCabe\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeString.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeString.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Tom Beauvais\n- *   Norris Boyd\n- *   Mike McCabe\n- *   Cameron McCormack\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NativeWith.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NativeWith.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/Node.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Node.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Roshan James\n- *   Roger Lawrence\n- *   Mike McCabe\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/NodeTransformer.java\n+++ b/lib/rhino/src/org/mozilla/javascript/NodeTransformer.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Bob Jervis\n- *   Roger Lawrence\n- *   Mike McCabe\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ObjArray.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ObjArray.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ObjToIntMap.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ObjToIntMap.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/Parser.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Parser.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Mike Ang\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Yuh-Ruey Chen\n- *   Travis Ennis\n- *   Ethan Hugg\n- *   Bob Jervis\n- *   Terry Lucas\n- *   Mike McCabe\n- *   Milen Nankov\n- *   Hannes Wallnoefer\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n         AstNode pn = assignExpr();\n         int pos = pn.getPosition();\n         while (matchToken(Token.COMMA)) {\n-            int lineno = ts.lineno;\n             int opPos = ts.tokenBeg;\n             if (compilerEnv.isStrictMode() && !pn.hasSideEffects())\n                 addStrictWarning(\"msg.no.side.effects\", \"\",\n \n             markDestructuring(pn);\n             int opPos = ts.tokenBeg;\n-            int opLineno = ts.getLineno();\n \n             pn = new Assignment(tt, pn, assignExpr(), opPos);\n \n         if (matchToken(Token.HOOK)) {\n             int line = ts.lineno;\n             int qmarkPos = ts.tokenBeg, colonPos = -1;\n-            AstNode ifTrue = assignExpr();\n+            /*\n+             * Always accept the 'in' operator in the middle clause of a ternary,\n+             * where it's unambiguous, even if we might be parsing the init of a\n+             * for statement.\n+             */\n+            boolean wasInForInit = inForInit;\n+            inForInit = false;\n+            AstNode ifTrue;\n+            try {\n+                ifTrue = assignExpr();\n+            } finally {\n+                inForInit = wasInForInit;\n+            }\n             if (mustMatchToken(Token.COLON, \"msg.no.colon.cond\"))\n                 colonPos = ts.tokenBeg;\n             AstNode ifFalse = assignExpr();\n         AstNode pn = andExpr();\n         if (matchToken(Token.OR)) {\n             int opPos = ts.tokenBeg;\n-            int lineno = ts.lineno;\n             pn = new InfixExpression(Token.OR, pn, orExpr(), opPos);\n         }\n         return pn;\n         AstNode pn = bitOrExpr();\n         if (matchToken(Token.AND)) {\n             int opPos = ts.tokenBeg;\n-            int lineno = ts.lineno;\n             pn = new InfixExpression(Token.AND, pn, andExpr(), opPos);\n         }\n         return pn;\n         AstNode pn = bitXorExpr();\n         while (matchToken(Token.BITOR)) {\n             int opPos = ts.tokenBeg;\n-            int lineno = ts.lineno;\n             pn = new InfixExpression(Token.BITOR, pn, bitXorExpr(), opPos);\n         }\n         return pn;\n         AstNode pn = bitAndExpr();\n         while (matchToken(Token.BITXOR)) {\n             int opPos = ts.tokenBeg;\n-            int lineno = ts.lineno;\n             pn = new InfixExpression(Token.BITXOR, pn, bitAndExpr(), opPos);\n         }\n         return pn;\n         AstNode pn = eqExpr();\n         while (matchToken(Token.BITAND)) {\n             int opPos = ts.tokenBeg;\n-            int lineno = ts.lineno;\n             pn = new InfixExpression(Token.BITAND, pn, eqExpr(), opPos);\n         }\n         return pn;\n         AstNode pn = relExpr();\n         for (;;) {\n             int tt = peekToken(), opPos = ts.tokenBeg;\n-            int lineno = ts.lineno;\n             switch (tt) {\n               case Token.EQ:\n               case Token.NE:\n         AstNode pn = shiftExpr();\n         for (;;) {\n             int tt = peekToken(), opPos = ts.tokenBeg;\n-            int line = ts.lineno;\n             switch (tt) {\n               case Token.IN:\n                 if (inForInit)\n         AstNode pn = addExpr();\n         for (;;) {\n             int tt = peekToken(), opPos = ts.tokenBeg;\n-            int lineno = ts.lineno;\n             switch (tt) {\n               case Token.LSH:\n               case Token.URSH:\n             int tt = peekToken(), opPos = ts.tokenBeg;\n             if (tt == Token.ADD || tt == Token.SUB) {\n                 consumeToken();\n-                int lineno = ts.lineno;\n                 pn = new InfixExpression(tt, pn, mulExpr(), opPos);\n                 continue;\n             }\n               case Token.DIV:\n               case Token.MOD:\n                 consumeToken();\n-                int line = ts.lineno;\n                 pn = new InfixExpression(tt, pn, unaryExpr(), opPos);\n                 continue;\n             }\n \n         if (!compilerEnv.isXmlAvailable()) {\n             int maybeName = nextToken();\n-            if (maybeName != Token.NAME &&\n-                !(compilerEnv.isReservedKeywordAsIdentifier()\n-                && TokenStream.isKeyword(ts.getString()))) {\n+            if (maybeName != Token.NAME\n+                    && !(compilerEnv.isReservedKeywordAsIdentifier()\n+                    && TokenStream.isKeyword(ts.getString()))) {\n               reportError(\"msg.no.name.after.dot\");\n             }\n \n         }\n     }\n \n-    private static final int PROP_ENTRY = 1;\n-    private static final int GET_ENTRY  = 2;\n-    private static final int SET_ENTRY  = 4;\n-\n     private AstNode generatorExpression(AstNode result, int pos)\n         throws IOException\n     {\n         }\n     }\n \n+    private static final int PROP_ENTRY = 1;\n+    private static final int GET_ENTRY  = 2;\n+    private static final int SET_ENTRY  = 4;\n+\n     private ObjectLiteral objectLiteral()\n         throws IOException\n     {\n             Comment jsdocNode = getAndResetJsDoc();\n             switch(tt) {\n               case Token.NAME:\n-                  afterComma = -1;\n                   Name name = createNameNode();\n                   propertyName = ts.getString();\n                   int ppos = ts.tokenBeg;\n                   // many tokens.)\n                   int peeked = peekToken();\n                   boolean maybeGetterOrSetter =\n-                      \"get\".equals(propertyName)\n-                      || \"set\".equals(propertyName);\n+                          \"get\".equals(propertyName)\n+                          || \"set\".equals(propertyName);\n                   if (maybeGetterOrSetter\n-                      && peeked != Token.COMMA && peeked != Token.COLON && peeked != Token.RC)\n+                          && peeked != Token.COMMA\n+                          && peeked != Token.COLON\n+                          && peeked != Token.RC)\n                   {\n                       boolean isGet = \"get\".equals(propertyName);\n                       entryKind = isGet ? GET_ENTRY : SET_ENTRY;\n                       AstNode pname = objliteralProperty();\n                       if (pname == null) {\n-                        propertyName = null;\n+                          propertyName = null;\n                       } else {\n-                        propertyName = ts.getString();\n-                        ObjectProperty objectProp = getterSetterProperty(\n-                              ppos, pname, isGet);\n-                        pname.setJsDocNode(jsdocNode);\n-                        elems.add(objectProp);\n+                          propertyName = ts.getString();\n+                          ObjectProperty objectProp = getterSetterProperty(\n+                                  ppos, pname, isGet);\n+                          pname.setJsDocNode(jsdocNode);\n+                          elems.add(objectProp);\n                       }\n                   } else {\n-                      AstNode pname = name;\n+                      name.setJsDocNode(jsdocNode);\n+                      elems.add(plainProperty(name, tt));\n+                  }\n+                  break;\n+\n+              case Token.RC:\n+                  if (afterComma != -1)\n+                      warnTrailingComma(pos, elems, afterComma);\n+                  break commaLoop;\n+\n+              default:\n+                  AstNode pname = objliteralProperty();\n+                  if (pname == null) {\n+                      propertyName = null;\n+                  } else {\n+                      propertyName = ts.getString();\n                       pname.setJsDocNode(jsdocNode);\n                       elems.add(plainProperty(pname, tt));\n                   }\n                   break;\n-\n-              case Token.RC:\n-                  if (afterComma != -1)\n-                      warnTrailingComma(pos, elems, afterComma);\n-                  break commaLoop;\n-\n-              default:\n-                  AstNode pname = objliteralProperty();\n-                  if (pname == null) {\n-                    propertyName = null;\n-                  } else {\n-                    afterComma = -1;\n-                    propertyName = ts.getString();\n-                    pname.setJsDocNode(jsdocNode);\n-                    elems.add(plainProperty(pname, tt));\n-                  }\n-                  break;\n             }\n \n             if (this.inUseStrictDirective && propertyName != null) {\n                 switch (entryKind) {\n                 case PROP_ENTRY:\n                     if (getterNames.contains(propertyName)\n-                        || setterNames.contains(propertyName)) {\n+                            || setterNames.contains(propertyName)) {\n                         addError(\"msg.dup.obj.lit.prop.strict\", propertyName);\n                     }\n                     getterNames.add(propertyName);\n                     break;\n                 case GET_ENTRY:\n                     if (getterNames.contains(propertyName)) {\n-                      addError(\"msg.dup.obj.lit.prop.strict\", propertyName);\n+                        addError(\"msg.dup.obj.lit.prop.strict\", propertyName);\n                     }\n                     getterNames.add(propertyName);\n                     break;\n                 case SET_ENTRY:\n                     if (setterNames.contains(propertyName)) {\n-                      addError(\"msg.dup.obj.lit.prop.strict\", propertyName);\n+                        addError(\"msg.dup.obj.lit.prop.strict\", propertyName);\n                     }\n                     setterNames.add(propertyName);\n                     break;\n \n           case Token.NUMBER:\n               pname = new NumberLiteral(\n-                  ts.tokenBeg, ts.getString(), ts.getNumber());\n+                      ts.tokenBeg, ts.getString(), ts.getNumber());\n               break;\n \n           default:\n               if (compilerEnv.isReservedKeywordAsIdentifier()\n-                  && TokenStream.isKeyword(ts.getString())) {\n+                      && TokenStream.isKeyword(ts.getString())) {\n                   // convert keyword to property name, e.g. ({if: 1})\n                   pname = createNameNode();\n                   break;\n         prevNameTokenStart = pos;\n         prevNameTokenString = name;\n         prevNameTokenLineno = lineno;\n-    }\n-\n-    // Check whether token is a reserved keyword that is allowed as property id.\n-    private boolean convertToName(int token) {\n-        if (compilerEnv.isReservedKeywordAsIdentifier()) {\n-            String conv = Token.keywordToName(token);\n-            if (conv != null) {\n-                saveNameTokenData(ts.tokenBeg, conv, ts.lineno);\n-                return true;\n-            }\n-        }\n-        return false;\n     }\n \n     /**\n--- a/lib/rhino/src/org/mozilla/javascript/PolicySecurityController.java\n+++ b/lib/rhino/src/org/mozilla/javascript/PolicySecurityController.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/Ref.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Ref.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov, igor@fastmail.fm\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/RefCallable.java\n+++ b/lib/rhino/src/org/mozilla/javascript/RefCallable.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov, igor@mir2.org\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/RegExpProxy.java\n+++ b/lib/rhino/src/org/mozilla/javascript/RegExpProxy.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/RhinoException.java\n+++ b/lib/rhino/src/org/mozilla/javascript/RhinoException.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n \n package org.mozilla.javascript;\n--- a/lib/rhino/src/org/mozilla/javascript/RhinoSecurityManager.java\n+++ b/lib/rhino/src/org/mozilla/javascript/RhinoSecurityManager.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript;\n \n /**\n--- a/lib/rhino/src/org/mozilla/javascript/Script.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Script.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/ScriptRuntime.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ScriptRuntime.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Patrick Beard\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Mike Harm\n- *   Ethan Hugg\n- *   Bob Jervis\n- *   Roger Lawrence\n- *   Terry Lucas\n- *   Frank Mitchell\n- *   Milen Nankov\n- *   Hannes Wallnoefer\n- *   Andrew Wason\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n             if (isName) {\n                 return Boolean.TRUE;\n             }\n-            String idStr = (id == null) ? \"null\" : id.toString();\n-            throw typeError2(\"msg.undef.prop.delete\", toString(obj), idStr);\n+            throw undefDeleteError(obj, id);\n         }\n         boolean result = deleteObjectElem(sobj, id, cx);\n         return wrapBoolean(result);\n                 // Don't overwrite existing def if already defined in object\n                 // or prototypes of object.\n                 if (!ScriptableObject.hasProperty(scope, name)) {\n-                    if (!evalScript) {\n+                    if (isConst) {\n+                        ScriptableObject.defineConstProperty(varScope, name);\n+                    } else if (!evalScript) {\n                         // Global var definitions are supposed to be DONTDELETE\n-                        if (isConst)\n-                            ScriptableObject.defineConstProperty(varScope, name);\n-                        else\n-                            ScriptableObject.defineProperty(\n-                                varScope, name, Undefined.instance,\n-                                ScriptableObject.PERMANENT);\n+                        ScriptableObject.defineProperty(\n+                            varScope, name, Undefined.instance,\n+                            ScriptableObject.PERMANENT);\n                     } else {\n                         varScope.put(name, varScope, Undefined.instance);\n                     }\n         Object obj;\n         boolean cacheObj;\n \n-      getObj:\n         if (t instanceof JavaScriptException) {\n             cacheObj = false;\n             obj = ((JavaScriptException)t).getValue();\n                 NativeObject last = (NativeObject)lastCatchScope;\n                 obj = last.getAssociatedValue(t);\n                 if (obj == null) Kit.codeBug();\n-                break getObj;\n-            }\n-\n-            RhinoException re;\n-            String errorName;\n-            String errorMsg;\n-            Throwable javaException = null;\n-\n-            if (t instanceof EcmaError) {\n-                EcmaError ee = (EcmaError)t;\n-                re = ee;\n-                errorName = ee.getName();\n-                errorMsg = ee.getErrorMessage();\n-            } else if (t instanceof WrappedException) {\n-                WrappedException we = (WrappedException)t;\n-                re = we;\n-                javaException = we.getWrappedException();\n-                errorName = \"JavaException\";\n-                errorMsg = javaException.getClass().getName()\n-                           +\": \"+javaException.getMessage();\n-            } else if (t instanceof EvaluatorException) {\n-                // Pure evaluator exception, nor WrappedException instance\n-                EvaluatorException ee = (EvaluatorException)t;\n-                re = ee;\n-                errorName = \"InternalError\";\n-                errorMsg = ee.getMessage();\n-            } else if (cx.hasFeature(Context.FEATURE_ENHANCED_JAVA_ACCESS)) {\n-                // With FEATURE_ENHANCED_JAVA_ACCESS, scripts can catch\n-                // all exception types\n-                re = new WrappedException(t);\n-                errorName = \"JavaException\";\n-                errorMsg = t.toString();\n             } else {\n-                // Script can catch only instances of JavaScriptException,\n-                // EcmaError and EvaluatorException\n-                throw Kit.codeBug();\n-            }\n-\n-            String sourceUri = re.sourceName();\n-            if (sourceUri == null) {\n-                sourceUri = \"\";\n-            }\n-            int line = re.lineNumber();\n-            Object args[];\n-            if (line > 0) {\n-                args = new Object[] { errorMsg, sourceUri, Integer.valueOf(line) };\n-            } else {\n-                args = new Object[] { errorMsg, sourceUri };\n-            }\n-\n-            Scriptable errorObject = cx.newObject(scope, errorName, args);\n-            ScriptableObject.putProperty(errorObject, \"name\", errorName);\n-            // set exception in Error objects to enable non-ECMA \"stack\" property\n-            if (errorObject instanceof NativeError) {\n-                ((NativeError) errorObject).setStackProvider(re);\n-            }\n-\n-            if (javaException != null && isVisible(cx, javaException)) {\n-                Object wrap = cx.getWrapFactory().wrap(cx, scope, javaException,\n-                                                       null);\n-                ScriptableObject.defineProperty(\n-                    errorObject, \"javaException\", wrap,\n-                    ScriptableObject.PERMANENT | ScriptableObject.READONLY);\n-            }\n-            if (isVisible(cx, re)) {\n-                Object wrap = cx.getWrapFactory().wrap(cx, scope, re, null);\n-                ScriptableObject.defineProperty(\n-                        errorObject, \"rhinoException\", wrap,\n-                        ScriptableObject.PERMANENT | ScriptableObject.READONLY);\n-            }\n-            obj = errorObject;\n+                obj = wrapException(t, scope, cx);\n+            }\n         }\n \n         NativeObject catchScopeObject = new NativeObject();\n             catchScopeObject.associateValue(t, obj);\n         }\n         return catchScopeObject;\n+    }\n+\n+    public static Scriptable wrapException(Throwable t,\n+                                           Scriptable scope,\n+                                           Context cx) {\n+        RhinoException re;\n+        String errorName;\n+        String errorMsg;\n+        Throwable javaException = null;\n+\n+        if (t instanceof EcmaError) {\n+            EcmaError ee = (EcmaError)t;\n+            re = ee;\n+            errorName = ee.getName();\n+            errorMsg = ee.getErrorMessage();\n+        } else if (t instanceof WrappedException) {\n+            WrappedException we = (WrappedException)t;\n+            re = we;\n+            javaException = we.getWrappedException();\n+            errorName = \"JavaException\";\n+            errorMsg = javaException.getClass().getName()\n+                       +\": \"+javaException.getMessage();\n+        } else if (t instanceof EvaluatorException) {\n+            // Pure evaluator exception, nor WrappedException instance\n+            EvaluatorException ee = (EvaluatorException)t;\n+            re = ee;\n+            errorName = \"InternalError\";\n+            errorMsg = ee.getMessage();\n+        } else if (cx.hasFeature(Context.FEATURE_ENHANCED_JAVA_ACCESS)) {\n+            // With FEATURE_ENHANCED_JAVA_ACCESS, scripts can catch\n+            // all exception types\n+            re = new WrappedException(t);\n+            errorName = \"JavaException\";\n+            errorMsg = t.toString();\n+        } else {\n+            // Script can catch only instances of JavaScriptException,\n+            // EcmaError and EvaluatorException\n+            throw Kit.codeBug();\n+        }\n+\n+        String sourceUri = re.sourceName();\n+        if (sourceUri == null) {\n+            sourceUri = \"\";\n+        }\n+        int line = re.lineNumber();\n+        Object args[];\n+        if (line > 0) {\n+            args = new Object[] { errorMsg, sourceUri, Integer.valueOf(line) };\n+        } else {\n+            args = new Object[] { errorMsg, sourceUri };\n+        }\n+\n+        Scriptable errorObject = cx.newObject(scope, errorName, args);\n+        ScriptableObject.putProperty(errorObject, \"name\", errorName);\n+        // set exception in Error objects to enable non-ECMA \"stack\" property\n+        if (errorObject instanceof NativeError) {\n+            ((NativeError) errorObject).setStackProvider(re);\n+        }\n+\n+        if (javaException != null && isVisible(cx, javaException)) {\n+            Object wrap = cx.getWrapFactory().wrap(cx, scope, javaException,\n+                                                   null);\n+            ScriptableObject.defineProperty(\n+                errorObject, \"javaException\", wrap,\n+                ScriptableObject.PERMANENT | ScriptableObject.READONLY);\n+        }\n+        if (isVisible(cx, re)) {\n+            Object wrap = cx.getWrapFactory().wrap(cx, scope, re, null);\n+            ScriptableObject.defineProperty(\n+                    errorObject, \"rhinoException\", wrap,\n+                    ScriptableObject.PERMANENT | ScriptableObject.READONLY);\n+        }\n+        return errorObject;\n     }\n \n     private static boolean isVisible(Context cx, Object obj) {\n \n     public static RuntimeException undefReadError(Object object, Object id)\n     {\n-        String idStr = (id == null) ? \"null\" : id.toString();\n-        return typeError2(\"msg.undef.prop.read\", toString(object), idStr);\n+        return typeError2(\"msg.undef.prop.read\", toString(object), toString(id));\n     }\n \n     public static RuntimeException undefCallError(Object object, Object id)\n     {\n-        String idStr = (id == null) ? \"null\" : id.toString();\n-        return typeError2(\"msg.undef.method.call\", toString(object), idStr);\n+        return typeError2(\"msg.undef.method.call\", toString(object), toString(id));\n     }\n \n     public static RuntimeException undefWriteError(Object object,\n                                                    Object id,\n                                                    Object value)\n     {\n-        String idStr = (id == null) ? \"null\" : id.toString();\n-        String valueStr = (value instanceof Scriptable)\n-                          ? value.toString() : toString(value);\n-        return typeError3(\"msg.undef.prop.write\", toString(object), idStr,\n-                          valueStr);\n+        return typeError3(\"msg.undef.prop.write\", toString(object), toString(id),\n+                          toString(value));\n+    }\n+\n+    private static RuntimeException undefDeleteError(Object object, Object id)\n+    {\n+        throw typeError2(\"msg.undef.prop.delete\", toString(object), toString(id));\n     }\n \n     public static RuntimeException notFoundError(Scriptable object,\n         String objString = toString(obj);\n         if (obj instanceof NativeFunction) {\n             // Omit function body in string representations of functions\n-            int curly = objString.indexOf('{');\n+            int paren = objString.indexOf(')');\n+            int curly = objString.indexOf('{', paren);\n             if (curly > -1) {\n                 objString = objString.substring(0, curly + 1) + \"...}\";\n             }\n             throw Context.reportRuntimeError0(\"msg.no.regexp\");\n         }\n         return result;\n+    }\n+\n+    public static Scriptable wrapRegExp(Context cx, Scriptable scope,\n+                                        Object compiled) {\n+        return cx.getRegExpProxy().wrapRegExp(cx, scope, compiled);\n     }\n \n     private static XMLLib currentXMLLib(Context cx)\n--- a/lib/rhino/src/org/mozilla/javascript/ScriptStackElement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ScriptStackElement.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript;\n \n import java.io.Serializable;\n--- a/lib/rhino/src/org/mozilla/javascript/Scriptable.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Scriptable.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/ScriptableObject.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ScriptableObject.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Daniel Gredler\n- *   Bob Jervis\n- *   Roger Lawrence\n- *   Cameron McCormack\n- *   Steve Weiss\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n         Scriptable proto = (Scriptable) protoCtor.newInstance(ScriptRuntime.emptyArgs);\n         String className = proto.getClassName();\n \n+        // check for possible redefinition\n+        Object existing = getProperty(getTopLevelScope(scope), className);\n+        if (existing instanceof BaseFunction) {\n+            Object existingProto = ((BaseFunction)existing).getPrototypeProperty();\n+            if (existingProto != null && clazz.equals(existingProto.getClass())) {\n+                return (BaseFunction)existing;\n+            }\n+        }\n+\n         // Set the prototype's prototype, trying to map Java inheritance to JS\n         // prototype-based inheritance if requested to do so.\n         Scriptable superProto = null;\n             ConstProperties cp = (ConstProperties)base;\n \n             if (cp.isConst(name))\n-                throw Context.reportRuntimeError1(\"msg.const.redecl\", name);\n+                throw ScriptRuntime.typeError1(\"msg.const.redecl\", name);\n         }\n         if (isConst)\n-            throw Context.reportRuntimeError1(\"msg.var.redecl\", name);\n+            throw ScriptRuntime.typeError1(\"msg.var.redecl\", name);\n     }\n     /**\n      * Returns whether an indexed property is defined in an object or any object\n--- a/lib/rhino/src/org/mozilla/javascript/SecureCaller.java\n+++ b/lib/rhino/src/org/mozilla/javascript/SecureCaller.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/SecurityController.java\n+++ b/lib/rhino/src/org/mozilla/javascript/SecurityController.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/SecurityUtilities.java\n+++ b/lib/rhino/src/org/mozilla/javascript/SecurityUtilities.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/SpecialRef.java\n+++ b/lib/rhino/src/org/mozilla/javascript/SpecialRef.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov, igor@fastmail.fm\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/Synchronizer.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Synchronizer.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Delegator.java, released\n- * Sep 27, 2000.\n- *\n- * The Initial Developer of the Original Code is\n- * Matthias Radestock. <matthias@sorted.org>.\n- * Portions created by the Initial Developer are Copyright (C) 2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/Token.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Token.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Roger Lawrence\n- *   Mike McCabe\n- *   Igor Bukanov\n- *   Bob Jervis\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/TokenStream.java\n+++ b/lib/rhino/src/org/mozilla/javascript/TokenStream.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Roger Lawrence\n- *   Mike McCabe\n- *   Igor Bukanov\n- *   Ethan Hugg\n- *   Bob Jervis\n- *   Terry Lucas\n- *   Milen Nankov\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/TopLevel.java\n+++ b/lib/rhino/src/org/mozilla/javascript/TopLevel.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n  package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/UintMap.java\n+++ b/lib/rhino/src/org/mozilla/javascript/UintMap.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/Undefined.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Undefined.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/UniqueTag.java\n+++ b/lib/rhino/src/org/mozilla/javascript/UniqueTag.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/VMBridge.java\n+++ b/lib/rhino/src/org/mozilla/javascript/VMBridge.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/WrapFactory.java\n+++ b/lib/rhino/src/org/mozilla/javascript/WrapFactory.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/WrappedException.java\n+++ b/lib/rhino/src/org/mozilla/javascript/WrappedException.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript;\n \n--- a/lib/rhino/src/org/mozilla/javascript/Wrapper.java\n+++ b/lib/rhino/src/org/mozilla/javascript/Wrapper.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/annotations/JSConstructor.java\n+++ b/lib/rhino/src/org/mozilla/javascript/annotations/JSConstructor.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.annotations;\n \n import java.lang.annotation.*;\n--- a/lib/rhino/src/org/mozilla/javascript/annotations/JSFunction.java\n+++ b/lib/rhino/src/org/mozilla/javascript/annotations/JSFunction.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.annotations;\n \n import java.lang.annotation.*;\n--- a/lib/rhino/src/org/mozilla/javascript/annotations/JSGetter.java\n+++ b/lib/rhino/src/org/mozilla/javascript/annotations/JSGetter.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.annotations;\n \n import java.lang.annotation.*;\n--- a/lib/rhino/src/org/mozilla/javascript/annotations/JSSetter.java\n+++ b/lib/rhino/src/org/mozilla/javascript/annotations/JSSetter.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.annotations;\n \n import java.lang.annotation.*;\n--- a/lib/rhino/src/org/mozilla/javascript/annotations/JSStaticFunction.java\n+++ b/lib/rhino/src/org/mozilla/javascript/annotations/JSStaticFunction.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.annotations;\n \n import java.lang.annotation.*;\n--- a/lib/rhino/src/org/mozilla/javascript/ast/ArrayComprehension.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ArrayComprehension.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ArrayComprehensionLoop.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ArrayComprehensionLoop.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ArrayLiteral.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ArrayLiteral.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/Assignment.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/Assignment.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/AstNode.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/AstNode.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/AstRoot.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/AstRoot.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/Block.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/Block.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *   Bob Jervis\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/BreakStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/BreakStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/CatchClause.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/CatchClause.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/Comment.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/Comment.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ConditionalExpression.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ConditionalExpression.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ContinueStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ContinueStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/DestructuringForm.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/DestructuringForm.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/DoLoop.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/DoLoop.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n     @Override\n     public String toSource(int depth) {\n         StringBuilder sb = new StringBuilder();\n+        sb.append(makeIndent(depth));\n         sb.append(\"do \");\n         sb.append(body.toSource(depth).trim());\n         sb.append(\" while (\");\n--- a/lib/rhino/src/org/mozilla/javascript/ast/ElementGet.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ElementGet.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/EmptyExpression.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/EmptyExpression.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/EmptyStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/EmptyStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ErrorCollector.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ErrorCollector.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ErrorNode.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ErrorNode.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ExpressionStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ExpressionStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ForInLoop.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ForInLoop.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n         sb.append(\" in \");\n         sb.append(iteratedObject.toSource(0));\n         sb.append(\") \");\n-        if (body instanceof Block) {\n+        if (body.getType() == Token.BLOCK) {\n             sb.append(body.toSource(depth).trim()).append(\"\\n\");\n         } else {\n             sb.append(\"\\n\").append(body.toSource(depth+1));\n--- a/lib/rhino/src/org/mozilla/javascript/ast/ForLoop.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ForLoop.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n         sb.append(\"; \");\n         sb.append(increment.toSource(0));\n         sb.append(\") \");\n-        if (body instanceof Block) {\n+        if (body.getType() == Token.BLOCK) {\n             sb.append(body.toSource(depth).trim()).append(\"\\n\");\n         } else {\n             sb.append(\"\\n\").append(body.toSource(depth+1));\n--- a/lib/rhino/src/org/mozilla/javascript/ast/FunctionCall.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/FunctionCall.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/FunctionNode.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/FunctionNode.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Bob Jervis\n- *   Norris Boyd\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/GeneratorExpression.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/GeneratorExpression.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Travis Ennis\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/GeneratorExpressionLoop.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/GeneratorExpressionLoop.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Travis Ennis\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/IdeErrorReporter.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/IdeErrorReporter.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/IfStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/IfStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n         sb.append(\"if (\");\n         sb.append(condition.toSource(0));\n         sb.append(\") \");\n-        if (!(thenPart instanceof Block)) {\n-            sb.append(\"\\n\").append(makeIndent(depth));\n+        if (thenPart.getType() != Token.BLOCK) {\n+            sb.append(\"\\n\").append(makeIndent(depth + 1));\n         }\n         sb.append(thenPart.toSource(depth).trim());\n-        if (elsePart instanceof IfStatement) {\n-            sb.append(\" else \");\n-            sb.append(elsePart.toSource(depth).trim());\n-        } else if (elsePart != null) {\n-            sb.append(\" else \");\n+        if (elsePart != null) {\n+            if (thenPart.getType() != Token.BLOCK) {\n+                sb.append(\"\\n\").append(pad).append(\"else \");\n+            } else {\n+                sb.append(\" else \");\n+            }\n+            if (elsePart.getType() != Token.BLOCK\n+                    && elsePart.getType() != Token.IF) {\n+                sb.append(\"\\n\").append(makeIndent(depth + 1));\n+            }\n             sb.append(elsePart.toSource(depth).trim());\n         }\n         sb.append(\"\\n\");\n--- a/lib/rhino/src/org/mozilla/javascript/ast/InfixExpression.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/InfixExpression.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n     public void setLeft(AstNode left) {\n         assertNotNull(left);\n         this.left = left;\n+        // line number should agree with source position\n+        setLineno(left.getLineno());\n         left.setParent(this);\n     }\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/Jump.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/Jump.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Roshan James\n- *   Roger Lawrence\n- *   Mike McCabe\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/KeywordLiteral.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/KeywordLiteral.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/Label.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/Label.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/LabeledStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/LabeledStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n     }\n \n     @Override\n+    public boolean hasSideEffects() {\n+        // just to avoid the default case for EXPR_VOID in AstNode\n+        return true;\n+    }\n+\n+    @Override\n     public String toSource(int depth) {\n         StringBuilder sb = new StringBuilder();\n         for (Label label : labels) {\n--- a/lib/rhino/src/org/mozilla/javascript/ast/LetNode.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/LetNode.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/Loop.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/Loop.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/Name.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/Name.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/NewExpression.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/NewExpression.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/NodeVisitor.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/NodeVisitor.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/NumberLiteral.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/NumberLiteral.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ObjectLiteral.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ObjectLiteral.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ObjectProperty.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ObjectProperty.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ParenthesizedExpression.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ParenthesizedExpression.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ParseProblem.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ParseProblem.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/PropertyGet.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/PropertyGet.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/RegExpLiteral.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/RegExpLiteral.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ReturnStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ReturnStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/Scope.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/Scope.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Roger Lawrence\n- *   Mike McCabe\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ScriptNode.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ScriptNode.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Bob Jervis\n- *   Norris Boyd\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/StringLiteral.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/StringLiteral.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/SwitchCase.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/SwitchCase.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/SwitchStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/SwitchStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/Symbol.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/Symbol.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Roger Lawrence\n- *   Mike McCabe\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/ThrowStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/ThrowStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/TryStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/TryStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/UnaryExpression.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/UnaryExpression.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/VariableDeclaration.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/VariableDeclaration.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/VariableInitializer.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/VariableInitializer.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/WhileLoop.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/WhileLoop.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n         sb.append(\"while (\");\n         sb.append(condition.toSource(0));\n         sb.append(\") \");\n-        if (body instanceof Block) {\n+        if (body.getType() == Token.BLOCK) {\n             sb.append(body.toSource(depth).trim());\n             sb.append(\"\\n\");\n         } else {\n--- a/lib/rhino/src/org/mozilla/javascript/ast/WithStatement.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/WithStatement.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n         sb.append(\"with (\");\n         sb.append(expression.toSource(0));\n         sb.append(\") \");\n-        sb.append(statement.toSource(depth+1));\n-        if (!(statement instanceof Block)) {\n-            sb.append(\";\\n\");\n+        if (statement.getType() == Token.BLOCK) {\n+            sb.append(statement.toSource(depth).trim());\n+            sb.append(\"\\n\");\n+        } else {\n+            sb.append(\"\\n\").append(statement.toSource(depth + 1));\n         }\n         return sb.toString();\n     }\n--- a/lib/rhino/src/org/mozilla/javascript/ast/XmlDotQuery.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/XmlDotQuery.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/XmlElemRef.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/XmlElemRef.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/XmlExpression.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/XmlExpression.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/XmlFragment.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/XmlFragment.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/XmlLiteral.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/XmlLiteral.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/XmlMemberGet.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/XmlMemberGet.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/XmlPropRef.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/XmlPropRef.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/XmlRef.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/XmlRef.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/XmlString.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/XmlString.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/ast/Yield.java\n+++ b/lib/rhino/src/org/mozilla/javascript/ast/Yield.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Steve Yegge\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.ast;\n \n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/ModuleScope.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/ModuleScope.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module;\n \n import org.mozilla.javascript.Scriptable;\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/ModuleScript.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/ModuleScript.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module;\n \n import java.io.Serializable;\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/ModuleScriptProvider.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/ModuleScriptProvider.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module;\n \n import org.mozilla.javascript.Context;\n      * @param moduleUri the URI of the module. If this is not null, resolution\n      * of <code>moduleId</code> is bypassed and the script is directly loaded\n      * from <code>moduleUri</code>\n+     * @param baseUri the module path base URI from which <code>moduleUri</code>\n+     * was derived.\n      * @param paths the value of the require() function's \"paths\" attribute. If\n      * the require() function is sandboxed, it will be null, otherwise it will\n      * be a JavaScript Array object. It is up to the provider implementation\n      * valid absolute module identifier.\n      */\n     public ModuleScript getModuleScript(Context cx, String moduleId,\n-            URI moduleUri, Scriptable paths)\n+            URI moduleUri, URI baseUri, Scriptable paths)\n             throws Exception;\n \n }\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/Require.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/Require.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module;\n \n import java.io.File;\n         try {\n             // try to get the module script to see if it is on the module path\n             moduleScript = moduleScriptProvider.getModuleScript(\n-                    cx, mainModuleId, null, paths);\n+                    cx, mainModuleId, null, null, paths);\n         } catch (RuntimeException x) {\n             throw x;\n         } catch (Exception x) {\n \n         if (moduleScript != null) {\n             mainExports = getExportedModuleInterface(cx, mainModuleId,\n-                    null, true);\n+                    null, null, true);\n         } else if (!sandboxed) {\n \n             URI mainUri = null;\n                 mainUri = file.toURI();\n             }\n             mainExports = getExportedModuleInterface(cx, mainUri.toString(),\n-                    mainUri, true);\n+                    mainUri, null, true);\n         }\n \n         this.mainModuleId = mainModuleId;\n \n         String id = (String)Context.jsToJava(args[0], String.class);\n         URI uri = null;\n+        URI base = null;\n         if (id.startsWith(\"./\") || id.startsWith(\"../\")) {\n             if (!(thisObj instanceof ModuleScope)) {\n                 throw ScriptRuntime.throwError(cx, scope,\n             }\n \n             ModuleScope moduleScope = (ModuleScope) thisObj;\n-            URI base = moduleScope.getBase();\n+            base = moduleScope.getBase();\n             URI current = moduleScope.getUri();\n             uri = current.resolve(id);\n \n                 }\n             }\n         }\n-        return getExportedModuleInterface(cx, id, uri, false);\n+        return getExportedModuleInterface(cx, id, uri, base, false);\n     }\n \n     public Scriptable construct(Context cx, Scriptable scope, Object[] args) {\n     }\n \n     private Scriptable getExportedModuleInterface(Context cx, String id,\n-            URI uri, boolean isMain)\n+            URI uri, URI base, boolean isMain)\n     {\n         // Check if the requested module is already completely loaded\n         Scriptable exports = exportedModuleInterfaces.get(id);\n                 return exports;\n             }\n             // Nope, still not loaded; we're loading it then.\n-            final ModuleScript moduleScript = getModule(cx, id, uri);\n+            final ModuleScript moduleScript = getModule(cx, id, uri, base);\n             if (sandboxed && !moduleScript.isSandboxed()) {\n                 throw ScriptRuntime.throwError(cx, nativeScope, \"Module \\\"\"\n                         + id + \"\\\" is not contained in sandbox.\");\n                 ScriptableObject.PERMANENT);\n     }\n \n-    private ModuleScript getModule(Context cx, String id, URI uri) {\n+    private ModuleScript getModule(Context cx, String id, URI uri, URI base) {\n         try {\n             final ModuleScript moduleScript =\n-                    moduleScriptProvider.getModuleScript(cx, id, uri, paths);\n+                    moduleScriptProvider.getModuleScript(cx, id, uri, base, paths);\n             if (moduleScript == null) {\n                 throw ScriptRuntime.throwError(cx, nativeScope, \"Module \\\"\"\n                         + id + \"\\\" not found.\");\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/RequireBuilder.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/RequireBuilder.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module;\n \n import java.io.Serializable;\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/CachingModuleScriptProviderBase.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/CachingModuleScriptProviderBase.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.io.Reader;\n     }\n \n     public ModuleScript getModuleScript(Context cx, String moduleId,\n-            URI moduleUri, Scriptable paths) throws Exception\n+            URI moduleUri, URI baseUri, Scriptable paths) throws Exception\n     {\n         final CachedModuleScript cachedModule1 = getLoadedModule(moduleId);\n         final Object validator1 = getValidator(cachedModule1);\n         final ModuleSource moduleSource = (moduleUri == null)\n                 ? moduleSourceProvider.loadSource(moduleId, paths, validator1)\n-                : moduleSourceProvider.loadSource(moduleUri, validator1);\n+                : moduleSourceProvider.loadSource(moduleUri, baseUri, validator1);\n         if(moduleSource == ModuleSourceProvider.NOT_MODIFIED) {\n             return cachedModule1.getModule();\n         }\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/DefaultUrlConnectionExpiryCalculator.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/DefaultUrlConnectionExpiryCalculator.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.io.Serializable;\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/ModuleSource.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/ModuleSource.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.io.Reader;\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/ModuleSourceProvider.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/ModuleSourceProvider.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.io.IOException;\n {\n     /**\n      * A special return value for {@link #loadSource(String, Scriptable,\n-     * Object)} and {@link #loadSource(URI, Object)} that signifies that the\n+     * Object)} and {@link #loadSource(URI, URI, Object)} that signifies that the\n      * cached representation is still valid according to the passed validator.\n      */\n     public static final ModuleSource NOT_MODIFIED = new ModuleSource(null,\n      * validator for it, and a security domain, where applicable.\n      * @param uri the absolute URI from which to load the module source, but\n      * without an extension such as \".js\".\n+     * @param baseUri the module path base URI from which <code>uri</code>\n+     * was derived.\n      * @param validator a validator for an existing loaded and cached module.\n      * This will either be null, or an object that this source provider\n      * returned earlier as part of a {@link ModuleSource}. It can be used to\n      * @throws IOException if there was an I/O problem reading the script\n      * @throws URISyntaxException if the final URI could not be constructed\n      */\n-    public ModuleSource loadSource(URI uri, Object validator)\n+    public ModuleSource loadSource(URI uri, URI baseUri, Object validator)\n             throws IOException, URISyntaxException;\n }\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/ModuleSourceProviderBase.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/ModuleSourceProviderBase.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.io.File;\n         return loadFromFallbackLocations(moduleId, validator);\n     }\n \n-    public ModuleSource loadSource(URI uri, Object validator)\n+    public ModuleSource loadSource(URI uri, URI base, Object validator)\n             throws IOException, URISyntaxException {\n-        return loadFromUri(uri, null, validator);\n+        return loadFromUri(uri, base, validator);\n     }\n \n     private ModuleSource loadFromPathArray(String moduleId,\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/MultiModuleScriptProvider.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/MultiModuleScriptProvider.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.net.URI;\n     }\n \n     public ModuleScript getModuleScript(Context cx, String moduleId, URI uri,\n-                                        Scriptable paths) throws Exception {\n+                                        URI base, Scriptable paths) throws Exception {\n         for (ModuleScriptProvider provider : providers) {\n             final ModuleScript script = provider.getModuleScript(cx, moduleId,\n-                    uri, paths);\n+                    uri, base, paths);\n             if(script != null) {\n                 return script;\n             }\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/ParsedContentType.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/ParsedContentType.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.io.Serializable;\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/SoftCachingModuleScriptProvider.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/SoftCachingModuleScriptProvider.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.io.IOException;\n \n     @Override\n     public ModuleScript getModuleScript(Context cx, String moduleId,\n-            URI uri, Scriptable paths)\n+            URI uri, URI base, Scriptable paths)\n             throws Exception\n     {\n         // Overridden to clear the reference queue before retrieving the\n             }\n             scripts.remove(ref.getModuleId(), ref);\n         }\n-        return super.getModuleScript(cx, moduleId, uri, paths);\n+        return super.getModuleScript(cx, moduleId, uri, base, paths);\n     }\n \n     @Override\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/StrongCachingModuleScriptProvider.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/StrongCachingModuleScriptProvider.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.util.Map;\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/UrlConnectionExpiryCalculator.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/UrlConnectionExpiryCalculator.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.net.URLConnection;\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/UrlConnectionSecurityDomainProvider.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/UrlConnectionSecurityDomainProvider.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.net.URLConnection;\n--- a/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/UrlModuleSourceProvider.java\n+++ b/lib/rhino/src/org/mozilla/javascript/commonjs/module/provider/UrlModuleSourceProvider.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.commonjs.module.provider;\n \n import java.io.FileNotFoundException;\n--- a/lib/rhino/src/org/mozilla/javascript/debug/DebugFrame.java\n+++ b/lib/rhino/src/org/mozilla/javascript/debug/DebugFrame.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/debug/DebuggableObject.java\n+++ b/lib/rhino/src/org/mozilla/javascript/debug/DebuggableObject.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/debug/DebuggableScript.java\n+++ b/lib/rhino/src/org/mozilla/javascript/debug/DebuggableScript.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/debug/Debugger.java\n+++ b/lib/rhino/src/org/mozilla/javascript/debug/Debugger.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/jdk13/VMBridge_jdk13.java\n+++ b/lib/rhino/src/org/mozilla/javascript/jdk13/VMBridge_jdk13.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.jdk13;\n \n--- a/lib/rhino/src/org/mozilla/javascript/jdk15/VMBridge_jdk15.java\n+++ b/lib/rhino/src/org/mozilla/javascript/jdk15/VMBridge_jdk15.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.jdk15;\n \n--- a/lib/rhino/src/org/mozilla/javascript/json/JsonParser.java\n+++ b/lib/rhino/src/org/mozilla/javascript/json/JsonParser.java\n /* -*- Mode: java; tab-width: 4; indent-tabs-mode: 1; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Raphael Speyer\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.json;\n \n     }\n \n     private Object readObject() throws ParseException {\n+        consumeWhitespace();\n         Scriptable object = cx.newObject(scope);\n+        // handle empty object literal case early\n+        if (pos < length && src.charAt(pos) == '}') {\n+            pos += 1;\n+            return object;\n+        }\n         String id;\n         Object value;\n         boolean needsComma = false;\n-        consumeWhitespace();\n         while (pos < length) {\n             char c = src.charAt(pos++);\n             switch(c) {\n                 case '}':\n+                    if (!needsComma) {\n+                        throw new ParseException(\"Unexpected comma in object literal\");\n+                    }\n                     return object;\n                 case ',':\n                     if (!needsComma) {\n     }\n \n     private Object readArray() throws ParseException {\n+        consumeWhitespace();\n+        // handle empty array literal case early\n+        if (pos < length && src.charAt(pos) == ']') {\n+            pos += 1;\n+            return cx.newArray(scope, 0);\n+        }\n         List<Object> list = new ArrayList<Object>();\n         boolean needsComma = false;\n-        consumeWhitespace();\n         while (pos < length) {\n             char c = src.charAt(pos);\n             switch(c) {\n                 case ']':\n+                    if (!needsComma) {\n+                        throw new ParseException(\"Unexpected comma in array literal\");\n+                    }\n                     pos += 1;\n                     return cx.newArray(scope, list.toArray());\n                 case ',':\n     }\n \n     private String readString() throws ParseException {\n-        StringBuilder b = new StringBuilder();\n+        /*\n+         * Optimization: if the source contains no escaped characters, create the\n+         * string directly from the source text.\n+         */\n+        int stringStart = pos;\n         while (pos < length) {\n             char c = src.charAt(pos++);\n             if (c <= '\\u001F') {\n                 throw new ParseException(\"String contains control character\");\n-            }\n-            switch(c) {\n+            } else if (c == '\\\\') {\n+                break;\n+            } else if (c == '\"') {\n+                return src.substring(stringStart, pos - 1);\n+            }\n+        }\n+\n+        /*\n+         * Slow case: string contains escaped characters.  Copy a maximal sequence\n+         * of unescaped characters into a temporary buffer, then an escaped\n+         * character, and repeat until the entire string is consumed.\n+         */\n+        StringBuilder b = new StringBuilder();\n+        while (pos < length) {\n+            assert src.charAt(pos - 1) == '\\\\';\n+            b.append(src, stringStart, pos - 1);\n+            if (pos >= length) {\n+                throw new ParseException(\"Unterminated string\");\n+            }\n+            char c = src.charAt(pos++);\n+            switch (c) {\n+                case '\"':\n+                    b.append('\"');\n+                    break;\n                 case '\\\\':\n-                    if (pos >= length) {\n-                        throw new ParseException(\"Unterminated string\");\n-                    }\n-                    c = src.charAt(pos++);\n-                    switch (c) {\n-                        case '\"':\n-                            b.append('\"');\n-                            break;\n-                        case '\\\\':\n-                            b.append('\\\\');\n-                            break;\n-                        case '/':\n-                            b.append('/');\n-                            break;\n-                        case 'b':\n-                            b.append('\\b');\n-                            break;\n-                        case 'f':\n-                            b.append('\\f');\n-                            break;\n-                        case 'n':\n-                            b.append('\\n');\n-                            break;\n-                        case 'r':\n-                            b.append('\\r');\n-                            break;\n-                        case 't':\n-                            b.append('\\t');\n-                            break;\n-                        case 'u':\n-                            if (length - pos < 5) {\n-                                throw new ParseException(\"Invalid character code: \\\\u\" + src.substring(pos));\n-                            }\n-                            try {\n-                                b.append((char) Integer.parseInt(src.substring(pos, pos + 4), 16));\n-                                pos += 4;\n-                            } catch (NumberFormatException nfx) {\n-                                throw new ParseException(\"Invalid character code: \" + src.substring(pos, pos + 4));\n-                            }\n-                            break;\n-                        default:\n-                            throw new ParseException(\"Unexcpected character in string: '\\\\\" + c + \"'\");\n-                    }\n-                    break;\n-                case '\"':\n+                    b.append('\\\\');\n+                    break;\n+                case '/':\n+                    b.append('/');\n+                    break;\n+                case 'b':\n+                    b.append('\\b');\n+                    break;\n+                case 'f':\n+                    b.append('\\f');\n+                    break;\n+                case 'n':\n+                    b.append('\\n');\n+                    break;\n+                case 'r':\n+                    b.append('\\r');\n+                    break;\n+                case 't':\n+                    b.append('\\t');\n+                    break;\n+                case 'u':\n+                    if (length - pos < 5) {\n+                        throw new ParseException(\"Invalid character code: \\\\u\" + src.substring(pos));\n+                    }\n+                    int code = fromHex(src.charAt(pos + 0)) << 12\n+                             | fromHex(src.charAt(pos + 1)) << 8\n+                             | fromHex(src.charAt(pos + 2)) << 4\n+                             | fromHex(src.charAt(pos + 3));\n+                    if (code < 0) {\n+                        throw new ParseException(\"Invalid character code: \" + src.substring(pos, pos + 4));\n+                    }\n+                    pos += 4;\n+                    b.append((char) code);\n+                    break;\n+                default:\n+                    throw new ParseException(\"Unexpected character in string: '\\\\\" + c + \"'\");\n+            }\n+            stringStart = pos;\n+            while (pos < length) {\n+                c = src.charAt(pos++);\n+                if (c <= '\\u001F') {\n+                    throw new ParseException(\"String contains control character\");\n+                } else if (c == '\\\\') {\n+                    break;\n+                } else if (c == '\"') {\n+                    b.append(src, stringStart, pos - 1);\n                     return b.toString();\n-                default:\n-                    b.append(c);\n-                    break;\n+                }\n             }\n         }\n         throw new ParseException(\"Unterminated string literal\");\n     }\n \n-    private Number readNumber(char first) throws ParseException {\n-        StringBuilder b = new StringBuilder();\n-        b.append(first);\n-        while (pos < length) {\n+    private int fromHex(char c) {\n+        return c >= '0' && c <= '9' ? c - '0'\n+                : c >= 'A' && c <= 'F' ? c - 'A' + 10\n+                : c >= 'a' && c <= 'f' ? c - 'a' + 10\n+                : -1;\n+    }\n+\n+    private Number readNumber(char c) throws ParseException {\n+        assert c == '-' || (c >= '0' && c <= '9');\n+        final int numberStart = pos - 1;\n+        if (c == '-') {\n+            c = nextOrNumberError(numberStart);\n+            if (!(c >= '0' && c <= '9')) {\n+                throw numberError(numberStart, pos);\n+            }\n+        }\n+        if (c != '0') {\n+            readDigits();\n+        }\n+        // read optional fraction part\n+        if (pos < length) {\n+            c = src.charAt(pos);\n+            if (c == '.') {\n+                pos += 1;\n+                c = nextOrNumberError(numberStart);\n+                if (!(c >= '0' && c <= '9')) {\n+                    throw numberError(numberStart, pos);\n+                }\n+                readDigits();\n+            }\n+        }\n+        // read optional exponent part\n+        if (pos < length) {\n+            c = src.charAt(pos);\n+            if (c == 'e' || c == 'E') {\n+                pos += 1;\n+                c = nextOrNumberError(numberStart);\n+                if (c == '-' || c == '+') {\n+                    c = nextOrNumberError(numberStart);\n+                }\n+                if (!(c >= '0' && c <= '9')) {\n+                    throw numberError(numberStart, pos);\n+                }\n+                readDigits();\n+            }\n+        }\n+        String num = src.substring(numberStart, pos);\n+        final double dval = Double.parseDouble(num);\n+        final int ival = (int)dval;\n+        if (ival == dval) {\n+            return Integer.valueOf(ival);\n+        } else {\n+            return Double.valueOf(dval);\n+        }\n+    }\n+\n+    private ParseException numberError(int start, int end) {\n+        return new ParseException(\"Unsupported number format: \" + src.substring(start, end));\n+    }\n+\n+    private char nextOrNumberError(int numberStart) throws ParseException {\n+        if (pos >= length) {\n+            throw numberError(numberStart, length);\n+        }\n+        return src.charAt(pos++);\n+    }\n+\n+    private void readDigits() {\n+        for (; pos < length; ++pos) {\n             char c = src.charAt(pos);\n-            if (!Character.isDigit(c)\n-                    && c != '-'\n-                    && c != '+'\n-                    && c != '.'\n-                    && c != 'e'\n-                    && c != 'E') {\n+            if (!(c >= '0' && c <= '9')) {\n                 break;\n             }\n-            pos += 1;\n-            b.append(c);\n-        }\n-        String num = b.toString();\n-        int numLength = num.length();\n-        try {\n-            // check for leading zeroes\n-            for (int i = 0; i < numLength; i++) {\n-                char c = num.charAt(i);\n-                if (Character.isDigit(c)) {\n-                    if (c == '0'\n-                            && numLength > i + 1\n-                            && Character.isDigit(num.charAt(i + 1))) {\n-                        throw new ParseException(\"Unsupported number format: \" + num);\n-                    }\n-                    break;\n-                }\n-            }\n-            final double dval = Double.parseDouble(num);\n-            final int ival = (int)dval;\n-            if (ival == dval) {\n-                return Integer.valueOf(ival);\n-            } else {\n-                return Double.valueOf(dval);\n-            }\n-        } catch (NumberFormatException nfe) {\n-            throw new ParseException(\"Unsupported number format: \" + num);\n         }\n     }\n \n--- a/lib/rhino/src/org/mozilla/javascript/optimizer/Block.java\n+++ b/lib/rhino/src/org/mozilla/javascript/optimizer/Block.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Roger Lawrence\n- *   Cameron McCormack\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.optimizer;\n \n         if (DEBUG) {\n             ++debug_blockCount;\n             System.out.println(\"-------------------\"+fn.fnode.getFunctionName()+\"  \"+debug_blockCount+\"--------\");\n+            System.out.println(fn.fnode.toStringTree(fn.fnode));\n             System.out.println(toString(theBlocks, statementNodes));\n         }\n \n         return sw.toString();\n     }\n \n-    private static void reachingDefDataFlow(OptFunctionNode fn, Node[] statementNodes, Block theBlocks[], int[] varTypes)\n+    private static void reachingDefDataFlow(OptFunctionNode fn, Node[] statementNodes,\n+                                            Block theBlocks[], int[] varTypes)\n     {\n /*\n     initialize the liveOnEntry and liveOnExit sets, then discover the variables\n         theBlocks[0].markAnyTypeVariables(varTypes);\n     }\n \n-    private static void typeFlow(OptFunctionNode fn, Node[] statementNodes, Block theBlocks[], int[] varTypes)\n+    private static void typeFlow(OptFunctionNode fn, Node[] statementNodes,\n+                                 Block theBlocks[], int[] varTypes)\n     {\n         boolean visit[] = new boolean[theBlocks.length];\n         boolean doneOnce[] = new boolean[theBlocks.length];\n     private void lookForVariableAccess(OptFunctionNode fn, Node n)\n     {\n         switch (n.getType()) {\n+            case Token.TYPEOFNAME:\n+            {\n+                // TYPEOFNAME may be used with undefined names, which is why\n+                // this is handled separately from GETVAR above.\n+                int varIndex = fn.fnode.getIndexForNameNode(n);\n+                if (varIndex > -1 && !itsNotDefSet.get(varIndex))\n+                    itsUseBeforeDefSet.set(varIndex);\n+            }\n+            break;\n             case Token.DEC :\n             case Token.INC :\n             {\n                     if (!itsNotDefSet.get(varIndex))\n                         itsUseBeforeDefSet.set(varIndex);\n                     itsNotDefSet.set(varIndex);\n+                } else {\n+                    lookForVariableAccess(fn, child);\n                 }\n             }\n             break;\n                 return Optimizer.AnyType;\n \n             case Token.GETELEM:\n+            case Token.GETPROP:\n+            case Token.NAME:\n+            case Token.THIS:\n                 return Optimizer.AnyType;\n \n             case Token.GETVAR:\n             case Token.BITOR:\n             case Token.BITXOR:\n             case Token.BITAND:\n+            case Token.BITNOT:\n             case Token.LSH:\n             case Token.RSH:\n             case Token.URSH:\n             case Token.NEG:\n                 return Optimizer.NumberType;\n \n+            case Token.VOID:\n+                // NYI: undefined type\n+                return Optimizer.AnyType;\n+\n+            case Token.FALSE:\n+            case Token.TRUE:\n             case Token.EQ:\n             case Token.NE:\n             case Token.LT:\n             case Token.GE:\n             case Token.SHEQ:\n             case Token.SHNE:\n+            case Token.NOT:\n+            case Token.INSTANCEOF:\n+            case Token.IN:\n+            case Token.DEL_REF:\n+            case Token.DELPROP:\n+                // NYI: boolean type\n+                return Optimizer.AnyType;\n+\n+            case Token.STRING:\n+            case Token.TYPEOF:\n+            case Token.TYPEOFNAME:\n+                // NYI: string type\n+                return Optimizer.AnyType;\n+\n+            case Token.NULL:\n+            case Token.REGEXP:\n+            case Token.ARRAYCOMP:\n             case Token.ARRAYLIT:\n             case Token.OBJECTLIT:\n                 return Optimizer.AnyType; // XXX: actually, we know it's not\n                 int rType = findExpressionType(fn, child.getNext(), varTypes);\n                 return lType | rType;    // we're not distinguishing strings yet\n             }\n-        }\n-\n-        Node child = n.getFirstChild();\n-        if (child == null) {\n-            return Optimizer.AnyType;\n-        } else {\n-            int result = Optimizer.NoType;\n-            while (child != null) {\n-                result |= findExpressionType(fn, child, varTypes);\n-                child = child.getNext();\n-            }\n-            return result;\n-        }\n+\n+            case Token.HOOK: {\n+                Node ifTrue = n.getFirstChild().getNext();\n+                Node ifFalse = ifTrue.getNext();\n+                int ifTrueType = findExpressionType(fn, ifTrue, varTypes);\n+                int ifFalseType = findExpressionType(fn, ifFalse, varTypes);\n+                return ifTrueType | ifFalseType;\n+            }\n+\n+            case Token.COMMA:\n+            case Token.SETVAR:\n+            case Token.SETNAME:\n+            case Token.SETPROP:\n+            case Token.SETELEM:\n+                return findExpressionType(fn, n.getLastChild(), varTypes);\n+\n+            case Token.AND:\n+            case Token.OR: {\n+                Node child = n.getFirstChild();\n+                int lType = findExpressionType(fn, child, varTypes);\n+                int rType = findExpressionType(fn, child.getNext(), varTypes);\n+                return lType | rType;\n+            }\n+        }\n+\n+        return Optimizer.AnyType;\n     }\n \n     private static boolean findDefPoints(OptFunctionNode fn, Node n,\n                                          int[] varTypes)\n     {\n         boolean result = false;\n-        Node child = n.getFirstChild();\n+        Node first = n.getFirstChild();\n+        for (Node next = first; next != null; next = next.getNext()) {\n+            result |= findDefPoints(fn, next, varTypes);\n+        }\n         switch (n.getType()) {\n-            default :\n-                while (child != null) {\n-                    result |= findDefPoints(fn, child, varTypes);\n-                    child = child.getNext();\n-                }\n-                break;\n             case Token.DEC :\n             case Token.INC :\n-                if (child.getType() == Token.GETVAR) {\n+                if (first.getType() == Token.GETVAR) {\n                     // theVar is a Number now\n-                    int i = fn.getVarIndex(child);\n-                    result = assignType(varTypes, i, Optimizer.NumberType);\n-                }\n-                break;\n-            case Token.SETPROP :\n-            case Token.SETPROP_OP :\n-                if (child.getType() == Token.GETVAR) {\n-                    int i = fn.getVarIndex(child);\n-                    assignType(varTypes, i, Optimizer.AnyType);\n-                }\n-                while (child != null) {\n-                    result |= findDefPoints(fn, child, varTypes);\n-                    child = child.getNext();\n+                    int i = fn.getVarIndex(first);\n+                    result |= assignType(varTypes, i, Optimizer.NumberType);\n                 }\n                 break;\n             case Token.SETVAR : {\n-                Node rValue = child.getNext();\n+                Node rValue = first.getNext();\n                 int theType = findExpressionType(fn, rValue, varTypes);\n                 int i = fn.getVarIndex(n);\n-                result = assignType(varTypes, i, theType);\n+                result |= assignType(varTypes, i, theType);\n                 break;\n             }\n         }\n--- a/lib/rhino/src/org/mozilla/javascript/optimizer/ClassCompiler.java\n+++ b/lib/rhino/src/org/mozilla/javascript/optimizer/ClassCompiler.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.optimizer;\n \n--- a/lib/rhino/src/org/mozilla/javascript/optimizer/Codegen.java\n+++ b/lib/rhino/src/org/mozilla/javascript/optimizer/Codegen.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Kemal Bayram\n- *   Igor Bukanov\n- *   Bob Jervis\n- *   Roger Lawrence\n- *   Andi Vajda\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n \n package org.mozilla.javascript.optimizer;\n \n import java.util.*;\n import java.lang.reflect.Constructor;\n+\n+import static org.mozilla.classfile.ClassFileWriter.ACC_FINAL;\n+import static org.mozilla.classfile.ClassFileWriter.ACC_PRIVATE;\n+import static org.mozilla.classfile.ClassFileWriter.ACC_PUBLIC;\n+import static org.mozilla.classfile.ClassFileWriter.ACC_STATIC;\n+import static org.mozilla.classfile.ClassFileWriter.ACC_VOLATILE;\n \n /**\n  * This class generates code for a given IR tree.\n         throw new RuntimeException(\"Malformed optimizer package \" + e);\n     }\n \n-    byte[] compileToClassFile(CompilerEnvirons compilerEnv,\n-                              String mainClassName,\n-                              ScriptNode scriptOrFn,\n-                              String encodedSource,\n-                              boolean returnFunction)\n+    public byte[] compileToClassFile(CompilerEnvirons compilerEnv,\n+                                     String mainClassName,\n+                                     ScriptNode scriptOrFn,\n+                                     String encodedSource,\n+                                     boolean returnFunction)\n     {\n         this.compilerEnv = compilerEnv;\n \n         ClassFileWriter cfw = new ClassFileWriter(mainClassName,\n                                                   SUPER_CLASS_NAME,\n                                                   sourceFile);\n-        cfw.addField(ID_FIELD_NAME, \"I\",\n-                     ClassFileWriter.ACC_PRIVATE);\n-        cfw.addField(REGEXP_ARRAY_FIELD_NAME, REGEXP_ARRAY_FIELD_TYPE,\n-                     ClassFileWriter.ACC_PRIVATE);\n+        cfw.addField(ID_FIELD_NAME, \"I\", ACC_PRIVATE);\n \n         if (hasFunctions) {\n             generateFunctionConstructor(cfw);\n */\n         cfw.startMethod(getDirectCtorName(ofn.fnode),\n                         getBodyMethodSignature(ofn.fnode),\n-                        (short)(ClassFileWriter.ACC_STATIC\n-                                | ClassFileWriter.ACC_PRIVATE));\n+                        (short)(ACC_STATIC | ACC_PRIVATE));\n \n         int argCount = ofn.fnode.getParamCount();\n         int firstLocal = (4 + argCount * 3) + 1;\n                         \"Lorg/mozilla/javascript/Scriptable;\" +\n                         \"ILjava/lang/Object;\" +\n                         \"Ljava/lang/Object;)Ljava/lang/Object;\",\n-                        (short)(ClassFileWriter.ACC_PUBLIC\n-                                | ClassFileWriter.ACC_FINAL));\n+                        (short)(ACC_PUBLIC | ACC_FINAL));\n \n         // load arguments for dispatch to the corresponding *_gen method\n         cfw.addALoad(0);\n                         \"Lorg/mozilla/javascript/Scriptable;\" +\n                         \"Lorg/mozilla/javascript/Scriptable;\" +\n                         \"[Ljava/lang/Object;)Ljava/lang/Object;\",\n-                        (short)(ClassFileWriter.ACC_PUBLIC\n-                                | ClassFileWriter.ACC_FINAL));\n+                        (short)(ACC_PUBLIC | ACC_FINAL));\n \n         // Generate code for:\n         // if (!ScriptRuntime.hasTopCall(cx)) {\n     private void generateMain(ClassFileWriter cfw)\n     {\n         cfw.startMethod(\"main\", \"([Ljava/lang/String;)V\",\n-                        (short)(ClassFileWriter.ACC_PUBLIC\n-                                | ClassFileWriter.ACC_STATIC));\n+                        (short)(ACC_PUBLIC | ACC_STATIC));\n \n         // load new ScriptImpl()\n         cfw.add(ByteCode.NEW, cfw.getClassName());\n                         \"(Lorg/mozilla/javascript/Context;\"\n                         +\"Lorg/mozilla/javascript/Scriptable;\"\n                         +\")Ljava/lang/Object;\",\n-                        (short)(ClassFileWriter.ACC_PUBLIC\n-                                | ClassFileWriter.ACC_FINAL));\n+                        (short)(ACC_PUBLIC | ACC_FINAL));\n \n         final int CONTEXT_ARG = 1;\n         final int SCOPE_ARG = 2;\n \n     private void generateScriptCtor(ClassFileWriter cfw)\n     {\n-        cfw.startMethod(\"<init>\", \"()V\", ClassFileWriter.ACC_PUBLIC);\n+        cfw.startMethod(\"<init>\", \"()V\", ACC_PUBLIC);\n \n         cfw.addLoadThis();\n         cfw.addInvoke(ByteCode.INVOKESPECIAL, SUPER_CLASS_NAME,\n         final int CONTEXT_ARG = 2;\n         final int ID_ARG = 3;\n \n-        cfw.startMethod(\"<init>\", FUNCTION_CONSTRUCTOR_SIGNATURE,\n-                        ClassFileWriter.ACC_PUBLIC);\n+        cfw.startMethod(\"<init>\", FUNCTION_CONSTRUCTOR_SIGNATURE, ACC_PUBLIC);\n         cfw.addALoad(0);\n         cfw.addInvoke(ByteCode.INVOKESPECIAL, SUPER_CLASS_NAME,\n                       \"<init>\", \"()V\");\n         final int SCOPE_ARG = 2;\n         cfw.startMethod(getFunctionInitMethodName(ofn),\n                         FUNCTION_INIT_SIGNATURE,\n-                        (short)(ClassFileWriter.ACC_PRIVATE\n-                                | ClassFileWriter.ACC_FINAL));\n+                        (short)(ACC_PRIVATE | ACC_FINAL));\n \n         // Call NativeFunction.initScriptFunction\n         cfw.addLoadThis();\n                       +\")V\");\n \n         // precompile all regexp literals\n-        int regexpCount = ofn.fnode.getRegexpCount();\n-        if (regexpCount != 0) {\n-            cfw.addLoadThis();\n-            pushRegExpArray(cfw, ofn.fnode, CONTEXT_ARG, SCOPE_ARG);\n-            cfw.add(ByteCode.PUTFIELD, mainClassName,\n-                    REGEXP_ARRAY_FIELD_NAME, REGEXP_ARRAY_FIELD_TYPE);\n+        if (ofn.fnode.getRegexpCount() != 0) {\n+            cfw.addALoad(CONTEXT_ARG);\n+            cfw.addInvoke(ByteCode.INVOKESTATIC, mainClassName,\n+                          REGEXP_INIT_METHOD_NAME, REGEXP_INIT_METHOD_SIGNATURE);\n         }\n \n         cfw.add(ByteCode.RETURN);\n         // Override NativeFunction.getLanguageVersion() with\n         // public int getLanguageVersion() { return <version-constant>; }\n \n-        cfw.startMethod(\"getLanguageVersion\", \"()I\",\n-                        ClassFileWriter.ACC_PUBLIC);\n+        cfw.startMethod(\"getLanguageVersion\", \"()I\", ACC_PUBLIC);\n \n         cfw.addPush(compilerEnv.getLanguageVersion());\n         cfw.add(ByteCode.IRETURN);\n               case Do_getFunctionName:\n                 methodLocals = 1; // Only this\n                 cfw.startMethod(\"getFunctionName\", \"()Ljava/lang/String;\",\n-                                ClassFileWriter.ACC_PUBLIC);\n+                                ACC_PUBLIC);\n                 break;\n               case Do_getParamCount:\n                 methodLocals = 1; // Only this\n                 cfw.startMethod(\"getParamCount\", \"()I\",\n-                                ClassFileWriter.ACC_PUBLIC);\n+                                ACC_PUBLIC);\n                 break;\n               case Do_getParamAndVarCount:\n                 methodLocals = 1; // Only this\n                 cfw.startMethod(\"getParamAndVarCount\", \"()I\",\n-                                ClassFileWriter.ACC_PUBLIC);\n+                                ACC_PUBLIC);\n                 break;\n               case Do_getParamOrVarName:\n                 methodLocals = 1 + 1; // this + paramOrVarIndex\n                 cfw.startMethod(\"getParamOrVarName\", \"(I)Ljava/lang/String;\",\n-                                ClassFileWriter.ACC_PUBLIC);\n+                                ACC_PUBLIC);\n                 break;\n               case Do_getParamOrVarConst:\n                 methodLocals = 1 + 1 + 1; // this + paramOrVarName\n                 cfw.startMethod(\"getParamOrVarConst\", \"(I)Z\",\n-                                ClassFileWriter.ACC_PUBLIC);\n+                                ACC_PUBLIC);\n                 break;\n               case Do_getEncodedSource:\n                 methodLocals = 1; // Only this\n                 cfw.startMethod(\"getEncodedSource\", \"()Ljava/lang/String;\",\n-                                ClassFileWriter.ACC_PUBLIC);\n+                                ACC_PUBLIC);\n                 cfw.addPush(encodedSource);\n                 break;\n               default:\n         }\n \n         cfw.startMethod(REGEXP_INIT_METHOD_NAME, REGEXP_INIT_METHOD_SIGNATURE,\n-            (short)(ClassFileWriter.ACC_STATIC | ClassFileWriter.ACC_PRIVATE\n-                    | ClassFileWriter.ACC_SYNCHRONIZED));\n+                (short)(ACC_STATIC | ACC_PRIVATE));\n         cfw.addField(\"_reInitDone\", \"Z\",\n-                     (short)(ClassFileWriter.ACC_STATIC\n-                             | ClassFileWriter.ACC_PRIVATE));\n+                     (short)(ACC_STATIC | ACC_PRIVATE | ACC_VOLATILE));\n         cfw.add(ByteCode.GETSTATIC, mainClassName, \"_reInitDone\", \"Z\");\n         int doInit = cfw.acquireLabel();\n         cfw.add(ByteCode.IFEQ, doInit);\n         cfw.add(ByteCode.RETURN);\n         cfw.markLabel(doInit);\n \n+        // get regexp proxy and store it in local slot 1\n+        cfw.addALoad(0); // context\n+        cfw.addInvoke(ByteCode.INVOKESTATIC,\n+                      \"org/mozilla/javascript/ScriptRuntime\",\n+                      \"checkRegExpProxy\",\n+                      \"(Lorg/mozilla/javascript/Context;\"\n+                      +\")Lorg/mozilla/javascript/RegExpProxy;\");\n+        cfw.addAStore(1); // proxy\n+\n+        // We could apply double-checked locking here but concurrency\n+        // shouldn't be a problem in practice\n         for (int i = 0; i != scriptOrFnNodes.length; ++i) {\n             ScriptNode n = scriptOrFnNodes[i];\n             int regCount = n.getRegexpCount();\n                 String reString = n.getRegexpString(j);\n                 String reFlags = n.getRegexpFlags(j);\n                 cfw.addField(reFieldName, reFieldType,\n-                             (short)(ClassFileWriter.ACC_STATIC\n-                                     | ClassFileWriter.ACC_PRIVATE));\n-                cfw.addALoad(0); // proxy\n-                cfw.addALoad(1); // context\n+                             (short)(ACC_STATIC | ACC_PRIVATE));\n+                cfw.addALoad(1); // proxy\n+                cfw.addALoad(0); // context\n                 cfw.addPush(reString);\n                 if (reFlags == null) {\n                     cfw.add(ByteCode.ACONST_NULL);\n         if (N == 0)\n             return;\n \n-        cfw.startMethod(\"<clinit>\", \"()V\",\n-            (short)(ClassFileWriter.ACC_STATIC | ClassFileWriter.ACC_FINAL));\n+        cfw.startMethod(\"<clinit>\", \"()V\", (short)(ACC_STATIC | ACC_FINAL));\n \n         double[] array = itsConstantList;\n         for (int i = 0; i != N; ++i) {\n             String constantName = \"_k\" + i;\n             String constantType = getStaticConstantWrapperType(num);\n             cfw.addField(constantName, constantType,\n-                         (short)(ClassFileWriter.ACC_STATIC\n-                                 | ClassFileWriter.ACC_PRIVATE));\n+                        (short)(ACC_STATIC | ACC_PRIVATE));\n             int inum = (int)num;\n             if (inum == num) {\n-                cfw.add(ByteCode.NEW, \"java/lang/Integer\");\n-                cfw.add(ByteCode.DUP);\n                 cfw.addPush(inum);\n-                cfw.addInvoke(ByteCode.INVOKESPECIAL, \"java/lang/Integer\",\n-                              \"<init>\", \"(I)V\");\n+                cfw.addInvoke(ByteCode.INVOKESTATIC, \"java/lang/Integer\",\n+                              \"valueOf\", \"(I)Ljava/lang/Integer;\");\n             } else {\n                 cfw.addPush(num);\n                 addDoubleWrap(cfw);\n \n         cfw.add(ByteCode.RETURN);\n         cfw.stopMethod((short)0);\n-    }\n-\n-    void pushRegExpArray(ClassFileWriter cfw, ScriptNode n,\n-                         int contextArg, int scopeArg)\n-    {\n-        int regexpCount = n.getRegexpCount();\n-        if (regexpCount == 0) throw badTree();\n-\n-        cfw.addPush(regexpCount);\n-        cfw.add(ByteCode.ANEWARRAY, \"java/lang/Object\");\n-\n-        cfw.addALoad(contextArg);\n-        cfw.addInvoke(ByteCode.INVOKESTATIC,\n-                      \"org/mozilla/javascript/ScriptRuntime\",\n-                      \"checkRegExpProxy\",\n-                      \"(Lorg/mozilla/javascript/Context;\"\n-                      +\")Lorg/mozilla/javascript/RegExpProxy;\");\n-        // Stack: proxy, array\n-        cfw.add(ByteCode.DUP);\n-        cfw.addALoad(contextArg);\n-        cfw.addInvoke(ByteCode.INVOKESTATIC, mainClassName,\n-                      REGEXP_INIT_METHOD_NAME, REGEXP_INIT_METHOD_SIGNATURE);\n-        for (int i = 0; i != regexpCount; ++i) {\n-            // Stack: proxy, array\n-            cfw.add(ByteCode.DUP2);\n-            cfw.addALoad(contextArg);\n-            cfw.addALoad(scopeArg);\n-            cfw.add(ByteCode.GETSTATIC, mainClassName,\n-                    getCompiledRegexpName(n, i), \"Ljava/lang/Object;\");\n-            // Stack: compiledRegExp, scope, cx, proxy, array, proxy, array\n-            cfw.addInvoke(ByteCode.INVOKEINTERFACE,\n-                          \"org/mozilla/javascript/RegExpProxy\",\n-                          \"wrapRegExp\",\n-                          \"(Lorg/mozilla/javascript/Context;\"\n-                          +\"Lorg/mozilla/javascript/Scriptable;\"\n-                          +\"Ljava/lang/Object;\"\n-                          +\")Lorg/mozilla/javascript/Scriptable;\");\n-            // Stack: wrappedRegExp, array, proxy, array\n-            cfw.addPush(i);\n-            cfw.add(ByteCode.SWAP);\n-            cfw.add(ByteCode.AASTORE);\n-            // Stack: proxy, array\n-        }\n-        // remove proxy\n-        cfw.add(ByteCode.POP);\n     }\n \n     void pushNumberAsObject(ClassFileWriter cfw, double num)\n         throw new RuntimeException(\"Bad tree in codegen\");\n     }\n \n-     void setMainMethodClass(String className)\n+     public void setMainMethodClass(String className)\n      {\n          mainMethodClass = className;\n      }\n \n     static final String ID_FIELD_NAME = \"_id\";\n \n-    private static final String REGEXP_INIT_METHOD_NAME = \"_reInit\";\n-    private static final String REGEXP_INIT_METHOD_SIGNATURE\n-        =  \"(Lorg/mozilla/javascript/RegExpProxy;\"\n-           +\"Lorg/mozilla/javascript/Context;\"\n-           +\")V\";\n-    static final String REGEXP_ARRAY_FIELD_NAME = \"_re\";\n-    static final String REGEXP_ARRAY_FIELD_TYPE = \"[Ljava/lang/Object;\";\n+    static final String REGEXP_INIT_METHOD_NAME = \"_reInit\";\n+    static final String REGEXP_INIT_METHOD_SIGNATURE\n+        =  \"(Lorg/mozilla/javascript/Context;)V\";\n \n     static final String FUNCTION_INIT_SIGNATURE\n         =  \"(Lorg/mozilla/javascript/Context;\"\n                           \"Ljava/lang/Object;I)Ljava/lang/Object;\";\n             cfw.startMethod(codegen.getBodyMethodName(scriptOrFn) + \"_gen\",\n                     type,\n-                    (short)(ClassFileWriter.ACC_STATIC\n-                            | ClassFileWriter.ACC_PRIVATE));\n+                    (short)(ACC_STATIC | ACC_PRIVATE));\n         } else {\n             cfw.startMethod(codegen.getBodyMethodName(scriptOrFn),\n                     codegen.getBodyMethodSignature(scriptOrFn),\n-                    (short)(ClassFileWriter.ACC_STATIC\n-                            | ClassFileWriter.ACC_PRIVATE));\n+                    (short)(ACC_STATIC | ACC_PRIVATE));\n         }\n \n         generatePrologue();\n             // return a generator object\n             generateGenerator();\n         }\n+\n+        if (literals != null) {\n+            // literals list may grow while we're looping\n+            for (int i = 0; i < literals.size(); i++) {\n+                Node node = literals.get(i);\n+                int type = node.getType();\n+                switch (type) {\n+                    case Token.OBJECTLIT:\n+                        generateObjectLiteralFactory(node, i + 1);\n+                        break;\n+                    case Token.ARRAYLIT:\n+                        generateArrayLiteralFactory(node, i + 1);\n+                        break;\n+                    default:\n+                        Kit.codeBug(Token.typeToName(type));\n+                }\n+            }\n+        }\n+\n     }\n \n     // This creates a the user-facing function that returns a NativeGenerator\n     {\n         cfw.startMethod(codegen.getBodyMethodName(scriptOrFn),\n                         codegen.getBodyMethodSignature(scriptOrFn),\n-                        (short)(ClassFileWriter.ACC_STATIC\n-                                | ClassFileWriter.ACC_PRIVATE));\n+                        (short)(ACC_STATIC | ACC_PRIVATE));\n \n         initBodyGeneration();\n         argsLocal = firstFreeLocal++;\n \n     private void initBodyGeneration()\n     {\n-        isTopLevel = (scriptOrFn == codegen.scriptOrFnNodes[0]);\n-\n         varRegisters = null;\n         if (scriptOrFn.getType() == Token.FUNCTION) {\n             fnCurrent = OptFunctionNode.get(scriptOrFn);\n         argsLocal = -1;\n         itsZeroArgArray = -1;\n         itsOneArgArray = -1;\n-        scriptRegexpLocal = -1;\n         epilogueLabel = -1;\n         enterAreaStartLabel = -1;\n         generatorStateLocal = -1;\n             }\n         }\n \n-        if (fnCurrent == null) {\n-            // See comments in case Token.REGEXP\n-            if (scriptOrFn.getRegexpCount() != 0) {\n-                scriptRegexpLocal = getNewWordLocal();\n-                codegen.pushRegExpArray(cfw, scriptOrFn, contextLocal,\n-                                        variableObjectLocal);\n-                cfw.addAStore(scriptRegexpLocal);\n-            }\n+        // Compile RegExp literals if this is a script. For functions\n+        // this is performed during instantiation in functionInit\n+        if (fnCurrent == null && scriptOrFn.getRegexpCount() != 0) {\n+            cfw.addALoad(contextLocal);\n+            cfw.addInvoke(ByteCode.INVOKESTATIC, codegen.mainClassName,\n+                          Codegen.REGEXP_INIT_METHOD_NAME,\n+                          Codegen.REGEXP_INIT_METHOD_SIGNATURE);\n         }\n \n         if (compilerEnv.isGenerateObserverCount())\n                 break;\n \n               case Token.LOCAL_BLOCK: {\n+                boolean prevLocal = inLocalBlock;\n+                inLocalBlock = true;\n                 int local = getNewWordLocal();\n                 if (isGenerator) {\n                     cfw.add(ByteCode.ACONST_NULL);\n                 }\n                 releaseWordLocal((short)local);\n                 node.removeProp(Node.LOCAL_PROP);\n+                inLocalBlock = prevLocal;\n                 break;\n               }\n \n \n               case Token.REGEXP:\n                 {\n+                    // Create a new wrapper around precompiled regexp\n+                    cfw.addALoad(contextLocal);\n+                    cfw.addALoad(variableObjectLocal);\n                     int i = node.getExistingIntProp(Node.REGEXP_PROP);\n-                    // Scripts can not use REGEXP_ARRAY_FIELD_NAME since\n-                    // it it will make script.exec non-reentrant so they\n-                    // store regexp array in a local variable while\n-                    // functions always access precomputed\n-                    // REGEXP_ARRAY_FIELD_NAME not to consume locals\n-                    if (fnCurrent == null) {\n-                        cfw.addALoad(scriptRegexpLocal);\n-                    } else {\n-                        cfw.addALoad(funObjLocal);\n-                        cfw.add(ByteCode.GETFIELD, codegen.mainClassName,\n-                                Codegen.REGEXP_ARRAY_FIELD_NAME,\n-                                Codegen.REGEXP_ARRAY_FIELD_TYPE);\n-                    }\n-                    cfw.addPush(i);\n-                    cfw.add(ByteCode.AALOAD);\n+                    cfw.add(ByteCode.GETSTATIC, codegen.mainClassName,\n+                            codegen.getCompiledRegexpName(scriptOrFn, i),\n+                            \"Ljava/lang/Object;\");\n+                    cfw.addInvoke(ByteCode.INVOKESTATIC,\n+                                  \"org/mozilla/javascript/ScriptRuntime\",\n+                                  \"wrapRegExp\",\n+                                  \"(Lorg/mozilla/javascript/Context;\"\n+                                  +\"Lorg/mozilla/javascript/Scriptable;\"\n+                                  +\"Ljava/lang/Object;\"\n+                                  +\")Lorg/mozilla/javascript/Scriptable;\");\n                 }\n                 break;\n \n               }\n \n               case Token.ARRAYLIT:\n-                visitArrayLiteral(node, child);\n+                visitArrayLiteral(node, child, false);\n                 break;\n \n               case Token.OBJECTLIT:\n-                visitObjectLiteral(node, child);\n+                visitObjectLiteral(node, child, false);\n                 break;\n \n               case Token.NOT: {\n         ret.jsrPoints.add(Integer.valueOf(retLabel));\n     }\n \n-    private void visitArrayLiteral(Node node, Node child)\n+    private void generateArrayLiteralFactory(Node node, int count) {\n+        String methodName = codegen.getBodyMethodName(scriptOrFn) + \"_literal\" + count;\n+        initBodyGeneration();\n+        argsLocal = firstFreeLocal++;\n+        localsMax = firstFreeLocal;\n+        cfw.startMethod(methodName, \"(Lorg/mozilla/javascript/Context;\"\n+                +\"Lorg/mozilla/javascript/Scriptable;\"\n+                +\"Lorg/mozilla/javascript/Scriptable;\"\n+                +\"[Ljava/lang/Object;\"\n+                +\")Lorg/mozilla/javascript/Scriptable;\",\n+                ACC_PRIVATE);\n+        visitArrayLiteral(node, node.getFirstChild(), true);\n+        cfw.add(ByteCode.ARETURN);\n+        cfw.stopMethod((short)(localsMax + 1));\n+    }\n+\n+    private void generateObjectLiteralFactory(Node node, int count) {\n+        String methodName = codegen.getBodyMethodName(scriptOrFn) + \"_literal\" + count;\n+        initBodyGeneration();\n+        argsLocal = firstFreeLocal++;\n+        localsMax = firstFreeLocal;\n+        cfw.startMethod(methodName, \"(Lorg/mozilla/javascript/Context;\"\n+                +\"Lorg/mozilla/javascript/Scriptable;\"\n+                +\"Lorg/mozilla/javascript/Scriptable;\"\n+                +\"[Ljava/lang/Object;\"\n+                +\")Lorg/mozilla/javascript/Scriptable;\",\n+                ACC_PRIVATE);\n+        visitObjectLiteral(node, node.getFirstChild(), true);\n+        cfw.add(ByteCode.ARETURN);\n+        cfw.stopMethod((short)(localsMax + 1));\n+    }\n+\n+\n+    private void visitArrayLiteral(Node node, Node child, boolean topLevel)\n     {\n         int count = 0;\n         for (Node cursor = child; cursor != null; cursor = cursor.getNext()) {\n             ++count;\n         }\n+\n+        // If code budget is tight swap out literals into separate method\n+        if (!topLevel && (count > 10 || cfw.getCurrentCodeOffset() > 30000)\n+                && !hasVarsInRegs && !isGenerator && !inLocalBlock) {\n+            if (literals == null) {\n+                literals = new LinkedList<Node>();\n+            }\n+            literals.add(node);\n+            String methodName = codegen.getBodyMethodName(scriptOrFn) + \"_literal\" + literals.size();\n+            cfw.addALoad(funObjLocal);\n+            cfw.addALoad(contextLocal);\n+            cfw.addALoad(variableObjectLocal);\n+            cfw.addALoad(thisObjLocal);\n+            cfw.addALoad(argsLocal);\n+            cfw.addInvoke(ByteCode.INVOKEVIRTUAL, codegen.mainClassName, methodName,\n+                    \"(Lorg/mozilla/javascript/Context;\"\n+                        +\"Lorg/mozilla/javascript/Scriptable;\"\n+                        +\"Lorg/mozilla/javascript/Scriptable;\"\n+                        +\"[Ljava/lang/Object;\"\n+                        +\")Lorg/mozilla/javascript/Scriptable;\");\n+            return;\n+        }\n+\n         // load array to store array literal objects\n         addNewObjectArray(count);\n         for (int i = 0; i != count; ++i) {\n              +\")Lorg/mozilla/javascript/Scriptable;\");\n     }\n \n-    private void visitObjectLiteral(Node node, Node child)\n+    private void visitObjectLiteral(Node node, Node child, boolean topLevel)\n     {\n         Object[] properties = (Object[])node.getProp(Node.OBJECT_IDS_PROP);\n         int count = properties.length;\n+\n+        // If code budget is tight swap out literals into separate method\n+        if (!topLevel && (count > 10 || cfw.getCurrentCodeOffset() > 30000)\n+                && !hasVarsInRegs && !isGenerator && !inLocalBlock) {\n+            if (literals == null) {\n+                literals = new LinkedList<Node>();\n+            }\n+            literals.add(node);\n+            String methodName = codegen.getBodyMethodName(scriptOrFn) + \"_literal\" + literals.size();\n+            cfw.addALoad(funObjLocal);\n+            cfw.addALoad(contextLocal);\n+            cfw.addALoad(variableObjectLocal);\n+            cfw.addALoad(thisObjLocal);\n+            cfw.addALoad(argsLocal);\n+            cfw.addInvoke(ByteCode.INVOKEVIRTUAL, codegen.mainClassName, methodName,\n+                    \"(Lorg/mozilla/javascript/Context;\"\n+                        +\"Lorg/mozilla/javascript/Scriptable;\"\n+                        +\"Lorg/mozilla/javascript/Scriptable;\"\n+                        +\"[Ljava/lang/Object;\"\n+                        +\")Lorg/mozilla/javascript/Scriptable;\");\n+            return;\n+        }\n \n         // load array with property ids\n         addNewObjectArray(count);\n                     +\"Lorg/mozilla/javascript/Scriptable;\"\n                     +\")Lorg/mozilla/javascript/Callable;\");\n             } else {\n-                // Optimizer do not optimize this case for now\n+                generateExpression(id, node);  // id\n                 if (node.getIntProp(Node.ISNUMBER_PROP, -1) != -1)\n-                    throw Codegen.badTree();\n-                generateExpression(id, node);  // id\n+                    addDoubleWrap();\n                 cfw.addALoad(contextLocal);\n                 addScriptRuntimeInvoke(\n                     \"getElemFunctionAndThis\",\n     private int savedCodeOffset;\n \n     private OptFunctionNode fnCurrent;\n-    private boolean isTopLevel;\n \n     private static final int MAX_LOCALS = 1024;\n     private int[] locals;\n     private boolean itsForcedObjectParameters;\n     private int enterAreaStartLabel;\n     private int epilogueLabel;\n+    private boolean inLocalBlock;\n \n     // special known locals. If you add a new local here, be sure\n     // to initialize it to -1 in initBodyGeneration\n     private short funObjLocal;\n     private short itsZeroArgArray;\n     private short itsOneArgArray;\n-    private short scriptRegexpLocal;\n     private short generatorStateLocal;\n \n     private boolean isGenerator;\n     private int maxStack = 0;\n \n     private Map<Node,FinallyReturnPoint> finallys;\n+    private List<Node> literals;\n \n     static class FinallyReturnPoint {\n         public List<Integer> jsrPoints  = new ArrayList<Integer>();\n--- a/lib/rhino/src/org/mozilla/javascript/optimizer/OptFunctionNode.java\n+++ b/lib/rhino/src/org/mozilla/javascript/optimizer/OptFunctionNode.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Bob Jervis\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n \n package org.mozilla.javascript.optimizer;\n import org.mozilla.javascript.ast.FunctionNode;\n import org.mozilla.javascript.ast.ScriptNode;\n \n-final class OptFunctionNode\n+public final class OptFunctionNode\n {\n     OptFunctionNode(FunctionNode fnode)\n     {\n         fnode.setCompilerData(this);\n     }\n \n-    static OptFunctionNode get(ScriptNode scriptOrFn, int i)\n+    public static OptFunctionNode get(ScriptNode scriptOrFn, int i)\n     {\n         FunctionNode fnode = scriptOrFn.getFunctionNode(i);\n         return (OptFunctionNode)fnode.getCompilerData();\n     }\n \n-    static OptFunctionNode get(ScriptNode scriptOrFn)\n+    public static OptFunctionNode get(ScriptNode scriptOrFn)\n     {\n         return (OptFunctionNode)scriptOrFn.getCompilerData();\n     }\n \n-    boolean isTargetOfDirectCall()\n+    public boolean isTargetOfDirectCall()\n     {\n         return directTargetIndex >= 0;\n     }\n \n-    int getDirectTargetIndex()\n+    public int getDirectTargetIndex()\n     {\n         return directTargetIndex;\n     }\n         itsParameterNumberContext = b;\n     }\n \n-    boolean getParameterNumberContext()\n+    public boolean getParameterNumberContext()\n     {\n         return itsParameterNumberContext;\n     }\n \n-    int getVarCount()\n+    public int getVarCount()\n     {\n         return fnode.getParamAndVarCount();\n     }\n \n-    boolean isParameter(int varIndex)\n+    public boolean isParameter(int varIndex)\n     {\n         return varIndex < fnode.getParamCount();\n     }\n \n-    boolean isNumberVar(int varIndex)\n+    public boolean isNumberVar(int varIndex)\n     {\n         varIndex -= fnode.getParamCount();\n         if (varIndex >= 0 && numberVarFlags != null) {\n         numberVarFlags[varIndex] = true;\n     }\n \n-    int getVarIndex(Node n)\n+    public int getVarIndex(Node n)\n     {\n         int index = n.getIntProp(Node.VARIABLE_PROP, -1);\n         if (index == -1) {\n         return index;\n     }\n \n-    FunctionNode fnode;\n+    public final FunctionNode fnode;\n+\n     private boolean[] numberVarFlags;\n     private int directTargetIndex = -1;\n     private boolean itsParameterNumberContext;\n--- a/lib/rhino/src/org/mozilla/javascript/optimizer/OptRuntime.java\n+++ b/lib/rhino/src/org/mozilla/javascript/optimizer/OptRuntime.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Roger Lawrence\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n \n package org.mozilla.javascript.optimizer;\n--- a/lib/rhino/src/org/mozilla/javascript/optimizer/OptTransformer.java\n+++ b/lib/rhino/src/org/mozilla/javascript/optimizer/OptTransformer.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n \n package org.mozilla.javascript.optimizer;\n--- a/lib/rhino/src/org/mozilla/javascript/optimizer/Optimizer.java\n+++ b/lib/rhino/src/org/mozilla/javascript/optimizer/Optimizer.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n \n \n              * generate non-object code.\n              */\n             parameterUsedInNumberContext = false;\n-            for (int i = 0; i < theStatementNodes.length; i++) {\n-                rewriteForNumberVariables(theStatementNodes[i], NumberType);\n+            for (Node theStatementNode : theStatementNodes) {\n+                rewriteForNumberVariables(theStatementNode, NumberType);\n             }\n             theFunction.setParameterNumberContext(parameterUsedInNumberContext);\n         }\n             case Token.INC :\n             case Token.DEC : {\n                     Node child = n.getFirstChild();\n-                    // \"child\" will be GETVAR or GETPROP or GETELEM\n+                    int type = rewriteForNumberVariables(child, NumberType);\n                     if (child.getType() == Token.GETVAR) {\n-                        if (rewriteForNumberVariables(child, NumberType) == NumberType &&\n-                            !convertParameter(child))\n+                        if (type == NumberType && !convertParameter(child))\n                         {\n                             n.putIntProp(Node.ISNUMBER_PROP, Node.BOTH);\n                             markDCPNumberContext(child);\n                             return NumberType;\n                         }\n-                      return NoType;\n-                    }\n-                    else if (child.getType() == Token.GETELEM) {\n-                        return rewriteForNumberVariables(child, NumberType);\n+                        return NoType;\n+                    }\n+                    else if (child.getType() == Token.GETELEM\n+                            || child.getType() == Token.GETPROP) {\n+                        return type;\n                     }\n                     return NoType;\n                 }\n                     Node arrayIndex = arrayBase.getNext();\n                     Node rValue = arrayIndex.getNext();\n                     int baseType = rewriteForNumberVariables(arrayBase, NumberType);\n-                    if (baseType == NumberType) {// can never happen ???\n+                    if (baseType == NumberType) {\n                         if (!convertParameter(arrayBase)) {\n                             n.removeChild(arrayBase);\n                             n.addChildToFront(\n                     Node arrayBase = n.getFirstChild();\n                     Node arrayIndex = arrayBase.getNext();\n                     int baseType = rewriteForNumberVariables(arrayBase, NumberType);\n-                    if (baseType == NumberType) {// can never happen ???\n+                    if (baseType == NumberType) {\n                         if (!convertParameter(arrayBase)) {\n                             n.removeChild(arrayBase);\n                             n.addChildToFront(\n--- a/lib/rhino/src/org/mozilla/javascript/regexp/NativeRegExp.java\n+++ b/lib/rhino/src/org/mozilla/javascript/regexp/NativeRegExp.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Brendan Eich\n- *   Matthias Radestock\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.regexp;\n \n \n     private static final boolean debug = false;\n \n-    private static final byte REOP_EMPTY         = 0;  /* match rest of input against rest of r.e. */\n-    private static final byte REOP_ALT           = 1;  /* alternative subexpressions in kid and next */\n+    private static final byte REOP_SIMPLE_START  = 1;  /* start of 'simple opcodes' */\n+    private static final byte REOP_EMPTY         = 1;  /* match rest of input against rest of r.e. */\n     private static final byte REOP_BOL           = 2;  /* beginning of input (or line if multiline) */\n     private static final byte REOP_EOL           = 3;  /* end of input (or line if multiline) */\n     private static final byte REOP_WBDRY         = 4;  /* match \"\" at word boundary */\n     private static final byte REOP_WNONBDRY      = 5;  /* match \"\" at word non-boundary */\n-    private static final byte REOP_QUANT         = 6;  /* quantified atom: atom{1,2} */\n-    private static final byte REOP_STAR          = 7;  /* zero or more occurrences of kid */\n-    private static final byte REOP_PLUS          = 8;  /* one or more occurrences of kid */\n-    private static final byte REOP_OPT           = 9;  /* optional subexpression in kid */\n-    private static final byte REOP_LPAREN        = 10; /* left paren bytecode: kid is u.num'th sub-regexp */\n-    private static final byte REOP_RPAREN        = 11; /* right paren bytecode */\n-    private static final byte REOP_DOT           = 12; /* stands for any character */\n-//    private static final byte REOP_CCLASS        = 13; /* character class: [a-f] */\n-    private static final byte REOP_DIGIT         = 14; /* match a digit char: [0-9] */\n-    private static final byte REOP_NONDIGIT      = 15; /* match a non-digit char: [^0-9] */\n-    private static final byte REOP_ALNUM         = 16; /* match an alphanumeric char: [0-9a-z_A-Z] */\n-    private static final byte REOP_NONALNUM      = 17; /* match a non-alphanumeric char: [^0-9a-z_A-Z] */\n-    private static final byte REOP_SPACE         = 18; /* match a whitespace char */\n-    private static final byte REOP_NONSPACE      = 19; /* match a non-whitespace char */\n-    private static final byte REOP_BACKREF       = 20; /* back-reference (e.g., \\1) to a parenthetical */\n-    private static final byte REOP_FLAT          = 21; /* match a flat string */\n-    private static final byte REOP_FLAT1         = 22; /* match a single char */\n-    private static final byte REOP_JUMP          = 23; /* for deoptimized closure loops */\n-//    private static final byte REOP_DOTSTAR       = 24; /* optimize .* to use a single opcode */\n-//    private static final byte REOP_ANCHOR        = 25; /* like .* but skips left context to unanchored r.e. */\n-//    private static final byte REOP_EOLONLY       = 26; /* $ not preceded by any pattern */\n-//    private static final byte REOP_UCFLAT        = 27; /* flat Unicode string; len immediate counts chars */\n-    private static final byte REOP_UCFLAT1       = 28; /* single Unicode char */\n-//    private static final byte REOP_UCCLASS       = 29; /* Unicode character class, vector of chars to match */\n-//    private static final byte REOP_NUCCLASS      = 30; /* negated Unicode character class */\n-//    private static final byte REOP_BACKREFi      = 31; /* case-independent REOP_BACKREF */\n-    private static final byte REOP_FLATi         = 32; /* case-independent REOP_FLAT */\n-    private static final byte REOP_FLAT1i        = 33; /* case-independent REOP_FLAT1 */\n-//    private static final byte REOP_UCFLATi       = 34; /* case-independent REOP_UCFLAT */\n-    private static final byte REOP_UCFLAT1i      = 35; /* case-independent REOP_UCFLAT1 */\n-//    private static final byte REOP_ANCHOR1       = 36; /* first-char discriminating REOP_ANCHOR */\n-//    private static final byte REOP_NCCLASS       = 37; /* negated 8-bit character class */\n-//    private static final byte REOP_DOTSTARMIN    = 38; /* ungreedy version of REOP_DOTSTAR */\n-//    private static final byte REOP_LPARENNON     = 39; /* non-capturing version of REOP_LPAREN */\n-//    private static final byte REOP_RPARENNON     = 40; /* non-capturing version of REOP_RPAREN */\n+    private static final byte REOP_DOT           = 6;  /* stands for any character */\n+    private static final byte REOP_DIGIT         = 7;  /* match a digit char: [0-9] */\n+    private static final byte REOP_NONDIGIT      = 8;  /* match a non-digit char: [^0-9] */\n+    private static final byte REOP_ALNUM         = 9;  /* match an alphanumeric char: [0-9a-z_A-Z] */\n+    private static final byte REOP_NONALNUM      = 10; /* match a non-alphanumeric char: [^0-9a-z_A-Z] */\n+    private static final byte REOP_SPACE         = 11; /* match a whitespace char */\n+    private static final byte REOP_NONSPACE      = 12; /* match a non-whitespace char */\n+    private static final byte REOP_BACKREF       = 13; /* back-reference (e.g., \\1) to a parenthetical */\n+    private static final byte REOP_FLAT          = 14; /* match a flat string */\n+    private static final byte REOP_FLAT1         = 15; /* match a single char */\n+    private static final byte REOP_FLATi         = 16; /* case-independent REOP_FLAT */\n+    private static final byte REOP_FLAT1i        = 17; /* case-independent REOP_FLAT1 */\n+    private static final byte REOP_UCFLAT1       = 18; /* single Unicode char */\n+    private static final byte REOP_UCFLAT1i      = 19; /* case-independent REOP_UCFLAT1 */\n+//    private static final byte REOP_UCFLAT        = 20; /* flat Unicode string; len immediate counts chars */\n+//    private static final byte REOP_UCFLATi       = 21; /* case-independent REOP_UCFLAT */\n+    private static final byte REOP_CLASS         = 22; /* character class with index */\n+    private static final byte REOP_NCLASS        = 23; /* negated character class with index */\n+    private static final byte REOP_SIMPLE_END    = 23; /* end of 'simple opcodes' */\n+    private static final byte REOP_QUANT         = 25; /* quantified atom: atom{1,2} */\n+    private static final byte REOP_STAR          = 26; /* zero or more occurrences of kid */\n+    private static final byte REOP_PLUS          = 27; /* one or more occurrences of kid */\n+    private static final byte REOP_OPT           = 28; /* optional subexpression in kid */\n+    private static final byte REOP_LPAREN        = 29; /* left paren bytecode: kid is u.num'th sub-regexp */\n+    private static final byte REOP_RPAREN        = 30; /* right paren bytecode */\n+    private static final byte REOP_ALT           = 31; /* alternative subexpressions in kid and next */\n+    private static final byte REOP_JUMP          = 32; /* for deoptimized closure loops */\n+//    private static final byte REOP_DOTSTAR       = 33; /* optimize .* to use a single opcode */\n+//    private static final byte REOP_ANCHOR        = 34; /* like .* but skips left context to unanchored r.e. */\n+//    private static final byte REOP_EOLONLY       = 35; /* $ not preceded by any pattern */\n+//    private static final byte REOP_BACKREFi      = 37; /* case-independent REOP_BACKREF */\n+//    private static final byte REOP_LPARENNON     = 40; /* non-capturing version of REOP_LPAREN */\n     private static final byte REOP_ASSERT        = 41; /* zero width positive lookahead assertion */\n     private static final byte REOP_ASSERT_NOT    = 42; /* zero width negative lookahead assertion */\n     private static final byte REOP_ASSERTTEST    = 43; /* sentinel at end of assertion child */\n     private static final byte REOP_MINIMALOPT    = 47; /* non-greedy version of ? */\n     private static final byte REOP_MINIMALQUANT  = 48; /* non-greedy version of {} */\n     private static final byte REOP_ENDCHILD      = 49; /* sentinel at end of quantifier child */\n-    private static final byte REOP_CLASS         = 50; /* character class with index */\n     private static final byte REOP_REPEAT        = 51; /* directs execution of greedy quantifier */\n     private static final byte REOP_MINIMALREPEAT = 52; /* directs execution of non-greedy quantifier */\n-    private static final byte REOP_END           = 53;\n-\n+    private static final byte REOP_ALTPREREQ     = 53; /* prerequisite for ALT, either of two chars */\n+    private static final byte REOP_ALTPREREQi    = 54; /* case-independent REOP_ALTPREREQ */\n+    private static final byte REOP_ALTPREREQ2    = 55; /* prerequisite for ALT, a char or a class */\n+//    private static final byte REOP_ENDALT        = 56; /* end of final alternate */\n+    private static final byte REOP_END           = 57;\n+\n+    private static final int ANCHOR_BOL = -2;\n \n \n     public static void init(Context cx, Scriptable scope, boolean sealed)\n     {\n \n         NativeRegExp proto = new NativeRegExp();\n-        proto.re = (RECompiled)compileRE(cx, \"\", null, false);\n+        proto.re = compileRE(cx, \"\", null, false);\n         proto.activatePrototypeMap(MAX_PROTOTYPE_ID);\n         proto.setParentScope(scope);\n         proto.setPrototype(getObjectPrototype(scope));\n         defineProperty(scope, \"RegExp\", ctor, ScriptableObject.DONTENUM);\n     }\n \n-    NativeRegExp(Scriptable scope, Object regexpCompiled)\n-    {\n-        this.re = (RECompiled)regexpCompiled;\n+    NativeRegExp(Scriptable scope, RECompiled regexpCompiled)\n+    {\n+        this.re = regexpCompiled;\n         this.lastIndex = 0;\n         ScriptRuntime.setBuiltinProtoAndParent(this, scope, TopLevel.Builtins.RegExp);\n     }\n             this.lastIndex = thatObj.lastIndex;\n             return this;\n         }\n-        String s = args.length == 0 ? \"\" : ScriptRuntime.toString(args[0]);\n+        String s = args.length == 0 ? \"\" : escapeRegExp(args[0]);\n         String global = args.length > 1 && args[1] != Undefined.instance\n             ? ScriptRuntime.toString(args[1])\n             : null;\n-        this.re = (RECompiled)compileRE(cx, s, global, false);\n+        this.re = compileRE(cx, s, global, false);\n         this.lastIndex = 0;\n         return this;\n     }\n     @Override\n     public String toString()\n     {\n-        StringBuffer buf = new StringBuffer();\n+        StringBuilder buf = new StringBuilder();\n         buf.append('/');\n         if (re.source.length != 0) {\n             buf.append(re.source);\n         return (RegExpImpl) ScriptRuntime.getRegExpProxy(cx);\n     }\n \n+    private static String escapeRegExp(Object src) {\n+        String s = ScriptRuntime.toString(src);\n+        // Escape any naked slashes in regexp source, see bug #510265\n+        StringBuilder sb = null; // instantiated only if necessary\n+        int start = 0;\n+        int slash = s.indexOf('/');\n+        while (slash > -1) {\n+            if (slash == start || s.charAt(slash - 1) != '\\\\') {\n+                if (sb == null) {\n+                    sb = new StringBuilder();\n+                }\n+                sb.append(s, start, slash);\n+                sb.append(\"\\\\/\");\n+                start = slash + 1;\n+            }\n+            slash = s.indexOf('/', slash + 1);\n+        }\n+        if (sb != null) {\n+            sb.append(s, start, s.length());\n+            s = sb.toString();\n+        }\n+        return s;\n+    }\n+\n     private Object execSub(Context cx, Scriptable scopeObj,\n                            Object[] args, int matchType)\n     {\n         return rval;\n     }\n \n-    static Object compileRE(Context cx, String str, String global, boolean flat)\n-    {\n-        RECompiled regexp = new RECompiled();\n-        regexp.source = str.toCharArray();\n+    static RECompiled compileRE(Context cx, String str, String global, boolean flat)\n+    {\n+        RECompiled regexp = new RECompiled(str);\n         int length = str.length();\n-\n         int flags = 0;\n         if (global != null) {\n             for (int i = 0; i < global.length(); i++) {\n \n         CompilerState state = new CompilerState(cx, regexp.source, length, flags);\n         if (flat && length > 0) {\n-if (debug) {\n-System.out.println(\"flat = \\\"\" + str + \"\\\"\");\n-}\n+            if (debug) {\n+                System.out.println(\"flat = \\\"\" + str + \"\\\"\");\n+            }\n             state.result = new RENode(REOP_FLAT);\n             state.result.chr = state.cpbegin[0];\n             state.result.length = length;\n         int endPC = emitREBytecode(state, regexp, 0, state.result);\n         regexp.program[endPC++] = REOP_END;\n \n-if (debug) {\n-System.out.println(\"Prog. length = \" + endPC);\n-for (int i = 0; i < endPC; i++) {\n-    System.out.print(regexp.program[i]);\n-    if (i < (endPC - 1)) System.out.print(\", \");\n-}\n-System.out.println();\n-}\n+        if (debug) {\n+            System.out.println(\"Prog. length = \" + endPC);\n+            for (int i = 0; i < endPC; i++) {\n+                System.out.print(regexp.program[i]);\n+                if (i < (endPC - 1)) System.out.print(\", \");\n+            }\n+            System.out.println();\n+        }\n         regexp.parenCount = state.parenCount;\n \n         // If re starts with literal, init anchorCh accordingly\n         switch (regexp.program[0]) {\n-        case REOP_UCFLAT1:\n-        case REOP_UCFLAT1i:\n-            regexp.anchorCh = (char)getIndex(regexp.program, 1);\n-            break;\n-        case REOP_FLAT1:\n-        case REOP_FLAT1i:\n-            regexp.anchorCh = (char)(regexp.program[1] & 0xFF);\n-            break;\n-        case REOP_FLAT:\n-        case REOP_FLATi:\n-            int k = getIndex(regexp.program, 1);\n-            regexp.anchorCh = regexp.source[k];\n-            break;\n-        }\n-\n-if (debug) {\n-if (regexp.anchorCh >= 0) {\n-    System.out.println(\"Anchor ch = '\" + (char)regexp.anchorCh + \"'\");\n-}\n-}\n+            case REOP_UCFLAT1:\n+            case REOP_UCFLAT1i:\n+                regexp.anchorCh = (char)getIndex(regexp.program, 1);\n+                break;\n+            case REOP_FLAT1:\n+            case REOP_FLAT1i:\n+                regexp.anchorCh = (char)(regexp.program[1] & 0xFF);\n+                break;\n+            case REOP_FLAT:\n+            case REOP_FLATi:\n+                int k = getIndex(regexp.program, 1);\n+                regexp.anchorCh = regexp.source[k];\n+                break;\n+            case REOP_BOL:\n+                regexp.anchorCh = ANCHOR_BOL;\n+                break;\n+            case REOP_ALT:\n+                RENode n = state.result;\n+                if (n.kid.op == REOP_BOL && n.kid2.op == REOP_BOL) {\n+                    regexp.anchorCh = ANCHOR_BOL;\n+                }\n+                break;\n+        }\n+\n+        if (debug) {\n+            if (regexp.anchorCh >= 0) {\n+                System.out.println(\"Anchor ch = '\" + (char)regexp.anchorCh + \"'\");\n+            }\n+        }\n         return regexp;\n     }\n \n             return ch;\n         }\n         char cu = Character.toUpperCase(ch);\n-        if ((ch >= 128) && (cu < 128)) return ch;\n-        return cu;\n+        return (cu < 128) ? ch : cu;\n     }\n \n     private static char downcase(char ch)\n             return ch;\n         }\n         char cl = Character.toLowerCase(ch);\n-        if ((ch >= 128) && (cl < 128)) return ch;\n-        return cl;\n+        return (cl < 128) ? ch : cl;\n+\n     }\n \n /*\n         char[] source = state.cpbegin;\n         int index = state.cp;\n         if (index != source.length && source[index] == '|') {\n-            RENode altResult;\n+            RENode result;\n             ++state.cp;\n-            altResult = new RENode(REOP_ALT);\n-            altResult.kid = state.result;\n+            result = new RENode(REOP_ALT);\n+            result.kid = state.result;\n             if (!parseDisjunction(state))\n                 return false;\n-            altResult.kid2 = state.result;\n-            state.result = altResult;\n-            /* ALT, <next>, ..., JUMP, <end> ... JUMP <end> */\n-            state.progLength += 9;\n+            result.kid2 = state.result;\n+            state.result = result;\n+            /*\n+             * Look at both alternates to see if there's a FLAT or a CLASS at\n+             * the start of each. If so, use a prerequisite match.\n+             */\n+            if (result.kid.op == REOP_FLAT && result.kid2.op == REOP_FLAT) {\n+                result.op = (state.flags & JSREG_FOLD) == 0 ?\n+                        REOP_ALTPREREQ : REOP_ALTPREREQi;\n+                result.chr = result.kid.chr;\n+                result.index = result.kid2.chr;\n+                /* ALTPREREQ, uch1, uch2, <next>, ...,\n+                                            JUMP, <end> ... JUMP, <end> */\n+                state.progLength += 13;\n+            } else if (result.kid.op == REOP_CLASS && result.kid.index < 256\n+                    && result.kid2.op == REOP_FLAT && (state.flags & JSREG_FOLD) == 0) {\n+                result.op = REOP_ALTPREREQ2;\n+                result.chr = result.kid2.chr;\n+                result.index = result.kid.index;\n+                /* ALTPREREQ2, uch1, uch2, <next>, ...,\n+                                            JUMP, <end> ... JUMP, <end> */\n+                state.progLength += 13;\n+            } else if (result.kid.op == REOP_FLAT && result.kid2.op == REOP_CLASS\n+                    && result.kid2.index < 256 && (state.flags & JSREG_FOLD) == 0) {\n+                result.op = REOP_ALTPREREQ2;\n+                result.chr = result.kid.chr;\n+                result.index = result.kid2.index;\n+                /* ALTPREREQ2, uch1, uch2, <next>, ...,\n+                                            JUMP, <end> ... JUMP, <end> */\n+                state.progLength += 13;\n+            } else {\n+                /* ALT, <next>, ..., JUMP, <end> ... JUMP, <end> */\n+                state.progLength += 9;\n+            }\n         }\n         return true;\n     }\n         boolean inRange = false;\n \n         target.bmsize = 0;\n+        target.sense = true;\n \n         if (index == end)\n             return true;\n \n-        if (src[index] == '^')\n+        if (src[index] == '^') {\n             ++index;\n+            target.sense = false;\n+        }\n \n         while (index != end) {\n             int localMax = 0;\n                 * atom next time instead.\n                 */\n \n-                c = src[++state.cp];\n-                if (isDigit(c)) {\n+                if (++state.cp < src.length && isDigit(c = src[state.cp])) {\n                     ++state.cp;\n                     min = getDecimalValue(c, state, 0xFFFF,\n                                           \"msg.overlarge.min\");\n         return ((array[pc] & 0xFF) << 8) | (array[pc + 1] & 0xFF);\n     }\n \n-    private static final int OFFSET_LEN = 2;\n     private static final int INDEX_LEN  = 2;\n \n     private static int\n             case REOP_EMPTY:\n                 --pc;\n                 break;\n+            case REOP_ALTPREREQ:\n+            case REOP_ALTPREREQi:\n+            case REOP_ALTPREREQ2:\n+                boolean ignoreCase = t.op == REOP_ALTPREREQi;\n+                addIndex(program, pc, ignoreCase ? upcase(t.chr) : t.chr);\n+                pc += INDEX_LEN;\n+                addIndex(program, pc, ignoreCase ? upcase((char)t.index) : t.index);\n+                pc += INDEX_LEN;\n+                // fall through to REOP_ALT\n             case REOP_ALT:\n                 nextAlt = t.kid2;\n                 nextAltFixup = pc;    /* address of next alternate */\n-                pc += OFFSET_LEN;\n+                pc += INDEX_LEN;\n                 pc = emitREBytecode(state, re, pc, t.kid);\n                 program[pc++] = REOP_JUMP;\n                 nextTermFixup = pc;    /* address of following term */\n-                pc += OFFSET_LEN;\n+                pc += INDEX_LEN;\n                 resolveForwardJump(program, nextAltFixup, pc);\n                 pc = emitREBytecode(state, re, pc, nextAlt);\n \n                 program[pc++] = REOP_JUMP;\n                 nextAltFixup = pc;\n-                pc += OFFSET_LEN;\n+                pc += INDEX_LEN;\n \n                 resolveForwardJump(program, nextTermFixup, pc);\n                 resolveForwardJump(program, nextAltFixup, pc);\n                 break;\n             case REOP_ASSERT:\n                 nextTermFixup = pc;\n-                pc += OFFSET_LEN;\n+                pc += INDEX_LEN;\n                 pc = emitREBytecode(state, re, pc, t.kid);\n                 program[pc++] = REOP_ASSERTTEST;\n                 resolveForwardJump(program, nextTermFixup, pc);\n                 break;\n             case REOP_ASSERT_NOT:\n                 nextTermFixup = pc;\n-                pc += OFFSET_LEN;\n+                pc += INDEX_LEN;\n                 pc = emitREBytecode(state, re, pc, t.kid);\n                 program[pc++] = REOP_ASSERTNOTTEST;\n                 resolveForwardJump(program, nextTermFixup, pc);\n                 pc = addIndex(program, pc, t.parenCount);\n                 pc = addIndex(program, pc, t.parenIndex);\n                 nextTermFixup = pc;\n-                pc += OFFSET_LEN;\n+                pc += INDEX_LEN;\n                 pc = emitREBytecode(state, re, pc, t.kid);\n                 program[pc++] = REOP_ENDCHILD;\n                 resolveForwardJump(program, nextTermFixup, pc);\n                 break;\n             case REOP_CLASS:\n+                if (!t.sense)\n+                    program[pc - 1] = REOP_NCLASS;\n                 pc = addIndex(program, pc, t.index);\n                 re.classList[t.index] = new RECharSet(t.bmsize, t.startIndex,\n-                                                      t.kidlen);\n+                                                      t.kidlen, t.sense);\n                 break;\n             default:\n                 break;\n     }\n \n     private static void\n-    pushProgState(REGlobalData gData, int min, int max,\n+    pushProgState(REGlobalData gData, int min, int max, int cp,\n                   REBackTrackData backTrackLastToSave,\n-                  int continuation_pc, int continuation_op)\n+                  int continuationOp, int continuationPc)\n     {\n         gData.stateStackTop = new REProgState(gData.stateStackTop, min, max,\n-                                              gData.cp, backTrackLastToSave,\n-                                              continuation_pc,\n-                                              continuation_op);\n+                                              cp, backTrackLastToSave,\n+                                              continuationOp, continuationPc);\n     }\n \n     private static REProgState\n     }\n \n     private static void\n-    pushBackTrackState(REGlobalData gData, byte op, int target)\n-    {\n-        gData.backTrackStackTop = new REBackTrackData(gData, op, target);\n+    pushBackTrackState(REGlobalData gData, byte op, int pc)\n+    {\n+        REProgState state = gData.stateStackTop;\n+        gData.backTrackStackTop = new REBackTrackData(gData, op, pc,\n+                gData.cp, state.continuationOp, state.continuationPc);\n+    }\n+\n+    private static void\n+    pushBackTrackState(REGlobalData gData, byte op, int pc,\n+                       int cp, int continuationOp, int continuationPc)\n+    {\n+        gData.backTrackStackTop = new REBackTrackData(gData, op, pc,\n+                cp, continuationOp, continuationPc);\n     }\n \n     /*\n     {\n         if ((gData.cp + length) > end)\n             return false;\n+        char[] source = gData.regexp.source;\n         for (int i = 0; i < length; i++) {\n-            if (upcase(gData.regexp.source[matchChars + i])\n-                != upcase(input.charAt(gData.cp + i)))\n-            {\n+            char c1 = source[matchChars + i];\n+            char c2 = input.charAt(gData.cp + i);\n+            if (c1 != c2 && upcase(c1) != upcase(c2)) {\n                 return false;\n             }\n         }\n         int i;\n         if (gData.parens == null || parenIndex >= gData.parens.length)\n             return false;\n-        int parenContent = gData.parens_index(parenIndex);\n+        int parenContent = gData.parensIndex(parenIndex);\n         if (parenContent == -1)\n             return true;\n \n-        len = gData.parens_length(parenIndex);\n+        len = gData.parensLength(parenIndex);\n         if ((gData.cp + len) > end)\n             return false;\n \n         if ((gData.regexp.flags & JSREG_FOLD) != 0) {\n             for (i = 0; i < len; i++) {\n-                if (upcase(input.charAt(parenContent + i)) != upcase(input.charAt(gData.cp + i)))\n+                char c1 = input.charAt(parenContent + i);\n+                char c2 = input.charAt(gData.cp + i);\n+                if (c1 != c2 && upcase(c1) != upcase(c2))\n                     return false;\n             }\n         }\n-        else {\n-            for (i = 0; i < len; i++) {\n-                if (input.charAt(parenContent + i) != input.charAt(gData.cp + i))\n-                    return false;\n-            }\n+        else if (!input.regionMatches(parenContent, input, gData.cp, len)) {\n+            return false;\n         }\n         gData.cp += len;\n         return true;\n         int i;\n         boolean inRange = false;\n \n-        charSet.sense = true;\n         byteLength = (charSet.length + 7) / 8;\n         charSet.bits = new byte[byteLength];\n \n             return;\n \n         if (gData.regexp.source[src] == '^') {\n-            charSet.sense = false;\n+            assert (!charSet.sense);\n             ++src;\n+        } else {\n+            assert (charSet.sense);\n         }\n \n         while (src != end) {\n             }\n             if (inRange) {\n                 if ((gData.regexp.flags & JSREG_FOLD) != 0) {\n-                    addCharacterRangeToCharSet(charSet,\n-                                               upcase(rangeStart),\n-                                               upcase(thisCh));\n-                    addCharacterRangeToCharSet(charSet,\n-                                               downcase(rangeStart),\n-                                               downcase(thisCh));\n+                    assert(rangeStart <= thisCh);\n+                    for (c = rangeStart; c <= thisCh;) {\n+                        addCharacterToCharSet(charSet, c);\n+                        char uch = upcase(c);\n+                        char dch = downcase(c);\n+                        if (c != uch)\n+                            addCharacterToCharSet(charSet, uch);\n+                        if (c != dch)\n+                            addCharacterToCharSet(charSet, dch);\n+                        if (++c == 0)\n+                            break; // overflow\n+                    }\n                 } else {\n                     addCharacterRangeToCharSet(charSet, rangeStart, thisCh);\n                 }\n             processCharSet(gData, charSet);\n         }\n \n-        int byteIndex = ch / 8;\n-        if (charSet.sense) {\n-            if ((charSet.length == 0) ||\n-                 ( (ch >= charSet.length)\n-                    || ((charSet.bits[byteIndex] & (1 << (ch & 0x7))) == 0) ))\n-                return false;\n-        } else {\n-            if (! ((charSet.length == 0) ||\n-                     ( (ch >= charSet.length)\n-                        || ((charSet.bits[byteIndex] & (1 << (ch & 0x7))) == 0) )))\n-                return false;\n-        }\n-        return true;\n-    }\n+        int byteIndex = ch >> 3;\n+        return (charSet.length == 0 ||\n+                ch >= charSet.length ||\n+                (charSet.bits[byteIndex] & (1 << (ch & 0x7))) == 0) ^ charSet.sense;\n+    }\n+\n+    private static boolean reopIsSimple(int op) {\n+        return op >= REOP_SIMPLE_START && op <= REOP_SIMPLE_END;\n+    }\n+\n+    /*\n+    *   Apply the current op against the given input to see if\n+    *   it's going to match or fail. Return false if we don't\n+    *   get a match, true if we do and update the state of the\n+    *   input and pc if the update flag is true.\n+    */\n+    private static int simpleMatch(REGlobalData gData, String input, int op,\n+                                   byte[] program, int pc, int end, boolean updatecp)\n+    {\n+        boolean result = false;\n+        char matchCh;\n+        int parenIndex;\n+        int offset, length, index;\n+        int startcp = gData.cp;\n+\n+        switch (op) {\n+            case REOP_EMPTY:\n+                result = true;\n+                break;\n+            case REOP_BOL:\n+                if (gData.cp != 0) {\n+                    if (!gData.multiline || !isLineTerm(input.charAt(gData.cp - 1))) {\n+                        break;\n+                    }\n+                }\n+                result = true;\n+                break;\n+            case REOP_EOL:\n+                if (gData.cp != end) {\n+                    if (!gData.multiline || !isLineTerm(input.charAt(gData.cp))) {\n+                        break;\n+                    }\n+                }\n+                result = true;\n+                break;\n+            case REOP_WBDRY:\n+                result = ((gData.cp == 0 || !isWord(input.charAt(gData.cp - 1)))\n+                        ^ !((gData.cp < end) && isWord(input.charAt(gData.cp))));\n+                break;\n+            case REOP_WNONBDRY:\n+                result = ((gData.cp == 0 || !isWord(input.charAt(gData.cp - 1)))\n+                        ^ ((gData.cp < end) && isWord(input.charAt(gData.cp))));\n+                break;\n+            case REOP_DOT:\n+                if (gData.cp != end && !isLineTerm(input.charAt(gData.cp))) {\n+                    result = true;\n+                    gData.cp++;\n+                }\n+                break;\n+            case REOP_DIGIT:\n+                if (gData.cp != end && isDigit(input.charAt(gData.cp))) {\n+                    result = true;\n+                    gData.cp++;\n+                }\n+                break;\n+            case REOP_NONDIGIT:\n+                if (gData.cp != end && !isDigit(input.charAt(gData.cp))) {\n+                    result = true;\n+                    gData.cp++;\n+                }\n+                break;\n+            case REOP_ALNUM:\n+                if (gData.cp != end && isWord(input.charAt(gData.cp))) {\n+                    result = true;\n+                    gData.cp++;\n+                }\n+                break;\n+            case REOP_NONALNUM:\n+                if (gData.cp != end && !isWord(input.charAt(gData.cp))) {\n+                    result = true;\n+                    gData.cp++;\n+                }\n+                break;\n+            case REOP_SPACE:\n+                if (gData.cp != end && isREWhiteSpace(input.charAt(gData.cp))) {\n+                    result = true;\n+                    gData.cp++;\n+                }\n+                break;\n+            case REOP_NONSPACE:\n+                if (gData.cp != end && !isREWhiteSpace(input.charAt(gData.cp))) {\n+                    result = true;\n+                    gData.cp++;\n+                }\n+                break;\n+            case REOP_BACKREF:\n+            {\n+                parenIndex = getIndex(program, pc);\n+                pc += INDEX_LEN;\n+                result = backrefMatcher(gData, parenIndex, input, end);\n+            }\n+            break;\n+            case REOP_FLAT:\n+            {\n+                offset = getIndex(program, pc);\n+                pc += INDEX_LEN;\n+                length = getIndex(program, pc);\n+                pc += INDEX_LEN;\n+                result = flatNMatcher(gData, offset, length, input, end);\n+            }\n+            break;\n+            case REOP_FLAT1:\n+            {\n+                matchCh = (char)(program[pc++] & 0xFF);\n+                if (gData.cp != end && input.charAt(gData.cp) == matchCh) {\n+                    result = true;\n+                    gData.cp++;\n+                }\n+            }\n+            break;\n+            case REOP_FLATi:\n+            {\n+                offset = getIndex(program, pc);\n+                pc += INDEX_LEN;\n+                length = getIndex(program, pc);\n+                pc += INDEX_LEN;\n+                result = flatNIMatcher(gData, offset, length, input, end);\n+            }\n+            break;\n+            case REOP_FLAT1i:\n+            {\n+                matchCh = (char)(program[pc++] & 0xFF);\n+                if (gData.cp != end) {\n+                    char c = input.charAt(gData.cp);\n+                    if (matchCh == c || upcase(matchCh) == upcase(c)) {\n+                        result = true;\n+                        gData.cp++;\n+                    }\n+                }\n+            }\n+            break;\n+            case REOP_UCFLAT1:\n+            {\n+                matchCh = (char)getIndex(program, pc);\n+                pc += INDEX_LEN;\n+                if (gData.cp != end && input.charAt(gData.cp) == matchCh) {\n+                    result = true;\n+                    gData.cp++;\n+                }\n+            }\n+            break;\n+            case REOP_UCFLAT1i:\n+            {\n+                matchCh = (char)getIndex(program, pc);\n+                pc += INDEX_LEN;\n+                if (gData.cp != end) {\n+                    char c = input.charAt(gData.cp);\n+                    if (matchCh == c || upcase(matchCh) == upcase(c)) {\n+                        result = true;\n+                        gData.cp++;\n+                    }\n+                }\n+            }\n+            break;\n+\n+            case REOP_CLASS:\n+            case REOP_NCLASS:\n+            {\n+                index = getIndex(program, pc);\n+                pc += INDEX_LEN;\n+                if (gData.cp != end) {\n+                    if (classMatcher(gData, gData.regexp.classList[index],\n+                            input.charAt(gData.cp)))\n+                    {\n+                        gData.cp++;\n+                        result = true;\n+                        break;\n+                    }\n+                }\n+            }\n+            break;\n+\n+            default:\n+                throw Kit.codeBug();\n+        }\n+        if (result) {\n+            if (!updatecp)\n+                gData.cp = startcp;\n+            return pc;\n+        }\n+        gData.cp = startcp;\n+        return -1;\n+    }\n+\n \n     private static boolean\n     executeREBytecode(REGlobalData gData, String input, int end)\n     {\n         int pc = 0;\n         byte program[] = gData.regexp.program;\n-        int currentContinuation_op;\n-        int currentContinuation_pc;\n+        int continuationOp = REOP_END;\n+        int continuationPc = 0;\n         boolean result = false;\n \n-        currentContinuation_pc = 0;\n-        currentContinuation_op = REOP_END;\n-if (debug) {\n-System.out.println(\"Input = \\\"\" + input + \"\\\", start at \" + gData.cp);\n-}\n         int op = program[pc++];\n+\n+        /*\n+         * If the first node is a simple match, step the index into the string\n+         * until that match is made, or fail if it can't be found at all.\n+         */\n+        if (gData.regexp.anchorCh < 0 && reopIsSimple(op)) {\n+            boolean anchor = false;\n+            while (gData.cp <= end) {\n+                int match = simpleMatch(gData, input, op, program, pc, end, true);\n+                if (match >= 0) {\n+                    anchor = true;\n+                    pc = match;    /* accept skip to next opcode */\n+                    op = program[pc++];\n+                    break;\n+                }\n+                gData.skipped++;\n+                gData.cp++;\n+            }\n+            if (!anchor)\n+                return false;\n+        }\n+\n         for (;;) {\n-if (debug) {\n-System.out.println(\"Testing at \" + gData.cp + \", op = \" + op);\n-}\n-            switch (op) {\n-            case REOP_EMPTY:\n-                result = true;\n-                break;\n-            case REOP_BOL:\n-                if (gData.cp != 0) {\n-                    if (gData.multiline ||\n-                            ((gData.regexp.flags & JSREG_MULTILINE) != 0)) {\n-                        if (!isLineTerm(input.charAt(gData.cp - 1))) {\n+\n+            if (reopIsSimple(op)) {\n+                int match = simpleMatch(gData, input, op, program, pc, end, true);\n+                result = match >= 0;\n+                if (result)\n+                    pc = match;    /* accept skip to next opcode */\n+            } else {\n+                switchStatement:\n+                switch (op) {\n+                    case REOP_ALTPREREQ:\n+                    case REOP_ALTPREREQi:\n+                    case REOP_ALTPREREQ2:\n+                    {\n+                        char matchCh1 = (char)getIndex(program, pc);\n+                        pc += INDEX_LEN;\n+                        char matchCh2 = (char)getIndex(program, pc);\n+                        pc += INDEX_LEN;\n+\n+                        if (gData.cp == end) {\n                             result = false;\n                             break;\n                         }\n-                    }\n-                    else {\n-                        result = false;\n-                        break;\n-                    }\n-                }\n-                result = true;\n-                break;\n-            case REOP_EOL:\n-                if (gData.cp != end) {\n-                    if (gData.multiline ||\n-                            ((gData.regexp.flags & JSREG_MULTILINE) != 0)) {\n-                        if (!isLineTerm(input.charAt(gData.cp))) {\n+                        char c = input.charAt(gData.cp);\n+                        if (op == REOP_ALTPREREQ2) {\n+                            if (c != matchCh1 &&\n+                                !classMatcher(gData, gData.regexp.classList[matchCh2], c)) {\n+                                result = false;\n+                                break;\n+                            }\n+                        } else {\n+                            if (op == REOP_ALTPREREQi)\n+                                c = upcase(c);\n+                            if (c != matchCh1 && c != matchCh2) {\n+                                result = false;\n+                                break;\n+                            }\n+                        }\n+                    }\n+                    /* else false thru... */\n+                    case REOP_ALT:\n+                    {\n+                        int nextpc = pc + getOffset(program, pc);\n+                        pc += INDEX_LEN;\n+                        op = program[pc++];\n+                        int startcp = gData.cp;\n+                        if (reopIsSimple(op)) {\n+                            int match = simpleMatch(gData, input, op, program, pc, end, true);\n+                            if (match < 0) {\n+                                op = program[nextpc++];\n+                                pc = nextpc;\n+                                continue;\n+                            }\n+                            result = true;\n+                            pc = match;\n+                            op = program[pc++];\n+                        }\n+                        byte nextop = program[nextpc++];\n+                        pushBackTrackState(gData, nextop, nextpc, startcp,\n+                                continuationOp, continuationPc);\n+                    }\n+                    continue;\n+\n+                    case REOP_JUMP:\n+                    {\n+                        int offset = getOffset(program, pc);\n+                        pc += offset;\n+                        op = program[pc++];\n+                    }\n+                    continue;\n+\n+\n+                    case REOP_LPAREN:\n+                    {\n+                        int parenIndex = getIndex(program, pc);\n+                        pc += INDEX_LEN;\n+                        gData.setParens(parenIndex, gData.cp, 0);\n+                        op = program[pc++];\n+                    }\n+                    continue;\n+                    case REOP_RPAREN:\n+                    {\n+                        int parenIndex = getIndex(program, pc);\n+                        pc += INDEX_LEN;\n+                        int cap_index = gData.parensIndex(parenIndex);\n+                        gData.setParens(parenIndex, cap_index,\n+                                gData.cp - cap_index);\n+                        op = program[pc++];\n+                    }\n+                    continue;\n+\n+                    case REOP_ASSERT:\n+                    {\n+                        int nextpc = pc + getIndex(program, pc); /* start of term after ASSERT */\n+                        pc += INDEX_LEN;                         /* start of ASSERT child */\n+                        op = program[pc++];\n+                        if (reopIsSimple(op) && simpleMatch(gData, input, op, program, pc, end, false) < 0) {\n                             result = false;\n                             break;\n                         }\n-                    }\n-                    else {\n-                        result = false;\n-                        break;\n-                    }\n-                }\n-                result = true;\n-                break;\n-            case REOP_WBDRY:\n-                result = ((gData.cp == 0 || !isWord(input.charAt(gData.cp - 1)))\n-                          ^ !((gData.cp < end) && isWord(input.charAt(gData.cp))));\n-                break;\n-            case REOP_WNONBDRY:\n-                result = ((gData.cp == 0 || !isWord(input.charAt(gData.cp - 1)))\n-                          ^ ((gData.cp < end) && isWord(input.charAt(gData.cp))));\n-                break;\n-            case REOP_DOT:\n-                result = (gData.cp != end && !isLineTerm(input.charAt(gData.cp)));\n-                if (result) {\n-                    gData.cp++;\n-                }\n-                break;\n-            case REOP_DIGIT:\n-                result = (gData.cp != end && isDigit(input.charAt(gData.cp)));\n-                if (result) {\n-                    gData.cp++;\n-                }\n-                break;\n-            case REOP_NONDIGIT:\n-                result = (gData.cp != end && !isDigit(input.charAt(gData.cp)));\n-                if (result) {\n-                    gData.cp++;\n-                }\n-                break;\n-            case REOP_SPACE:\n-                result = (gData.cp != end && isREWhiteSpace(input.charAt(gData.cp)));\n-                if (result) {\n-                    gData.cp++;\n-                }\n-                break;\n-            case REOP_NONSPACE:\n-                result = (gData.cp != end && !isREWhiteSpace(input.charAt(gData.cp)));\n-                if (result) {\n-                    gData.cp++;\n-                }\n-                break;\n-            case REOP_ALNUM:\n-                result = (gData.cp != end && isWord(input.charAt(gData.cp)));\n-                if (result) {\n-                    gData.cp++;\n-                }\n-                break;\n-            case REOP_NONALNUM:\n-                result = (gData.cp != end && !isWord(input.charAt(gData.cp)));\n-                if (result) {\n-                    gData.cp++;\n-                }\n-                break;\n-            case REOP_FLAT:\n-                {\n-                    int offset = getIndex(program, pc);\n-                    pc += INDEX_LEN;\n-                    int length = getIndex(program, pc);\n-                    pc += INDEX_LEN;\n-                    result = flatNMatcher(gData, offset, length, input, end);\n-                }\n-                break;\n-            case REOP_FLATi:\n-                {\n-                    int offset = getIndex(program, pc);\n-                    pc += INDEX_LEN;\n-                    int length = getIndex(program, pc);\n-                    pc += INDEX_LEN;\n-                    result = flatNIMatcher(gData, offset, length, input, end);\n-                }\n-                break;\n-            case REOP_FLAT1:\n-                {\n-                    char matchCh = (char)(program[pc++] & 0xFF);\n-                    result = (gData.cp != end && input.charAt(gData.cp) == matchCh);\n-                    if (result) {\n-                        gData.cp++;\n-                    }\n-                }\n-                break;\n-            case REOP_FLAT1i:\n-                {\n-                    char matchCh = (char)(program[pc++] & 0xFF);\n-                    result = (gData.cp != end\n-                              && upcase(input.charAt(gData.cp)) == upcase(matchCh));\n-                    if (result) {\n-                        gData.cp++;\n-                    }\n-                }\n-                break;\n-            case REOP_UCFLAT1:\n-                {\n-                    char matchCh = (char)getIndex(program, pc);\n-                    pc += INDEX_LEN;\n-                    result = (gData.cp != end && input.charAt(gData.cp) == matchCh);\n-                    if (result) {\n-                        gData.cp++;\n-                    }\n-                }\n-                break;\n-            case REOP_UCFLAT1i:\n-                {\n-                    char matchCh = (char)getIndex(program, pc);\n-                    pc += INDEX_LEN;\n-                    result = (gData.cp != end\n-                              && upcase(input.charAt(gData.cp)) == upcase(matchCh));\n-                    if (result) {\n-                        gData.cp++;\n-                    }\n-                }\n-                break;\n-            case REOP_ALT:\n-                {\n-                    int nextpc;\n-                    byte nextop;\n-                    pushProgState(gData, 0, 0, null,\n-                                  currentContinuation_pc,\n-                                  currentContinuation_op);\n-                    nextpc = pc + getOffset(program, pc);\n-                    nextop = program[nextpc++];\n-                    pushBackTrackState(gData, nextop, nextpc);\n-                    pc += INDEX_LEN;\n-                    op = program[pc++];\n-                }\n-                continue;\n-\n-            case REOP_JUMP:\n-                {\n-                    int offset;\n-                    REProgState state = popProgState(gData);\n-                    currentContinuation_pc = state.continuation_pc;\n-                    currentContinuation_op = state.continuation_op;\n-                    offset = getOffset(program, pc);\n-                    pc += offset;\n-                    op = program[pc++];\n-                }\n-                continue;\n-\n-\n-            case REOP_LPAREN:\n-                {\n-                    int parenIndex = getIndex(program, pc);\n-                    pc += INDEX_LEN;\n-                    gData.set_parens(parenIndex, gData.cp, 0);\n-                    op = program[pc++];\n-                }\n-                continue;\n-            case REOP_RPAREN:\n-                {\n-                    int cap_index;\n-                    int parenIndex = getIndex(program, pc);\n-                    pc += INDEX_LEN;\n-                    cap_index = gData.parens_index(parenIndex);\n-                    gData.set_parens(parenIndex, cap_index,\n-                                     gData.cp - cap_index);\n-                    if (parenIndex > gData.lastParen)\n-                        gData.lastParen = parenIndex;\n-                    op = program[pc++];\n-                }\n-                continue;\n-            case REOP_BACKREF:\n-                {\n-                    int parenIndex = getIndex(program, pc);\n-                    pc += INDEX_LEN;\n-                    result = backrefMatcher(gData, parenIndex, input, end);\n-                }\n-                break;\n-\n-            case REOP_CLASS:\n-                {\n-                    int index = getIndex(program, pc);\n-                    pc += INDEX_LEN;\n-                    if (gData.cp != end) {\n-                        if (classMatcher(gData, gData.regexp.classList[index],\n-                                         input.charAt(gData.cp)))\n-                        {\n-                            gData.cp++;\n-                            result = true;\n-                            break;\n+                        pushProgState(gData, 0, 0, gData.cp, gData.backTrackStackTop,\n+                                continuationOp, continuationPc);\n+                        pushBackTrackState(gData, REOP_ASSERTTEST, nextpc);\n+                    }\n+                    continue;\n+                    case REOP_ASSERT_NOT:\n+                    {\n+                        int nextpc = pc + getIndex(program, pc); /* start of term after ASSERT */\n+                        pc += INDEX_LEN;                         /* start of ASSERT child */\n+                        op = program[pc++];\n+                        if (reopIsSimple(op)) {\n+                            int match = simpleMatch(gData, input, op, program, pc, end, false);\n+                            if (match >= 0 && program[match] == REOP_ASSERTNOTTEST) {\n+                                result = false;\n+                                break;\n+                            }\n                         }\n-                    }\n-                    result = false;\n-                }\n-                break;\n-\n-            case REOP_ASSERT:\n-            case REOP_ASSERT_NOT:\n-                {\n-                    byte testOp;\n-                    pushProgState(gData, 0, 0, gData.backTrackStackTop,\n-                                  currentContinuation_pc,\n-                                  currentContinuation_op);\n-                    if (op == REOP_ASSERT) {\n-                        testOp = REOP_ASSERTTEST;\n-                    } else {\n-                        testOp = REOP_ASSERTNOTTEST;\n-                    }\n-                    pushBackTrackState(gData, testOp,\n-                                       pc + getOffset(program, pc));\n-                    pc += INDEX_LEN;\n-                    op = program[pc++];\n-                }\n-                continue;\n-\n-            case REOP_ASSERTTEST:\n-            case REOP_ASSERTNOTTEST:\n-                {\n-                    REProgState state = popProgState(gData);\n-                    gData.cp = state.index;\n-                    gData.backTrackStackTop = state.backTrack;\n-                    currentContinuation_pc = state.continuation_pc;\n-                    currentContinuation_op = state.continuation_op;\n-                    if (result) {\n-                        if (op == REOP_ASSERTTEST) {\n-                            result = true;\n-                        } else {\n-                            result = false;\n+                        pushProgState(gData, 0, 0, gData.cp, gData.backTrackStackTop,\n+                                continuationOp, continuationPc);\n+                        pushBackTrackState(gData, REOP_ASSERTNOTTEST, nextpc);\n+                    }\n+                    continue;\n+\n+                    case REOP_ASSERTTEST:\n+                    case REOP_ASSERTNOTTEST:\n+                    {\n+                        REProgState state = popProgState(gData);\n+                        gData.cp = state.index;\n+                        gData.backTrackStackTop = state.backTrack;\n+                        continuationPc = state.continuationPc;\n+                        continuationOp = state.continuationOp;\n+                        if (op == REOP_ASSERTNOTTEST) {\n+                            result = !result;\n                         }\n-                    } else {\n-                        if (op == REOP_ASSERTTEST) {\n-                            // Do nothing\n-                        } else {\n-                            result = true;\n+                    }\n+                    break;\n+\n+                    case REOP_STAR:\n+                    case REOP_PLUS:\n+                    case REOP_OPT:\n+                    case REOP_QUANT:\n+                    case REOP_MINIMALSTAR:\n+                    case REOP_MINIMALPLUS:\n+                    case REOP_MINIMALOPT:\n+                    case REOP_MINIMALQUANT:\n+                    {\n+                        int min, max;\n+                        boolean greedy = false;\n+                        switch (op) {\n+                            case REOP_STAR:\n+                                greedy = true;\n+                                // fallthrough\n+                            case REOP_MINIMALSTAR:\n+                                min = 0;\n+                                max = -1;\n+                                break;\n+                            case REOP_PLUS:\n+                                greedy = true;\n+                                // fallthrough\n+                            case REOP_MINIMALPLUS:\n+                                min = 1;\n+                                max = -1;\n+                                break;\n+                            case REOP_OPT:\n+                                greedy = true;\n+                                // fallthrough\n+                            case REOP_MINIMALOPT:\n+                                min = 0;\n+                                max = 1;\n+                                break;\n+                            case REOP_QUANT:\n+                                greedy = true;\n+                                // fallthrough\n+                            case REOP_MINIMALQUANT:\n+                                min = getOffset(program, pc);\n+                                pc += INDEX_LEN;\n+                                // See comments in emitREBytecode for \" - 1\" reason\n+                                max = getOffset(program, pc) - 1;\n+                                pc += INDEX_LEN;\n+                                break;\n+                            default:\n+                                throw Kit.codeBug();\n                         }\n-                    }\n-                }\n-                break;\n-\n-            case REOP_STAR:\n-            case REOP_PLUS:\n-            case REOP_OPT:\n-            case REOP_QUANT:\n-            case REOP_MINIMALSTAR:\n-            case REOP_MINIMALPLUS:\n-            case REOP_MINIMALOPT:\n-            case REOP_MINIMALQUANT:\n-                {\n-                    int min, max;\n-                    boolean greedy = false;\n-                    switch (op) {\n-                      case REOP_STAR:\n-                        greedy = true;\n-                        // fallthrough\n-                      case REOP_MINIMALSTAR:\n-                        min = 0;\n-                        max = -1;\n-                        break;\n-                      case REOP_PLUS:\n-                        greedy = true;\n-                        // fallthrough\n-                      case REOP_MINIMALPLUS:\n-                        min = 1;\n-                        max = -1;\n-                        break;\n-                      case REOP_OPT:\n-                        greedy = true;\n-                        // fallthrough\n-                      case REOP_MINIMALOPT:\n-                        min = 0;\n-                        max = 1;\n-                        break;\n-                      case REOP_QUANT:\n-                        greedy = true;\n-                        // fallthrough\n-                      case REOP_MINIMALQUANT:\n-                        min = getOffset(program, pc);\n-                        pc += INDEX_LEN;\n-                        // See comments in emitREBytecode for \" - 1\" reason\n-                        max = getOffset(program, pc) - 1;\n-                        pc += INDEX_LEN;\n-                        break;\n-                      default:\n-                        throw Kit.codeBug();\n-                    }\n-                    pushProgState(gData, min, max, null,\n-                                  currentContinuation_pc,\n-                                  currentContinuation_op);\n-                    if (greedy) {\n-                        currentContinuation_op = REOP_REPEAT;\n-                        currentContinuation_pc = pc;\n-                        pushBackTrackState(gData, REOP_REPEAT, pc);\n-                        /* Step over <parencount>, <parenindex> & <next> */\n-                        pc += 3 * INDEX_LEN;\n-                        op = program[pc++];\n-                    } else {\n-                        if (min != 0) {\n-                            currentContinuation_op = REOP_MINIMALREPEAT;\n-                            currentContinuation_pc = pc;\n-                            /* <parencount> <parenindex> & <next> */\n+                        pushProgState(gData, min, max, gData.cp, null,\n+                                continuationOp, continuationPc);\n+                        if (greedy) {\n+                            pushBackTrackState(gData, REOP_REPEAT, pc);\n+                            continuationOp = REOP_REPEAT;\n+                            continuationPc = pc;\n+                            /* Step over <parencount>, <parenindex> & <next> */\n                             pc += 3 * INDEX_LEN;\n                             op = program[pc++];\n                         } else {\n-                            pushBackTrackState(gData, REOP_MINIMALREPEAT, pc);\n-                            popProgState(gData);\n-                            pc += 2 * INDEX_LEN;  // <parencount> & <parenindex>\n-                            pc = pc + getOffset(program, pc);\n-                            op = program[pc++];\n+                            if (min != 0) {\n+                                continuationOp = REOP_MINIMALREPEAT;\n+                                continuationPc = pc;\n+                                /* <parencount> <parenindex> & <next> */\n+                                pc += 3 * INDEX_LEN;\n+                                op = program[pc++];\n+                            } else {\n+                                pushBackTrackState(gData, REOP_MINIMALREPEAT, pc);\n+                                popProgState(gData);\n+                                pc += 2 * INDEX_LEN;  // <parencount> & <parenindex>\n+                                pc = pc + getOffset(program, pc);\n+                                op = program[pc++];\n+                            }\n                         }\n                     }\n-                }\n-                continue;\n-\n-            case REOP_ENDCHILD:\n-                //\n-                // If we have not gotten a result here, it is because of an\n-                // empty match.  Do the same thing REOP_EMPTY would do.\n-                //\n-                result = true;\n-                // Use the current continuation.\n-                pc = currentContinuation_pc;\n-                op = currentContinuation_op;\n-                continue;\n-\n-            case REOP_REPEAT:\n-                {\n-                    REProgState state = popProgState(gData);\n-                    if (!result) {\n-                        //\n-                        // There's been a failure, see if we have enough\n-                        // children.\n-                        //\n-                        if (state.min == 0)\n-                            result = true;\n-                        currentContinuation_pc = state.continuation_pc;\n-                        currentContinuation_op = state.continuation_op;\n-                        pc += 2 * INDEX_LEN;  /* <parencount> & <parenindex> */\n-                        pc = pc + getOffset(program, pc);\n-                        break;\n-                    }\n-                    else {\n-                        if (state.min == 0 && gData.cp == state.index) {\n-                            // matched an empty string, that'll get us nowhere\n-                            result = false;\n-                            currentContinuation_pc = state.continuation_pc;\n-                            currentContinuation_op = state.continuation_op;\n-                            pc += 2 * INDEX_LEN;\n-                            pc = pc + getOffset(program, pc);\n-                            break;\n+                    continue;\n+\n+                    case REOP_ENDCHILD: /* marks the end of a quantifier child */\n+                        // If we have not gotten a result here, it is because of an\n+                        // empty match.  Do the same thing REOP_EMPTY would do.\n+                        result = true;\n+                        // Use the current continuation.\n+                        pc = continuationPc;\n+                        op = continuationOp;\n+                        continue;\n+\n+                    case REOP_REPEAT:\n+                    {\n+                        int nextpc, nextop;\n+                        do {\n+                            REProgState state = popProgState(gData);\n+                            if (!result) {\n+                                // Failed, see if we have enough children.\n+                                if (state.min == 0)\n+                                    result = true;\n+                                continuationPc = state.continuationPc;\n+                                continuationOp = state.continuationOp;\n+                                pc += 2 * INDEX_LEN;  /* <parencount> & <parenindex> */\n+                                pc += getOffset(program, pc);\n+                                break switchStatement;\n+                            }\n+                            if (state.min == 0 && gData.cp == state.index) {\n+                                // matched an empty string, that'll get us nowhere\n+                                result = false;\n+                                continuationPc = state.continuationPc;\n+                                continuationOp = state.continuationOp;\n+                                pc += 2 * INDEX_LEN;\n+                                pc += getOffset(program, pc);\n+                                break switchStatement;\n+                            }\n+                            int new_min = state.min, new_max = state.max;\n+                            if (new_min != 0) new_min--;\n+                            if (new_max != -1) new_max--;\n+                            if (new_max == 0) {\n+                                result = true;\n+                                continuationPc = state.continuationPc;\n+                                continuationOp = state.continuationOp;\n+                                pc += 2 * INDEX_LEN;\n+                                pc += getOffset(program, pc);\n+                                break switchStatement;\n+                            }\n+                            nextpc = pc + 3 * INDEX_LEN;\n+                            nextop = program[nextpc];\n+                            int startcp = gData.cp;\n+                            if (reopIsSimple(nextop)) {\n+                                nextpc++;\n+                                int match = simpleMatch(gData, input, nextop, program, nextpc, end, true);\n+                                if (match < 0) {\n+                                    result = (new_min == 0);\n+                                    continuationPc = state.continuationPc;\n+                                    continuationOp = state.continuationOp;\n+                                    pc += 2 * INDEX_LEN;  /* <parencount> & <parenindex> */\n+                                    pc += getOffset(program, pc);\n+                                    break switchStatement;\n+                                }\n+                                result = true;\n+                                nextpc = match;\n+                            }\n+                            continuationOp = REOP_REPEAT;\n+                            continuationPc = pc;\n+                            pushProgState(gData, new_min, new_max, startcp, null,\n+                                    state.continuationOp, state.continuationPc);\n+                            if (new_min == 0) {\n+                                pushBackTrackState(gData, REOP_REPEAT, pc, startcp,\n+                                        state.continuationOp, state.continuationPc);\n+                                int parenCount = getIndex(program, pc);\n+                                int parenIndex = getIndex(program, pc + INDEX_LEN);\n+                                for (int k = 0; k < parenCount; k++) {\n+                                    gData.setParens(parenIndex + k, -1, 0);\n+                                }\n+                            }\n+                        } while (program[nextpc] == REOP_ENDCHILD);\n+\n+                        pc = nextpc;\n+                        op = program[pc++];\n+                    }\n+                    continue;\n+\n+                    case REOP_MINIMALREPEAT:\n+                    {\n+                        REProgState state = popProgState(gData);\n+                        if (!result) {\n+                            //\n+                            // Non-greedy failure - try to consume another child.\n+                            //\n+                            if (state.max == -1 || state.max > 0) {\n+                                pushProgState(gData, state.min, state.max, gData.cp, null,\n+                                        state.continuationOp, state.continuationPc);\n+                                continuationOp = REOP_MINIMALREPEAT;\n+                                continuationPc = pc;\n+                                int parenCount = getIndex(program, pc);\n+                                pc += INDEX_LEN;\n+                                int parenIndex = getIndex(program, pc);\n+                                pc += 2 * INDEX_LEN;\n+                                for (int k = 0; k < parenCount; k++) {\n+                                    gData.setParens(parenIndex + k, -1, 0);\n+                                }\n+                                op = program[pc++];\n+                                continue;\n+                            } else {\n+                                // Don't need to adjust pc since we're going to pop.\n+                                continuationPc = state.continuationPc;\n+                                continuationOp = state.continuationOp;\n+                                break;\n+                            }\n+                        } else {\n+                            if (state.min == 0 && gData.cp == state.index) {\n+                                // Matched an empty string, that'll get us nowhere.\n+                                result = false;\n+                                continuationPc = state.continuationPc;\n+                                continuationOp = state.continuationOp;\n+                                break;\n+                            }\n+                            int new_min = state.min, new_max = state.max;\n+                            if (new_min != 0) new_min--;\n+                            if (new_max != -1) new_max--;\n+                            pushProgState(gData, new_min, new_max, gData.cp, null,\n+                                    state.continuationOp, state.continuationPc);\n+                            if (new_min != 0) {\n+                                continuationOp = REOP_MINIMALREPEAT;\n+                                continuationPc = pc;\n+                                int parenCount = getIndex(program, pc);\n+                                pc += INDEX_LEN;\n+                                int parenIndex = getIndex(program, pc);\n+                                pc += 2 * INDEX_LEN;\n+                                for (int k = 0; k < parenCount; k++) {\n+                                    gData.setParens(parenIndex + k, -1, 0);\n+                                }\n+                                op = program[pc++];\n+                            } else {\n+                                continuationPc = state.continuationPc;\n+                                continuationOp = state.continuationOp;\n+                                pushBackTrackState(gData, REOP_MINIMALREPEAT, pc);\n+                                popProgState(gData);\n+                                pc += 2 * INDEX_LEN;\n+                                pc = pc + getOffset(program, pc);\n+                                op = program[pc++];\n+                            }\n+                            continue;\n                         }\n-                        int new_min = state.min, new_max = state.max;\n-                        if (new_min != 0) new_min--;\n-                        if (new_max != -1) new_max--;\n-                        if (new_max == 0) {\n-                            result = true;\n-                            currentContinuation_pc = state.continuation_pc;\n-                            currentContinuation_op = state.continuation_op;\n-                            pc += 2 * INDEX_LEN;\n-                            pc = pc + getOffset(program, pc);\n-                            break;\n-                        }\n-                        pushProgState(gData, new_min, new_max, null,\n-                                      state.continuation_pc,\n-                                      state.continuation_op);\n-                        currentContinuation_op = REOP_REPEAT;\n-                        currentContinuation_pc = pc;\n-                        pushBackTrackState(gData, REOP_REPEAT, pc);\n-                        int parenCount = getIndex(program, pc);\n-                        pc += INDEX_LEN;\n-                        int parenIndex = getIndex(program, pc);\n-                        pc += 2 * INDEX_LEN;\n-                        op = program[pc++];\n-                        for (int k = 0; k < parenCount; k++) {\n-                            gData.set_parens(parenIndex + k, -1, 0);\n-                        }\n-                    }\n-                }\n-                continue;\n-\n-            case REOP_MINIMALREPEAT:\n-                {\n-                    REProgState state = popProgState(gData);\n-                    if (!result) {\n-                        //\n-                        // Non-greedy failure - try to consume another child.\n-                        //\n-                        if (state.max == -1 || state.max > 0) {\n-                            pushProgState(gData, state.min, state.max, null,\n-                                          state.continuation_pc,\n-                                          state.continuation_op);\n-                            currentContinuation_op = REOP_MINIMALREPEAT;\n-                            currentContinuation_pc = pc;\n-                            int parenCount = getIndex(program, pc);\n-                            pc += INDEX_LEN;\n-                            int parenIndex = getIndex(program, pc);\n-                            pc += 2 * INDEX_LEN;\n-                            for (int k = 0; k < parenCount; k++) {\n-                                gData.set_parens(parenIndex + k, -1, 0);\n-                            }\n-                            op = program[pc++];\n-                            continue;\n-                        } else {\n-                            // Don't need to adjust pc since we're going to pop.\n-                            currentContinuation_pc = state.continuation_pc;\n-                            currentContinuation_op = state.continuation_op;\n-                            break;\n-                        }\n-                    } else {\n-                        if (state.min == 0 && gData.cp == state.index) {\n-                            // Matched an empty string, that'll get us nowhere.\n-                            result = false;\n-                            currentContinuation_pc = state.continuation_pc;\n-                            currentContinuation_op = state.continuation_op;\n-                            break;\n-                        }\n-                        int new_min = state.min, new_max = state.max;\n-                        if (new_min != 0) new_min--;\n-                        if (new_max != -1) new_max--;\n-                        pushProgState(gData, new_min, new_max, null,\n-                                      state.continuation_pc,\n-                                      state.continuation_op);\n-                        if (new_min != 0) {\n-                            currentContinuation_op = REOP_MINIMALREPEAT;\n-                            currentContinuation_pc = pc;\n-                            int parenCount = getIndex(program, pc);\n-                            pc += INDEX_LEN;\n-                            int parenIndex = getIndex(program, pc);\n-                            pc += 2 * INDEX_LEN;\n-                            for (int k = 0; k < parenCount; k++) {\n-                                gData.set_parens(parenIndex + k, -1, 0);\n-                            }\n-                            op = program[pc++];\n-                        } else {\n-                            currentContinuation_pc = state.continuation_pc;\n-                            currentContinuation_op = state.continuation_op;\n-                            pushBackTrackState(gData, REOP_MINIMALREPEAT, pc);\n-                            popProgState(gData);\n-                            pc += 2 * INDEX_LEN;\n-                            pc = pc + getOffset(program, pc);\n-                            op = program[pc++];\n-                        }\n-                        continue;\n-                    }\n-                }\n-\n-            case REOP_END:\n-                return true;\n-\n-            default:\n-                throw Kit.codeBug();\n-\n+                    }\n+\n+                    case REOP_END:\n+                        return true;\n+\n+                    default:\n+                        throw Kit.codeBug(\"invalid bytecode\");\n+\n+                }\n             }\n             /*\n              *  If the match failed and there's a backtrack option, take it.\n                 REBackTrackData backTrackData = gData.backTrackStackTop;\n                 if (backTrackData != null) {\n                     gData.backTrackStackTop = backTrackData.previous;\n-\n-                    gData.lastParen = backTrackData.lastParen;\n-\n-                    // XXX: If backTrackData will no longer be used, then\n-                    // there is no need to clone backTrackData.parens\n-                    if (backTrackData.parens != null) {\n-                        gData.parens = backTrackData.parens.clone();\n-                    }\n-\n+                    gData.parens = backTrackData.parens;\n                     gData.cp = backTrackData.cp;\n-\n                     gData.stateStackTop = backTrackData.stateStackTop;\n-\n-                    currentContinuation_op\n-                        = gData.stateStackTop.continuation_op;\n-                    currentContinuation_pc\n-                        = gData.stateStackTop.continuation_pc;\n-                    pc = backTrackData.continuation_pc;\n-                    op = backTrackData.continuation_op;\n+                    continuationOp = backTrackData.continuationOp;\n+                    continuationPc = backTrackData.continuationPc;\n+                    pc = backTrackData.pc;\n+                    op = backTrackData.op;\n                     continue;\n                 }\n                 else\n         }\n \n         gData.backTrackStackTop = null;\n-\n         gData.stateStackTop = null;\n \n-        gData.multiline = multiline;\n+        gData.multiline = multiline || (re.flags & JSREG_MULTILINE) != 0;\n         gData.regexp = re;\n-        gData.lastParen = 0;\n \n         int anchorCh = gData.regexp.anchorCh;\n         //\n                 }\n             }\n             gData.cp = i;\n+            gData.skipped = i - start;\n             for (int j = 0; j < re.parenCount; j++) {\n-                gData.set_parens(j, -1, 0);\n+                gData.parens[j] = -1l;\n             }\n             boolean result = executeREBytecode(gData, input, end);\n \n             gData.backTrackStackTop = null;\n             gData.stateStackTop = null;\n             if (result) {\n-                gData.skipped = i - start;\n                 return true;\n             }\n+            if (anchorCh == ANCHOR_BOL && !gData.multiline) {\n+                gData.skipped = end;\n+                return false;\n+            }\n+            i = start + gData.skipped;\n         }\n         return false;\n     }\n             int num;\n             res.parens = new SubString[re.parenCount];\n             for (num = 0; num < re.parenCount; num++) {\n-                int cap_index = gData.parens_index(num);\n+                int cap_index = gData.parensIndex(num);\n                 String parstr;\n                 if (cap_index != -1) {\n-                    int cap_length = gData.parens_length(num);\n+                    int cap_length = gData.parensLength(num);\n                     parsub = new SubString(str, cap_index, cap_length);\n                     res.parens[num] = parsub;\n-                    if (matchType == TEST) continue;\n-                    parstr = parsub.toString();\n-                    obj.put(num+1, obj, parstr);\n+                    if (matchType != TEST)\n+                        obj.put(num+1, obj, parsub.toString());\n                 }\n                 else {\n                     if (matchType != TEST)\n {\n     static final long serialVersionUID = -6144956577595844213L;\n \n-    char []source;          /* locked source string, sans // */\n+    final char[] source;    /* locked source string, sans // */\n     int parenCount;         /* number of parenthesized submatches */\n     int flags;              /* flags  */\n     byte[] program;         /* regular expression bytecode */\n     int classCount;         /* count [...] bitmaps */\n     RECharSet[] classList;  /* list of [...] bitmaps */\n     int anchorCh = -1;      /* if >= 0, then re starts with this literal char */\n+\n+    RECompiled(String str) {\n+        this.source = str.toCharArray();\n+    }\n }\n \n class RENode {\n     int             kidlen;     /* length of string at kid, in chars */\n     int             bmsize;     /* bitmap size, based on max char code */\n     int             index;      /* index into class list */\n+    boolean         sense;\n \n                                 /* or a literal sequence */\n     char            chr;        /* of one character */\n {\n     REProgState(REProgState previous, int min, int max, int index,\n                 REBackTrackData backTrack,\n-                int continuation_pc, int continuation_op)\n+                int continuationOp, int continuationPc)\n     {\n         this.previous = previous;\n         this.min = min;\n         this.max = max;\n         this.index = index;\n-        this.continuation_op = continuation_op;\n-        this.continuation_pc = continuation_pc;\n+        this.continuationOp = continuationOp;\n+        this.continuationPc = continuationPc;\n         this.backTrack = backTrack;\n     }\n \n-    REProgState previous; // previous state in stack\n-\n-    int min;                      /* current quantifier min */\n-    int max;                      /* current quantifier max */\n-    int index;                    /* progress in text */\n-    int continuation_op;\n-    int continuation_pc;\n-    REBackTrackData backTrack; // used by ASSERT_  to recover state\n+    final REProgState previous; // previous state in stack\n+\n+    final int min;                      /* current quantifier min */\n+    final int max;                      /* current quantifier max */\n+    final int index;                    /* progress in text */\n+    final int continuationOp;\n+    final int continuationPc;\n+    final REBackTrackData backTrack; // used by ASSERT_  to recover state\n }\n \n class REBackTrackData {\n \n-    REBackTrackData(REGlobalData gData, int op, int pc)\n+    REBackTrackData(REGlobalData gData, int op, int pc, int cp,\n+                    int continuationOp, int continuationPc)\n     {\n         previous = gData.backTrackStackTop;\n-        continuation_op = op;\n-        continuation_pc = pc;\n-        lastParen = gData.lastParen;\n-        if (gData.parens != null) {\n-            parens = gData.parens.clone();\n-        }\n-        cp = gData.cp;\n+        this.op = op;\n+        this.pc = pc;\n+        this.cp = cp;\n+        this.continuationOp = continuationOp;\n+        this.continuationPc = continuationPc;\n+        parens = gData.parens;\n         stateStackTop = gData.stateStackTop;\n     }\n \n-    REBackTrackData previous;\n-\n-    int continuation_op;                /* where to backtrack to */\n-    int continuation_pc;\n-    int lastParen;\n-    long[] parens;                      /* parenthesis captures */\n-    int cp;                             /* char buffer index */\n-    REProgState stateStackTop;          /* state of op that backtracked */\n+    final REBackTrackData previous;\n+\n+    final int op;                             /* operator */\n+    final int pc;                             /* bytecode pointer */\n+    final int cp;                             /* char buffer index */\n+    final int continuationOp;                 /* continuation op */\n+    final int continuationPc;                 /* continuation pc */\n+    final long[] parens;                      /* parenthesis captures */\n+    final REProgState stateStackTop;          /* state of op that backtracked */\n }\n \n class REGlobalData {\n     boolean multiline;\n     RECompiled regexp;              /* the RE in execution */\n-    int lastParen;                  /* highest paren set so far */\n     int skipped;                    /* chars skipped anchoring this r.e. */\n \n     int cp;                         /* char buffer index */\n     /**\n      * Get start of parenthesis capture contents, -1 for empty.\n      */\n-    int parens_index(int i)\n+    int parensIndex(int i)\n     {\n         return (int)(parens[i]);\n     }\n     /**\n      * Get length of parenthesis capture contents.\n      */\n-    int parens_length(int i)\n+    int parensLength(int i)\n     {\n         return (int)(parens[i] >>> 32);\n     }\n \n-    void set_parens(int i, int index, int length)\n-    {\n+    void setParens(int i, int index, int length)\n+    {\n+        // clone parens array if it is shared with backtrack state\n+        if (backTrackStackTop != null && backTrackStackTop.parens == parens) {\n+            parens = parens.clone();\n+        }\n         parens[i] = (index & 0xffffffffL) | ((long)length << 32);\n     }\n \n {\n     static final long serialVersionUID = 7931787979395898394L;\n \n-    RECharSet(int length, int startIndex, int strlength)\n+    RECharSet(int length, int startIndex, int strlength, boolean sense)\n     {\n         this.length = length;\n         this.startIndex = startIndex;\n         this.strlength = strlength;\n-    }\n-\n-    int length;\n-    int startIndex;\n-    int strlength;\n+        this.sense = sense;\n+    }\n+\n+    final int length;\n+    final int startIndex;\n+    final int strlength;\n+    final boolean sense;\n \n     volatile transient boolean converted;\n-    volatile transient boolean sense;\n     volatile transient byte[] bits;\n }\n--- a/lib/rhino/src/org/mozilla/javascript/regexp/NativeRegExpCtor.java\n+++ b/lib/rhino/src/org/mozilla/javascript/regexp/NativeRegExpCtor.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Brendan Eich\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.regexp;\n \n--- a/lib/rhino/src/org/mozilla/javascript/regexp/RegExpImpl.java\n+++ b/lib/rhino/src/org/mozilla/javascript/regexp/RegExpImpl.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.regexp;\n \n     public Scriptable wrapRegExp(Context cx, Scriptable scope,\n                                  Object compiled)\n     {\n-        return new NativeRegExp(scope, compiled);\n+        return new NativeRegExp(scope, (RECompiled) compiled);\n     }\n \n     public Object action(Context cx, Scriptable scope,\n         Scriptable topScope = ScriptableObject.getTopLevelScope(scope);\n \n         if (args.length == 0) {\n-            Object compiled = NativeRegExp.compileRE(cx, \"\", \"\", false);\n+            RECompiled compiled = NativeRegExp.compileRE(cx, \"\", \"\", false);\n             re = new NativeRegExp(topScope, compiled);\n         } else if (args[0] instanceof NativeRegExp) {\n             re = (NativeRegExp) args[0];\n             } else {\n                 opt = null;\n             }\n-            Object compiled = NativeRegExp.compileRE(cx, src, opt, forceFlat);\n+            RECompiled compiled = NativeRegExp.compileRE(cx, src, opt, forceFlat);\n             re = new NativeRegExp(topScope, compiled);\n         }\n \n--- a/lib/rhino/src/org/mozilla/javascript/regexp/SubString.java\n+++ b/lib/rhino/src/org/mozilla/javascript/regexp/SubString.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.regexp;\n \n--- a/lib/rhino/src/org/mozilla/javascript/serialize/ScriptableInputStream.java\n+++ b/lib/rhino/src/org/mozilla/javascript/serialize/ScriptableInputStream.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino serialization code, released\n- * Sept. 25, 2001.\n- *\n- * The Initial Developer of the Original Code is\n- * Norris Boyd.\n- * Portions created by the Initial Developer are Copyright (C) 2001\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Attila Szegedi\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n // API class\n \n--- a/lib/rhino/src/org/mozilla/javascript/serialize/ScriptableOutputStream.java\n+++ b/lib/rhino/src/org/mozilla/javascript/serialize/ScriptableOutputStream.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino serialization code, released\n- * Sept. 25, 2001.\n- *\n- * The Initial Developer of the Original Code is\n- * Norris Boyd.\n- * Portions created by the Initial Developer are Copyright (C) 2001\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Attila Szegedi\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.serialize;\n \n--- a/lib/rhino/src/org/mozilla/javascript/v8dtoa/DiyFp.java\n+++ b/lib/rhino/src/org/mozilla/javascript/v8dtoa/DiyFp.java\n // have the most significant bit of the significand set.\n // Multiplication and Subtraction do not normalize their results.\n // DiyFp are not designed to contain special doubles (NaN and Infinity).\n-class DiyFp implements Cloneable {\n+class DiyFp {\n \n     private long f;\n     private int e;\n         this.e = e;\n     }\n \n+    private static boolean uint64_gte(long a, long b) {\n+        // greater-or-equal for unsigned int64 in java-style...\n+        return (a == b) || ((a > b) ^ (a < 0) ^ (b < 0));\n+    }\n+\n     // this = this - other.\n     // The exponents of both numbers must be the same and the significand of this\n     // must be bigger than the significand of other.\n     // The result will not be normalized.\n     void subtract(DiyFp other) {\n         assert (e == other.e);\n-        assert (f >= other.f);\n+        assert uint64_gte(f, other.f);\n         f -= other.f;\n     }\n \n     // The exponents of both numbers must be the same and this must be bigger\n     // than other. The result will not be normalized.\n     static DiyFp minus(DiyFp a, DiyFp b) {\n-        DiyFp result = a.clone();\n+        DiyFp result = new DiyFp(a.f, a.e);\n         result.subtract(b);\n         return result;\n     }\n \n     // returns a * b;\n     static DiyFp times(DiyFp a, DiyFp b) {\n-        DiyFp result = a.clone();\n+        DiyFp result = new DiyFp(a.f, a.e);\n         result.multiply(b);\n         return result;\n     }\n     }\n \n     static DiyFp normalize(DiyFp a) {\n-        DiyFp result = a.clone();\n+        DiyFp result = new DiyFp(a.f, a.e);\n         result.normalize();\n         return result;\n     }\n     void setF(long new_value) { f = new_value; }\n     void setE(int new_value) { e = new_value; }\n \n-    public DiyFp clone() {\n-        try {\n-            return (DiyFp) super.clone();\n-        } catch (CloneNotSupportedException e) {\n-            throw new RuntimeException(); // won't happen\n-        }\n-    }\n-\n     @Override\n     public String toString() {\n         return \"[DiyFp f:\" + f + \", e:\" + e + \"]\";\n--- a/lib/rhino/src/org/mozilla/javascript/v8dtoa/FastDtoa.java\n+++ b/lib/rhino/src/org/mozilla/javascript/v8dtoa/FastDtoa.java\n         return ((long)power << 32) | (0xffffffffL & exponent);\n     }\n \n+    private static boolean uint64_lte(long a, long b) {\n+        // less-or-equal for unsigned int64 in java-style...\n+        return (a == b) || ((a < b) ^ (a < 0) ^ (b < 0));\n+    }\n \n     // Generates the digits of input number w.\n     // w is a floating-point number (DiyFp), consisting of a significand and an\n                      FastDtoaBuilder buffer,\n                      int mk) {\n         assert(low.e() == w.e() && w.e() == high.e());\n-        assert(low.f() + 1 <= high.f() - 1);\n+        assert uint64_lte(low.f() + 1, high.f() - 1);\n         assert(minimal_target_exponent <= w.e() && w.e() <= maximal_target_exponent);\n         // low, w and high are imprecise, but by less than one ulp (unit in the last\n         // place).\n--- a/lib/rhino/src/org/mozilla/javascript/v8dtoa/FastDtoaBuilder.java\n+++ b/lib/rhino/src/org/mozilla/javascript/v8dtoa/FastDtoaBuilder.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.v8dtoa;\n \n--- a/lib/rhino/src/org/mozilla/javascript/xml/XMLLib.java\n+++ b/lib/rhino/src/org/mozilla/javascript/xml/XMLLib.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml;\n \n--- a/lib/rhino/src/org/mozilla/javascript/xml/XMLObject.java\n+++ b/lib/rhino/src/org/mozilla/javascript/xml/XMLObject.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xml;\n \n--- a/lib/rhino/testsrc/org/mozilla/javascript/drivers/JsDriver.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/drivers/JsDriver.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is the Java port of jsDriver.pl.\n- *\n- * The Initial Developer of the Original Code is\n- * David P. Caldwell.\n- * Portions created by David P. Caldwell are Copyright (C)\n- * 2007 David P. Caldwell. All Rights Reserved.\n- *\n- *\n- * Contributor(s):\n- *   David P. Caldwell <inonit@inonit.com>\n- *   Norris Boyd <norrisboyd@gmail.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.drivers;\n \n--- a/lib/rhino/testsrc/org/mozilla/javascript/drivers/JsTestsBase.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/drivers/JsTestsBase.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.drivers;\n \n import java.io.File;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/drivers/ShellTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/drivers/ShellTest.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is the Java port of jsDriver.pl.\n- *\n- * The Initial Developer of the Original Code is\n- * David P. Caldwell.\n- * Portions created by David P. Caldwell are Copyright (C)\n- * 2007 David P. Caldwell. All Rights Reserved.\n- *\n- *\n- * Contributor(s):\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.drivers;\n \n         return new String(bytes.toByteArray());\n     }\n \n-    private static void runFileIfExists(Context cx, Scriptable global, File f)\n-    {\n-        if(f.isFile())\n-        {\n-            Main.processFile(cx, global, f.getPath());\n-        }\n-    }\n-\n-    private static class TestState\n-    {\n+    private static void runFileIfExists(Context cx, Scriptable global, File f) {\n+        if(f.isFile()) {\n+            Main.processFileNoThrow(cx, global, f.getPath());\n+        }\n+    }\n+\n+    private static class TestState {\n         boolean finished;\n         ErrorReporterWrapper errors;\n         int exitCode = 0;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/drivers/StandardTests.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/drivers/StandardTests.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Attila Szegedi\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.drivers;\n \n--- a/lib/rhino/testsrc/org/mozilla/javascript/drivers/TestUtils.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/drivers/TestUtils.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.drivers;\n \n import java.io.*;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/testing/TestErrorReporter.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/testing/TestErrorReporter.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.testing;\n \n import org.mozilla.javascript.ErrorReporter;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/ApplyOnPrimitiveNumberTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/ApplyOnPrimitiveNumberTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import junit.framework.TestCase;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/ArrayConcatTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/ArrayConcatTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import junit.framework.TestCase;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug409702Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug409702Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug412433Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug412433Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug419940Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug419940Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import junit.framework.TestCase;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug421071Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug421071Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /*\n  * @(#)Bug421071Test.java\n  *\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug448816Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug448816Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.mozilla.javascript.ScriptableObject;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug466207Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug466207Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import junit.framework.TestCase;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug467396Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug467396Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.mozilla.javascript.Context;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug482203Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug482203Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import java.io.InputStreamReader;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug491621Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug491621Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.junit.Assert;\n         assertSource(\"for(var i=0;i<10;i++)x[i]=i;a++;\",\n                 \"for (var i = 0; i < 10; i++) \\n  x[i] = i;\\na++;\\n\");\n         assertSource(\"var a;if(true)a=1;\",\n-                \"var a;\\nif (true) \\na = 1;\\n\");\n+                \"var a;\\nif (true) \\n  a = 1;\\n\");\n         assertSource(\"switch(x){case 1:var y;z++}\",\n                 \"switch (x) {\\n  case 1:\\n    var y;\\n    z++;\\n}\\n\");\n         assertSource(\"for(var p in o)s+=o[p]\",\n                 \"for (var p in o) \\n  s += o[p];\\n\");\n         assertSource(\"if(c)var a=0;else a=1\",\n-                \"if (c) \\nvar a = 0; else a = 1;\\n\");\n+                \"if (c) \\n  var a = 0;\\nelse \\n  a = 1;\\n\");\n         assertSource(\"for(var i=0;i<10;i++)var x=i;x++;\",\n                 \"for (var i = 0; i < 10; i++) \\n  var x = i;\\nx++;\\n\");\n         assertSource(\"function f(){var i=2;for(var j=0;j<i;++j)print(j);}\",\n         assertSource(\"for(let i=0;i<10;i++)x[i]=i;a++;\",\n                 \"for (let i = 0; i < 10; i++) \\n  x[i] = i;\\na++;\\n\");\n         assertSource(\"let a;if(true)a=1;\",\n-                \"let a;\\nif (true) \\na = 1;\\n\");\n+                \"let a;\\nif (true) \\n  a = 1;\\n\");\n         assertSource(\"switch(x){case 1:let y;z++}\",\n                 \"switch (x) {\\n  case 1:\\n    let y;\\n    z++;\\n}\\n\");\n         assertSource(\"for(let p in o)s+=o[p]\",\n                 \"for (let p in o) \\n  s += o[p];\\n\");\n         assertSource(\"if(c)let a=0;else a=1\",\n-                \"if (c) \\nlet a = 0; else a = 1;\\n\");\n+                \"if (c) \\n  let a = 0;\\nelse \\n  a = 1;\\n\");\n         assertSource(\"for(let i=0;i<10;i++){let x=i;}x++;\",\n-                \"for (let i = 0; i < 10; i++) \\n  {\\n    let x = i;\\n  }\\nx++;\\n\");\n+                \"for (let i = 0; i < 10; i++) {\\n  let x = i;\\n}\\nx++;\\n\");\n         assertSource(\"function f(){let i=2;for(let j=0;j<i;++j)print(j);}\",\n                 \"function f() {\\n  let i = 2;\\n  for (let j = 0; j < i; ++j) \\n    print(j);\\n}\\n\");\n     }\n         assertSource(\"const x=0;x++;\",\n                 \"const x = 0;\\nx++;\\n\");\n         assertSource(\"const a;if(true)a=1;\",\n-                \"const a;\\nif (true) \\na = 1;\\n\");\n+                \"const a;\\nif (true) \\n  a = 1;\\n\");\n         assertSource(\"switch(x){case 1:const y;z++}\",\n                 \"switch (x) {\\n  case 1:\\n    const y;\\n    z++;\\n}\\n\");\n         assertSource(\"if(c)const a=0;else a=1\",\n-                \"if (c) \\nconst a = 0; else a = 1;\\n\");\n+                \"if (c) \\n  const a = 0;\\nelse \\n  a = 1;\\n\");\n     }\n }\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug492525Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug492525Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.junit.Test;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug496585Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug496585Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.junit.Assert;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug687669Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug687669Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n         assertEquals(\"L1:\\n  ;\\n\", toSource(\"L1:;\"));\n         assertEquals(\"L1:\\n  ;\\na = 1;\\n\", toSource(\"L1:; a=1;\"));\n \n-        assertEquals(\"if (1) \\n;\\n\", toSource(\"if(1);\"));\n-        assertEquals(\"if (1) \\n;\\na = 1;\\n\", toSource(\"if(1); a=1;\"));\n+        assertEquals(\"if (1) \\n  ;\\n\", toSource(\"if(1);\"));\n+        assertEquals(\"if (1) \\n  ;\\na = 1;\\n\", toSource(\"if(1); a=1;\"));\n \n-        assertEquals(\"if (1) \\na = 1;\\n\", toSource(\"if(1)a=1;\"));\n-        assertEquals(\"if (1) \\na = 1;\\na = 1;\\n\", toSource(\"if(1)a=1; a=1;\"));\n+        assertEquals(\"if (1) \\n  a = 1;\\n\", toSource(\"if(1)a=1;\"));\n+        assertEquals(\"if (1) \\n  a = 1;\\na = 1;\\n\", toSource(\"if(1)a=1; a=1;\"));\n \n-        assertEquals(\"if (1) \\n;\\n;\\n;\\n;\\n\", toSource(\"if(1);;;;\"));\n+        assertEquals(\"if (1) \\n  ;\\n;\\n;\\n;\\n\", toSource(\"if(1);;;;\"));\n     }\n \n }\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug688018Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug688018Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug688021Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug688021Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug689308Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug689308Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug689314Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug689314Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug714204Test.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Bug714204Test.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/ClassShutterExceptionTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/ClassShutterExceptionTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/ContextFactoryTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/ContextFactoryTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/ContinuationsApiTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/ContinuationsApiTest.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *    Norris Boyd\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tests;\n \n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/CustomSetterAcceptNullScriptableTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/CustomSetterAcceptNullScriptableTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import java.lang.reflect.Method;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/DecompileTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/DecompileTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n \n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/DefineClassTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/DefineClassTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.junit.Test;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/DefineFunctionPropertiesTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/DefineFunctionPropertiesTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.mozilla.javascript.*;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/DeletePropertyTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/DeletePropertyTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import junit.framework.TestCase;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/DoctestsTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/DoctestsTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import java.io.File;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/ErrorPropertiesTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/ErrorPropertiesTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.junit.Assert;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Evaluator.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Evaluator.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n import org.mozilla.javascript.*;\n import java.util.Collections;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/FunctionTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/FunctionTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/GeneratedClassNameTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/GeneratedClassNameTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.mozilla.javascript.Context;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/GeneratedMethodNameTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/GeneratedMethodNameTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.mozilla.javascript.Context;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/GlobalParseXTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/GlobalParseXTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/JavaAcessibilityTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/JavaAcessibilityTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/JsTestsTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/JsTestsTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import java.io.File;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/MozillaSuiteTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/MozillaSuiteTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import java.io.File;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/NativeArrayTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/NativeArrayTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.junit.Test;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/NativeStringTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/NativeStringTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/ObserveInstructionCountTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/ObserveInstructionCountTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/ParserTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/ParserTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.mozilla.javascript.ast.*;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/PrimitiveTypeScopeResolutionTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/PrimitiveTypeScopeResolutionTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.junit.Test;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/PrivateAccessClass.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/PrivateAccessClass.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Attila Szegedi\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tests;\n \n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/StackTraceTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/StackTraceTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /**\n  *\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/StrictModeApiTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/StrictModeApiTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import junit.framework.TestCase;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/TypeOfTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/TypeOfTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import junit.framework.TestCase;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/Utils.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/Utils.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import org.mozilla.javascript.Context;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/WriteReadOnlyPropertyTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/WriteReadOnlyPropertyTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests;\n \n import java.lang.reflect.Method;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/commonjs/module/ComplianceTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/commonjs/module/ComplianceTest.java\n     throws URISyntaxException\n     {\n         return new Require(cx, scope, new StrongCachingModuleScriptProvider(\n-                new UrlModuleSourceProvider(Collections.singleton(new URI(\n-                        \"file:\" + dir.getAbsolutePath().replace(File.separatorChar,'/') + \"/\")),\n+                new UrlModuleSourceProvider(\n+                        Collections.singleton(dir.getAbsoluteFile().toURI()),\n                         Collections.singleton(new URI(ComplianceTest.class.getResource(\".\").toExternalForm() + \"/\")))),\n                         null, null, false);\n     }\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyDescriptorTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /*\n  * Tests for the Object.getOwnPropertyDescriptor(obj, prop) method\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectGetOwnPropertyNamesTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /*\n  * Tests for the Object.getOwnPropertyNames(obj) method\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/es5/ObjectKeysTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n /*\n  * Tests for the Object.keys(obj) method\n  */\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/es5/Test262RegExpTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/es5/Test262RegExpTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests.es5;\n \n import java.util.ArrayList;\n--- a/lib/rhino/testsrc/org/mozilla/javascript/tests/json/JsonParserTest.java\n+++ b/lib/rhino/testsrc/org/mozilla/javascript/tests/json/JsonParserTest.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tests.json;\n \n import static org.junit.Assert.assertEquals;\n         parser.parseValue(\"[1 \");\n     }\n \n+    @Test(expected = ParseException.class)\n+    public void shouldFailToParseIllegalUnicodeEscapeSeq() throws Exception {\n+        parser.parseValue(\"\\\"\\\\u-123\\\"\");\n+    }\n+\n+    @Test(expected = ParseException.class)\n+    public void shouldFailToParseIllegalUnicodeEscapeSeq2() throws Exception {\n+        parser.parseValue(\"\\\"\\\\u006\\u0661\\\"\");\n+    }\n+\n+    @Test(expected = ParseException.class)\n+    public void shouldFailToParseIllegalUnicodeEscapeSeq3() throws Exception {\n+        parser.parseValue(\"\\\"\\\\u006\u0661\\\"\");\n+    }\n+\n+    @Test(expected = ParseException.class)\n+    public void shouldFailToParseTrailingCommaInObject1() throws Exception {\n+        parser.parseValue(\"{\\\"a\\\": 1,}\");\n+    }\n+\n+    @Test(expected = ParseException.class)\n+    public void shouldFailToParseTrailingCommaInObject2() throws Exception {\n+        parser.parseValue(\"{,\\\"a\\\": 1}\");\n+    }\n+\n+    @Test(expected = ParseException.class)\n+    public void shouldFailToParseTrailingCommaInObject3() throws Exception {\n+        parser.parseValue(\"{,}\");\n+    }\n+\n+    @Test\n+    public void shouldParseEmptyObject() throws Exception {\n+        parser.parseValue(\"{}\");\n+    }\n+\n+    @Test(expected = ParseException.class)\n+    public void shouldFailToParseTrailingCommaInArray1() throws Exception {\n+        parser.parseValue(\"[1,]\");\n+    }\n+\n+    @Test(expected = ParseException.class)\n+    public void shouldFailToParseTrailingCommaInArray2() throws Exception {\n+        parser.parseValue(\"[,1]\");\n+    }\n+\n+    @Test(expected = ParseException.class)\n+    public void shouldFailToParseTrailingCommaInArray3() throws Exception {\n+        parser.parseValue(\"[,]\");\n+    }\n+\n+    @Test\n+    public void shouldParseEmptyArray() throws Exception {\n+        parser.parseValue(\"[]\");\n+    }\n+\n+    @Test(expected = ParseException.class)\n+    public void shouldFailToParseIllegalNumber() throws Exception {\n+        parser.parseValue(\"1.\");\n+    }\n+\n     private String str(char... chars) {\n         return new String(chars);\n     }\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/SourceReader.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/SourceReader.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n package org.mozilla.javascript.tools;\n \n import java.io.File;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/ToolErrorReporter.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/ToolErrorReporter.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Kurt Westerfeld\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tools;\n \n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/Dim.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/Dim.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino JavaScript Debugger code, released\n- * November 21, 2000.\n- *\n- * The Initial Developer of the Original Code is\n- * SeeBeyond Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Matt Gould\n- *   Christopher Oliver\n- *   Cameron McCormack\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.debugger;\n \n import org.mozilla.javascript.*;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/GuiCallback.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/GuiCallback.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov, igor@fastmail.fm\n- *   Cameron McCormack\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.debugger;\n \n /**\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/Main.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/Main.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino JavaScript Debugger code, released\n- * November 21, 2000.\n- *\n- * The Initial Developer of the Original Code is\n- * SeeBeyond Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Matt Gould\n- *   Christopher Oliver\n- *   Cameron McCormack\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tools.debugger;\n \n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/ScopeProvider.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/ScopeProvider.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino JavaScript Debugger code, released\n- * November 21, 2000.\n- *\n- * The Initial Developer of the Original Code is\n- * See Beyond Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Christopher Oliver\n- *   Cameron McCormack\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.debugger;\n \n import org.mozilla.javascript.Scriptable;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/SourceProvider.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/SourceProvider.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino JavaScript Debugger code, released\n- * November 21, 2000.\n- *\n- * The Initial Developer of the Original Code is\n- * See Beyond Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Marc Guillemot\n- *   Attila Szegedi\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.debugger;\n \n import org.mozilla.javascript.debug.DebuggableScript;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/SwingGui.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/debugger/SwingGui.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino JavaScript Debugger code, released\n- * November 21, 2000.\n- *\n- * The Initial Developer of the Original Code is\n- * SeeBeyond Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Matt Gould\n- *   Cameron McCormack\n- *   Christopher Oliver\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.debugger;\n \n import javax.swing.*;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/idswitch/CodePrinter.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/idswitch/CodePrinter.java\n /* -*- Mode: java; tab-width: 4; indent-tabs-mode: 1; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.idswitch;\n \n class CodePrinter {\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/idswitch/FileBody.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/idswitch/FileBody.java\n /* -*- Mode: java; tab-width: 4; indent-tabs-mode: 1; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.idswitch;\n \n import java.io.IOException;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/idswitch/IdValuePair.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/idswitch/IdValuePair.java\n /* -*- Mode: java; tab-width: 4; indent-tabs-mode: 1; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.idswitch;\n \n public class IdValuePair\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/idswitch/Main.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/idswitch/Main.java\n /* -*- Mode: java; tab-width: 4; indent-tabs-mode: 1; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.idswitch;\n \n import java.io.*;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/idswitch/SwitchGenerator.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/idswitch/SwitchGenerator.java\n /* -*- Mode: java; tab-width: 4; indent-tabs-mode: 1; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.idswitch;\n \n import org.mozilla.javascript.EvaluatorException;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/jsc/Main.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/jsc/Main.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Mozilla Communicator client code, released\n- * March 31, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1998-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Christine Begle\n- *   Norris Boyd\n- *   Roger Lawrence\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tools.jsc;\n \n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/ConsoleTextArea.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/ConsoleTextArea.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino JavaScript Debugger code, released\n- * November 21, 2000.\n- *\n- * The Initial Developer of the Original Code is\n- * See Beyond Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Christopher Oliver\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.shell;\n import java.io.*;\n import java.awt.*;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/Environment.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/Environment.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n /*\n         Environment.java\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/Global.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/Global.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Patrick Beard\n- *   Igor Bukanov\n- *   Norris Boyd\n- *   Rob Ginda\n- *   Kurt Westerfeld\n- *   Matthias Radestock\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tools.shell;\n \n import java.io.*;\n import java.net.*;\n+import java.nio.charset.Charset;\n import java.lang.reflect.*;\n import java.util.ArrayList;\n import java.util.HashMap;\n \n     NativeArray history;\n     boolean attemptedJLineLoad;\n+    private ShellConsole console;\n     private InputStream inStream;\n     private PrintStream outStream;\n     private PrintStream errStream;\n     public static void load(Context cx, Scriptable thisObj,\n                             Object[] args, Function funObj)\n     {\n-        for (int i = 0; i < args.length; i++) {\n-            Main.processFile(cx, thisObj, Context.toString(args[i]));\n+        for (Object arg : args) {\n+            String file = Context.toString(arg);\n+            try {\n+                Main.processFile(cx, thisObj, file);\n+            } catch (IOException ioex) {\n+                String msg = ToolErrorReporter.getMessage(\n+                        \"msg.couldnt.read.source\", file, ioex.getMessage());\n+                throw Context.reportRuntimeError(msg);\n+            } catch (VirtualMachineError ex) {\n+                // Treat StackOverflow and OutOfMemory as runtime errors\n+                ex.printStackTrace();\n+                String msg = ToolErrorReporter.getMessage(\n+                        \"msg.uncaughtJSException\", ex.toString());\n+                throw Context.reportRuntimeError(msg);\n+            }\n         }\n     }\n \n         return ScriptRuntime.wrapInt(ScriptRuntime.toInt32(arg));\n     }\n \n+    private boolean loadJLine(Charset cs) {\n+        if (!attemptedJLineLoad) {\n+            // Check if we can use JLine for better command line handling\n+            attemptedJLineLoad = true;\n+            console = ShellConsole.getConsole(this, cs);\n+        }\n+        return console != null;\n+    }\n+\n+    public ShellConsole getConsole(Charset cs) {\n+        if (!loadJLine(cs)) {\n+            console = ShellConsole.getConsole(getIn(), getErr(), cs);\n+        }\n+        return console;\n+    }\n+\n     public InputStream getIn() {\n         if (inStream == null && !attemptedJLineLoad) {\n-            // Check if we can use JLine for better command line handling\n-            InputStream jlineStream = ShellLine.getStream(this);\n-            if (jlineStream != null)\n-                inStream = jlineStream;\n-            attemptedJLineLoad = true;\n+            if (loadJLine(Charset.defaultCharset())) {\n+                inStream = console.getIn();\n+            }\n         }\n         return inStream == null ? System.in : inStream;\n     }\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/JSConsole.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/JSConsole.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino JavaScript Debugger code, released\n- * November 21, 2000.\n- *\n- * The Initial Developer of the Original Code is\n- * See Beyond Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Christopher Oliver\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n package org.mozilla.javascript.tools.shell;\n import java.awt.event.ActionEvent;\n import java.awt.event.ActionListener;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/JavaPolicySecurity.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/JavaPolicySecurity.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tools.shell;\n \n+import java.io.IOException;\n import java.security.*;\n import java.net.MalformedURLException;\n import java.net.URL;\n             public Object run() {\n                 URL url = getUrlObj(filename);\n                 ProtectionDomain staticDomain = getUrlDomain(url);\n-                Main.processFileSecure(cx, scope, url.toExternalForm(),\n-                                       staticDomain);\n+                try {\n+                    Main.processFileSecure(cx, scope, url.toExternalForm(),\n+                                           staticDomain);\n+                } catch (IOException ioex) {\n+                    throw new RuntimeException(ioex);\n+                }\n                 return null;\n             }\n         });\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/Main.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/Main.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Patrick Beard\n- *   Norris Boyd\n- *   Igor Bukanov\n- *   Rob Ginda\n- *   Kurt Westerfeld\n- *   Hannes Wallnoefer\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tools.shell;\n \n-import java.io.BufferedReader;\n import java.io.File;\n+import java.io.FileNotFoundException;\n import java.io.IOException;\n import java.io.InputStream;\n-import java.io.InputStreamReader;\n import java.io.PrintStream;\n import java.io.UnsupportedEncodingException;\n import java.lang.ref.ReferenceQueue;\n import java.lang.ref.SoftReference;\n-import java.lang.reflect.UndeclaredThrowableException;\n import java.net.URI;\n import java.net.URISyntaxException;\n+import java.nio.charset.Charset;\n import java.security.MessageDigest;\n import java.security.NoSuchAlgorithmException;\n import java.util.ArrayList;\n             if (type == PROCESS_FILES) {\n                 processFiles(cx, args);\n             } else if (type == EVAL_INLINE_SCRIPT) {\n-                Script script = loadScriptFromSource(cx, scriptText,\n-                                                     \"<command>\", 1, null);\n-                if (script != null) {\n-                    evaluateScript(script, cx, getShellScope());\n-                }\n+                evalInlineScript(cx, scriptText);\n             } else {\n                 throw Kit.codeBug();\n             }\n                               ScriptableObject.DONTENUM);\n \n         for (String file: fileList) {\n-            processSource(cx, file);\n+            try {\n+                processSource(cx, file);\n+            } catch (IOException ioex) {\n+                Context.reportError(ToolErrorReporter.getMessage(\n+                        \"msg.couldnt.read.source\", file, ioex.getMessage()));\n+                exitCode = EXITCODE_FILE_NOT_FOUND;\n+            } catch (RhinoException rex) {\n+                ToolErrorReporter.reportException(\n+                    cx.getErrorReporter(), rex);\n+                exitCode = EXITCODE_RUNTIME_ERROR;\n+            } catch (VirtualMachineError ex) {\n+                // Treat StackOverflow and OutOfMemory as runtime errors\n+                ex.printStackTrace();\n+                String msg = ToolErrorReporter.getMessage(\n+                    \"msg.uncaughtJSException\", ex.toString());\n+                Context.reportError(msg);\n+                exitCode = EXITCODE_RUNTIME_ERROR;\n+            }\n+        }\n+    }\n+\n+    static void evalInlineScript(Context cx, String scriptText) {\n+        try {\n+            Script script = cx.compileString(scriptText, \"<command>\", 1, null);\n+            if (script != null) {\n+                script.exec(cx, getShellScope());\n+            }\n+        } catch (RhinoException rex) {\n+            ToolErrorReporter.reportException(\n+                    cx.getErrorReporter(), rex);\n+            exitCode = EXITCODE_RUNTIME_ERROR;\n+        } catch (VirtualMachineError ex) {\n+            // Treat StackOverflow and OutOfMemory as runtime errors\n+            ex.printStackTrace();\n+            String msg = ToolErrorReporter.getMessage(\n+                    \"msg.uncaughtJSException\", ex.toString());\n+            Context.reportError(msg);\n+            exitCode = EXITCODE_RUNTIME_ERROR;\n         }\n     }\n \n      * @param cx the current context\n      * @param filename the name of the file to compile, or null\n      *                 for interactive mode.\n+     * @throws IOException if the source could not be read\n+     * @throws RhinoException thrown during evaluation of source\n      */\n     public static void processSource(Context cx, String filename)\n+            throws IOException\n     {\n         if (filename == null || filename.equals(\"-\")) {\n             Scriptable scope = getShellScope();\n-            PrintStream ps = global.getErr();\n+            Charset cs;\n+            String charEnc = shellContextFactory.getCharacterEncoding();\n+            if (charEnc != null) {\n+                cs = Charset.forName(charEnc);\n+            } else {\n+                cs = Charset.defaultCharset();\n+            }\n+            ShellConsole console = global.getConsole(cs);\n             if (filename == null) {\n                 // print implementation version\n-                ps.println(cx.getImplementationVersion());\n-            }\n-\n-            String charEnc = shellContextFactory.getCharacterEncoding();\n-            if(charEnc == null)\n-            {\n-                charEnc = System.getProperty(\"file.encoding\");\n-            }\n-            BufferedReader in;\n-            try\n-            {\n-                in = new BufferedReader(new InputStreamReader(global.getIn(),\n-                        charEnc));\n-            }\n-            catch(UnsupportedEncodingException e)\n-            {\n-                throw new UndeclaredThrowableException(e);\n-            }\n+                console.println(cx.getImplementationVersion());\n+            }\n+\n             int lineno = 1;\n             boolean hitEOF = false;\n             while (!hitEOF) {\n-            \tString[] prompts = global.getPrompts(cx);\n+                String[] prompts = global.getPrompts(cx);\n+                String prompt = null;\n                 if (filename == null)\n-                    ps.print(prompts[0]);\n-                ps.flush();\n+                    prompt = prompts[0];\n+                console.flush();\n                 String source = \"\";\n \n                 // Collect lines of source to compile.\n                 while (true) {\n                     String newline;\n                     try {\n-                        newline = in.readLine();\n+                        newline = console.readLine(prompt);\n                     }\n                     catch (IOException ioe) {\n-                        ps.println(ioe.toString());\n+                        console.println(ioe.toString());\n                         break;\n                     }\n                     if (newline == null) {\n                     lineno++;\n                     if (cx.stringIsCompilableUnit(source))\n                         break;\n-                    ps.print(prompts[1]);\n-                }\n-                Script script = loadScriptFromSource(cx, source, \"<stdin>\",\n-                                                     lineno, null);\n-                if (script != null) {\n-                    Object result = evaluateScript(script, cx, scope);\n-                    // Avoid printing out undefined or function definitions.\n-                    if (result != Context.getUndefinedValue() &&\n-                        !(result instanceof Function &&\n-                          source.trim().startsWith(\"function\")))\n-                    {\n-                        try {\n-                            ps.println(Context.toString(result));\n-                        } catch (RhinoException rex) {\n-                            ToolErrorReporter.reportException(\n-                                cx.getErrorReporter(), rex);\n+                    prompt = prompts[1];\n+                }\n+                try {\n+                    Script script = cx.compileString(source, \"<stdin>\", lineno, null);\n+                    if (script != null) {\n+                        Object result = script.exec(cx, scope);\n+                        // Avoid printing out undefined or function definitions.\n+                        if (result != Context.getUndefinedValue() &&\n+                                !(result instanceof Function &&\n+                                        source.trim().startsWith(\"function\")))\n+                        {\n+                            try {\n+                                console.println(Context.toString(result));\n+                            } catch (RhinoException rex) {\n+                                ToolErrorReporter.reportException(\n+                                        cx.getErrorReporter(), rex);\n+                            }\n                         }\n+                        NativeArray h = global.history;\n+                        h.put((int)h.getLength(), h, source);\n                     }\n-                    NativeArray h = global.history;\n-                    h.put((int)h.getLength(), h, source);\n-                }\n-            }\n-            ps.println();\n+                } catch (RhinoException rex) {\n+                    ToolErrorReporter.reportException(\n+                        cx.getErrorReporter(), rex);\n+                    exitCode = EXITCODE_RUNTIME_ERROR;\n+                } catch (VirtualMachineError ex) {\n+                    // Treat StackOverflow and OutOfMemory as runtime errors\n+                    ex.printStackTrace();\n+                    String msg = ToolErrorReporter.getMessage(\n+                        \"msg.uncaughtJSException\", ex.toString());\n+                    Context.reportError(msg);\n+                    exitCode = EXITCODE_RUNTIME_ERROR;\n+                }\n+            }\n+            console.println();\n+            console.flush();\n         } else if (useRequire && filename.equals(mainModule)) {\n-            try {\n-                require.requireMain(cx, filename);\n-            } catch (RhinoException rex) {\n-                ToolErrorReporter.reportException(\n-                        cx.getErrorReporter(), rex);\n-                exitCode = EXITCODE_RUNTIME_ERROR;\n-            } catch (VirtualMachineError ex) {\n-                // Treat StackOverflow and OutOfMemory as runtime errors\n-                ex.printStackTrace();\n-                String msg = ToolErrorReporter.getMessage(\n-                        \"msg.uncaughtJSException\", ex.toString());\n-                exitCode = EXITCODE_RUNTIME_ERROR;\n-                Context.reportError(msg);\n-            }\n+            require.requireMain(cx, filename);\n         } else {\n             processFile(cx, getScope(filename), filename);\n         }\n     }\n \n-    public static void processFile(Context cx, Scriptable scope,\n-                                   String filename)\n+    public static void processFileNoThrow(Context cx, Scriptable scope, String filename) {\n+        try {\n+            processFile(cx, scope, filename);\n+        } catch (IOException ioex) {\n+            Context.reportError(ToolErrorReporter.getMessage(\n+                    \"msg.couldnt.read.source\", filename, ioex.getMessage()));\n+            exitCode = EXITCODE_FILE_NOT_FOUND;\n+        } catch (RhinoException rex) {\n+            ToolErrorReporter.reportException(\n+                    cx.getErrorReporter(), rex);\n+            exitCode = EXITCODE_RUNTIME_ERROR;\n+        } catch (VirtualMachineError ex) {\n+            // Treat StackOverflow and OutOfMemory as runtime errors\n+            ex.printStackTrace();\n+            String msg = ToolErrorReporter.getMessage(\n+                    \"msg.uncaughtJSException\", ex.toString());\n+            Context.reportError(msg);\n+            exitCode = EXITCODE_RUNTIME_ERROR;\n+        }\n+    }\n+\n+    public static void processFile(Context cx, Scriptable scope, String filename)\n+            throws IOException\n     {\n         if (securityImpl == null) {\n             processFileSecure(cx, scope, filename, null);\n     }\n \n     static void processFileSecure(Context cx, Scriptable scope,\n-                                  String path, Object securityDomain) {\n+                                  String path, Object securityDomain)\n+            throws IOException {\n \n         boolean isClass = path.endsWith(\".class\");\n         Object source = readFileOrUrl(path, !isClass);\n-\n-        if (source == null) {\n-            exitCode = EXITCODE_FILE_NOT_FOUND;\n-            return;\n-        }\n \n         byte[] digest = getDigest(source);\n         String key = path + \"_\" + cx.getOptimizationLevel();\n                         }\n                     }\n                 }\n-                script = loadScriptFromSource(cx, strSrc, path, 1, securityDomain);\n+                script = cx.compileString(strSrc, path, 1, securityDomain);\n             }\n             scriptCache.put(key, digest, script);\n         }\n \n         if (script != null) {\n-            evaluateScript(script, cx, scope);\n-        }\n-    }\n-\n-    public static Script loadScriptFromSource(Context cx, String scriptSource,\n-                                              String path, int lineno,\n-                                              Object securityDomain)\n-    {\n-        try {\n-            return cx.compileString(scriptSource, path, lineno,\n-                                    securityDomain);\n-        } catch (RhinoException rex) {\n-            ToolErrorReporter.reportException(\n-                cx.getErrorReporter(), rex);\n-            exitCode = EXITCODE_RUNTIME_ERROR;\n-        } catch (VirtualMachineError ex) {\n-            // Treat StackOverflow and OutOfMemory as runtime errors\n-            ex.printStackTrace();\n-            String msg = ToolErrorReporter.getMessage(\n-                \"msg.uncaughtJSException\", ex.toString());\n-            exitCode = EXITCODE_RUNTIME_ERROR;\n-            Context.reportError(msg);\n-        }\n-        return null;\n+            script.exec(cx, scope);\n+        }\n     }\n \n     private static byte[] getDigest(Object source) {\n \n     private static Script loadCompiledScript(Context cx, String path,\n                                              byte[] data, Object securityDomain)\n+            throws FileNotFoundException\n     {\n         if (data == null) {\n-            exitCode = EXITCODE_FILE_NOT_FOUND;\n-            return null;\n+            throw new FileNotFoundException(path);\n         }\n         // XXX: For now extract class name of compiled Script from path\n         // instead of parsing class bytes\n                 throw Context.reportRuntimeError(\"msg.must.implement.Script\");\n             }\n             return (Script) clazz.newInstance();\n-         } catch (RhinoException rex) {\n-            ToolErrorReporter.reportException(\n-                cx.getErrorReporter(), rex);\n-            exitCode = EXITCODE_RUNTIME_ERROR;\n         } catch (IllegalAccessException iaex) {\n-            exitCode = EXITCODE_RUNTIME_ERROR;\n             Context.reportError(iaex.toString());\n+            throw new RuntimeException(iaex);\n         } catch (InstantiationException inex) {\n-            exitCode = EXITCODE_RUNTIME_ERROR;\n             Context.reportError(inex.toString());\n-        }\n-        return null;\n-    }\n-\n-    public static Object evaluateScript(Script script, Context cx,\n-                                        Scriptable scope)\n-    {\n-        try {\n-            return script.exec(cx, scope);\n-        } catch (RhinoException rex) {\n-            ToolErrorReporter.reportException(\n-                cx.getErrorReporter(), rex);\n-            exitCode = EXITCODE_RUNTIME_ERROR;\n-        } catch (VirtualMachineError ex) {\n-            // Treat StackOverflow and OutOfMemory as runtime errors\n-            ex.printStackTrace();\n-            String msg = ToolErrorReporter.getMessage(\n-                \"msg.uncaughtJSException\", ex.toString());\n-            exitCode = EXITCODE_RUNTIME_ERROR;\n-            Context.reportError(msg);\n-        }\n-        return Context.getUndefinedValue();\n+            throw new RuntimeException(inex);\n+        }\n     }\n \n     public static InputStream getIn() {\n      * <tt>convertToString</tt> is true.\n      */\n     private static Object readFileOrUrl(String path, boolean convertToString)\n-    {\n-        try {\n-            return SourceReader.readFileOrUrl(path, convertToString,\n-                    shellContextFactory.getCharacterEncoding());\n-        } catch (IOException ex) {\n-            Context.reportError(ToolErrorReporter.getMessage(\n-                    \"msg.couldnt.read.source\", path, ex.getMessage()));\n-            return null;\n-        }\n+            throws IOException\n+    {\n+        return SourceReader.readFileOrUrl(path, convertToString,\n+                shellContextFactory.getCharacterEncoding());\n     }\n \n     static class ScriptReference extends SoftReference<Script> {\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/QuitAction.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/QuitAction.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tools.shell;\n \n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/SecurityProxy.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/SecurityProxy.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tools.shell;\n \n--- /dev/null\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/ShellConsole.java\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n+package org.mozilla.javascript.tools.shell;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.PrintStream;\n+import java.io.PrintWriter;\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.nio.charset.Charset;\n+import java.util.List;\n+\n+import org.mozilla.javascript.Function;\n+import org.mozilla.javascript.Kit;\n+import org.mozilla.javascript.Scriptable;\n+import org.mozilla.javascript.ScriptableObject;\n+\n+/**\n+ *\n+ */\n+public abstract class ShellConsole {\n+\n+    private final static Class[] NO_ARG = {};\n+    private final static Class[] BOOLEAN_ARG = {Boolean.TYPE};\n+    private final static Class[] STRING_ARG = {String.class};\n+    private final static Class[] CHARSEQ_ARG = {CharSequence.class};\n+\n+    protected ShellConsole() {\n+    }\n+\n+    /**\n+     * Returns the underlying {@link InputStream}\n+     */\n+    public abstract InputStream getIn();\n+\n+    /**\n+     * Reads a single line from the console\n+     */\n+    public abstract String readLine() throws IOException;\n+\n+    /**\n+     * Reads a single line from the console and sets the console's prompt to\n+     * {@code prompt}\n+     */\n+    public abstract String readLine(String prompt) throws IOException;\n+\n+    /**\n+     * Flushes the console's output\n+     */\n+    public abstract void flush() throws IOException;\n+\n+    /**\n+     * Prints a single string to the console\n+     */\n+    public abstract void print(String s) throws IOException;\n+\n+    /**\n+     * Prints the newline character-sequence to the console\n+     */\n+    public abstract void println() throws IOException;\n+\n+    /**\n+     * Prints a string and the newline character-sequence to the console\n+     */\n+    public abstract void println(String s) throws IOException;\n+\n+\n+    private static Object tryInvoke(Object obj, String method,\n+                                    Class[] paramTypes, Object... args) {\n+        try {\n+            Method m = obj.getClass().getDeclaredMethod(method, paramTypes);\n+            if (m != null) {\n+                return m.invoke(obj, args);\n+            }\n+        } catch (NoSuchMethodException e) {\n+        } catch (IllegalArgumentException e) {\n+        } catch (IllegalAccessException e) {\n+        } catch (InvocationTargetException e) {\n+        }\n+        return null;\n+    }\n+\n+    /**\n+     * {@link ShellConsole} implementation for JLine v1\n+     */\n+    private static class JLineShellConsoleV1 extends ShellConsole {\n+        private final Object reader;\n+        private final InputStream in;\n+\n+        JLineShellConsoleV1(Object reader, Charset cs) {\n+            this.reader = reader;\n+            this.in = new ConsoleInputStream(this, cs);\n+        }\n+\n+        @Override\n+        public InputStream getIn() {\n+            return in;\n+        }\n+\n+        @Override\n+        public String readLine() throws IOException {\n+            return (String) tryInvoke(reader, \"readLine\", NO_ARG);\n+        }\n+\n+        @Override\n+        public String readLine(String prompt) throws IOException {\n+            return (String) tryInvoke(reader, \"readLine\", STRING_ARG, prompt);\n+        }\n+\n+        @Override\n+        public void flush() throws IOException {\n+            tryInvoke(reader, \"flushConsole\", NO_ARG);\n+        }\n+\n+        @Override\n+        public void print(String s) throws IOException {\n+            tryInvoke(reader, \"printString\", STRING_ARG, s);\n+        }\n+\n+        @Override\n+        public void println() throws IOException {\n+            tryInvoke(reader, \"printNewline\", NO_ARG);\n+        }\n+\n+        @Override\n+        public void println(String s) throws IOException {\n+            tryInvoke(reader, \"printString\", STRING_ARG, s);\n+            tryInvoke(reader, \"printNewline\", NO_ARG);\n+        }\n+    }\n+\n+    /**\n+     * {@link ShellConsole} implementation for JLine v2\n+     */\n+    private static class JLineShellConsoleV2 extends ShellConsole {\n+        private final Object reader;\n+        private final InputStream in;\n+\n+        JLineShellConsoleV2(Object reader, Charset cs) {\n+            this.reader = reader;\n+            this.in = new ConsoleInputStream(this, cs);\n+        }\n+\n+        @Override\n+        public InputStream getIn() {\n+            return in;\n+        }\n+\n+        @Override\n+        public String readLine() throws IOException {\n+            return (String) tryInvoke(reader, \"readLine\", NO_ARG);\n+        }\n+\n+        @Override\n+        public String readLine(String prompt) throws IOException {\n+            return (String) tryInvoke(reader, \"readLine\", STRING_ARG, prompt);\n+        }\n+\n+        @Override\n+        public void flush() throws IOException {\n+            tryInvoke(reader, \"flush\", NO_ARG);\n+        }\n+\n+        @Override\n+        public void print(String s) throws IOException {\n+            tryInvoke(reader, \"print\", CHARSEQ_ARG, s);\n+        }\n+\n+        @Override\n+        public void println() throws IOException {\n+            tryInvoke(reader, \"println\", NO_ARG);\n+        }\n+\n+        @Override\n+        public void println(String s) throws IOException {\n+            tryInvoke(reader, \"println\", CHARSEQ_ARG, s);\n+        }\n+    }\n+\n+    /**\n+     * JLine's ConsoleReaderInputStream is no longer public, therefore we need\n+     * to use our own implementation\n+     */\n+    private static class ConsoleInputStream extends InputStream {\n+        private static final byte[] EMPTY = new byte[] {};\n+        private final ShellConsole console;\n+        private final Charset cs;\n+        private byte[] buffer = EMPTY;\n+        private int cursor = -1;\n+        private boolean atEOF = false;\n+\n+        public ConsoleInputStream(ShellConsole console, Charset cs) {\n+            this.console = console;\n+            this.cs = cs;\n+        }\n+\n+        @Override\n+        public synchronized int read(byte[] b, int off, int len)\n+                throws IOException {\n+            if (b == null) {\n+                throw new NullPointerException();\n+            } else if (off < 0 || len < 0 || len > b.length - off) {\n+                throw new IndexOutOfBoundsException();\n+            } else if (len == 0) {\n+                return 0;\n+            }\n+            if (!ensureInput()) {\n+                return -1;\n+            }\n+            int n = Math.min(len, buffer.length - cursor);\n+            for (int i = 0; i < n; ++i) {\n+                b[off + i] = buffer[cursor + i];\n+            }\n+            if (n < len) {\n+                b[off + n++] = '\\n';\n+            }\n+            cursor += n;\n+            return n;\n+        }\n+\n+        @Override\n+        public synchronized int read() throws IOException {\n+            if (!ensureInput()) {\n+                return -1;\n+            }\n+            if (cursor == buffer.length) {\n+                cursor++;\n+                return '\\n';\n+            }\n+            return buffer[cursor++];\n+        }\n+\n+        private boolean ensureInput() throws IOException {\n+            if (atEOF) {\n+                return false;\n+            }\n+            if (cursor < 0 || cursor > buffer.length) {\n+                if (readNextLine() == -1) {\n+                    atEOF = true;\n+                    return false;\n+                }\n+                cursor = 0;\n+            }\n+            return true;\n+        }\n+\n+        private int readNextLine() throws IOException {\n+            String line = console.readLine(null);\n+            if (line != null) {\n+                buffer = line.getBytes(cs);\n+                return buffer.length;\n+            } else {\n+                buffer = EMPTY;\n+                return -1;\n+            }\n+        }\n+    }\n+\n+    private static class SimpleShellConsole extends ShellConsole {\n+        private final InputStream in;\n+        private final PrintWriter out;\n+        private final BufferedReader reader;\n+\n+        SimpleShellConsole(InputStream in, PrintStream ps, Charset cs) {\n+            this.in = in;\n+            this.out = new PrintWriter(ps);\n+            this.reader = new BufferedReader(new InputStreamReader(in, cs));\n+        }\n+\n+        @Override\n+        public InputStream getIn() {\n+            return in;\n+        }\n+\n+        @Override\n+        public String readLine() throws IOException {\n+            return reader.readLine();\n+        }\n+\n+        @Override\n+        public String readLine(String prompt) throws IOException {\n+            if (prompt != null) {\n+                out.write(prompt);\n+                out.flush();\n+            }\n+            return reader.readLine();\n+        }\n+\n+        @Override\n+        public void flush() throws IOException {\n+            out.flush();\n+        }\n+\n+        @Override\n+        public void print(String s) throws IOException {\n+            out.print(s);\n+        }\n+\n+        @Override\n+        public void println() throws IOException {\n+            out.println();\n+        }\n+\n+        @Override\n+        public void println(String s) throws IOException {\n+            out.println(s);\n+        }\n+    }\n+\n+    /**\n+     * Returns a new {@link ShellConsole} which uses the supplied\n+     * {@link InputStream} and {@link PrintStream} for its input/output\n+     */\n+    public static ShellConsole getConsole(InputStream in, PrintStream ps,\n+            Charset cs) {\n+        return new SimpleShellConsole(in, ps, cs);\n+    }\n+\n+    /**\n+     * Provides a specialized {@link ShellConsole} to handle line editing,\n+     * history and completion. Relies on the JLine library (see\n+     * <http://jline.sourceforge.net>).\n+     */\n+    public static ShellConsole getConsole(Scriptable scope, Charset cs) {\n+        // We don't want a compile-time dependency on the JLine jar, so use\n+        // reflection to load and reference the JLine classes.\n+        ClassLoader classLoader = ShellConsole.class.getClassLoader();\n+        if (classLoader == null) {\n+            // If the attempt to get a class specific class loader above failed\n+            // then fallback to the system class loader.\n+            classLoader = ClassLoader.getSystemClassLoader();\n+        }\n+        if (classLoader == null) {\n+            // If for some reason we still don't have a handle to a class\n+            // loader then give up (avoid a NullPointerException).\n+            return null;\n+        }\n+        try {\n+            // first try to load JLine v2...\n+            Class<?> readerClass = Kit.classOrNull(classLoader,\n+                    \"jline.console.ConsoleReader\");\n+            if (readerClass != null) {\n+                return getJLineShellConsoleV2(classLoader, readerClass, scope, cs);\n+            }\n+            // ...if that fails, try to load JLine v1\n+            readerClass = Kit.classOrNull(classLoader, \"jline.ConsoleReader\");\n+            if (readerClass != null) {\n+                return getJLineShellConsoleV1(classLoader, readerClass, scope, cs);\n+            }\n+        } catch (NoSuchMethodException e) {\n+        } catch (IllegalAccessException e) {\n+        } catch (InstantiationException e) {\n+        } catch (InvocationTargetException e) {\n+        }\n+        return null;\n+    }\n+\n+    private static JLineShellConsoleV1 getJLineShellConsoleV1(\n+            ClassLoader classLoader, Class<?> readerClass, Scriptable scope,\n+            Charset cs) throws NoSuchMethodException, InstantiationException,\n+            IllegalAccessException, InvocationTargetException {\n+        // ConsoleReader reader = new ConsoleReader();\n+        Constructor<?> c = readerClass.getConstructor();\n+        Object reader = c.newInstance();\n+\n+        // reader.setBellEnabled(false);\n+        tryInvoke(reader, \"setBellEnabled\", BOOLEAN_ARG, Boolean.FALSE);\n+\n+        // reader.addCompletor(new FlexibleCompletor(prefixes));\n+        Class<?> completorClass = Kit.classOrNull(classLoader,\n+                \"jline.Completor\");\n+        Object completor = Proxy.newProxyInstance(classLoader,\n+                new Class[] { completorClass },\n+                new FlexibleCompletor(completorClass, scope));\n+        tryInvoke(reader, \"addCompletor\", new Class[] {completorClass}, completor);\n+\n+        return new JLineShellConsoleV1(reader, cs);\n+    }\n+\n+    private static JLineShellConsoleV2 getJLineShellConsoleV2(\n+            ClassLoader classLoader, Class<?> readerClass, Scriptable scope,\n+            Charset cs) throws NoSuchMethodException, InstantiationException,\n+            IllegalAccessException, InvocationTargetException {\n+        // ConsoleReader reader = new ConsoleReader();\n+        Constructor<?> c = readerClass.getConstructor();\n+        Object reader = c.newInstance();\n+\n+        // reader.setBellEnabled(false);\n+        tryInvoke(reader, \"setBellEnabled\", BOOLEAN_ARG, Boolean.FALSE);\n+\n+        // reader.addCompleter(new FlexibleCompletor(prefixes));\n+        Class<?> completorClass = Kit.classOrNull(classLoader,\n+                \"jline.console.completer.Completer\");\n+        Object completor = Proxy.newProxyInstance(classLoader,\n+                new Class[] { completorClass },\n+                new FlexibleCompletor(completorClass, scope));\n+        tryInvoke(reader, \"addCompleter\", new Class[] {completorClass}, completor);\n+\n+        return new JLineShellConsoleV2(reader, cs);\n+    }\n+}\n+\n+/**\n+* The completors provided with JLine are pretty uptight, they only\n+* complete on a line that it can fully recognize (only composed of\n+* completed strings). This one completes whatever came before.\n+*/\n+class FlexibleCompletor implements java.lang.reflect.InvocationHandler {\n+    private Method completeMethod;\n+    private Scriptable global;\n+\n+    FlexibleCompletor(Class<?> completorClass, Scriptable global)\n+        throws NoSuchMethodException\n+    {\n+        this.global = global;\n+        this.completeMethod = completorClass.getMethod(\"complete\", String.class,\n+                Integer.TYPE, List.class);\n+    }\n+\n+    @SuppressWarnings({\"unchecked\"})\n+    public Object invoke(Object proxy, Method method, Object[] args) {\n+        if (method.equals(this.completeMethod)) {\n+            int result = complete((String)args[0], ((Integer) args[1]).intValue(),\n+                    (List<String>) args[2]);\n+            return Integer.valueOf(result);\n+        }\n+        throw new NoSuchMethodError(method.toString());\n+    }\n+\n+    public int complete(String buffer, int cursor, List<String> candidates) {\n+        // Starting from \"cursor\" at the end of the buffer, look backward\n+        // and collect a list of identifiers separated by (possibly zero)\n+        // dots. Then look up each identifier in turn until getting to the\n+        // last, presumably incomplete fragment. Then enumerate all the\n+        // properties of the last object and find any that have the\n+        // fragment as a prefix and return those for autocompletion.\n+        int m = cursor - 1;\n+        while (m >= 0) {\n+            char c = buffer.charAt(m);\n+            if (!Character.isJavaIdentifierPart(c) && c != '.')\n+                break;\n+            m--;\n+        }\n+        String namesAndDots = buffer.substring(m+1, cursor);\n+        String[] names = namesAndDots.split(\"\\\\.\", -1);\n+        Scriptable obj = this.global;\n+        for (int i=0; i < names.length - 1; i++) {\n+            Object val = obj.get(names[i], global);\n+            if (val instanceof Scriptable)\n+                obj = (Scriptable) val;\n+            else {\n+                return buffer.length(); // no matches\n+            }\n+        }\n+        Object[] ids = (obj instanceof ScriptableObject)\n+                       ? ((ScriptableObject)obj).getAllIds()\n+                       : obj.getIds();\n+        String lastPart = names[names.length-1];\n+        for (int i=0; i < ids.length; i++) {\n+            if (!(ids[i] instanceof String))\n+                continue;\n+            String id = (String)ids[i];\n+            if (id.startsWith(lastPart)) {\n+                if (obj.get(id, obj) instanceof Function)\n+                    id += \"(\";\n+                candidates.add(id);\n+            }\n+        }\n+        return buffer.length() - lastPart.length();\n+    }\n+}\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/ShellContextFactory.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/ShellContextFactory.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Bob Jervis\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tools.shell;\n \n {\n     private boolean strictMode;\n     private boolean warningAsError;\n-    private int languageVersion;\n+    private int languageVersion = Context.VERSION_1_7;\n     private int optimizationLevel;\n     private boolean generatingDebug;\n     private boolean allowReservedKeywords = true;\n--- a/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/ShellLine.java\n+++ b/lib/rhino/toolsrc/org/mozilla/javascript/tools/shell/ShellLine.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1998.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Matthieu Riou\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.tools.shell;\n \n import java.io.InputStream;\n-import java.util.List;\n-import java.lang.reflect.Constructor;\n-import java.lang.reflect.Method;\n-import java.lang.reflect.Proxy;\n-import java.lang.reflect.InvocationTargetException;\n+import java.nio.charset.Charset;\n \n-import org.mozilla.javascript.Kit;\n import org.mozilla.javascript.Scriptable;\n-import org.mozilla.javascript.ScriptableObject;\n-import org.mozilla.javascript.Function;\n+import org.mozilla.javascript.tools.shell.ShellConsole;\n \n /**\n  * Provides a specialized input stream for consoles to handle line\n  * editing, history and completion. Relies on the JLine library (see\n  * <http://jline.sourceforge.net>).\n  */\n+@Deprecated\n public class ShellLine {\n-\n+    @Deprecated\n     public static InputStream getStream(Scriptable scope) {\n-        // We don't want a compile-time dependency on the JLine jar, so use\n-        // reflection to load and reference the JLine classes.\n-        ClassLoader classLoader = ShellLine.class.getClassLoader();\n-        if (classLoader == null) {\n-            // If the attempt to get a class specific class loader above failed\n-            // then fallback to the system class loader.\n-            classLoader = ClassLoader.getSystemClassLoader();\n-        }\n-        if (classLoader == null) {\n-            // If for some reason we still don't have a handle to a class\n-            // loader then give up (avoid a NullPointerException).\n-            return null;\n-        }\n-        Class<?> readerClass = Kit.classOrNull(classLoader, \"jline.ConsoleReader\");\n-        if (readerClass == null)\n-            return null;\n-        try {\n-            // ConsoleReader reader = new ConsoleReader();\n-            Constructor<?> c = readerClass.getConstructor();\n-            Object reader = c.newInstance();\n-\n-            // reader.setBellEnabled(false);\n-            Method m = readerClass.getMethod(\"setBellEnabled\", Boolean.TYPE);\n-            m.invoke(reader, Boolean.FALSE);\n-\n-            // reader.addCompletor(new FlexibleCompletor(prefixes));\n-            Class<?> completorClass = Kit.classOrNull(classLoader,\n-                \"jline.Completor\");\n-            m = readerClass.getMethod(\"addCompletor\", completorClass);\n-            Object completor = Proxy.newProxyInstance(classLoader,\n-                    new Class[] { completorClass },\n-                    new FlexibleCompletor(completorClass, scope));\n-            m.invoke(reader, completor);\n-\n-            // return new ConsoleReaderInputStream(reader);\n-            Class<?> inputStreamClass = Kit.classOrNull(classLoader,\n-                \"jline.ConsoleReaderInputStream\");\n-            c = inputStreamClass.getConstructor(readerClass);\n-            return (InputStream) c.newInstance(reader);\n-        } catch (NoSuchMethodException e) {\n-        } catch (InstantiationException e) {\n-        } catch (IllegalAccessException e) {\n-        } catch (InvocationTargetException e) {\n-        }\n-        return null;\n+        ShellConsole console = ShellConsole.getConsole(scope,\n+                Charset.defaultCharset());\n+        return (console != null ? console.getIn() : null);\n     }\n }\n-\n-/**\n- * The completors provided with JLine are pretty uptight, they only\n- * complete on a line that it can fully recognize (only composed of\n- * completed strings). This one completes whatever came before.\n- */\n-class FlexibleCompletor implements java.lang.reflect.InvocationHandler {\n-    private Method completeMethod;\n-    private Scriptable global;\n-\n-    FlexibleCompletor(Class<?> completorClass, Scriptable global)\n-        throws NoSuchMethodException\n-    {\n-        this.global = global;\n-        this.completeMethod = completorClass.getMethod(\"complete\", String.class,\n-                Integer.TYPE, List.class);\n-    }\n-\n-    @SuppressWarnings({\"unchecked\"})\n-    public Object invoke(Object proxy, Method method, Object[] args) {\n-        if (method.equals(this.completeMethod)) {\n-            int result = complete((String)args[0], ((Integer) args[1]).intValue(),\n-                    (List<String>) args[2]);\n-            return Integer.valueOf(result);\n-        }\n-        throw new NoSuchMethodError(method.toString());\n-    }\n-\n-    public int complete(String buffer, int cursor, List<String> candidates) {\n-        // Starting from \"cursor\" at the end of the buffer, look backward\n-        // and collect a list of identifiers separated by (possibly zero)\n-        // dots. Then look up each identifier in turn until getting to the\n-        // last, presumably incomplete fragment. Then enumerate all the\n-        // properties of the last object and find any that have the\n-        // fragment as a prefix and return those for autocompletion.\n-        int m = cursor - 1;\n-        while (m >= 0) {\n-            char c = buffer.charAt(m);\n-            if (!Character.isJavaIdentifierPart(c) && c != '.')\n-                break;\n-            m--;\n-        }\n-        String namesAndDots = buffer.substring(m+1, cursor);\n-        String[] names = namesAndDots.split(\"\\\\.\", -1);\n-        Scriptable obj = this.global;\n-        for (int i=0; i < names.length - 1; i++) {\n-            Object val = obj.get(names[i], global);\n-            if (val instanceof Scriptable)\n-                obj = (Scriptable) val;\n-            else {\n-                return buffer.length(); // no matches\n-            }\n-        }\n-        Object[] ids = (obj instanceof ScriptableObject)\n-                       ? ((ScriptableObject)obj).getAllIds()\n-                       : obj.getIds();\n-        String lastPart = names[names.length-1];\n-        for (int i=0; i < ids.length; i++) {\n-            if (!(ids[i] instanceof String))\n-                continue;\n-            String id = (String)ids[i];\n-            if (id.startsWith(lastPart)) {\n-                if (obj.get(id, obj) instanceof Function)\n-                    id += \"(\";\n-                candidates.add(id);\n-            }\n-        }\n-        return buffer.length() - lastPart.length();\n-    }\n-}\n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/Namespace.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/Namespace.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n \n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/QName.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/QName.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n \n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XML.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XML.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n \n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLCtor.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLCtor.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n \n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLLibImpl.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLLibImpl.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n \n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLList.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLList.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n \n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLName.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLName.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Milen Nankov\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n \n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLObjectImpl.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLObjectImpl.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-2000\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Igor Bukanov\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n \n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLWithScope.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XMLWithScope.java\n /* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-\n  *\n- * ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino code, released\n- * May 6, 1999.\n- *\n- * The Initial Developer of the Original Code is\n- * Netscape Communications Corporation.\n- * Portions created by the Initial Developer are Copyright (C) 1997-1999\n- * the Initial Developer. All Rights Reserved.\n- *\n- * Contributor(s):\n- *   Norris Boyd\n- *   Ethan Hugg\n- *   Terry Lucas\n- *   Milen Nankov\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n \n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlNode.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino DOM-only E4X implementation.\n- *\n- * The Initial Developer of the Original Code is\n- * David P. Caldwell.\n- * Portions created by David P. Caldwell are Copyright (C)\n- * 2007 David P. Caldwell. All Rights Reserved.\n- *\n- *\n- * Contributor(s):\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n \n--- a/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlProcessor.java\n+++ b/lib/rhino/xmlimplsrc/org/mozilla/javascript/xmlimpl/XmlProcessor.java\n-/* ***** BEGIN LICENSE BLOCK *****\n- * Version: MPL 1.1/GPL 2.0\n- *\n- * The contents of this file are subject to the Mozilla Public License Version\n- * 1.1 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- * http://www.mozilla.org/MPL/\n- *\n- * Software distributed under the License is distributed on an \"AS IS\" basis,\n- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n- * for the specific language governing rights and limitations under the\n- * License.\n- *\n- * The Original Code is Rhino DOM-only E4X implementation.\n- *\n- * The Initial Developer of the Original Code is\n- * David P. Caldwell.\n- * Portions created by David P. Caldwell are Copyright (C)\n- * 2007 David P. Caldwell. All Rights Reserved.\n- *\n- *\n- * Contributor(s):\n- *   David P. Caldwell <inonit@inonit.com>\n- *\n- * Alternatively, the contents of this file may be used under the terms of\n- * the GNU General Public License Version 2 or later (the \"GPL\"), in which\n- * case the provisions of the GPL are applicable instead of those above. If\n- * you wish to allow use of your version of this file only under the terms of\n- * the GPL and not to allow others to use your version of this file under the\n- * MPL, indicate your decision by deleting the provisions above and replacing\n- * them with the notice and other provisions required by the GPL. If you do\n- * not delete the provisions above, a recipient may use your version of this\n- * file under either the MPL or the GPL.\n- *\n- * ***** END LICENSE BLOCK ***** */\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n \n package org.mozilla.javascript.xmlimpl;\n ", "timestamp": 1351779766, "metainfo": ""}