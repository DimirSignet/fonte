{"sha": "ec82f50f1d59755e1ec86ca2488cbbb0baeb6d75", "log": "Pool names to reduce raw souce map size an additional 20%.  This is already supported by the spec and the consumer code.  R=jschorr DELTA=207  (102 added, 27 deleted, 78 changed)   Revision created by MOE tool push_codebase. MOE_MIGRATION=1504   ", "commit": "\n--- a/src/com/google/debugging/sourcemap/SourceMapConsumerV2.java\n+++ b/src/com/google/debugging/sourcemap/SourceMapConsumerV2.java\n    */\n   public void parse(String contents) throws SourceMapParseException {\n     try {\n-      parseInternal(contents);\n+      JSONObject sourceMapRoot = new JSONObject(contents);\n+      parse(sourceMapRoot);\n+    } catch (JSONException ex) {\n+      throw new SourceMapParseException(\"JSON parse exception: \" + ex);\n+    }\n+  }\n+\n+  /**\n+   * Parses the given contents containing a source map.\n+   */\n+  public void parse(JSONObject sourceMapRoot) throws SourceMapParseException {\n+    try {\n+      parseInternal(sourceMapRoot);\n     } catch (JSONException ex) {\n       throw new SourceMapParseException(\"JSON parse exception: \" + ex);\n     }\n   /**\n    * Parses the given contents as version 2 of a SourceMap.\n    */\n-  private void parseInternal(String contents)\n+  private void parseInternal(JSONObject sourceMapRoot)\n       throws JSONException, SourceMapParseException {\n-    JSONObject sourceMapRoot = new JSONObject(contents);\n \n     // Check basic assertions about the format.\n     int version = sourceMapRoot.getInt(\"version\");\n--- a/src/com/google/debugging/sourcemap/SourceMapGeneratorV2.java\n+++ b/src/com/google/debugging/sourcemap/SourceMapGeneratorV2.java\n import java.util.Deque;\n import java.util.LinkedHashMap;\n import java.util.List;\n+import java.util.Map;\n import java.util.Map.Entry;\n \n import javax.annotation.Nullable;\n       Maps.newLinkedHashMap();\n \n   /**\n+   * A map of symbol names to symbol name index\n+   */\n+  private LinkedHashMap<String, Integer> originalNameMap =\n+      Maps.newLinkedHashMap();\n+\n+  /**\n    * Cache of the last mappings source name.\n    */\n   private String lastSourceFile = null;\n     mappings.clear();\n     lastMapping = null;\n     sourceFileMap.clear();\n+    originalNameMap.clear();\n     lastSourceFile = null;\n     lastSourceFileIndex = -1;\n     offsetPosition = new FilePosition(0, 0);\n     // Don't bother if there is not sufficient information to be useful.\n     if (sourceName == null || sourceStartPosition.getLine() < 0) {\n       return;\n-    }\n-\n-    if (sourceName != lastSourceFile) {\n-      lastSourceFile = sourceName;\n-      Integer index = sourceFileMap.get(sourceName);\n-      if (index != null) {\n-        lastSourceFileIndex = index;\n-      } else {\n-        lastSourceFileIndex = sourceFileMap.size();\n-        sourceFileMap.put(sourceName, lastSourceFileIndex);\n-      }\n     }\n \n     FilePosition adjustedStart = startPosition;\n \n     // Create the new mapping.\n     Mapping mapping = new Mapping();\n-    mapping.sourceFile = lastSourceFileIndex;\n+    mapping.sourceFile = getSourceId(sourceName);\n     mapping.originalPosition = sourceStartPosition;\n     mapping.originalName = symbolName;\n     mapping.startPosition = adjustedStart;\n     out.append(\"]\");\n     appendFieldEnd(out);\n \n+    // Add the mappings themselves.\n+    appendFieldStart(out, \"mappings\");\n+    out.append(\"[\");\n+    (new MappingWriter()).appendMappings(out);\n+    out.append(\"]\");\n+    appendFieldEnd(out);\n+\n     // Files names\n     appendFieldStart(out, \"sources\");\n     out.append(\"[\");\n     out.append(\"]\");\n     appendFieldEnd(out);\n \n-    // Add the mappings themselves.\n-    appendFieldStart(out, \"mappings\");\n+    // Files names\n+    appendFieldStart(out, \"names\");\n     out.append(\"[\");\n-    (new MappingWriter()).appendMappings(out);\n+    addOriginalNameMap(out);\n     out.append(\"]\");\n     appendFieldEnd(out);\n \n    * Writes the source name map to 'out'.\n    */\n   private void addSourceNameMap(Appendable out) throws IOException {\n+    addMap(out, sourceFileMap);\n+  }\n+\n+  /**\n+   * Writes the original name map to 'out'.\n+   */\n+  private void addOriginalNameMap(Appendable out) throws IOException {\n+    addMap(out, originalNameMap);\n+  }\n+\n+  /**\n+   * Writes the source name map to 'out'.\n+   */\n+  private void addMap(Appendable out, Map<String,Integer> map)\n+      throws IOException {\n     int i = 0;\n-    for (Entry<String, Integer> entry : sourceFileMap.entrySet()) {\n+    for (Entry<String, Integer> entry : map.entrySet()) {\n       String key = entry.getKey();\n       if (i != 0) {\n         out.append(\",\");\n       }\n-      out.append(\"\\\"\");\n-      out.append(key);\n-      out.append(\"\\\"\");\n+      out.append(escapeString(key));\n       i++;\n     }\n   }\n   }\n \n   /**\n+   * Pools source names.\n+   * @param sourceName The source location to index.\n+   * @return The id to represent the source name in the output.\n+   */\n+  private int getSourceId(String sourceName) {\n+    if (sourceName != lastSourceFile) {\n+      lastSourceFile = sourceName;\n+      Integer index = sourceFileMap.get(sourceName);\n+      if (index != null) {\n+        lastSourceFileIndex = index;\n+      } else {\n+        lastSourceFileIndex = sourceFileMap.size();\n+        sourceFileMap.put(sourceName, lastSourceFileIndex);\n+      }\n+    }\n+    return lastSourceFileIndex;\n+  }\n+\n+  /**\n+   * Pools symbol names\n+   * @param symbolName The symbol name to index.\n+   * @return The id to represent the symbol name in the output.\n+   */\n+  private int getNameId(String symbolName) {\n+    int originalNameIndex;\n+    Integer index = originalNameMap.get(symbolName);\n+    if (index != null) {\n+      originalNameIndex = index;\n+    } else {\n+      originalNameIndex = originalNameMap.size();\n+      originalNameMap.put(symbolName, originalNameIndex);\n+    }\n+    return originalNameIndex;\n+  }\n+\n+  /**\n    * A mapping from a given position in an input source file to a given position\n    * in the generated code.\n    */\n       out.append(lineValue);\n \n       out.append(\",\");\n-      out.append(String.valueOf(\n-          m.originalPosition.getColumn()));\n+      out.append(String.valueOf(m.originalPosition.getColumn()));\n \n       if (m.originalName != null) {\n         out.append(\",\");\n-        out.append(escapeString(m.originalName));\n+        out.append(String.valueOf(getNameId(m.originalName)));\n       }\n \n       out.append(\"],\\n\");\n--- a/test/com/google/debugging/sourcemap/SourceMapGeneratorV2Test.java\n+++ b/test/com/google/debugging/sourcemap/SourceMapGeneratorV2Test.java\n                    \"\\\"file\\\":\\\"testcode\\\",\\n\" +\n                    \"\\\"lineCount\\\":1,\\n\" +\n                    \"\\\"lineMaps\\\":[\\\"cAkBEBEB\\\"],\\n\" +\n-                   \"\\\"sources\\\":[\\\"testcode\\\"],\\n\" +\n-                   \"\\\"mappings\\\":[[0,1,9,\\\"__BASIC__\\\"],\\n\" +\n-                   \"[0,1,9,\\\"__BASIC__\\\"],\\n\" +\n+                   \"\\\"mappings\\\":[[0,1,9,0],\\n\" +\n+                   \"[0,1,9,0],\\n\" +\n                    \"[0,1,18],\\n\" +\n                    \"[0,1,21],\\n\" +\n-                   \"]\\n\" +\n+                   \"],\\n\" +\n+                   \"\\\"sources\\\":[\\\"testcode\\\"],\\n\" +\n+                   \"\\\"names\\\":[\\\"__BASIC__\\\"]\\n\" +\n                    \"}\\n\");\n   }\n \n                    \"\\\"file\\\":\\\"testcode\\\",\\n\" +\n                    \"\\\"lineCount\\\":1,\\n\" +\n                    \"\\\"lineMaps\\\":[\\\"cAkBABkBA/kCA+ADMBcBgBA9\\\"],\\n\" +\n-                   \"\\\"sources\\\":[\\\"testcode\\\"],\\n\" +\n-                   \"\\\"mappings\\\":[[0,1,9,\\\"__BASIC__\\\"],\\n\" +\n-                   \"[0,1,9,\\\"__BASIC__\\\"],\\n\" +\n+                   \"\\\"mappings\\\":[[0,1,9,0],\\n\" +\n+                   \"[0,1,9,0],\\n\" +\n                    \"[0,1,18],\\n\" +\n-                   \"[0,1,19,\\\"__PARAM1__\\\"],\\n\" +\n-                   \"[0,1,31,\\\"__PARAM2__\\\"],\\n\" +\n+                   \"[0,1,19,1],\\n\" +\n+                   \"[0,1,31,2],\\n\" +\n                    \"[0,1,43],\\n\" +\n                    \"[0,1,45],\\n\" +\n-                   \"[0,1,49,\\\"__VAR__\\\"],\\n\" +\n+                   \"[0,1,49,3],\\n\" +\n                    \"[0,1,59],\\n\" +\n-                   \"]\\n\" +\n+                   \"],\\n\" +\n+                   \"\\\"sources\\\":[\\\"testcode\\\"],\\n\" +\n+                   \"\\\"names\\\":[\" +\n+                       \"\\\"__BASIC__\\\",\\\"__PARAM1__\\\",\\\"__PARAM2__\\\",\" +\n+                       \"\\\"__VAR__\\\"]\\n\" +\n                    \"}\\n\");\n   }\n \n                    \"\\\"file\\\":\\\"testcode\\\",\\n\" +\n                    \"\\\"lineCount\\\":1,\\n\" +\n                    \"\\\"lineMaps\\\":[\\\"\\\"],\\n\" +\n+                   \"\\\"mappings\\\":[],\\n\" +\n                    \"\\\"sources\\\":[\\\"testcode\\\"],\\n\" +\n-                   \"\\\"mappings\\\":[]\\n\" +\n+                   \"\\\"names\\\":[]\\n\" +\n                    \"}\\n\");\n   }\n \n   public void testGoldenOutput1() throws Exception {\n     detailLevel = SourceMap.DetailLevel.ALL;\n \n-    checkSourceMap(\"function f(foo, bar) { foo = foo + bar + 2; return foo; }\",\n-\n-                   \"{\\n\" +\n-                   \"\\\"version\\\":2,\\n\" +\n-                   \"\\\"file\\\":\\\"testcode\\\",\\n\" +\n-                   \"\\\"lineCount\\\":1,\\n\" +\n-                   \"\\\"lineMaps\\\":\" +\n-                       \"[\\\"cAEBABIBA/ICA+ADICA/ICA+IDA9AEYBMBA5\\\"],\\n\" +\n-                   \"\\\"sources\\\":[\\\"testcode\\\"],\\n\" +\n-                   \"\\\"mappings\\\":[[0,1,9,\\\"f\\\"],\\n\" +\n-                   \"[0,1,9,\\\"f\\\"],\\n\" +\n-                   \"[0,1,10],\\n\" +\n-                   \"[0,1,11,\\\"foo\\\"],\\n\" +\n-                   \"[0,1,16,\\\"bar\\\"],\\n\" +\n-                   \"[0,1,21],\\n\" +\n-                   \"[0,1,23],\\n\" +\n-                   \"[0,1,23,\\\"foo\\\"],\\n\" +\n-                   \"[0,1,29,\\\"foo\\\"],\\n\" +\n-                   \"[0,1,35,\\\"bar\\\"],\\n\" +\n-                   \"[0,1,41],\\n\" +\n-                   \"[0,1,44],\\n\" +\n-                   \"[0,1,51,\\\"foo\\\"],\\n\" +\n-                   \"]\\n\" +\n-                   \"}\\n\");\n+    checkSourceMap(\n+        \"function f(foo, bar) { foo = foo + bar + 2; return foo; }\",\n+\n+        \"{\\n\" +\n+        \"\\\"version\\\":2,\\n\" +\n+        \"\\\"file\\\":\\\"testcode\\\",\\n\" +\n+        \"\\\"lineCount\\\":1,\\n\" +\n+        \"\\\"lineMaps\\\":[\\\"cAEBABIBA/ICA+ADICA/ICA+IDA9AEYBMBA5\\\"],\\n\" +\n+        \"\\\"mappings\\\":[[0,1,9,0],\\n\" +\n+        \"[0,1,9,0],\\n\" +\n+        \"[0,1,10],\\n\" +\n+        \"[0,1,11,1],\\n\" +\n+        \"[0,1,16,2],\\n\" +\n+        \"[0,1,21],\\n\" +\n+        \"[0,1,23],\\n\" +\n+        \"[0,1,23,1],\\n\" +\n+        \"[0,1,29,1],\\n\" +\n+        \"[0,1,35,2],\\n\" +\n+        \"[0,1,41],\\n\" +\n+        \"[0,1,44],\\n\" +\n+        \"[0,1,51,1],\\n\" +\n+        \"],\\n\" +\n+        \"\\\"sources\\\":[\\\"testcode\\\"],\\n\" +\n+        \"\\\"names\\\":[\\\"f\\\",\\\"foo\\\",\\\"bar\\\"]\\n\" +\n+        \"}\\n\");\n \n     detailLevel = SourceMap.DetailLevel.SYMBOLS;\n \n                    \"\\\"file\\\":\\\"testcode\\\",\\n\" +\n                    \"\\\"lineCount\\\":1,\\n\" +\n                    \"\\\"lineMaps\\\":[\\\"cAEBA/ICA+IDE9IEA8IFA7IGg6MHA5\\\"],\\n\" +\n+                   \"\\\"mappings\\\":[[0,1,9,0],\\n\" +\n+                   \"[0,1,9,0],\\n\" +\n+                   \"[0,1,11,1],\\n\" +\n+                   \"[0,1,16,2],\\n\" +\n+                   \"[0,1,23,1],\\n\" +\n+                   \"[0,1,29,1],\\n\" +\n+                   \"[0,1,35,2],\\n\" +\n+                   \"[0,1,51,1],\\n\" +\n+                   \"],\\n\" +\n                    \"\\\"sources\\\":[\\\"testcode\\\"],\\n\" +\n-                   \"\\\"mappings\\\":[[0,1,9,\\\"f\\\"],\\n\" +\n-                   \"[0,1,9,\\\"f\\\"],\\n\" +\n-                   \"[0,1,11,\\\"foo\\\"],\\n\" +\n-                   \"[0,1,16,\\\"bar\\\"],\\n\" +\n-                   \"[0,1,23,\\\"foo\\\"],\\n\" +\n-                   \"[0,1,29,\\\"foo\\\"],\\n\" +\n-                   \"[0,1,35,\\\"bar\\\"],\\n\" +\n-                   \"[0,1,51,\\\"foo\\\"],\\n\" +\n-                   \"]\\n\" +\n+                   \"\\\"names\\\":[\\\"f\\\",\\\"foo\\\",\\\"bar\\\"]\\n\" +\n                    \"}\\n\");\n   }\n \n                    \"\\\"version\\\":2,\\n\" +\n                    \"\\\"file\\\":\\\"testcode\\\",\\n\" +\n                    \"\\\"lineCount\\\":1,\\n\" +\n-                   \"\\\"lineMaps\\\":\" +\n-                       \"[\\\"cAEBABIBA/ICA+ADICA/ICA+IDA9IEYBMBA5\\\"],\\n\" +\n-                   \"\\\"sources\\\":[\\\"testcode\\\"],\\n\" +\n-                   \"\\\"mappings\\\":[[0,1,9,\\\"f\\\"],\\n\" +\n-                   \"[0,1,9,\\\"f\\\"],\\n\" +\n+                   \"\\\"lineMaps\\\":[\" +\n+                       \"\\\"cAEBABIBA/ICA+ADICA/ICA+IDA9IEYBMBA5\\\"],\\n\" +\n+                   \"\\\"mappings\\\":[[0,1,9,0],\\n\" +\n+                   \"[0,1,9,0],\\n\" +\n                    \"[0,1,10],\\n\" +\n-                   \"[0,1,11,\\\"foo\\\"],\\n\" +\n-                   \"[0,1,16,\\\"bar\\\"],\\n\" +\n+                   \"[0,1,11,1],\\n\" +\n+                   \"[0,1,16,2],\\n\" +\n                    \"[0,1,21],\\n\" +\n                    \"[0,5,0],\\n\" +\n-                   \"[0,5,0,\\\"foo\\\"],\\n\" +\n-                   \"[0,5,6,\\\"foo\\\"],\\n\" +\n-                   \"[0,5,12,\\\"bar\\\"],\\n\" +\n-                   \"[0,5,18,\\\"foo\\\"],\\n\" +\n+                   \"[0,5,0,1],\\n\" +\n+                   \"[0,5,6,1],\\n\" +\n+                   \"[0,5,12,2],\\n\" +\n+                   \"[0,5,18,1],\\n\" +\n                    \"[0,6,0],\\n\" +\n-                   \"[0,6,7,\\\"foo\\\"],\\n\" +\n-                   \"]\\n\" +\n+                   \"[0,6,7,1],\\n\" +\n+                   \"],\\n\" +\n+                   \"\\\"sources\\\":[\\\"testcode\\\"],\\n\" +\n+                   \"\\\"names\\\":[\\\"f\\\",\\\"foo\\\",\\\"bar\\\"]\\n\" +\n                    \"}\\n\");\n   }\n \n                    \"\\\"file\\\":\\\"testcode\\\",\\n\" +\n                    \"\\\"lineCount\\\":1,\\n\" +\n                    \"\\\"lineMaps\\\":[\\\"IA\\\"],\\n\" +\n-                   \"\\\"sources\\\":[\\\"c:\\\\myfile.js\\\"],\\n\" +\n-                   \"\\\"mappings\\\":[[0,1,0,\\\"foo\\\"],\\n\" +\n-                   \"]\\n\" +\n+                   \"\\\"mappings\\\":[[0,1,0,0],\\n\" +\n+                   \"],\\n\" +\n+                   \"\\\"sources\\\":[\\\"c:\\\\\\\\myfile.js\\\"],\\n\" +\n+                   \"\\\"names\\\":[\\\"foo\\\"]\\n\" +\n                    \"}\\n\");\n   }\n \n                    \"\\\"file\\\":\\\"testcode\\\",\\n\" +\n                    \"\\\"lineCount\\\":1,\\n\" +\n                    \"\\\"lineMaps\\\":[\\\"IAMBMB\\\"],\\n\" +\n-                   \"\\\"sources\\\":[\\\"c:\\\\myfile.js\\\"],\\n\" +\n-                   \"\\\"mappings\\\":[[0,1,0,\\\"foo\\\"],\\n\" +\n-                   \"[0,1,7,\\\"boo\\\"],\\n\" +\n-                   \"[0,1,14,\\\"goo\\\"],\\n\" +\n-                   \"]\\n\" +\n+                   \"\\\"mappings\\\":[[0,1,0,0],\\n\" +\n+                   \"[0,1,7,1],\\n\" +\n+                   \"[0,1,14,2],\\n\" +\n+                   \"],\\n\" +\n+                   \"\\\"sources\\\":[\\\"c:\\\\\\\\myfile.js\\\"],\\n\" +\n+                   \"\\\"names\\\":[\\\"foo\\\",\\\"boo\\\",\\\"goo\\\"]\\n\" +\n                    \"}\\n\");\n   }\n \n                    \"\\\"\\\",\\n\" +\n                    \"\\\"MAMBABA/!!AUSC\\\",\\n\" +\n                    \"\\\"AEA9AEA8AF\\\"],\\n\" +\n-                   \"\\\"sources\\\":[\\\"c:\\\\myfile.js\\\"],\\n\" +\n                    \"\\\"mappings\\\":[[0,4,0],\\n\" +\n-                   \"[0,4,4,\\\"foo\\\"],\\n\" +\n-                   \"[0,4,8,\\\"a\\\"],\\n\" +\n+                   \"[0,4,4,0],\\n\" +\n+                   \"[0,4,8,1],\\n\" +\n                    \"[0,4,12],\\n\" +\n-                   \"[0,4,1314,\\\"c\\\"],\\n\" +\n-                   \"[0,4,1318,\\\"d\\\"],\\n\" +\n-                   \"[0,4,1322,\\\"e\\\"],\\n\" +\n-                   \"]\\n\" +\n+                   \"[0,4,1314,2],\\n\" +\n+                   \"[0,4,1318,3],\\n\" +\n+                   \"[0,4,1322,4],\\n\" +\n+                   \"],\\n\" +\n+                   \"\\\"sources\\\":[\\\"c:\\\\\\\\myfile.js\\\"],\\n\" +\n+                   \"\\\"names\\\":[\\\"foo\\\",\\\"a\\\",\\\"c\\\",\\\"d\\\",\\\"e\\\"]\\n\" +\n                    \"}\\n\");\n \n     detailLevel = SourceMap.DetailLevel.SYMBOLS;\n         \"\\\"\\\",\\n\" +\n         \"\\\"M/MBAB\\\",\\n\" +\n         \"\\\"ACA+ADA9AE\\\"],\\n\" +\n-        \"\\\"sources\\\":[\\\"c:\\\\myfile.js\\\"],\\n\" +\n-        \"\\\"mappings\\\":[[0,4,4,\\\"foo\\\"],\\n\" +\n-        \"[0,4,8,\\\"a\\\"],\\n\" +\n-        \"[0,4,1314,\\\"c\\\"],\\n\" +\n-        \"[0,4,1318,\\\"d\\\"],\\n\" +\n-        \"[0,4,1322,\\\"e\\\"],\\n\" +\n-        \"]\\n\" +\n+        \"\\\"mappings\\\":[[0,4,4,0],\\n\" +\n+        \"[0,4,8,1],\\n\" +\n+        \"[0,4,1314,2],\\n\" +\n+        \"[0,4,1318,3],\\n\" +\n+        \"[0,4,1322,4],\\n\" +\n+        \"],\\n\" +\n+        \"\\\"sources\\\":[\\\"c:\\\\\\\\myfile.js\\\"],\\n\" +\n+        \"\\\"names\\\":[\\\"foo\\\",\\\"a\\\",\\\"c\\\",\\\"d\\\",\\\"e\\\"]\\n\" +\n         \"}\\n\");\n   }\n ", "timestamp": 1303238182, "metainfo": ""}