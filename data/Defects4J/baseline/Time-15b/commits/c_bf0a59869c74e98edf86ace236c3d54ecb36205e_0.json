{"sha": "bf0a59869c74e98edf86ace236c3d54ecb36205e", "log": "Add LocalDate.toDate() [2465359] providing direct conversion to JDK Date handling DST and time zone data differences  ", "commit": "\n--- a/JodaTime/src/java/org/joda/time/LocalDate.java\n+++ b/JodaTime/src/java/org/joda/time/LocalDate.java\n import java.util.HashSet;\n import java.util.Locale;\n import java.util.Set;\n+import java.util.TimeZone;\n \n import org.joda.time.base.BaseLocal;\n import org.joda.time.chrono.ISOChronology;\n \n     //-----------------------------------------------------------------------\n     /**\n+     * Get the date time as a <code>java.util.Date</code>.\n+     * <p>\n+     * The <code>Date</code> object created has exactly the same year, month and day\n+     * as this date. The time will be set to the earliest valid time for that date.\n+     * <p>\n+     * Converting to a JDK Date is full of complications as the JDK Date constructor\n+     * doesn't behave as you might expect around DST transitions. This method works\n+     * by taking a first guess and then adjusting the JDK date until it has the\n+     * earliest valid instant. This also handles the situation where the JDK time\n+     * zone data differs from the Joda-Time time zone data.\n+     *\n+     * @return a Date initialised with this date, never null\n+     */\n+    public Date toDate() {\n+        int dom = getDayOfMonth();\n+        Date date = new Date(getYear() - 1900, getMonthOfYear() - 1, dom);\n+        LocalDate check = LocalDate.fromDateFields(date);\n+        if (check.isBefore(this)) {\n+            // DST gap (no midnight)\n+            // move forward in units of one hour until date correct\n+            while (check.equals(this) == false) {\n+                date.setTime(date.getTime() + 3600000);\n+                check = LocalDate.fromDateFields(date);\n+            }\n+            // move back in units of one second until date wrong\n+            while (date.getDate() == dom) {\n+                date.setTime(date.getTime() - 1000);\n+            }\n+            // fix result\n+            date.setTime(date.getTime() + 1000);\n+        } else if (check.equals(this)) {\n+            // check for DST overlap (two midnights)\n+            Date earlier = new Date(date.getTime() - TimeZone.getDefault().getDSTSavings());\n+            if (earlier.getDate() == dom) {\n+                date = earlier;\n+            }\n+        }\n+        return date;\n+    }\n+\n+    //-----------------------------------------------------------------------\n+    /**\n      * Returns a copy of this date with different local millis.\n      * <p>\n      * The returned object will be a new instance of the same type.\n--- a/JodaTime/src/test/org/joda/time/TestLocalDate_Basics.java\n+++ b/JodaTime/src/test/org/joda/time/TestLocalDate_Basics.java\n import java.io.ObjectInputStream;\n import java.io.ObjectOutputStream;\n import java.util.Arrays;\n+import java.util.Calendar;\n+import java.util.Date;\n+import java.util.GregorianCalendar;\n import java.util.Locale;\n+import java.util.SimpleTimeZone;\n+import java.util.TimeZone;\n \n import junit.framework.TestCase;\n import junit.framework.TestSuite;\n     }\n \n     //-----------------------------------------------------------------------\n+    public void testToDate_summer() {\n+        LocalDate base = new LocalDate(2005, 7, 9, COPTIC_PARIS);\n+        \n+        Date test = base.toDate();\n+        check(base, 2005, 7, 9);\n+        \n+        GregorianCalendar gcal = new GregorianCalendar();\n+        gcal.clear();\n+        gcal.set(Calendar.YEAR, 2005);\n+        gcal.set(Calendar.MONTH, Calendar.JULY);\n+        gcal.set(Calendar.DAY_OF_MONTH, 9);\n+        assertEquals(gcal.getTime(), test);\n+    }\n+\n+    public void testToDate_winter() {\n+        LocalDate base = new LocalDate(2005, 1, 9, COPTIC_PARIS);\n+        \n+        Date test = base.toDate();\n+        check(base, 2005, 1, 9);\n+        \n+        GregorianCalendar gcal = new GregorianCalendar();\n+        gcal.clear();\n+        gcal.set(Calendar.YEAR, 2005);\n+        gcal.set(Calendar.MONTH, Calendar.JANUARY);\n+        gcal.set(Calendar.DAY_OF_MONTH, 9);\n+        assertEquals(gcal.getTime(), test);\n+    }\n+\n+    public void testToDate_springDST() {\n+        LocalDate base = new LocalDate(2007, 4, 2);\n+        \n+        SimpleTimeZone testZone = new SimpleTimeZone(3600000, \"NoMidnight\",\n+                Calendar.APRIL, 2, 0, 0, Calendar.OCTOBER, 2, 0, 3600000);\n+        TimeZone currentZone = TimeZone.getDefault();\n+        try {\n+            TimeZone.setDefault(testZone);\n+            Date test = base.toDate();\n+            check(base, 2007, 4, 2);\n+            assertEquals(\"Mon Apr 02 01:00:00 GMT+02:00 2007\", test.toString());\n+        } finally {\n+            TimeZone.setDefault(currentZone);\n+        }\n+    }\n+\n+    public void testToDate_springDST_2Hour40Savings() {\n+        LocalDate base = new LocalDate(2007, 4, 2);\n+        \n+        SimpleTimeZone testZone = new SimpleTimeZone(3600000, \"NoMidnight\",\n+                Calendar.APRIL, 2, 0, 0, Calendar.OCTOBER, 2, 0, 3600000, (3600000 / 6) * 16);\n+        TimeZone currentZone = TimeZone.getDefault();\n+        try {\n+            TimeZone.setDefault(testZone);\n+            Date test = base.toDate();\n+            check(base, 2007, 4, 2);\n+            assertEquals(\"Mon Apr 02 02:40:00 GMT+03:40 2007\", test.toString());\n+        } finally {\n+            TimeZone.setDefault(currentZone);\n+        }\n+    }\n+\n+    public void testToDate_autumnDST() {\n+        LocalDate base = new LocalDate(2007, 10, 2);\n+        \n+        SimpleTimeZone testZone = new SimpleTimeZone(3600000, \"NoMidnight\",\n+                Calendar.APRIL, 2, 0, 0, Calendar.OCTOBER, 2, 0, 3600000);\n+        TimeZone currentZone = TimeZone.getDefault();\n+        try {\n+            TimeZone.setDefault(testZone);\n+            Date test = base.toDate();\n+            check(base, 2007, 10, 2);\n+            assertEquals(\"Tue Oct 02 00:00:00 GMT+02:00 2007\", test.toString());\n+        } finally {\n+            TimeZone.setDefault(currentZone);\n+        }\n+    }\n+\n+    //-----------------------------------------------------------------------\n     public void testProperty() {\n         LocalDate test = new LocalDate(2005, 6, 9, GJ_UTC);\n         assertEquals(test.year(), test.property(DateTimeFieldType.year()));", "timestamp": 1257599916, "metainfo": ""}